<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ í˜ì´ì§€ - í•™ìƒ ì§„ë„ ê´€ë¦¬</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #f8f9fa; 
            color: #212529; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }
        h1 { 
            text-align: center; 
            color: #0056b3; 
            border-bottom: 2px solid #e9ecef; 
            padding-bottom: 15px; 
        }
        .search-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .search-section input {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            margin-right: 10px;
            width: 200px;
        }
        .search-section button {
            padding: 10px 20px;
            background-color: #0056b3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .search-section button:hover {
            background-color: #004494;
        }
        .progress-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .progress-table th, .progress-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        .progress-table th {
            background-color: #0056b3;
            color: white;
            font-weight: 600;
        }
        .progress-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .progress-table tr:hover {
            background-color: #e9ecef;
        }
        .score-good { color: #28a745; font-weight: bold; }
        .score-bad { color: #dc3545; font-weight: bold; }
        .status-complete { color: #28a745; }
        .status-incomplete { color: #dc3545; }
        .loading { text-align: center; padding: 40px; color: #6c757d; }
        .no-data { text-align: center; padding: 40px; color: #6c757d; }
        .back-button {
            display: inline-block;
            padding: 8px 16px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .back-button:hover {
            background-color: #5a6268;
        }
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #0056b3;
        }
        .stat-card .number {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-button">â† ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ</a>
        <h1>ğŸ‘©â€ğŸ« ì„ ìƒë‹˜ í˜ì´ì§€ - í•™ìƒ ì§„ë„ ê´€ë¦¬</h1>
        
        <div class="search-section">
            <input type="text" id="studentIdSearch" placeholder="í•™ìƒ ID ì…ë ¥ (ì „ì²´ ì¡°íšŒì‹œ ê³µë°±)">
            <button onclick="searchProgress()">ì§„ë„ ì¡°íšŒ</button>
            <button onclick="loadAllProgress()">ì „ì²´ í•™ìƒ ì¡°íšŒ</button>
        </div>

        <div id="progressData">
            <div class="loading">í•™ìƒ ì§„ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <script>
        async function searchProgress() {
            const studentId = document.getElementById('studentIdSearch').value.trim();
            await loadProgress(studentId);
        }

        async function loadAllProgress() {
            await loadProgress();
        }

        async function loadProgress(studentId = '') {
            const container = document.getElementById('progressData');
            container.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            try {
                const url = studentId ? `/api/student-progress/${studentId}` : '/api/student-progress';
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    container.innerHTML = `<div class="no-data">ì˜¤ë¥˜: ${data.error}</div>`;
                    return;
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="no-data">ì§„ë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                // í†µê³„ ìš”ì•½ ìƒì„±
                const stats = generateStats(data);
                
                // í…Œì´ë¸” ìƒì„±
                let html = '<div class="stats-summary">';
                html += `<div class="stat-card"><h3>ì´ í•™ìŠµ ê¸°ë¡</h3><div class="number">${data.length}ê±´</div></div>`;
                html += `<div class="stat-card"><h3>ì°¸ì—¬ í•™ìƒ</h3><div class="number">${stats.uniqueStudents}ëª…</div></div>`;
                html += `<div class="stat-card"><h3>í‰ê·  ë‹¨ì–´ ì ìˆ˜</h3><div class="number">${stats.avgVocabScore}ì </div></div>`;
                html += `<div class="stat-card"><h3>í‰ê·  ë¬¸ë²• ì ìˆ˜</h3><div class="number">${stats.avgGrammarScore}ì </div></div>`;
                html += '</div>';
                
                html += '<table class="progress-table">';
                html += '<thead><tr>';
                html += '<th>í•™ìƒ ID</th><th>ë‚ ì§œ</th><th>ë‹¨ì–´ ì ìˆ˜</th><th>ë¬¸ë²• ì ìˆ˜</th>';
                html += '<th>ë…í•´ ê²°ê³¼</th><th>ì˜ì–´ë…ì„œ</th><th>ì½ì€ ì±…</th><th>í•™ìŠµ ì†Œê°</th>';
                html += '</tr></thead><tbody>';
                
                data.forEach(record => {
                    html += '<tr>';
                    html += `<td>${record.studentId}</td>`;
                    html += `<td>${new Date(record.date).toLocaleDateString('ko-KR')}</td>`;
                    html += `<td class="${record.vocabScore >= 80 ? 'score-good' : 'score-bad'}">${record.vocabScore}ì </td>`;
                    html += `<td class="${record.grammarScore >= 80 ? 'score-good' : 'score-bad'}">${record.grammarScore}ì </td>`;
                    html += `<td class="${record.readingResult === 'pass' ? 'status-complete' : 'status-incomplete'}">${record.readingResult}</td>`;
                    html += `<td class="${record.englishReading === 'ì™„ë£Œí•¨' ? 'status-complete' : 'status-incomplete'}">${record.englishReading}</td>`;
                    html += `<td>${record.bookTitle || '-'}</td>`;
                    html += `<td>${record.feeling ? record.feeling.substring(0, 50) + (record.feeling.length > 50 ? '...' : '') : '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('ì§„ë„ ì¡°íšŒ ì˜¤ë¥˜:', error);
                container.innerHTML = '<div class="no-data">ì§„ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        function generateStats(data) {
            const uniqueStudents = new Set(data.map(d => d.studentId)).size;
            const vocabScores = data.filter(d => d.vocabScore > 0).map(d => d.vocabScore);
            const grammarScores = data.filter(d => d.grammarScore > 0).map(d => d.grammarScore);
            
            const avgVocabScore = vocabScores.length > 0 ? 
                Math.round(vocabScores.reduce((a, b) => a + b, 0) / vocabScores.length) : 0;
            const avgGrammarScore = grammarScores.length > 0 ? 
                Math.round(grammarScores.reduce((a, b) => a + b, 0) / grammarScores.length) : 0;
            
            return {
                uniqueStudents,
                avgVocabScore,
                avgGrammarScore
            };
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ ì§„ë„ ì¡°íšŒ
        window.addEventListener('load', () => {
            loadAllProgress();
        });
    </script>
</body>
</html>