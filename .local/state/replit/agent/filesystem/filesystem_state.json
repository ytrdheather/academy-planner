{"file_contents":{"main.py":{"content":"","size_bytes":0},"notion-client.js":{"content":"import { Client } from '@notionhq/client';\n\nlet connectionSettings;\n\nasync function getAccessToken() {\n  if (connectionSettings && connectionSettings.settings.expires_at && new Date(connectionSettings.settings.expires_at).getTime() > Date.now()) {\n    return connectionSettings.settings.access_token;\n  }\n  \n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=notion',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  const accessToken = connectionSettings?.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n  if (!connectionSettings || !accessToken) {\n    throw new Error('Notion not connected');\n  }\n  return accessToken;\n}\n\n// WARNING: Never cache this client.\n// Access tokens expire, so a new client must be created each time.\n// Always call this function again to get a fresh client.\nexport async function getUncachableNotionClient() {\n  const accessToken = await getAccessToken();\n  return new Client({ auth: accessToken });\n}","size_bytes":1506},"pyproject.toml":{"content":"[project]\nname = \"python-template\"\nversion = \"0.1.0\"\ndescription = \"\"\nauthors = [\"Your Name <you@example.com>\"]\nrequires-python = \">=3.11\"\ndependencies = []\n","size_bytes":157},"replit.md":{"content":"# Overview\n\nThis is a comprehensive student learning planner web application designed for Vercel deployment. The system features a multi-user teacher dashboard with role-based access control, full Notion database integration, and JWT-based authentication optimized for serverless environments. Students can log daily study progress including test results, homework verification, and reading activities, while teachers can monitor progress through filtered dashboards based on their assigned responsibilities.\n\n# User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n# System Architecture\n\n## Vercel Serverless Structure\nThe application is optimized for Vercel's serverless platform:\n- `api/index.js` - Main Express app exported as serverless function\n- `public/views/` - Static HTML files served directly\n- `vercel.json` - Routing configuration for serverless deployment\n- JWT-based authentication replacing memory sessions for serverless compatibility\n\n## Multi-User Authentication System\nImplements role-based access control with 7 distinct user accounts:\n- **Manager (1)**: Full system access and student management\n- **Teachers (4)**: Access to assigned students only\n- **Assistants (2)**: Limited read-only permissions\n- JWT tokens stored in localStorage with automatic expiration handling\n- Session regeneration on login for security\n\n## Permission System\n- **Manager**: All students + administrative functions\n- **Teacher**: Assigned students + progress management\n- **Assistant**: Limited viewing capabilities\n- Server-side filtering based on user roles and assignments\n- Activity logging for accountability\n\n## Database Integration\n- Notion API integration for student data and progress tracking\n- Graceful fallback to sample data when Notion is unavailable\n- Support for both Replit connector authentication and direct API keys\n- Smart book title autocomplete for English and Korean reading lists\n\n## Security Features\n- Environment variable validation for production deployments\n- JWT secret requirement in production environments\n- Protection against session fixation attacks\n- Secure token storage and automatic cleanup on logout\n\n## Deployment Architecture\n- **Primary Target**: Vercel serverless platform\n- **Development**: Replit environment with full debugging\n- **Runtime**: Node.js 18+ with ES6 modules\n- **Authentication**: JWT-based for serverless compatibility\n- **Static Assets**: Served directly by Vercel CDN\n\n## Environment Configuration\n- `JWT_SECRET`: Required for production token signing\n- `STUDENT_DATABASE_ID` & `PROGRESS_DATABASE_ID`: Notion database connections\n- `REPLIT_CONNECTORS_HOSTNAME`: For Replit-based Notion authentication\n- Automatic fallback to sample data for development testing\n\n# External Dependencies\n\n## Notion API\n- **@notionhq/client** (v5.1.0): Official Notion JavaScript SDK for database and page operations\n- Requires OAuth access tokens for authentication\n- Used for all Notion workspace interactions\n\n## JWT Authentication\n- **jsonwebtoken** (v9.0.2): JWT token generation and verification\n- Stateless authentication suitable for serverless environments\n- 24-hour token expiration with automatic refresh\n\n## Replit Connectors (Development Only)\n- Replit's internal connector system for OAuth management\n- Hostname resolution through `REPLIT_CONNECTORS_HOSTNAME` environment variable\n- Token-based authentication with Replit's API endpoints\n- Automatic credential refresh and secure storage\n\n## Vercel Environment Variables\nRequired for production deployment:\n- `JWT_SECRET`: Strong random string for token signing (REQUIRED)\n- `NOTION_ACCESS_TOKEN`: Notion integration token from https://www.notion.so/my-integrations (REQUIRED)\n- `NODE_ENV`: Set to 'production' for deployment\n- `STUDENT_DATABASE_ID`: Notion student database ID (optional - uses sample data if missing)\n- `PROGRESS_DATABASE_ID`: Notion progress database ID (optional - uses sample data if missing)\n\n# User Accounts\n\n## Login Credentials (All use same password: rdtd112!@)\n- `manager` - ë§¤ë‹ˆì € (ì „ì²´ ê´€ë¦¬)\n- `teacher1` - ì„ ìƒë‹˜1 (ë‹´ë‹¹ í•™ìƒ)\n- `teacher2` - ì„ ìƒë‹˜2 (ë‹´ë‹¹ í•™ìƒ)  \n- `teacher3` - ì„ ìƒë‹˜3 (ë‹´ë‹¹ í•™ìƒ)\n- `teacher4` - ì„ ìƒë‹˜4 (ë‹´ë‹¹ í•™ìƒ)\n- `assistant1` - ì•„ë¥´ë°”ì´íŠ¸1 (ì œí•œì  ê¶Œí•œ)\n- `assistant2` - ì•„ë¥´ë°”ì´íŠ¸2 (ì œí•œì  ê¶Œí•œ)\n\n# Deployment Guide\n\n## Vercel Deployment Steps\n1. **Create Notion Integration**:\n   - Go to https://www.notion.so/my-integrations\n   - Create new integration and copy the token\n   - Share your Notion databases with the integration\n\n2. **Connect GitHub repository to Vercel**\n\n3. **Set environment variables in Vercel dashboard**:\n   - `JWT_SECRET`: Generate strong random string (use openssl rand -base64 32)\n   - `NOTION_ACCESS_TOKEN`: Your Notion integration token\n   - `NODE_ENV`: production\n   - Optional: `STUDENT_DATABASE_ID` and `PROGRESS_DATABASE_ID`\n\n4. **Deploy with zero configuration** (vercel.json handles routing)\n\n5. **Access deployed application** at Vercel provided URL\n\n**Note**: The app works with or without Notion databases - it uses sample data for testing when databases are not configured.\n\n## Local Development\n- Runs on port 5000 in Replit environment\n- Automatic Notion connection testing\n- JWT tokens work with development fallback\n- All static files served properly","size_bytes":5333},"server.js":{"content":"import express from 'express';\nimport cors from 'cors';\nimport bodyParser from 'body-parser';\nimport session from 'express-session';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport { getUncachableNotionClient } from './notion-client.js';\n\n// getAccessToken í•¨ìˆ˜ ì¶”ê°€ (notion-client.jsì—ì„œ ê°€ì ¸ì˜¤ê¸°)\nasync function getAccessToken() {\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  const connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=notion',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  const accessToken = connectionSettings?.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n  if (!connectionSettings || !accessToken) {\n    throw new Error('Notion not connected');\n  }\n  return accessToken;\n}\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nconst app = express();\nconst PORT = 5000;\n\n// ë¯¸ë“¤ì›¨ì–´ ì„¤ì •\napp.use(cors({\n  origin: process.env.NODE_ENV === 'production' ? false : 'http://localhost:5000',\n  credentials: true\n}));\napp.use(bodyParser.json());\napp.use(bodyParser.urlencoded({ extended: true }));\napp.use(express.static('public'));\napp.use('/assets', express.static('assets'));\napp.use(session({\n  secret: process.env.SESSION_SECRET || 'readitude-secret-key-change-in-production',\n  resave: false,\n  saveUninitialized: false,\n  cookie: { \n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 24 * 60 * 60 * 1000 // 24ì‹œê°„\n  }\n}));\n\n// í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ (í•„ìˆ˜)\nconst requiredEnvVars = {\n  STUDENT_DATABASE_ID: 'í•™ìƒ ë¡œê·¸ì¸ ì •ë³´ ë°ì´í„°ë² ì´ìŠ¤',\n  PROGRESS_DATABASE_ID: 'í•™ìŠµ ì§„ë„ ë°ì´í„°ë² ì´ìŠ¤',\n  TEACHER_ACCESS_TOKEN: 'ì„ ìƒë‹˜ ì ‘ê·¼ í† í°'\n};\n\nconst missingVars = Object.keys(requiredEnvVars).filter(key => !process.env[key]);\nif (missingVars.length > 0 && process.env.NODE_ENV === 'production') {\n  console.error('âŒ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:');\n  missingVars.forEach(key => {\n    console.error(`   ${key}: ${requiredEnvVars[key]}`);\n  });\n  console.error('   ì´ ë³€ìˆ˜ë“¤ì„ ì„¤ì •í•œ í›„ ì„œë²„ë¥¼ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.');\n  process.exit(1);\n} else if (missingVars.length > 0) {\n  console.warn('âš ï¸  ê°œë°œ í™˜ê²½: ì¼ë¶€ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ (ê¸°ë³¸ê°’ ì‚¬ìš©):');\n  missingVars.forEach(key => {\n    console.warn(`   ${key}: ${requiredEnvVars[key]}`);\n  });\n}\n\n// ë°ì´í„°ë² ì´ìŠ¤ IDë¥¼ Notion í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜\nfunction formatNotionId(id) {\n  // ëŒ€ì‹œê°€ ì—†ëŠ” ê²½ìš° Notion í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (8-4-4-4-12)\n  if (id && !id.includes('-') && id.length === 32) {\n    return `${id.substring(0, 8)}-${id.substring(8, 12)}-${id.substring(12, 16)}-${id.substring(16, 20)}-${id.substring(20, 32)}`;\n  }\n  return id;\n}\n\n// í•™ìƒ ë°ì´í„°ë² ì´ìŠ¤ ID (ì›ìƒ ê´€ë¦¬)  \nconst STUDENT_DB_ID = formatNotionId(process.env.STUDENT_DATABASE_ID || '25409320bce280f8ace1ddcdd022b360');\nconst PROGRESS_DB_ID = formatNotionId(process.env.PROGRESS_DATABASE_ID || '25409320bce2807697ede3f1c1b62ada');\nconst BOOK_LIST_DB_ID = formatNotionId(process.env.BOOK_LIST_DATABASE_ID || '9ef2bbaeec19466daa0d0c0677b9eb90');\nconst SAYU_BOOK_DB_ID = formatNotionId(process.env.SAYU_BOOK_DATABASE_ID || 'cf82d56634574d7e83d893fbf1b1a4e3');\n\n\n\n// ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸ ì™„ë£Œ\n\n\n// ì‚¬ìœ ë…í‰ ì±… ì œëª© ìë™ì™„ì„± API (3ë… ë…ì„œìš©)\napp.get('/api/search-sayu-books', async (req, res) => {\n  const { query } = req.query;\n  \n  try {\n    if (!query || query.length < 2) {\n      return res.json([]);\n    }\n    \n    const accessToken = await getAccessToken();\n    \n    // ì‚¬ìœ ë…í‰ í•©ë³¸ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê²€ìƒ‰\n    const response = await fetch(`https://api.notion.com/v1/databases/${SAYU_BOOK_DB_ID}/query`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      },\n      body: JSON.stringify({\n        filter: {\n          property: '3ë… ìš”ì•½ ì‚¬ìœ ë…í‰ ë„ì„œ ë³´ìœ  ëª©ë¡',\n          title: {\n            contains: query\n          }\n        },\n        sorts: [\n          {\n            property: '3ë… ìš”ì•½ ì‚¬ìœ ë…í‰ ë„ì„œ ë³´ìœ  ëª©ë¡',\n            direction: 'ascending'\n          }\n        ],\n        page_size: 10\n      })\n    });\n    \n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('ì‚¬ìœ ë…í‰ ë„ì„œ ê²€ìƒ‰ API ìƒì„¸ ì˜¤ë¥˜:', errorText);\n      throw new Error(`ì‚¬ìœ ë…í‰ ë„ì„œ ê²€ìƒ‰ ì‹¤íŒ¨: ${response.status} - ${errorText}`);\n    }\n    \n    const data = await response.json();\n    \n    const books = data.results.map(page => {\n      const title = page.properties['3ë… ìš”ì•½ ì‚¬ìœ ë…í‰ ë„ì„œ ë³´ìœ  ëª©ë¡']?.title?.[0]?.plain_text || '';\n      const author = page.properties[' ì§€ì€ì´']?.rich_text?.[0]?.plain_text || '';\n      const publisher = page.properties[' ì¶œíŒì‚¬']?.rich_text?.[0]?.plain_text || '';\n      \n      return {\n        title,\n        author,\n        publisher,\n        display: author ? `${title} (${author})` : title\n      };\n    }).filter(book => book.title && book.title.toLowerCase().includes(query.toLowerCase()));\n    \n    res.json(books);\n  } catch (error) {\n    console.error('ì‚¬ìœ ë…í‰ ì±… ê²€ìƒ‰ ì˜¤ë¥˜:', error);\n    res.status(500).json({ error: 'ì±… ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });\n  }\n});\n\n// ì˜ì–´ ì›ì„œ ì œëª© ìë™ì™„ì„± API\napp.get('/api/search-books', async (req, res) => {\n  const { query } = req.query;\n  \n  try {\n    if (!query || query.length < 2) {\n      return res.json([]);\n    }\n    \n    const accessToken = await getAccessToken();\n    \n    // ë¦¬ë””íŠœë“œ ì˜í†µ ë„ì„œë¦¬ìŠ¤íŠ¸ì—ì„œ ê²€ìƒ‰\n    const response = await fetch(`https://api.notion.com/v1/databases/${BOOK_LIST_DB_ID}/query`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      },\n      body: JSON.stringify({\n        filter: {\n          property: 'Title',\n          title: {\n            contains: query\n          }\n        },\n        sorts: [\n          {\n            property: 'Title',\n            direction: 'ascending'\n          }\n        ],\n        page_size: 10\n      })\n    });\n    \n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('ë„ì„œ ê²€ìƒ‰ API ìƒì„¸ ì˜¤ë¥˜:', errorText);\n      throw new Error(`ë„ì„œ ê²€ìƒ‰ ì‹¤íŒ¨: ${response.status} - ${errorText}`);\n    }\n    \n    const data = await response.json();\n    const books = data.results.map(page => {\n      const title = page.properties.Title?.title?.[0]?.plain_text || '';\n      const level = page.properties.Level?.select?.name || '';\n      const series = page.properties.Series?.rich_text?.[0]?.plain_text || '';\n      \n      return {\n        title,\n        level,\n        series,\n        display: level ? `${title} (${level})` : title\n      };\n    }).filter(book => book.title && book.title.toLowerCase().includes(query.toLowerCase())); // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œë„ í•œë²ˆ ë” í•„í„°ë§\n    \n    res.json(books);\n    \n  } catch (error) {\n    console.error('ì±… ê²€ìƒ‰ ì˜¤ë¥˜:', error);\n    res.status(500).json({ error: 'ì±… ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });\n  }\n});\n\n// ë¡œê·¸ì¸ í˜ì´ì§€\napp.get('/', (req, res) => {\n  if (req.session.studentId) {\n    return res.redirect('/planner');\n  }\n  res.sendFile(path.join(__dirname, 'views', 'login.html'));\n});\n\n// í•™ìŠµ í”Œë˜ë„ˆ í˜ì´ì§€\napp.get('/planner', (req, res) => {\n  if (!req.session.studentId) {\n    return res.redirect('/');\n  }\n  res.sendFile(path.join(__dirname, 'views', 'planner.html'));\n});\n\n// ì„¸ì…˜ì—ì„œ í•™ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸° API\napp.get('/api/student-info', (req, res) => {\n  if (!req.session.studentId) {\n    return res.status(401).json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' });\n  }\n  \n  res.json({\n    studentId: req.session.studentId,\n    studentName: req.session.studentName || req.session.studentId,\n    studentRealName: req.session.studentRealName || req.session.studentName || req.session.studentId\n  });\n});\n\n// ì„ ìƒë‹˜ í˜ì´ì§€\n// ì„ ìƒë‹˜ ë¡œê·¸ì¸ í˜ì´ì§€\napp.get('/teacher-login', (req, res) => {\n  res.sendFile(path.join(__dirname, 'views', 'teacher-login.html'));\n});\n\n// ë‹¤ì¤‘ ì‚¬ìš©ì ê³„ì • ì„¤ì •\nconst userAccounts = {\n  // ë§¤ë‹ˆì € (ì „ì²´ ê´€ë¦¬)\n  'manager': { password: 'rdtd112!@', role: 'manager', name: 'ë§¤ë‹ˆì €', assignedStudents: 'all' },\n  \n  // ì„ ìƒë‹˜ 4ëª… (ë‹´ë‹¹ í•™ìƒë§Œ)\n  'teacher1': { password: 'rdtd112!@', role: 'teacher', name: 'ì„ ìƒë‹˜1', assignedStudents: [] },\n  'teacher2': { password: 'rdtd112!@', role: 'teacher', name: 'ì„ ìƒë‹˜2', assignedStudents: [] },\n  'teacher3': { password: 'rdtd112!@', role: 'teacher', name: 'ì„ ìƒë‹˜3', assignedStudents: [] },\n  'teacher4': { password: 'rdtd112!@', role: 'teacher', name: 'ì„ ìƒë‹˜4', assignedStudents: [] },\n  \n  // ì•„ë¥´ë°”ì´íŠ¸ìƒ 2ëª… (ì œí•œì  ê¶Œí•œ)\n  'assistant1': { password: 'rdtd112!@', role: 'assistant', name: 'ì•„ë¥´ë°”ì´íŠ¸1', assignedStudents: [] },\n  'assistant2': { password: 'rdtd112!@', role: 'assistant', name: 'ì•„ë¥´ë°”ì´íŠ¸2', assignedStudents: [] }\n};\n\n// ì„ ìƒë‹˜ ë¡œê·¸ì¸ ì²˜ë¦¬\napp.post('/teacher-login', async (req, res) => {\n  const { teacherId, teacherPassword } = req.body;\n  \n  // ì‚¬ìš©ì ê³„ì • í™•ì¸\n  const userAccount = userAccounts[teacherId];\n  \n  if (userAccount && teacherPassword === userAccount.password) {\n    // ë³´ì•ˆ: ì„¸ì…˜ ê³ ì • ê³µê²© ë°©ì§€ë¥¼ ìœ„í•œ ì„¸ì…˜ ID ì¬ìƒì„±\n    req.session.regenerate((err) => {\n      if (err) {\n        console.error('ì„¸ì…˜ ì¬ìƒì„± ì˜¤ë¥˜:', err);\n        return res.json({ success: false, message: 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });\n      }\n      \n      // ì„¸ì…˜ì— ì‚¬ìš©ì ì •ë³´ ì €ì¥\n      req.session.isTeacher = true;\n      req.session.userId = teacherId;\n      req.session.userRole = userAccount.role;\n      req.session.userName = userAccount.name;\n      req.session.assignedStudents = userAccount.assignedStudents;\n      \n      console.log(`ë¡œê·¸ì¸ ì„±ê³µ: ${userAccount.name} (${userAccount.role})`);\n      \n      // ì„¸ì…˜ ì €ì¥ í›„ ì‘ë‹µ\n      req.session.save((err) => {\n        if (err) {\n          console.error('ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜:', err);\n          return res.json({ success: false, message: 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });\n        }\n        res.json({ success: true, message: 'ë¡œê·¸ì¸ ì„±ê³µ' });\n      });\n    });\n  } else {\n    console.log(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${teacherId}`);\n    res.json({ success: false, message: 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' });\n  }\n});\n\n// ì„ ìƒë‹˜ ë¡œê·¸ì•„ì›ƒ\napp.post('/teacher-logout', (req, res) => {\n  // ë³´ì•ˆ: ì™„ì „í•œ ì„¸ì…˜ íŒŒê¸° ë° ì¿ í‚¤ ì‚­ì œ\n  req.session.destroy((err) => {\n    if (err) {\n      console.error('ì„¸ì…˜ íŒŒê¸° ì˜¤ë¥˜:', err);\n      return res.json({ success: false, message: 'ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });\n    }\n    \n    // ì„¸ì…˜ ì¿ í‚¤ ì‚­ì œ\n    res.clearCookie('connect.sid'); // ê¸°ë³¸ ì„¸ì…˜ ì¿ í‚¤ ì´ë¦„\n    res.json({ success: true, message: 'ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.' });\n  });\n});\n\n// ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ (ì„¸ì…˜ í™•ì¸ í•„ìš”)\napp.get('/teacher', (req, res) => {\n  if (!req.session.isTeacher) {\n    return res.redirect('/teacher-login');\n  }\n  res.sendFile(path.join(__dirname, 'views', 'teacher.html'));\n});\n\n// ë¡œê·¸ì¸ ì²˜ë¦¬\napp.post('/login', async (req, res) => {\n  const { studentId, password } = req.body;\n  \n  try {\n    // í•™ìƒ ì •ë³´ ì¡°íšŒ - REST API ì§ì ‘ í˜¸ì¶œ\n    const accessToken = await getAccessToken();\n    \n    const restResponse = await fetch(`https://api.notion.com/v1/databases/${STUDENT_DB_ID}/query`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      },\n      body: JSON.stringify({\n        filter: {\n          and: [\n            {\n              property: 'í•™ìƒ ID',\n              rich_text: {\n                equals: studentId\n              }\n            },\n            {\n              property: 'ë¹„ë°€ë²ˆí˜¸',\n              rich_text: {\n                equals: password.toString()\n              }\n            }\n          ]\n        }\n      })\n    });\n    \n    if (!restResponse.ok) {\n      const errorText = await restResponse.text();\n      console.error('ë¡œê·¸ì¸ API ì˜¤ë¥˜:', errorText);\n      throw new Error(`ë¡œê·¸ì¸ API í˜¸ì¶œ ì‹¤íŒ¨: ${restResponse.status}`);\n    }\n    \n    const response = await restResponse.json();\n\n    if (response.results.length > 0) {\n      req.session.studentId = studentId;\n      \n      // í•™ìƒ ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  í•„ë“œ í™•ì¸ (ë””ë²„ê¹…ìš©)\n      console.log('í•™ìƒ ë°ì´í„°ë² ì´ìŠ¤ í•„ë“œë“¤:', Object.keys(response.results[0].properties));\n      \n      // ì‹¤ì œ ì´ë¦„ í•„ë“œ ì°¾ê¸° ('ì´ë¦„', 'Name', 'í•™ìƒì´ë¦„' ë“± ì‹œë„)\n      const studentRecord = response.results[0].properties;\n      let realName = null;\n      \n      // ê°€ëŠ¥í•œ ì´ë¦„ í•„ë“œë“¤ ì‹œë„\n      const nameFields = ['ì´ë¦„', 'Name', 'í•™ìƒì´ë¦„', 'í•™ìƒ ì´ë¦„', 'ì„±ëª…'];\n      for (const field of nameFields) {\n        if (studentRecord[field]?.rich_text?.[0]?.plain_text) {\n          realName = studentRecord[field].rich_text[0].plain_text;\n          console.log(`ì°¾ì€ ì´ë¦„ í•„ë“œ: ${field} = ${realName}`);\n          break;\n        }\n        if (studentRecord[field]?.title?.[0]?.plain_text) {\n          realName = studentRecord[field].title[0].plain_text;\n          console.log(`ì°¾ì€ ì´ë¦„ í•„ë“œ (title): ${field} = ${realName}`);\n          break;\n        }\n      }\n      \n      req.session.studentName = realName || studentId;\n      req.session.studentRealName = realName; // ì‹¤ì œ ì´ë¦„ ë³„ë„ ì €ì¥\n      console.log('ì„¸ì…˜ì— ì €ì¥ëœ í•™ìƒ ì´ë¦„:', req.session.studentName);\n      \n      res.json({ success: true, message: 'ë¡œê·¸ì¸ ì„±ê³µ!' });\n    } else {\n      res.json({ success: false, message: 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' });\n    }\n  } catch (error) {\n    console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);\n    res.json({ success: false, message: 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });\n  }\n});\n\n// ë¡œê·¸ì•„ì›ƒ\napp.post('/logout', (req, res) => {\n  req.session.destroy();\n  res.redirect('/');\n});\n\n// í•™ìŠµ ë°ì´í„° ì €ì¥\napp.post('/save-progress', async (req, res) => {\n  console.log('=== ì €ì¥ ìš”ì²­ ì‹œì‘ ===');\n  console.log('ì„¸ì…˜ í•™ìƒ ID:', req.session.studentId);\n  console.log('ë°›ì€ í¼ ë°ì´í„°:', JSON.stringify(req.body, null, 2));\n  \n  if (!req.session.studentId) {\n    return res.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' });\n  }\n\n  try {\n    console.log('ì•¡ì„¸ìŠ¤ í† í° íšë“ ì¤‘...');\n    const accessToken = await getAccessToken();\n    console.log('ì•¡ì„¸ìŠ¤ í† í° íšë“ ì™„ë£Œ');\n    \n    const formData = req.body;\n    \n    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìƒˆ í•­ëª© ìƒì„±\n    const today = new Date().toISOString().split('T')[0];\n    \n    // í•™ìƒ ì •ë³´ë¶€í„° ì°¾ê¸° - relation í•„ë“œë¥¼ ìœ„í•´ í•™ìƒì˜ ì‹¤ì œ í˜ì´ì§€ ID í•„ìš”\n    console.log('í•™ìƒ í˜ì´ì§€ ID ì°¾ëŠ” ì¤‘... í•™ìƒ ID:', req.session.studentId);\n    \n    // REST APIë¡œ í•™ìƒ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì´ í•™ìƒì˜ í˜ì´ì§€ ID ì°¾ê¸°\n    const studentResponse = await fetch(`https://api.notion.com/v1/databases/${STUDENT_DB_ID}/query`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      },\n      body: JSON.stringify({\n        filter: {\n          property: 'í•™ìƒ ID',\n          rich_text: {\n            equals: req.session.studentId\n          }\n        }\n      })\n    });\n    \n    if (!studentResponse.ok) {\n      throw new Error(`í•™ìƒ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ${studentResponse.status}`);\n    }\n    \n    const studentData = await studentResponse.json();\n    \n    if (studentData.results.length === 0) {\n      throw new Error(`í•™ìƒ ID ${req.session.studentId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);\n    }\n    \n    const studentPageId = studentData.results[0].id;\n    console.log('ì°¾ì€ í•™ìƒ í˜ì´ì§€ ID:', studentPageId);\n    \n    // ì˜¤ëŠ˜ ë‚ ì§œì— í•´ë‹¹í•˜ëŠ” ê¸°ì¡´ ì¼ì§€ ì°¾ê¸° (MAKEê°€ ì•„ì¹¨ì— ìƒì„±í•œ ê»ë°ê¸° ì¼ì§€)\n    console.log('ì˜¤ëŠ˜ ë‚ ì§œì˜ ê¸°ì¡´ ì¼ì§€ ì°¾ëŠ” ì¤‘...');\n    const existingLogResponse = await fetch(`https://api.notion.com/v1/databases/${PROGRESS_DB_ID}/query`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      },\n      body: JSON.stringify({\n        filter: {\n          and: [\n            {\n              property: 'ğŸ• ë‚ ì§œ',\n              date: {\n                equals: today\n              }\n            },\n            {\n              property: 'í•™ìƒ ëª…ë¶€ ê´€ë¦¬',\n              relation: {\n                contains: studentPageId\n              }\n            }\n          ]\n        }\n      })\n    });\n    \n    if (!existingLogResponse.ok) {\n      throw new Error(`ê¸°ì¡´ ì¼ì§€ ì¡°íšŒ ì‹¤íŒ¨: ${existingLogResponse.status}`);\n    }\n    \n    const existingLogData = await existingLogResponse.json();\n    \n    if (existingLogData.results.length === 0) {\n      throw new Error(`ì˜¤ëŠ˜ ë‚ ì§œ(${today})ì˜ ê¸°ì¡´ ì¼ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. MAKE ìë™í™”ê°€ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);\n    }\n    \n    const existingPageId = existingLogData.results[0].id;\n    console.log('ì°¾ì€ ê¸°ì¡´ ì¼ì§€ í˜ì´ì§€ ID:', existingPageId);\n    \n    // ì—…ë°ì´íŠ¸í•  properties (ë‚ ì§œì™€ í•™ìƒ ê´€ê³„ëŠ” ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì œì™¸)\n    const properties = {};\n\n    // ìˆ™ì œ í™•ì¸ í•„ë“œë“¤ (ìƒíƒœ ì†ì„±) - \"í•´ë‹¹ì—†ìŒ\"ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ\n    if (formData['â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬'] && formData['â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬'] !== 'í•´ë‹¹ì—†ìŒ') {\n      properties['â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬'] = { status: { name: formData['â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬'] } };\n    }\n    if (formData['1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ'] && formData['1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ'] !== 'í•´ë‹¹ì—†ìŒ') {\n      properties['1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ'] = { status: { name: formData['1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ'] } };\n    }\n    if (formData['2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ'] && formData['2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ'] !== 'í•´ë‹¹ì—†ìŒ') {\n      properties['2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ'] = { status: { name: formData['2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ'] } };\n    }\n    if (formData['4ï¸âƒ£ Summary ìˆ™ì œ'] && formData['4ï¸âƒ£ Summary ìˆ™ì œ'] !== 'í•´ë‹¹ì—†ìŒ') {\n      properties['4ï¸âƒ£ Summary ìˆ™ì œ'] = { status: { name: formData['4ï¸âƒ£ Summary ìˆ™ì œ'] } };\n    }\n    if (formData['5ï¸âƒ£ ë§¤ì¼ ë…í•´ ìˆ™ì œ'] && formData['5ï¸âƒ£ ë§¤ì¼ ë…í•´ ìˆ™ì œ'] !== 'í•´ë‹¹ì—†ìŒ') {\n      properties['5ï¸âƒ£ ë§¤ì¼ ë…í•´ ìˆ™ì œ'] = { status: { name: formData['5ï¸âƒ£ ë§¤ì¼ ë…í•´ ìˆ™ì œ'] } };\n    }\n    if (formData['6ï¸âƒ£ ì˜ì–´ ì¼ê¸°(ì´ˆë“±) / ê°œì¸ ë…í•´ì„œ (ì¤‘ê³ ë“±)'] && formData['6ï¸âƒ£ ì˜ì–´ ì¼ê¸°(ì´ˆë“±) / ê°œì¸ ë…í•´ì„œ (ì¤‘ê³ ë“±)'] !== 'í•´ë‹¹ì—†ìŒ') {\n      properties['6ï¸âƒ£ ì˜ì–´ ì¼ê¸°(ì´ˆë“±) / ê°œì¸ ë…í•´ì„œ (ì¤‘ê³ ë“±)'] = { status: { name: formData['6ï¸âƒ£ ì˜ì–´ ì¼ê¸°(ì´ˆë“±) / ê°œì¸ ë…í•´ì„œ (ì¤‘ê³ ë“±)'] } };\n    }\n\n    // í¼ ë°ì´í„°ë¥¼ Notion ì†ì„±ìœ¼ë¡œ ë³€í™˜\n    if (formData['ì–´íœ˜ì •ë‹µ']) {\n      properties['ì–´íœ˜ì •ë‹µ'] = { number: parseInt(formData['ì–´íœ˜ì •ë‹µ']) || 0 };\n    }\n    if (formData['ì–´íœ˜ì´ë¬¸ì œ']) {\n      properties['ì–´íœ˜ì´ë¬¸ì œ'] = { number: parseInt(formData['ì–´íœ˜ì´ë¬¸ì œ']) || 0 };\n    }\n    if (formData['ì–´íœ˜ìœ ë‹›']) {\n      properties['ì–´íœ˜ìœ ë‹›'] = { rich_text: [{ text: { content: formData['ì–´íœ˜ìœ ë‹›'] } }] };\n    }\n    if (formData['ë¬¸ë²• ì „ì²´ ê°œìˆ˜']) {\n      properties['ë¬¸ë²• ì „ì²´ ê°œìˆ˜'] = { number: parseInt(formData['ë¬¸ë²• ì „ì²´ ê°œìˆ˜']) || 0 };\n    }\n    if (formData['ë¬¸ë²•ìˆ™ì œì˜¤ë‹µ']) {\n      properties['ë¬¸ë²•ìˆ™ì œì˜¤ë‹µ'] = { number: parseInt(formData['ë¬¸ë²•ìˆ™ì œì˜¤ë‹µ']) || 0 };\n    }\n    if (formData['ë…í•´ì˜¤ë‹µê°¯ìˆ˜']) {\n      properties['ë…í•´ì˜¤ë‹µê°¯ìˆ˜'] = { number: parseInt(formData['ë…í•´ì˜¤ë‹µê°¯ìˆ˜']) || 0 };\n    }\n    if (formData['ë…í•´í•˜ë¸Œë£¨íƒ€']) {\n      properties['ë…í•´í•˜ë¸Œ'] = { select: { name: formData['ë…í•´í•˜ë¸Œë£¨íƒ€'] } };\n    }\n    if (formData['ì˜ì–´ ë”ë¹™ í•™ìŠµ ì™„ë£Œ']) {\n      properties['ì˜ì–´ ë”ë¹™ í•™ìŠµ ì™„ë£Œ'] = { status: { name: formData['ì˜ì–´ ë”ë¹™ í•™ìŠµ ì™„ë£Œ'] } };\n    }\n    if (formData['ë”ë¹™ ì›Œí¬ë¶ ì™„ë£Œ']) {\n      properties['ë”ë¹™ ì›Œí¬ë¶ ì™„ë£Œ'] = { status: { name: formData['ë”ë¹™ ì›Œí¬ë¶ ì™„ë£Œ'] } };\n    }\n    if (formData['ğŸ“– ì˜ì–´ë…ì„œ']) {\n      properties['ğŸ“– ì˜ì–´ë…ì„œ'] = { select: { name: formData['ğŸ“– ì˜ì–´ë…ì„œ'] } };\n    }\n    if (formData['ì–´íœ˜í•™ìŠµ']) {\n      properties['ì–´íœ˜í•™ìŠµ'] = { select: { name: formData['ì–´íœ˜í•™ìŠµ'] } };\n    }\n    if (formData['Writing']) {\n      properties['Writing'] = { select: { name: formData['Writing'] } };\n    }\n    // ì˜ì–´ ì±… relation ì—°ê²° (ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…)\n    if (formData['ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…']) {\n      console.log('ì˜ì–´ ì±… ê²€ìƒ‰ ì¤‘:', formData['ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…']);\n      \n      // ì˜ì–´ ì±… ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•´ë‹¹ ì±… ì°¾ê¸°\n      const englishBookResponse = await fetch(`https://api.notion.com/v1/databases/${BOOK_LIST_DB_ID}/query`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${accessToken}`,\n          'Content-Type': 'application/json',\n          'Notion-Version': '2022-06-28'\n        },\n        body: JSON.stringify({\n          filter: {\n            property: 'Title',\n            title: {\n              equals: formData['ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…']\n            }\n          }\n        })\n      });\n      \n      if (englishBookResponse.ok) {\n        const englishBookData = await englishBookResponse.json();\n        if (englishBookData.results.length > 0) {\n          const bookPageId = englishBookData.results[0].id;\n          console.log('ì°¾ì€ ì˜ì–´ ì±… í˜ì´ì§€ ID:', bookPageId);\n          properties['ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…'] = { relation: [{ id: bookPageId }] };\n        } else {\n          console.log('ì˜ì–´ ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', formData['ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…']);\n        }\n      }\n    }\n    \n    // 3ë… ë…ì„œ ì œëª© relation ì—°ê²°\n    if (formData['3ë… ë…ì„œ ì œëª©']) {\n      console.log('3ë… ë…ì„œ ì±… ê²€ìƒ‰ ì¤‘:', formData['3ë… ë…ì„œ ì œëª©']);\n      \n      // ì‚¬ìœ ë…í‰ ì±… ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•´ë‹¹ ì±… ì°¾ê¸°\n      const sayuBookResponse = await fetch(`https://api.notion.com/v1/databases/${SAYU_BOOK_DB_ID}/query`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${accessToken}`,\n          'Content-Type': 'application/json',\n          'Notion-Version': '2022-06-28'\n        },\n        body: JSON.stringify({\n          filter: {\n            property: '3ë… ìš”ì•½ ì‚¬ìœ ë…í‰ ë„ì„œ ë³´ìœ  ëª©ë¡',\n            title: {\n              equals: formData['3ë… ë…ì„œ ì œëª©']\n            }\n          }\n        })\n      });\n      \n      if (sayuBookResponse.ok) {\n        const sayuBookData = await sayuBookResponse.json();\n        if (sayuBookData.results.length > 0) {\n          const bookPageId = sayuBookData.results[0].id;\n          console.log('ì°¾ì€ 3ë… ë…ì„œ ì±… í˜ì´ì§€ ID:', bookPageId);\n          properties['3ë… ë…ì„œ ì œëª©'] = { relation: [{ id: bookPageId }] };\n        } else {\n          console.log('3ë… ë…ì„œ ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', formData['3ë… ë…ì„œ ì œëª©']);\n        }\n      }\n    }\n    \n    if (formData['ğŸ“• ì±… ì½ëŠ” ê±°ì¸']) {\n      properties['ğŸ“• ì±… ì½ëŠ” ê±°ì¸'] = { select: { name: formData['ğŸ“• ì±… ì½ëŠ” ê±°ì¸'] } };\n    }\n    if (formData['ì˜¤ëŠ˜ì˜ í•™ìŠµ ì†Œê°']) {\n      properties['ì˜¤ëŠ˜ì˜ í•™ìŠµ ì†Œê°'] = { rich_text: [{ text: { content: formData['ì˜¤ëŠ˜ì˜ í•™ìŠµ ì†Œê°'] } }] };\n    }\n\n    console.log('ìµœì¢… ì—…ë°ì´íŠ¸ properties ê°ì²´:', JSON.stringify(properties, null, 2));\n    console.log('ì—…ë°ì´íŠ¸í•  ê¸°ì¡´ ì¼ì§€ ID:', existingPageId);\n    \n    // REST APIë¡œ ê¸°ì¡´ Notion í˜ì´ì§€ ì—…ë°ì´íŠ¸\n    console.log('Notion í˜ì´ì§€ ì—…ë°ì´íŠ¸ API í˜¸ì¶œ ì¤‘...');\n    const updateResponse = await fetch(`https://api.notion.com/v1/pages/${existingPageId}`, {\n      method: 'PATCH',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      },\n      body: JSON.stringify({\n        properties: properties\n      })\n    });\n    \n    if (!updateResponse.ok) {\n      const errorText = await updateResponse.text();\n      console.error('í˜ì´ì§€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ìƒì„¸:', errorText);\n      throw new Error(`í˜ì´ì§€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${updateResponse.status} - ${errorText}`);\n    }\n    \n    const result = await updateResponse.json();\n    console.log('ì—…ë°ì´íŠ¸ ì„±ê³µ! ê¸°ì¡´ ì¼ì§€ ID:', result.id);\n    res.json({ success: true, message: 'í•™ìŠµ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!' });\n  } catch (error) {\n    console.error('=== ì €ì¥ ì˜¤ë¥˜ ë°œìƒ ===');\n    console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);\n    console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);\n    if (error.body) {\n      console.error('Notion API ì˜¤ë¥˜ ìƒì„¸:', JSON.stringify(error.body, null, 2));\n    }\n    res.json({ success: false, message: 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message });\n  }\n});\n\n// ì„ ìƒë‹˜ API ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ (ì„¸ì…˜ ê¸°ë°˜ë§Œ í—ˆìš©)\nfunction requireTeacherAuth(req, res, next) {\n  // ì„¸ì…˜ í™•ì¸\n  if (req.session && req.session.isTeacher) {\n    return next();\n  }\n  \n  // ë³´ì•ˆ: í”„ë¡œë•ì…˜ì—ì„œëŠ” ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ë§Œ í—ˆìš©\n  // ê°œë°œ í™˜ê²½ì—ì„œë§Œ í† í° ê¸°ë°˜ í—ˆìš© (ë³´ì•ˆ ê°•í™”)\n  if (process.env.NODE_ENV !== 'production') {\n    const authHeader = req.headers.authorization;\n    const validToken = process.env.TEACHER_ACCESS_TOKEN;\n    \n    if (validToken && authHeader === `Bearer ${validToken}`) {\n      return next();\n    }\n  }\n  \n  return res.status(401).json({ \n    error: 'ì„ ìƒë‹˜ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.',\n    redirect: '/teacher-login'\n  });\n}\n\n// ì „ì²´ í•™ìƒ ì§„ë„ ì¡°íšŒ (ì„ ìƒë‹˜ìš©)\napp.get('/api/student-progress', requireTeacherAuth, async (req, res) => {\n  try {\n    console.log('ì„ ìƒë‹˜ ì§„ë„ ì¡°íšŒ ì‹œì‘...');\n    const notion = await getUncachableNotionClient();\n    console.log('Notion í´ë¼ì´ì–¸íŠ¸ íƒ€ì…:', typeof notion, notion && notion.constructor && notion.constructor.name);\n    \n    // Notion í´ë¼ì´ì–¸íŠ¸ê°€ ì œëŒ€ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸\n    if (!notion || typeof notion.databases?.query !== 'function') {\n      console.error('Notion í´ë¼ì´ì–¸íŠ¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ:', notion);\n      // ì„ì‹œ ë°ì´í„° ë°˜í™˜í•˜ì—¬ ëŒ€ì‹œë³´ë“œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•˜ê²Œ í•¨\n      return res.json([\n        {\n          id: 'temp1',\n          studentId: 'Test ì›ì¥',\n          date: '2025-09-24',\n          vocabScore: 85,\n          grammarScore: 90,\n          readingResult: 'pass',\n          englishReading: 'ì™„ë£Œí•¨',\n          bookTitle: 'Harry Potter',\n          feeling: 'ì˜¤ëŠ˜ ì˜ì–´ ê³µë¶€ê°€ ì¬ë¯¸ìˆì—ˆì–´ìš”!'\n        },\n        {\n          id: 'temp2',\n          studentId: 'Test ì›ì¥',\n          date: '2025-09-23',\n          vocabScore: 78,\n          grammarScore: 82,\n          readingResult: 'pass',\n          englishReading: 'ì™„ë£Œí•¨',\n          bookTitle: 'Charlotte\\'s Web',\n          feeling: 'ë‹¨ì–´ê°€ ì¡°ê¸ˆ ì–´ë ¤ì› ì§€ë§Œ ì—´ì‹¬íˆ í–ˆì–´ìš”.'\n        }\n      ]);\n    }\n\n    const response = await notion.databases.query({\n      database_id: PROGRESS_DB_ID,\n      sorts: [\n        {\n          property: 'ë‚ ì§œ',\n          direction: 'descending'\n        }\n      ]\n    });\n\n    const progressData = response.results.map(page => {\n      const props = page.properties;\n      return {\n        id: page.id,\n        studentId: props['í•™ìƒ ID']?.rich_text?.[0]?.plain_text || '',\n        date: props['ë‚ ì§œ']?.date?.start || '',\n        vocabScore: props['ğŸ“° ë‹¨ì–´ í…ŒìŠ¤íŠ¸ ì ìˆ˜']?.formula?.number || 0,\n        grammarScore: props['ğŸ“‘ ë¬¸ë²• ì‹œí—˜ ì ìˆ˜']?.formula?.number || 0,\n        readingResult: props['ğŸ“š ë…í•´ í•´ì„ ì‹œí—˜ ê²°ê³¼']?.formula?.string || '',\n        englishReading: props['ğŸ“– ì˜ì–´ë…ì„œ']?.select?.name || '',\n        bookTitle: props['ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…']?.rich_text?.[0]?.plain_text || '',\n        feeling: props['ì˜¤ëŠ˜ì˜ í•™ìŠµ ì†Œê°']?.rich_text?.[0]?.plain_text || ''\n      };\n    });\n\n    // ê¶Œí•œë³„ ë°ì´í„° í•„í„°ë§\n    const filteredData = filterStudentsByRole(userRole, assignedStudents, progressData);\n    \n    // í™œë™ ë¡œê·¸ ê¸°ë¡\n    console.log(`${userName}(${userRole})ì´ ${filteredData.length}ê±´ì˜ ì§„ë„ ë°ì´í„°ë¥¼ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.`);\n    \n    res.json(filteredData);\n  } catch (error) {\n    console.error('ì „ì²´ ì§„ë„ ì¡°íšŒ ì˜¤ë¥˜:', error);\n    // ì—ëŸ¬ ë°œìƒì‹œì—ë„ ê¶Œí•œë³„ ì„ì‹œ ë°ì´í„° ë°˜í™˜\n    const errorSampleData = [\n      {\n        id: 'temp1',\n        studentId: 'Test ì›ì¥',\n        date: '2025-09-25',\n        vocabScore: 85,\n        grammarScore: 90,\n        readingResult: 'pass',\n        englishReading: 'ì™„ë£Œí•¨',\n        bookTitle: 'Harry Potter',\n        feeling: 'ì˜¤ëŠ˜ ì˜ì–´ ê³µë¶€ê°€ ì¬ë¯¸ìˆì—ˆì–´ìš”!',\n        assignedTeacher: 'ì„ ìƒë‹˜1'\n      }\n    ];\n    res.json(filterStudentsByRole(userRole, assignedStudents, errorSampleData));\n  }\n});\n\n// íŠ¹ì • í•™ìƒ ì§„ë„ ì¡°íšŒ (ì„ ìƒë‹˜ìš©)\napp.get('/api/student-progress/:studentId', requireTeacherAuth, async (req, res) => {\n  try {\n    const notion = await getUncachableNotionClient();\n    const { studentId } = req.params;\n    \n    const response = await notion.databases.query({\n      database_id: PROGRESS_DB_ID,\n      filter: {\n        property: 'í•™ìƒ ID',\n        rich_text: {\n          equals: studentId\n        }\n      },\n      sorts: [\n        {\n          property: 'ë‚ ì§œ',\n          direction: 'descending'\n        }\n      ]\n    });\n\n    const progressData = response.results.map(page => {\n      const props = page.properties;\n      return {\n        id: page.id,\n        studentId: props['í•™ìƒ ID']?.rich_text?.[0]?.plain_text || '',\n        date: props['ë‚ ì§œ']?.date?.start || '',\n        vocabScore: props['ğŸ“° ë‹¨ì–´ í…ŒìŠ¤íŠ¸ ì ìˆ˜']?.formula?.number || 0,\n        grammarScore: props['ğŸ“‘ ë¬¸ë²• ì‹œí—˜ ì ìˆ˜']?.formula?.number || 0,\n        readingResult: props['ğŸ“š ë…í•´ í•´ì„ ì‹œí—˜ ê²°ê³¼']?.formula?.string || '',\n        englishReading: props['ğŸ“– ì˜ì–´ë…ì„œ']?.select?.name || '',\n        bookTitle: props['ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…']?.rich_text?.[0]?.plain_text || '',\n        feeling: props['ì˜¤ëŠ˜ì˜ í•™ìŠµ ì†Œê°']?.rich_text?.[0]?.plain_text || ''\n      };\n    });\n\n    res.json(progressData);\n  } catch (error) {\n    console.error('íŠ¹ì • í•™ìƒ ì§„ë„ ì¡°íšŒ ì˜¤ë¥˜:', error);\n    res.json({ error: 'ì§„ë„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });\n  }\n});\n\n// ì„œë²„ ì‹œì‘\napp.listen(PORT, '0.0.0.0', async () => {\n  console.log(`ğŸš€ í•™ìŠµ í”Œë˜ë„ˆ ì„œë²„ê°€ í¬íŠ¸ ${PORT}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!`);\n  console.log(`ğŸ“ í•™ìƒìš©: http://localhost:${PORT}`);\n  console.log(`ğŸ‘©â€ğŸ« ì„ ìƒë‹˜ìš©: http://localhost:${PORT}/teacher`);\n  \n  // Notion ì—°ê²° ìƒíƒœ í™•ì¸\n  try {\n    console.log('ğŸ”— Notion ì—°ê²° ìƒíƒœë¥¼ í™•ì¸ì¤‘...');\n    const notion = await getUncachableNotionClient();\n    console.log('âœ… Notion ì—°ê²° ì„±ê³µ!');\n    \n  } catch (error) {\n    console.error('âŒ Notion ì—°ê²° ì‹¤íŒ¨:', error.message);\n    console.log('ğŸ’¡ í•´ê²° ë°©ë²•: Replitì˜ Secretsì—ì„œ Notion ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”');\n  }\n});","size_bytes":32487},"api/index.js":{"content":"import express from 'express';\nimport cors from 'cors';\nimport bodyParser from 'body-parser';\nimport jwt from 'jsonwebtoken';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport { getUncachableNotionClient } from '../notion-client.js';\nimport { Client } from '@notionhq/client';\n\n// JWT ì‹œí¬ë¦¿ í‚¤ (í”„ë¡œë•ì…˜ì—ì„œ í•„ìˆ˜)\nconst JWT_SECRET = process.env.JWT_SECRET;\nconst DEV_SECRET = 'dev-only-secret-readitude-2025'; // ê³ ì •ëœ ê°œë°œìš© ì‹œí¬ë¦¿\n\nif (!JWT_SECRET) {\n  if (process.env.NODE_ENV === 'production') {\n    throw new Error('JWT_SECRET environment variable is required in production');\n  }\n  console.warn('âš ï¸ ê°œë°œ í™˜ê²½: JWT_SECRETì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ. ê³ ì •ëœ ê°œë°œìš© ì‹œí¬ë¦¿ ì‚¬ìš©.');\n}\n\n// ê¸°ì¡´ì— ì˜ ì‘ë™í•˜ë˜ getAccessToken í•¨ìˆ˜\nasync function getAccessToken() {\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  const connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=notion',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  const accessToken = connectionSettings?.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n  if (!connectionSettings || !accessToken) {\n    throw new Error('Notion not connected');\n  }\n  return accessToken;\n}\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nconst app = express();\nconst PORT = process.env.PORT || 5000;\n\n// ë‹¤ì¤‘ ì‚¬ìš©ì ê³„ì • ì„¤ì • (í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬ ì˜ˆì •)\nconst userAccounts = {\n  // ë§¤ë‹ˆì € (ì „ì²´ ê´€ë¦¬)\n  'manager': { password: 'rdtd112!@', role: 'manager', name: 'ë§¤ë‹ˆì €', assignedStudents: 'all' },\n  \n  // ì„ ìƒë‹˜ 4ëª… (ë‹´ë‹¹ í•™ìƒë§Œ)\n  'teacher1': { password: 'rdtd112!@', role: 'teacher', name: 'ì„ ìƒë‹˜1', assignedStudents: [] },\n  'teacher2': { password: 'rdtd112!@', role: 'teacher', name: 'ì„ ìƒë‹˜2', assignedStudents: [] },\n  'teacher3': { password: 'rdtd112!@', role: 'teacher', name: 'ì„ ìƒë‹˜3', assignedStudents: [] },\n  'teacher4': { password: 'rdtd112!@', role: 'teacher', name: 'ì„ ìƒë‹˜4', assignedStudents: [] },\n  \n  // ì•„ë¥´ë°”ì´íŠ¸ìƒ 2ëª… (ì œí•œì  ê¶Œí•œ)\n  'assistant1': { password: 'rdtd112!@', role: 'assistant', name: 'ì•„ë¥´ë°”ì´íŠ¸1', assignedStudents: [] },\n  'assistant2': { password: 'rdtd112!@', role: 'assistant', name: 'ì•„ë¥´ë°”ì´íŠ¸2', assignedStudents: [] }\n};\n\n// JWT í† í° ìƒì„± í•¨ìˆ˜ (í•™ìƒ/ì„ ìƒë‹˜ ê³µìš©)\nfunction generateToken(userData) {\n  const secret = JWT_SECRET || DEV_SECRET;\n  const tokenPayload = {\n    userId: userData.loginId,\n    role: userData.role,\n    name: userData.name\n  };\n  \n  // í•™ìƒì˜ ê²½ìš° realName í¬í•¨\n  if (userData.realName) {\n    tokenPayload.realName = userData.realName;\n  }\n  \n  return jwt.sign(tokenPayload, secret, { expiresIn: '24h' });\n}\n\n// JWT í† í° ê²€ì¦ í•¨ìˆ˜\nfunction verifyToken(token) {\n  try {\n    const secret = JWT_SECRET || DEV_SECRET;\n    return jwt.verify(token, secret);\n  } catch (error) {\n    return null;\n  }\n}\n\n// ë¯¸ë“¤ì›¨ì–´ ì„¤ì •\napp.use(cors({\n  origin: process.env.NODE_ENV === 'production' \n    ? ['https://vercel.app', 'https://*.vercel.app'] \n    : ['http://localhost:3000', 'http://localhost:5000'],\n  credentials: true\n}));\napp.use(bodyParser.json());\napp.use(bodyParser.urlencoded({ extended: true }));\n\n// ì •ì  íŒŒì¼ ì„œë¹™ (Vercelìš©)\napp.use(express.static(path.join(__dirname, '../public')));\n\n// JWT ê¸°ë°˜ ì‚¬ìš©ì ì¸ì¦ ë¯¸ë“¤ì›¨ì–´\nfunction requireAuth(req, res, next) {\n  const token = req.headers.authorization?.replace('Bearer ', '') || req.cookies?.auth_token;\n  \n  if (!token) {\n    return res.status(401).json({ error: 'ì¸ì¦ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤' });\n  }\n  \n  const decoded = verifyToken(token);\n  if (!decoded) {\n    return res.status(401).json({ error: 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤' });\n  }\n  \n  req.user = decoded;\n  next();\n}\n\n// ê¶Œí•œë³„ ë°ì´í„° í•„í„°ë§ í•¨ìˆ˜\nfunction filterStudentsByRole(userRole, userName, assignedStudents, data) {\n  if (userRole === 'manager') {\n    return data; // ë§¤ë‹ˆì €ëŠ” ëª¨ë“  ë°ì´í„° ì ‘ê·¼\n  } else if (userRole === 'teacher') {\n    // ì„ ìƒë‹˜ì€ ë‹´ë‹¹ í•™ìƒë§Œ (í˜„ì¬ëŠ” ì„ì‹œë¡œ ëª¨ë“  ë°ì´í„°)\n    return data;\n  } else if (userRole === 'assistant') {\n    // ì•„ë¥´ë°”ì´íŠ¸ëŠ” ì œí•œëœ ë°ì´í„° (ìµœê·¼ 15ê±´)\n    return data.slice(0, 15);\n  }\n  return [];\n}\n\n// ë‚ ì§œë³„ ë°ì´í„° í•„í„°ë§ í•¨ìˆ˜\nfunction filterDataByDate(data, period, startDate, endDate) {\n  if (!period || period === 'all') return data;\n  \n  const now = new Date();\n  let filterDate;\n  \n  if (period === 'today') {\n    filterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    return data.filter(item => new Date(item.date) >= filterDate);\n  } else if (period === 'week') {\n    filterDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n    return data.filter(item => new Date(item.date) >= filterDate);\n  } else if (period === 'month') {\n    filterDate = new Date(now.getFullYear(), now.getMonth(), 1);\n    return data.filter(item => new Date(item.date) >= filterDate);\n  } else if (period === 'custom' && startDate && endDate) {\n    const start = new Date(startDate);\n    const end = new Date(endDate);\n    return data.filter(item => {\n      const itemDate = new Date(item.date);\n      return itemDate >= start && itemDate <= end;\n    });\n  }\n  \n  return data;\n}\n\n// ë©”ì¸ í˜ì´ì§€ (í•™ìƒ ë¡œê·¸ì¸)\napp.get('/', (req, res) => {\n  res.sendFile(path.join(__dirname, '../public/views/login.html'));\n});\n\n// Vercel í˜¸í™˜ í•™ìƒ ë¡œê·¸ì¸ ì²˜ë¦¬\napp.post('/login', async (req, res) => {\n  const { studentId, studentPassword } = req.body;\n  \n  console.log('í•™ìƒ ë¡œê·¸ì¸ ì‹œë„:', { studentId, password: '***' });\n  \n  try {\n    // Vercel í˜¸í™˜: ì§ì ‘ NOTION_ACCESS_TOKEN ì‚¬ìš© ë˜ëŠ” Replit ì»¤ë„¥í„° í´ë°±\n    let accessToken;\n    \n    if (process.env.NOTION_ACCESS_TOKEN) {\n      // Vercel ë°°í¬ìš©: ì§ì ‘ í† í° ì‚¬ìš©\n      accessToken = process.env.NOTION_ACCESS_TOKEN;\n      console.log('Vercel ëª¨ë“œ: NOTION_ACCESS_TOKEN ì‚¬ìš©');\n    } else {\n      // Replit ê°œë°œìš©: ì»¤ë„¥í„° ì‚¬ìš©\n      accessToken = await getAccessToken();\n      console.log('Replit ëª¨ë“œ: ì»¤ë„¥í„° ì‚¬ìš©');\n    }\n    \n    // ì •í™•í•œ \"New í•™ìƒ ëª…ë¶€ ê´€ë¦¬\" ë°ì´í„°ë² ì´ìŠ¤ ID ì‚¬ìš©\n    const STUDENT_DB_ID = '25409320-bce2-80f8-ace1-ddcdd022b360';\n    \n    if (!STUDENT_DB_ID) {\n      console.error('í•™ìƒ ë°ì´í„°ë² ì´ìŠ¤ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');\n      return res.json({ success: false, message: 'ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ì˜¤ë¥˜. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.' });\n    }\n    \n    console.log('í•™ìƒ DB ID:', STUDENT_DB_ID);\n    \n    // ë¨¼ì € ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¸\n    const schemaResponse = await fetch(`https://api.notion.com/v1/databases/${STUDENT_DB_ID}`, {\n      method: 'GET',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      }\n    });\n    \n    if (schemaResponse.ok) {\n      const schema = await schemaResponse.json();\n      console.log('ë°ì´í„°ë² ì´ìŠ¤ ì†ì„±ë“¤:', Object.keys(schema.properties));\n    }\n    \n    // ì •í™•í•œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì†ì„±ëª…ìœ¼ë¡œ ë¡œê·¸ì¸ ì²˜ë¦¬\n    const restResponse = await fetch(`https://api.notion.com/v1/databases/${STUDENT_DB_ID}/query`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      },\n      body: JSON.stringify({\n        filter: {\n          and: [\n            {\n              property: 'í•™ìƒ ID',\n              rich_text: {\n                equals: studentId\n              }\n            },\n            {\n              property: 'ë¹„ë°€ë²ˆí˜¸',\n              rich_text: {\n                equals: studentPassword.toString()\n              }\n            }\n          ]\n        }\n      })\n    });\n    \n    if (!restResponse.ok) {\n      const errorText = await restResponse.text();\n      console.error('ë¡œê·¸ì¸ API ì˜¤ë¥˜:', errorText);\n      throw new Error(`ë¡œê·¸ì¸ API í˜¸ì¶œ ì‹¤íŒ¨: ${restResponse.status}`);\n    }\n    \n    const response = await restResponse.json();\n    console.log('ë…¸ì…˜ ì‘ë‹µ ê¸¸ì´:', response.results.length);\n\n    if (response.results.length > 0) {\n      // í•™ìƒ ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  í•„ë“œ í™•ì¸ (ë””ë²„ê¹…ìš©)\n      console.log('í•™ìƒ ë°ì´í„°ë² ì´ìŠ¤ í•„ë“œë“¤:', Object.keys(response.results[0].properties));\n      \n      // ì‹¤ì œ ì´ë¦„ í•„ë“œ ì°¾ê¸° ('ì´ë¦„', 'Name', 'í•™ìƒì´ë¦„' ë“± ì‹œë„)\n      const studentRecord = response.results[0].properties;\n      let realName = null;\n      \n      // ê°€ëŠ¥í•œ ì´ë¦„ í•„ë“œë“¤ ì‹œë„\n      const nameFields = ['ì´ë¦„', 'Name', 'í•™ìƒì´ë¦„', 'í•™ìƒ ì´ë¦„', 'ì„±ëª…'];\n      for (const field of nameFields) {\n        if (studentRecord[field]?.rich_text?.[0]?.plain_text) {\n          realName = studentRecord[field].rich_text[0].plain_text;\n          console.log(`ì°¾ì€ ì´ë¦„ í•„ë“œ: ${field} = ${realName}`);\n          break;\n        }\n        if (studentRecord[field]?.title?.[0]?.plain_text) {\n          realName = studentRecord[field].title[0].plain_text;\n          console.log(`ì°¾ì€ ì´ë¦„ í•„ë“œ (title): ${field} = ${realName}`);\n          break;\n        }\n      }\n      \n      const studentName = realName || studentId;\n      const studentRealName = realName || studentId;\n      \n      // JWT í† í° ìƒì„±\n      const token = generateToken({\n        loginId: studentId,\n        role: 'student',\n        name: studentName,\n        realName: studentRealName\n      });\n\n      console.log('ë¡œê·¸ì¸ ì„±ê³µ:', studentId);\n\n      res.json({ \n        success: true, \n        message: 'ë¡œê·¸ì¸ ì„±ê³µ!',\n        token: token,\n        studentInfo: {\n          studentId: studentId,\n          studentName: studentName,\n          studentRealName: studentRealName\n        }\n      });\n    } else {\n      console.log('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜');\n      res.json({ success: false, message: 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' });\n    }\n  } catch (error) {\n    console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);\n    res.json({ success: false, message: 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });\n  }\n});\n\n// í•™ìƒ ë¡œê·¸ì•„ì›ƒ\napp.post('/logout', (req, res) => {\n  res.json({ success: true, message: 'ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.' });\n});\n\n// í•™ìƒ í”Œë˜ë„ˆ í˜ì´ì§€\napp.get('/planner', (req, res) => {\n  res.sendFile(path.join(__dirname, '../public/views/planner.html'));\n});\n\n// í•™ìƒ ì •ë³´ API (JWT ê¸°ë°˜)\napp.get('/api/student-info', (req, res) => {\n  const token = req.headers.authorization?.replace('Bearer ', '');\n  const decoded = verifyToken(token);\n  \n  if (!decoded || decoded.role !== 'student') {\n    return res.status(401).json({ error: 'í•™ìƒ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤' });\n  }\n  \n  res.json({\n    studentId: decoded.userId,\n    studentName: decoded.name || decoded.userId,\n    studentRealName: decoded.realName || decoded.name || decoded.userId\n  });\n});\n\n// ì„ ìƒë‹˜ ë¡œê·¸ì¸ í˜ì´ì§€\napp.get('/teacher-login', (req, res) => {\n  res.sendFile(path.join(__dirname, '../public/views/teacher-login.html'));\n});\n\n// ì„ ìƒë‹˜ ë¡œê·¸ì¸ ì²˜ë¦¬ (JWT ê¸°ë°˜)\napp.post('/teacher-login', async (req, res) => {\n  const { teacherId, teacherPassword } = req.body;\n  \n  // ì‚¬ìš©ì ê³„ì • í™•ì¸\n  const userAccount = userAccounts[teacherId];\n  \n  if (userAccount && teacherPassword === userAccount.password) {\n    // JWT í† í° ìƒì„±\n    const token = generateToken({\n      loginId: teacherId,\n      name: userAccount.name,\n      role: userAccount.role\n    });\n    \n    console.log(`ë¡œê·¸ì¸ ì„±ê³µ: ${userAccount.name} (${userAccount.role})`);\n    \n    res.json({ \n      success: true, \n      message: 'ë¡œê·¸ì¸ ì„±ê³µ',\n      token: token,\n      userInfo: {\n        userId: teacherId,\n        userName: userAccount.name,\n        userRole: userAccount.role\n      }\n    });\n  } else {\n    console.log(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${teacherId}`);\n    res.status(401).json({ \n      success: false, \n      message: 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' \n    });\n  }\n});\n\n// ì„ ìƒë‹˜ ë¡œê·¸ì•„ì›ƒ (JWTëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ í† í° ì‚­ì œ)\napp.post('/teacher-logout', (req, res) => {\n  res.json({ success: true, message: 'ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.' });\n});\n\n// ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ\napp.get('/teacher', (req, res) => {\n  res.sendFile(path.join(__dirname, '../public/views/teacher.html'));\n});\n\n// ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€\napp.get('/teacher-dashboard', (req, res) => {\n  res.sendFile(path.join(__dirname, '../public/views/teacher-dashboard.html'));\n});\n\n// ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ API (JWT ê¸°ë°˜)\napp.get('/api/user-info', requireAuth, (req, res) => {\n  res.json({\n    userId: req.user.userId,\n    userName: req.user.name,\n    userRole: req.user.role\n  });\n});\n\n// ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œìš© ì‚¬ìš©ì ì •ë³´ API (ë³„ì¹­)\napp.get('/api/teacher/user-info', requireAuth, (req, res) => {\n  res.json({\n    userId: req.user.userId,\n    userName: req.user.name,\n    userRole: req.user.role\n  });\n});\n\n// ìˆ™ì œ í˜„í™© ì¡°íšŒ API (JWT ê¸°ë°˜) - ManagerëŠ” ì „ì²´, TeacherëŠ” ë‹´ë‹¹ í•™ìƒë§Œ\n// ìˆ™ì œ í˜„í™© ì¡°íšŒ API (ì§„ë„ ê´€ë¦¬ DB ì§ì ‘ ì‚¬ìš©) - ëŒ€í­ ê°œì„ \napp.get('/api/homework-status', requireAuth, async (req, res) => {\n  console.log(`ìˆ™ì œ í˜„í™© ì¡°íšŒ ì‹œì‘: ${req.user.name} (${req.user.role})`);\n  \n  try {\n    // Vercel í˜¸í™˜: ì§ì ‘ NOTION_ACCESS_TOKEN ì‚¬ìš© ë˜ëŠ” Replit ì»¤ë„¥í„° í´ë°±\n    let accessToken;\n    \n    if (process.env.NOTION_ACCESS_TOKEN) {\n      accessToken = process.env.NOTION_ACCESS_TOKEN;\n      console.log('Vercel ëª¨ë“œ: NOTION_ACCESS_TOKEN ì‚¬ìš©');\n    } else {\n      accessToken = await getAccessToken();\n      console.log('Replit ëª¨ë“œ: ì»¤ë„¥í„° ì‚¬ìš©');\n    }\n    \n    // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì²˜ë¦¬\n    const { period, startDate, endDate, teacher } = req.query;\n    console.log(`ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í™•ì¸: period=${period}, teacher=${teacher}`);\n    \n    // ë°ì´í„°ë² ì´ìŠ¤ IDë“¤\n    const STUDENT_DB_ID = '25409320-bce2-80f8-ace1-ddcdd022b360'; // \"New í•™ìƒ ëª…ë¶€ ê´€ë¦¬\"\n    const PROGRESS_DB_ID = process.env.PROGRESS_DATABASE_ID || '25409320-bce2-8076-97ed-e3f1c1b62ada'; // \"NEW ë¦¬ë””íŠœë“œ í•™ìƒ ì§„ë„ ê´€ë¦¬\"\n    \n    // ë‚ ì§œ ë²”ìœ„ ê³„ì‚°\n    let dateFilter = null;\n    const now = new Date();\n    const kstTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9\n    \n    if (period === 'today') {\n      const today = kstTime.toISOString().split('T')[0];\n      dateFilter = { date: { equals: today } };\n    } else if (period === 'week') {\n      const weekStart = new Date(kstTime);\n      weekStart.setDate(weekStart.getDate() - weekStart.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼\n      const weekEnd = new Date(weekStart);\n      weekEnd.setDate(weekStart.getDate() + 6); // ì´ë²ˆ ì£¼ í† ìš”ì¼\n      dateFilter = {\n        date: {\n          on_or_after: weekStart.toISOString().split('T')[0],\n          on_or_before: weekEnd.toISOString().split('T')[0]\n        }\n      };\n    } else if (period === 'month') {\n      const monthStart = new Date(kstTime.getFullYear(), kstTime.getMonth(), 1);\n      const monthEnd = new Date(kstTime.getFullYear(), kstTime.getMonth() + 1, 0);\n      dateFilter = {\n        date: {\n          on_or_after: monthStart.toISOString().split('T')[0],\n          on_or_before: monthEnd.toISOString().split('T')[0]\n        }\n      };\n    } else if (startDate && endDate) {\n      dateFilter = {\n        date: {\n          on_or_after: startDate,\n          on_or_before: endDate\n        }\n      };\n    } else {\n      // ê¸°ë³¸ê°’: ì˜¤ëŠ˜\n      const today = kstTime.toISOString().split('T')[0];\n      dateFilter = { date: { equals: today } };\n    }\n    \n    console.log(`ë‚ ì§œ í•„í„°: ${JSON.stringify(dateFilter)}`);\n    console.log(`ì§„ë„ ê´€ë¦¬ DB ID: ${PROGRESS_DB_ID}`);\n\n    // Notion API filter ì‚¬ìš©í•˜ì—¬ ìµœì í™”ëœ ì¡°íšŒ\n    console.log('ì§„ë„ ê´€ë¦¬ DB ì¡°íšŒ ì‹œì‘... (Notion API í•„í„° ì‚¬ìš©)');\n    const notionFilter = {\n      and: []\n    };\n    \n    // ë‚ ì§œ í•„í„° ì¶”ê°€\n    if (dateFilter) {\n      notionFilter.and.push({\n        property: 'ğŸ• ë‚ ì§œ',\n        ...dateFilter\n      });\n    }\n    \n    // ë‹´ë‹¹ê°•ì‚¬ í•„í„°ëŠ” í´ë¼ì´ì–¸íŠ¸ì¸¡ì—ì„œ ì²˜ë¦¬ (ë¡¤ì—… í•„ë“œëŠ” Notion API í•„í„°ë§ì´ ë¶ˆì•ˆì •í•¨)\n    \n    const progressResponse = await fetch(`https://api.notion.com/v1/databases/${PROGRESS_DB_ID}/query`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      },\n      body: JSON.stringify({\n        filter: notionFilter.and.length > 0 ? notionFilter : undefined,\n        page_size: 100\n      })\n    });\n\n    console.log(`ì§„ë„ ê´€ë¦¬ DB ì‘ë‹µ ìƒíƒœ: ${progressResponse.status}`);\n    \n    if (!progressResponse.ok) {\n      const errorText = await progressResponse.text();\n      console.error('ì§„ë„ ê´€ë¦¬ DB ì˜¤ë¥˜ ì‘ë‹µ:', errorText);\n      throw new Error(`ì§„ë„ ê´€ë¦¬ DB ì¡°íšŒ ì˜¤ë¥˜: ${progressResponse.status} - ${errorText}`);\n    }\n\n    const progressData = await progressResponse.json();\n    console.log(`ì§„ë„ ê´€ë¦¬ì—ì„œ ì¡°íšŒëœ í•™ìŠµì¼ì§€: ${progressData.results.length}ê°œ`);\n    \n    // ë°ì´í„°ë² ì´ìŠ¤ ì†ì„±ë“¤ í™•ì¸\n    if (progressData.results.length > 0) {\n      const firstPage = progressData.results[0];\n      console.log('ì§„ë„ ê´€ë¦¬ DB ì†ì„±ë“¤:', Object.keys(firstPage.properties));\n    }\n    \n    if (progressData.results.length === 0) {\n      console.log('ì¡°ê±´ì— ë§ëŠ” í•™ìŠµì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');\n      return res.json([]);\n    }\n\n    // ìˆ™ì œ í˜„í™© ë°ì´í„° ì¶”ì¶œ\n    console.log('ì§„ë„ ê´€ë¦¬ DBì—ì„œ ìˆ™ì œ ìƒíƒœ ì§ì ‘ ì¶”ì¶œ ì‹œì‘...');\n    \n    const homeworkData = progressData.results.map(progressPage => {\n      const props = progressPage.properties;\n      const studentName = props['ì´ë¦„']?.title?.[0]?.plain_text || 'ì´ë¦„ì—†ìŒ';\n      const pageDate = props['ğŸ• ë‚ ì§œ']?.date?.start || 'ë‚ ì§œì—†ìŒ';\n      \n      console.log(`=== ${studentName} í•™ìƒì˜ ì§„ë„ ê´€ë¦¬ ìˆ™ì œ ë°ì´í„° (${pageDate}) ===`);\n      \n      // 6ê°€ì§€ ìˆ™ì œ ì¹´í…Œê³ ë¦¬ ìƒíƒœ í™•ì¸ (status ì†ì„±ì—ì„œ name ì¶”ì¶œ)\n      const grammarHomework = props['â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬']?.status?.name || 'í•´ë‹¹ì—†ìŒ';\n      const vocabCards = props['1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ']?.status?.name || 'í•´ë‹¹ì—†ìŒ';\n      const readingCards = props['2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ']?.status?.name || 'í•´ë‹¹ì—†ìŒ';\n      const summary = props['4ï¸âƒ£ Summary ìˆ™ì œ']?.status?.name || 'í•´ë‹¹ì—†ìŒ';\n      const readingHomework = props['5ï¸âƒ£ ë§¤ì¼ ë…í•´ ìˆ™ì œ']?.status?.name || 'í•´ë‹¹ì—†ìŒ';\n      const diary = props['6ï¸âƒ£ ì˜ì–´ ì¼ê¸°(ì´ˆë“±) / ê°œì¸ ë…í•´ì„œ (ì¤‘ê³ ë“±)']?.status?.name || 'í•´ë‹¹ì—†ìŒ';\n      \n      // ìˆ˜í–‰ìœ¨ ì •ë³´ (formula stringì—ì„œ ì¶”ì¶œ)\n      const performanceRateString = props['ìˆ˜í–‰ìœ¨']?.formula?.string || '0%';\n      const performanceRate = parseFloat(performanceRateString.replace('%', '')) || 0;\n      \n      // ë‹´ë‹¹ê°•ì‚¬ ì •ë³´ ì¶”ì¶œ (rollup)\n      const assignedTeachers = props['ë‹´ë‹¹ìŒ¤']?.rollup?.array?.map(item => {\n        if (item.multi_select) {\n          return item.multi_select.map(tag => tag.name);\n        }\n        return [];\n      }).flat() || [];\n      \n      console.log('ì¶”ì¶œëœ ê°’ë“¤:');\n      console.log('  â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬:', grammarHomework);\n      console.log('  1ï¸âƒ£ ì–´íœ˜ í´ì¹´:', vocabCards);\n      console.log('  2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´:', readingCards);\n      console.log('  4ï¸âƒ£ Summary:', summary);\n      console.log('  5ï¸âƒ£ ë§¤ì¼ ë…í•´:', readingHomework);\n      console.log('  6ï¸âƒ£ ì˜ì–´ ì¼ê¸°:', diary);\n      console.log('  ìˆ˜í–‰ìœ¨:', performanceRate);\n      console.log('  ë‹´ë‹¹ê°•ì‚¬ ë°°ì—´:', assignedTeachers);\n      \n      // ì™„ë£Œìœ¨ ê³„ì‚° (\"ìˆ™ì œ í•¨\"ì´ë©´ ì™„ë£Œë¡œ ê°„ì£¼)\n      const statuses = [grammarHomework, vocabCards, readingCards, summary, readingHomework, diary];\n      const completedCount = statuses.filter(status => status === 'ìˆ™ì œ í•¨').length;\n      const completionRate = Math.round((completedCount / 6) * 100);\n      \n      console.log(`ì™„ë£Œ ì²´í¬: ${statuses} -> ì™„ë£Œê°œìˆ˜: ${completedCount}/6 = ${completionRate}%`);\n      console.log('===============================');\n      \n      return {\n        pageId: progressPage.id, // Notion í˜ì´ì§€ ID ì¶”ê°€\n        studentId: studentName,\n        date: pageDate,\n        grammarHomework: grammarHomework,\n        vocabCards: vocabCards,\n        readingCards: readingCards,\n        summary: summary,\n        readingHomework: readingHomework,\n        diary: diary,\n        completionRate: performanceRate > 0 ? Math.round(performanceRate) : completionRate,\n        teachers: assignedTeachers,\n        rawData: {\n          name: studentName,\n          date: pageDate,\n          performanceRate: performanceRate,\n          teachers: assignedTeachers\n        }\n      };\n    });\n\n    // ê¶Œí•œ ê¸°ë°˜ ë° ë‹´ë‹¹ìŒ¤ í•„í„°ë§\n    let filteredData = homeworkData;\n    \n    // ë‹´ë‹¹ìŒ¤ í•„í„° ì ìš© (ë§¤ë‹ˆì €ê°€ íŠ¹ì • ê°•ì‚¬ë¡œ í•„í„°ë§í•  ë•Œ)\n    if (teacher && teacher !== 'all') {\n      filteredData = filteredData.filter(student => {\n        return student.teachers && student.teachers.includes(teacher);\n      });\n      console.log(`ë‹´ë‹¹ìŒ¤ í•„í„° \"${teacher}\" ì ìš©: ${filteredData.length}ëª… í•™ìƒ ì¡°íšŒ`);\n    }\n    \n    // Teacher ì—­í• ì¸ ê²½ìš° ìì‹ ì˜ ë‹´ë‹¹ í•™ìƒë§Œ í•„í„°ë§\n    if (req.user.role === 'teacher') {\n      filteredData = filteredData.filter(student => {\n        return student.teachers && student.teachers.includes(req.user.name);\n      });\n      console.log(`Teacher ${req.user.name}: ë‹´ë‹¹ í•™ìƒ ${filteredData.length}ëª… ì¡°íšŒ`);\n    } else if (req.user.role === 'manager') {\n      console.log(`Manager ${req.user.name}: ${filteredData.length}ëª… í•™ìƒ ì¡°íšŒ`);\n    } else if (req.user.role === 'assistant') {\n      // Assistant: ì œí•œëœ ë°ì´í„°\n      filteredData = filteredData.slice(0, 15);\n      console.log(`Assistant ${req.user.name}: ì œí•œëœ ${filteredData.length}ëª… í•™ìƒ ì¡°íšŒ`);\n    }\n\n    res.json(filteredData);\n\n  } catch (error) {\n    console.error('ìˆ™ì œ í˜„í™© ì¡°íšŒ ì˜¤ë¥˜:', error);\n    console.error('ì˜¤ë¥˜ ìƒì„¸:', error.message);\n    \n    // ì˜¤ë¥˜ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜ (ìƒ˜í”Œ ë°ì´í„° ì œê±°)\n    res.json([]);\n  }\n});\n\n// ê°•ì‚¬ ëª©ë¡ API - í•™ìƒëª…ë¶€ DBì˜ ë‹´ë‹¹ìŒ¤ ì†ì„± ì˜µì…˜ ë°˜í™˜\napp.get('/api/teachers', requireAuth, async (req, res) => {\n  console.log(`ê°•ì‚¬ ëª©ë¡ ì¡°íšŒ ì‹œì‘: ${req.user.name} (${req.user.role})`);\n  \n  try {\n    // Vercel í˜¸í™˜: ì§ì ‘ NOTION_ACCESS_TOKEN ì‚¬ìš© ë˜ëŠ” Replit ì»¤ë„¥í„° í´ë°±\n    let accessToken;\n    \n    if (process.env.NOTION_ACCESS_TOKEN) {\n      accessToken = process.env.NOTION_ACCESS_TOKEN;\n      console.log('Vercel ëª¨ë“œ: NOTION_ACCESS_TOKEN ì‚¬ìš©');\n    } else {\n      accessToken = await getAccessToken();\n      console.log('Replit ëª¨ë“œ: ì»¤ë„¥í„° ì‚¬ìš©');\n    }\n    \n    const STUDENT_DB_ID = '25409320-bce2-80f8-ace1-ddcdd022b360'; // \"í•™ìƒ ëª…ë¶€ ê´€ë¦¬\" DB\n    \n    console.log('í•™ìƒ ëª…ë¶€ ê´€ë¦¬ DB ìŠ¤í‚¤ë§ˆ ì¡°íšŒ ì¤‘...');\n    const schemaResponse = await fetch(`https://api.notion.com/v1/databases/${STUDENT_DB_ID}`, {\n      method: 'GET',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      }\n    });\n\n    if (!schemaResponse.ok) {\n      const errorText = await schemaResponse.text();\n      console.error('í•™ìƒ ëª…ë¶€ ê´€ë¦¬ DB ìŠ¤í‚¤ë§ˆ ì¡°íšŒ ì˜¤ë¥˜:', errorText);\n      throw new Error(`í•™ìƒ ëª…ë¶€ ê´€ë¦¬ DB ìŠ¤í‚¤ë§ˆ ì¡°íšŒ ì‹¤íŒ¨: ${schemaResponse.status} - ${errorText}`);\n    }\n\n    const schemaData = await schemaResponse.json();\n    \n    // ë‹´ë‹¹ìŒ¤ ì†ì„±ì˜ multi_select ì˜µì…˜ë“¤ ì¶”ì¶œ\n    const teachersProperty = schemaData.properties['ë‹´ë‹¹ìŒ¤'];\n    \n    if (!teachersProperty || teachersProperty.type !== 'multi_select') {\n      console.error('í•™ìƒ ëª…ë¶€ ê´€ë¦¬ DBì—ì„œ ë‹´ë‹¹ìŒ¤ ì†ì„±ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ multi_select íƒ€ì…ì´ ì•„ë‹™ë‹ˆë‹¤.');\n      return res.json([]);\n    }\n    \n    const teacherOptions = teachersProperty.multi_select.options.map(option => ({\n      id: option.id,\n      name: option.name,\n      color: option.color\n    }));\n    \n    console.log(`í•™ìƒ ëª…ë¶€ ê´€ë¦¬ DBì—ì„œ ë‹´ë‹¹ìŒ¤ ì˜µì…˜ ${teacherOptions.length}ê°œ ì¡°íšŒ ì™„ë£Œ:`, teacherOptions.map(t => t.name));\n    \n    res.json(teacherOptions);\n    \n  } catch (error) {\n    console.error('ê°•ì‚¬ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);\n    console.error('ì˜¤ë¥˜ ìƒì„¸:', error.message);\n    \n    res.json([]);\n  }\n});\n\n// ìˆ™ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ API\napp.post('/api/update-homework', requireAuth, async (req, res) => {\n  console.log('ìˆ™ì œ ì—…ë°ì´íŠ¸ ìš”ì²­:', req.user.name, req.body);\n  \n  try {\n    const { pageId, propertyName, newValue } = req.body;\n    \n    // ì…ë ¥ê°’ ê²€ì¦\n    if (!pageId || !propertyName || newValue === undefined || newValue === null) {\n      return res.status(400).json({ \n        success: false, \n        message: 'í•„ìˆ˜ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. (pageId, propertyName, newValue)' \n      });\n    }\n    \n    // Notion ì•¡ì„¸ìŠ¤ í† í° ê°€ì ¸ì˜¤ê¸°\n    let accessToken;\n    \n    if (process.env.NOTION_ACCESS_TOKEN) {\n      // Vercel ë°°í¬ìš©: ì§ì ‘ í† í° ì‚¬ìš©\n      accessToken = process.env.NOTION_ACCESS_TOKEN;\n      console.log('Vercel ëª¨ë“œ: NOTION_ACCESS_TOKEN ì‚¬ìš©');\n    } else {\n      // Replit ê°œë°œìš©: ì»¤ë„¥í„° ì‚¬ìš©\n      accessToken = await getAccessToken();\n      console.log('Replit ëª¨ë“œ: ì»¤ë„¥í„° ì‚¬ìš©');\n    }\n    \n    console.log(`Notion í˜ì´ì§€ ì—…ë°ì´íŠ¸ ì‹œì‘: ${pageId}, ì†ì„±: ${propertyName}, ê°’: ${newValue}`);\n    \n    // ë¨¼ì € select íƒ€ì…ìœ¼ë¡œ ì‹œë„\n    let updateResponse = await fetch(`https://api.notion.com/v1/pages/${pageId}`, {\n      method: 'PATCH',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n        'Notion-Version': '2022-06-28'\n      },\n      body: JSON.stringify({\n        properties: {\n          [propertyName]: {\n            select: {\n              name: newValue\n            }\n          }\n        }\n      })\n    });\n    \n    // selectê°€ ì‹¤íŒ¨í•˜ë©´ status íƒ€ì…ìœ¼ë¡œ ì¬ì‹œë„\n    if (!updateResponse.ok) {\n      console.log('select íƒ€ì… ì‹¤íŒ¨, status íƒ€ì…ìœ¼ë¡œ ì¬ì‹œë„...');\n      updateResponse = await fetch(`https://api.notion.com/v1/pages/${pageId}`, {\n        method: 'PATCH',\n        headers: {\n          'Authorization': `Bearer ${accessToken}`,\n          'Content-Type': 'application/json',\n          'Notion-Version': '2022-06-28'\n        },\n        body: JSON.stringify({\n          properties: {\n            [propertyName]: {\n              status: {\n                name: newValue\n              }\n            }\n          }\n        }\n      });\n    }\n    \n    if (!updateResponse.ok) {\n      const errorData = await updateResponse.text();\n      console.error('Notion API ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateResponse.status, errorData);\n      \n      let errorMessage = 'ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';\n      try {\n        const errorJson = JSON.parse(errorData);\n        if (errorJson.message) {\n          errorMessage = errorJson.message;\n        }\n      } catch (e) {\n        // JSON íŒŒì‹± ì‹¤íŒ¨ì‹œ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©\n      }\n      \n      return res.status(500).json({ \n        success: false, \n        message: errorMessage,\n        details: errorData\n      });\n    }\n    \n    const updateResult = await updateResponse.json();\n    console.log('Notion í˜ì´ì§€ ì—…ë°ì´íŠ¸ ì„±ê³µ:', updateResult.id);\n    \n    res.json({ \n      success: true, \n      message: 'ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.',\n      pageId: updateResult.id,\n      property: propertyName,\n      newValue: newValue,\n      updatedAt: new Date().toISOString()\n    });\n    \n  } catch (error) {\n    console.error('ìˆ™ì œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);\n    console.error('ì˜¤ë¥˜ ìƒì„¸:', error.message);\n    \n    res.status(500).json({ \n      success: false, \n      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',\n      error: error.message \n    });\n  }\n});\n\n// Vercel ë°°í¬ìš© ê¸°ë³¸ handler\nexport default app;\n\n// ë¡œì»¬ ê°œë°œí™˜ê²½ì—ì„œë§Œ ì‹¤í–‰\nif (process.env.NODE_ENV !== 'production') {\n  app.listen(PORT, () => {\n    console.log(`í•™ìŠµ í”Œë˜ë„ˆ ì„œë²„ê°€ í¬íŠ¸ ${PORT}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!`);\n    console.log(`í•™ìƒìš©: http://localhost:${PORT}`);\n    console.log(`ì„ ìƒë‹˜ìš©: http://localhost:${PORT}/teacher`);\n    \n    // Notion ì—°ê²° ìƒíƒœ í™•ì¸\n    console.log('ì²˜ìš° Notion ì—°ê²° ìƒíƒœë¥¼ í™•ì¸ì¤‘...');\n    getAccessToken()\n      .then(() => console.log('âœ“ Notion ì—°ê²° ì„±ê³µ!'))\n      .catch(err => console.error('âœ— Notion ì—°ê²° ì‹¤íŒ¨:', err.message));\n  });\n}","size_bytes":29431}},"version":1}