<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>선생님 대시보드 - 리디튜드</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <style>
        /* --- 기본 스타일 --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "NanumSquareRound", sans-serif; }
        body { background: #f8f9fa; color: #2d3748; min-height: 100vh; padding: 0; }
        .container { max-width: 1400px; margin: 0 auto; background: none; box-shadow: none; overflow: visible; padding: 0 20px; }
        .header { background: #ffffff; color: #6b46c1; padding: 20px 30px; text-align: left; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; margin: 0; }
        .user-info { position: static; text-align: right; display: flex; align-items: center; gap: 15px;}
        .user-name { font-size: 1em; margin-bottom: 0; display: inline-block; font-weight: 600; }
        .logout-btn { background: #6b46c1; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s ease; box-shadow: none; }
        .logout-btn:hover { background: #5a3eaa; }

        /* --- 탭 메뉴 --- */
        .tab-menu { display: flex; background-color: #ffffff; border-bottom: 1px solid #e2e8f0; padding: 0 40px; margin-top: 20px; border-radius: 12px 12px 0 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-button { padding: 15px 25px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: 600; color: #6b7280; position: relative; transition: color 0.3s ease; }
        .tab-button::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: #8b5cf6; transform: scaleX(0); transition: transform 0.3s ease; }
        .tab-button.active { color: #6b46c1; }
        .tab-button.active::after { transform: scaleX(1); }

        /* --- 컨텐츠 공통 --- */
        .main-content { padding: 30px 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .content-section { background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); border: 1px solid #e9ecef; padding: 30px; margin: 0 20px 30px; }
        .section-title { font-size: 1.6em; font-weight: 700; color: #6b46c1; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: var(--icon, "📋"); font-size: 1.2em; }
        .loading, .no-data { text-align: center; padding: 60px; color: #718096; font-size: 16px; }
        .loading::before { content: "⏳ "; } .no-data::before { content: "📝 "; }

        /* --- 통계 카드 --- */
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 0 20px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .stat-value { font-size: 2.0em; font-weight: 700; color: #6b46c1; margin-bottom: 5px; }
        .stat-label { color: #718096; font-size: 14px; }

        /* --- 필터 --- */
        .filters-container { display:flex; gap:15px; margin-bottom:25px; align-items:center; flex-wrap: wrap; }
        .refresh-btn { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .filter-group { display:flex; align-items:center; gap:8px; }
        .filter-label { font-weight:600; color:#6b46c1; }
        .filter-select, .filter-input { padding:8px 12px; border-radius:8px; border:2px solid #e2e8f0; background:white; font-size: 14px; }
        #customDateContainer_hw, #customDateContainer_test, #customDateContainer_reading, #customDateContainer_listening { display:none; align-items:center; gap:8px; }
        #teacherFilterContainer_hw, #teacherFilterContainer_test, #teacherFilterContainer_reading, #teacherFilterContainer_listening { display:none; }

        /* --- 테이블 --- */
        .table-container { overflow-x: auto; border: 1px solid #e9ecef; border-radius: 12px; }
        .styled-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .styled-table th { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; padding: 12px 10px; text-align: center; font-weight: 600; font-size: 13px; border-right: 1px solid rgba(255,255,255,0.2); white-space: nowrap; }
        .styled-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #f1f3f4; border-right: 1px solid #f1f3f4; vertical-align: middle; font-size: 13px; }
        .styled-table tr:hover { background-color: #f8f9ff; }
        .student-name { font-weight: 600; color: #2d3748; font-size: 14px; background: #f9fafc; text-align: left; padding-left: 15px; }

        /* --- 테이블 내 요소 --- */
        .editable-input { padding: 4px 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; text-align: center; max-width: 60px; background-color: #f9fafb; transition: all 0.2s ease; }
        .editable-input:focus { border-color: #8b5cf6; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); background-color: white; }
        .editable-text-input { max-width: 100px; text-align: left; }

        .reading-result-badge { padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 11px; display: inline-block; }
        .result-pass { background-color: #dcfce7; color: #166534; }
        .result-fail { background-color: #fecaca; color: #991b1b; }
        .result-none { background-color: #f3f4f6; color: #6b7280; }

        /* --- 수행율 버튼 --- */
        .completion-rate { font-weight: 700; font-size: 14px; }
        .rate-excellent { color: #10b981; } .rate-good { color: #8b5cf6; } .rate-poor { color: #ef4444; }
        .refresh-rate-btn { background: none; border: none; cursor: pointer; font-size: 1.1em; vertical-align: middle; margin-left: 5px; opacity: 0.6; transition: opacity 0.2s ease, transform 0.2s ease; }
        .refresh-rate-btn:hover { opacity: 1; transform: rotate(90deg); }
        .refresh-rate-btn.loading { opacity: 0.5; cursor: default; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- 드롭다운 공통 --- */
        .homework-dropdown { padding: 4px 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 11px; font-weight: 600; text-align: center; min-width: 50px; background: white; cursor: pointer; transition: all 0.2s ease; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%239ca3af'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em 1em; padding-right: 1.8em; }
        .homework-dropdown:hover { border-color: #6b46c1; box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.1); }
        .homework-dropdown:focus { outline: none; border-color: #6b46c1; box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1); }

        /* [수정] 드롭다운 색상 스타일 (리스닝 상태 추가) */
        .homework-dropdown.status-default,
        .homework-dropdown.status-none,
        .homework-dropdown.status-listening-none { background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db; }

        /* (Green) 숙제 함, 완료, 북리포트 */
        .homework-dropdown.status-complete,
        .homework-dropdown.status-reading-complete,
        .homework-dropdown.status-vocab-complete,
        .homework-dropdown.status-writing-bookreport,
        .homework-dropdown.status-listening-complete { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }

        /* (Red) 안 해옴, 못함, 미완료 */
        .homework-dropdown.status-incomplete,
        .homework-dropdown.status-reading-incomplete,
        .homework-dropdown.status-vocab-incomplete,
        .homework-dropdown.status-listening-incomplete { background-color: #fecaca; color: #991b1b; border-color: #fca5a5; }

        /* (Orange) SKIP */
        .homework-dropdown.status-vocab-skip,
        .homework-dropdown.status-writing-skip { background-color: #ffedd5; color: #9a3412; border-color: #fed7aa; }

        /* (Blue) 3 SENTENCE */
        .homework-dropdown.status-writing-3sentence { background-color: #dbeafe; color: #1e40af; border-color: #bfdbfe; }

        /* --- 원형 점수 그래프 --- */
        .score-circle { position: relative; width: 45px; height: 45px; border-radius: 50%; background: conic-gradient(var(--score-color, #e5e7eb) 0% var(--score-value, 0%), #e5e7eb var(--score-value, 0%) 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto; }
        .score-circle::before { content: ''; position: absolute; width: 75%; height: 75%; background: white; border-radius: 50%; }
        .score-text { position: relative; font-size: 13px; font-weight: 700; color: var(--score-color, #6b7280); }
        .score-none { font-size: 14px; font-weight: 600; color: #9ca3af; }

        /* --- 책 제목 버튼 (원서 독서) --- */
        .book-title-cell { padding: 5px !important; }
        .book-title-button {
            width: 100%; min-height: 30px;
            padding: 6px 8px;
            border: 1px solid transparent; /* 기본 테두리 숨김 */
            border-radius: 4px;
            background-color: transparent; /* 기본 배경 투명 */
            cursor: pointer;
            text-align: left;
            font-size: 13px;
            color: #111827;
            transition: all 0.2s ease;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            line-height: 1.4;
        }
        .book-title-button:hover {
            border-color: #d1d5db; /* 호버 시 테두리 */
            background-color: #f9fafb;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
        }
        .book-title-button.empty {
            color: #6b7280;
            font-style: italic;
            text-align: center;
        }

        /* --- 책 검색 모달 --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        .modal-title { font-size: 1.4em; font-weight: 700; color: #6b46c1; margin-bottom: 20px; }
        .modal-search-input { width: 100%; padding: 12px 15px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; }
        .modal-search-results { max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; }
        .result-item { padding: 12px 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer; }
        .result-item:hover { background-color: #f8f9ff; }
        .result-item:last-child { border-bottom: none; }
        .result-title { font-weight: 600; color: #2d3748; }
        .result-meta { font-size: 13px; color: #718096; margin-top: 4px; }
        .modal-actions { margin-top: 20px; display: flex; justify-content: space-between; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: #f3f4f6; color: #4b5563; }
        .btn-clear { background: #fee2e2; color: #991b1b; }

        /* --- 토스트 메시지 --- */
        .toast-message { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; font-weight: 600; z-index: 3000; opacity: 0; transform: translateX(100%); transition: all 0.3s ease; }
        .toast-message.show { opacity: 1; transform: translateX(0); }
        .toast-success { background: #dcfce7; border: 1px solid #bbf7d0; color: #166534; }
        .toast-error { background: #fecaca; border: 1px solid #fca5a5; color: #991b1b; }
    </style>
</head>
<body>
    <div class="header">
        <h1>📚 리디튜드 선생님</h1>
        <div class="user-info">
            <span class="user-name" id="userName">로딩중...</span>
            <button class="logout-btn" onclick="logout()">로그아웃</button>
        </div>
    </div>

    <div class="container">
        <div class="tab-menu">
            <button class="tab-button active" onclick="showTab('homework')">숙제 현황</button>
            <button class="tab-button" onclick="showTab('tests')">테스트 결과</button>
            <button class="tab-button" onclick="showTab('reading')">원서 독서 현황</button>
            <button class="tab-button" onclick="showTab('listening')">리스닝 현황</button>
            <button class="tab-button" onclick="showTab('comments')">오늘의 코멘트</button>
        </div>

        <div class="main-content">
            <!-- ========== 숙제 현황 탭 ========== -->
            <div id="homework-view" class="tab-content active">
                <div class="stats-summary" id="statsContainer_hw"></div>
                <div class="content-section">
                    <div class="section-title" style="--icon:'📋'">담당 학생 숙제 현황</div>
                    <div class="filters-container" id="commonFilters_hw">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">🔄 새로고침</button>
                        <div class="filter-group">
                            <label for="periodFilter_hw" class="filter-label">기간:</label>
                            <select id="periodFilter_hw" class="filter-select">
                                <option value="today">오늘</option> <option value="week">이번 주</option> <option value="month">이번 달</option> <option value="custom">사용자 지정</option>
                            </select>
                        </div>
                        <div id="customDateContainer_hw" style="display:none;" class="filter-group">
                            <input type="date" id="startDate_hw" class="filter-input"> <span>~</span> <input type="date" id="endDate_hw" class="filter-input">
                        </div>
                        <div id="teacherFilterContainer_hw" style="display:none;" class="filter-group">
                            <label for="teacherFilter_hw" class="filter-label">담당강사:</label>
                            <select id="teacherFilter_hw" class="filter-select">
                                <option value="">전체 보기</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr> <th>학생 이름</th> <th>담당강사</th> <th>⭕ 문법</th> <th>1️⃣ 어휘</th> <th>2️⃣ 독해</th> <th>4️⃣ Sum</th> <th>5️⃣ 독해</th> <th>6️⃣ 일기 등</th> <th>수행율</th> </tr>
                            </thead>
                            <tbody id="homeworkTableBody">
                                <tr><td colspan="9" class="loading">숙제 현황을 불러오는 중입니다...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========== 테스트 결과 탭 ========== -->
            <div id="tests-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title" style="--icon:'📝'">담당 학생 테스트 결과</div>
                    <div class="filters-container" id="commonFilters_test">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">🔄 새로고침</button>
                        <div class="filter-group">
                            <label for="periodFilter_test" class="filter-label">기간:</label>
                            <select id="periodFilter_test" class="filter-select">
                                <option value="today">오늘</option> <option value="week">이번 주</option> <option value="month">이번 달</option> <option value="custom">사용자 지정</option>
                            </select>
                        </div>
                        <div id="customDateContainer_test" style="display:none;" class="filter-group">
                            <input type="date" id="startDate_test" class="filter-input"> <span>~</span> <input type="date" id="endDate_test" class="filter-input">
                        </div>
                        <div id="teacherFilterContainer_test" style="display:none;" class="filter-group">
                            <label for="teacherFilter_test" class="filter-label">담당강사:</label>
                            <select id="teacherFilter_test" class="filter-select">
                                <option value="">전체 보기</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>학생 이름</th>
                                    <th>어휘유닛</th>
                                    <th>어휘정답</th>
                                    <th>총갯수</th>
                                    <th>어휘점수</th>
                                    <th>독해오답</th>
                                    <th>독해결과</th>
                                    <th>하브루타</th>
                                    <th>문법문항</th> <th>문법오답</th> <th>문법점수</th>
                                </tr>
                            </thead>
                            <tbody id="testsTableBody">
                                <tr><td colspan="11" class="loading">테스트 결과를 불러오는 중입니다...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========== 원서 독서 현황 탭 ========== -->
            <div id="reading-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title" style="--icon:'📚'">원서 독서 현황</div>
                    <div class="filters-container" id="commonFilters_reading">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">🔄 새로고침</button>
                        <div class="filter-group">
                            <label for="periodFilter_reading" class="filter-label">기간:</label>
                            <select id="periodFilter_reading" class="filter-select">
                                <option value="today">오늘</option> <option value="week">이번 주</option> <option value="month">이번 달</option> <option value="custom">사용자 지정</option>
                            </select>
                        </div>
                        <div id="customDateContainer_reading" style="display:none;" class="filter-group">
                            <input type="date" id="startDate_reading" class="filter-input"> <span>~</span> <input type="date" id="endDate_reading" class="filter-input">
                        </div>
                        <div id="teacherFilterContainer_reading" style="display:none;" class="filter-group">
                            <label for="teacherFilter_reading" class="filter-label">담당강사:</label>
                            <select id="teacherFilter_reading" class="filter-select">
                                <option value="">전체 보기</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>학생 이름</th>
                                    <th>담당강사</th>
                                    <th>📖 영어독서</th>
                                    <th>어휘학습</th>
                                    <th>📚 책 제목</th>
                                    <th>시리즈</th>
                                    <th>AR</th>
                                    <th>Lexile</th>
                                    <th>Writing 학습</th>
                                </tr>
                            </thead>
                            <tbody id="readingTableBody">
                                <tr><td colspan="9" class="loading">원서 독서 현황을 불러오는 중입니다...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========== [신규] 리스닝 현황 탭 ========== -->
            <div id="listening-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title" style="--icon:'🎧'">리스닝 현황</div>
                    <div class="filters-container" id="commonFilters_listening">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">🔄 새로고침</button>
                        <div class="filter-group">
                            <label for="periodFilter_listening" class="filter-label">기간:</label>
                            <select id="periodFilter_listening" class="filter-select">
                                <option value="today">오늘</option> <option value="week">이번 주</option> <option value="month">이번 달</option> <option value="custom">사용자 지정</option>
                            </select>
                        </div>
                        <div id="customDateContainer_listening" style="display:none;" class="filter-group">
                            <input type="date" id="startDate_listening" class="filter-input"> <span>~</span> <input type="date" id="endDate_listening" class="filter-input">
                        </div>
                        <div id="teacherFilterContainer_listening" style="display:none;" class="filter-group">
                            <label for="teacherFilter_listening" class="filter-label">담당강사:</label>
                            <select id="teacherFilter_listening" class="filter-select">
                                <option value="">전체 보기</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>학생 이름</th>
                                    <th>담당강사</th>
                                    <th>리스닝 학습 교재</th>
                                    <th>듣기 학습</th>
                                    <th>듣기 워크북</th>
                                </tr>
                            </thead>
                            <tbody id="listeningTableBody">
                                <tr><td colspan="5" class="loading">리스닝 현황을 불러오는 중입니다...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="comments-view" class="tab-content"><div class="content-section"><div class="section-title" style="--icon:'💬'">💬 오늘의 코멘트</div><p class="no-data">구현 예정</p></div></div>
        </div>
    </div>

    <!-- ========== 책 검색 모달 ========== -->
    <div id="bookSearchModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">📚 책 제목 검색</h2>
            <input type="text" id="modalSearchInput" class="modal-search-input" placeholder="검색어를 입력하세요...">
            <div id="modalSearchResults" class="modal-search-results">
                <div class="no-data" style="padding: 30px;">검색어를 입력하세요...</div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-clear" onclick="selectBook(null, '책 검색...')">🚫 관계 연결 해제</button>
                <button class="modal-btn btn-cancel" onclick="closeBookSearchModal()">닫기</button>
            </div>
        </div>
    </div>

    <script>
        // --- 전역 변수 및 초기화 ---
        const API_BASE_URL = 'http://localhost:5001';
        let authToken = localStorage.getItem('teacher_auth_token');
        let allCombinedData = []; // 숙제+테스트 탭 데이터 캐시
        let allReadingData = []; // 원서 독서 탭 데이터 캐시
        let allListeningData = []; // [신규] 리스닝 탭 데이터 캐시
        let currentUserRole = '';
        let currentUserName = '';
        let currentActiveTab = 'homework'; // 현재 활성화된 탭
        let currentModalContext = {}; // 모달에 전달할 pageId 등
        let bookSearchTimer = null; // 책 검색 디바운스 타이머

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) { console.error('인증 토큰 없음'); window.location.href='/teacher-login'; return; }
            initializePage();
        });

        async function initializePage() {
            try {
                await loadUserInfo(); // 사용자 정보 및 강사 필터 옵션 로드
                setupEventListeners(); // 모든 탭의 이벤트 리스너 설정
                showTab('homework'); // 초기 탭 설정 및 데이터 로드
            } catch (e) { console.error("초기화 오류:", e); }
        }

        function setupEventListeners() {
            // [수정] 모든 탭의 필터 변경 시 자동 새로고침
            ['hw', 'test', 'reading', 'listening'].forEach(suffix => {
                const s = `_${suffix}`; // _hw, _test, _reading, _listening
                document.getElementById(`periodFilter${s}`)?.addEventListener('change', () => {
                    toggleCustomDateInputs(s);
                    loadDataForCurrentTab();
                });
                document.getElementById(`startDate${s}`)?.addEventListener('change', loadDataForCurrentTab);
                document.getElementById(`endDate${s}`)?.addEventListener('change', loadDataForCurrentTab);
                document.getElementById(`teacherFilter${s}`)?.addEventListener('change', loadDataForCurrentTab);
            });

            // 책 검색 모달 디바운스 입력
            document.getElementById('modalSearchInput')?.addEventListener('input', (e) => {
                clearTimeout(bookSearchTimer);
                const query = e.target.value;
                bookSearchTimer = setTimeout(() => {
                    searchBooks(query);
                }, 300); // 300ms 디바운스
            });

            // 모달 닫기 버튼
            document.querySelector('.btn-cancel').addEventListener('click', closeBookSearchModal);
        }

        // --- 데이터 로드 함수 ---
        async function loadUserInfo() {
             try {
                const userInfoResponse = await fetch(`${API_BASE_URL}/api/teacher/user-info`, { headers:{Authorization:'Bearer '+authToken} });
                if (!userInfoResponse.ok) throw new Error('사용자 정보 로드 실패');
                const data = await userInfoResponse.json();
                if (data.userName) {
                    document.getElementById('userName').textContent = data.userName + ' ('+data.userRole+')';
                    currentUserRole = data.userRole;
                    currentUserName = data.userName;

                    // [수정] 모든 탭의 필터 컨테이너
                    const filterContainers = document.querySelectorAll('#teacherFilterContainer_hw, #teacherFilterContainer_test, #teacherFilterContainer_reading, #teacherFilterContainer_listening');

                    if (data.userRole === 'manager') {
                        const teachersResponse = await fetch(`${API_BASE_URL}/api/teachers`, { headers:{Authorization:'Bearer '+authToken} });
                        if (!teachersResponse.ok) throw new Error('강사 목록 로드 실패');
                        const teachers = await teachersResponse.json();
                        updateTeacherFilterOptions(teachers); // 모든 필터 업데이트
                        filterContainers.forEach(el => { if (el) el.style.display='flex'; });
                    } else {
                        // 매니저가 아닐 때, 필터 숨김
                        updateTeacherFilterOptions([]); // 강사 목록 비우고 본인 이름으로 설정
                        filterContainers.forEach(el => { if (el) el.style.display='none'; });
                    }
                } else { throw new Error('사용자 정보 형식이 잘못됨'); }
             } catch (error) {
                 console.error("사용자 정보 로드 오류:", error);
                 alert('사용자 정보를 불러오는데 실패했습니다. 다시 로그인해주세요.');
                 logout();
             }
        }

        async function loadDataForCurrentTab() {
            console.log(`데이터 로드 시작: ${currentActiveTab}`);
            // [수정] 현재 활성화된 탭에 따라 다른 데이터 로드 함수 호출
            if (currentActiveTab === 'homework' || currentActiveTab === 'tests') {
                await loadHomeworkAndTestData();
            } else if (currentActiveTab === 'reading') {
                await loadReadingStatusData();
            } else if (currentActiveTab === 'listening') {
                await loadListeningStatusData();
            }
            // ... 다른 탭 데이터 로드 ...
        }

        function getFilterParams(suffix) { // suffix e.g., _hw, _test, _reading, _listening
            const period = document.getElementById(`periodFilter${suffix}`)?.value || 'today';
            const teacherSelect = document.getElementById(`teacherFilter${suffix}`);
            const teacher = (currentUserRole === 'manager' && teacherSelect) ? teacherSelect.value : (currentUserRole === 'teacher' ? currentUserName : '');

            let url = `period=${period}`;
            if (period === 'custom') {
                const s = document.getElementById(`startDate${suffix}`)?.value;
                const e = document.getElementById(`endDate${suffix}`)?.value;
                if (s && e) {
                    url += `&startDate=${s}&endDate=${e}`;
                } else {
                    console.warn('사용자 지정 기간이 선택되었으나 날짜가 없습니다.');
                }
            }
            if (currentUserRole === 'manager' && teacher && teacher !== "") {
                url += `&teacher=${encodeURIComponent(teacher)}`;
            }
            return url;
        }

        async function loadHomeworkAndTestData() {
            const hwTbody = document.getElementById('homeworkTableBody');
            const testTbody = document.getElementById('testsTableBody');
            hwTbody.innerHTML = '<tr><td colspan="9" class="loading">로딩중...</td></tr>';
            testTbody.innerHTML = '<tr><td colspan="11" class="loading">로딩중...</td></tr>';

            try {
                const filterSuffix = (currentActiveTab === 'tests') ? '_test' : '_hw';
                const params = getFilterParams(filterSuffix);
                const url = `${API_BASE_URL}/api/homework-status?${params}`;

                const response = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!response.ok) { const errorText = await response.text(); console.error("서버 응답 오류:", errorText); throw new Error("네트워크 오류 또는 서버 응답 실패"); }

                const combinedData = await response.json();
                allCombinedData = combinedData;

                displayHomeworkData(combinedData);
                displayTestData(combinedData);
                updateStats(combinedData);
            } catch(e) {
                console.error("숙제/테스트 데이터 로드 오류:", e);
                const errorMsg = `<tr><td colspan="11" class="no-data">${e.message || '로드 실패'}</td></tr>`;
                hwTbody.innerHTML = errorMsg.replace('colspan="11"', 'colspan="9"');
                testTbody.innerHTML = errorMsg;
                updateStats([]);
            }
        }

        async function loadReadingStatusData() {
            const tbody = document.getElementById('readingTableBody');
            tbody.innerHTML = '<tr><td colspan="9" class="loading">로딩중...</td></tr>';
            try {
                const params = getFilterParams('_reading');
                const url = `${API_BASE_URL}/api/reading-status?${params}`;
                const response = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || "원서 독서 데이터 로드 실패"); }
                const readingData = await response.json();
                allReadingData = readingData;
                displayReadingData(readingData);
            } catch(e) {
                console.error("원서 독서 데이터 로드 오류:", e);
                tbody.innerHTML = `<tr><td colspan="9" class="no-data">${e.message || '로드 실패'}</td></tr>`;
            }
        }

        // [신규] 리스닝 현황 데이터 로드
        async function loadListeningStatusData() {
            const tbody = document.getElementById('listeningTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">로딩중...</td></tr>';
            try {
                const params = getFilterParams('_listening');
                const url = `${API_BASE_URL}/api/listening-status?${params}`;
                const response = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || "리스닝 데이터 로드 실패"); }
                const listeningData = await response.json();
                allListeningData = listeningData;
                displayListeningData(listeningData);
            } catch(e) {
                console.error("리스닝 데이터 로드 오류:", e);
                tbody.innerHTML = `<tr><td colspan="5" class="no-data">${e.message || '로드 실패'}</td></tr>`;
            }
        }


        // --- UI 업데이트 함수 ---
        function toggleCustomDateInputs(suffixWithUnderscore) { // e.g., _hw, _test, _reading, _listening
             const periodEl = document.getElementById(`periodFilter${suffixWithUnderscore}`);
             const customDateEl = document.getElementById(`customDateContainer${suffixWithUnderscore}`);

             if (periodEl && customDateEl) {
                 customDateEl.style.display = (periodEl.value === 'custom') ? 'flex' : 'none';
             }
        }

        function displayHomeworkData(data) {
            const tbody = document.getElementById('homeworkTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="9" class="no-data">데이터 없음</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `
                <tr id="row-hw-${st.pageId || Math.random()}">
                    <td class="student-name">${st.studentName || '이름 없음'}</td>
                    <td>${(st.teachers || []).join(', ') || '미배정'}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '⭕ 지난 문법 숙제 검사', st.grammarHomework)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '1️⃣ 어휘 클카 암기 숙제', st.vocabCards)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '2️⃣ 독해 단어 클카 숙제', st.readingCards)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '4️⃣ Summary 숙제', st.summary)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '5️⃣ 매일 독해 숙제', st.readingHomework)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '6️⃣ 영어일기 or 개인 독해서', st.diary)}</td>
                    <td>
                        <span class="completion-rate ${rateClass(st.completionRate)}">${st.completionRate || 0}%</span>
                        <button class="refresh-rate-btn" onclick="refreshStudentRate(this, '${st.pageId}')" title="수행율 새로고침">🔄</button>
                    </td>
                </tr>`).join('');
        }

        function displayTestData(data) {
            const tbody = document.getElementById('testsTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="11" class="no-data">데이터 없음</td></tr>'; return; }
            tbody.innerHTML = data.map(st => {
                const vScore = (st.vocabTotal > 0) ? Math.round((st.vocabCorrect / st.vocabTotal) * 100) : 0;
                const gScore = (st.grammarTotal > 0) ? Math.round(((st.grammarTotal - (st.grammarWrong || 0)) / st.grammarTotal) * 100) : 0;

                return `
                <tr id="row-test-${st.pageId || Math.random()}">
                    <td class="student-name">${st.studentName || '이름 없음'}</td>
                    <td><input type="text" class="editable-input editable-text-input" value="${st.vocabUnit || ''}" defaultValue="${st.vocabUnit || ''}" data-page-id="${st.pageId || ''}" data-property-name="어휘유닛" data-property-type="rich_text" onblur="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td><input type="number" class="editable-input" value="${st.vocabCorrect ?? ''}" defaultValue="${st.vocabCorrect ?? ''}" data-page-id="${st.pageId || ''}" data-property-name="단어 (맞은 개수)" data-property-type="number" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td><input type="number" class="editable-input" value="${st.vocabTotal ?? ''}" defaultValue="${st.vocabTotal ?? ''}" data-page-id="${st.pageId || ''}" data-property-name="단어 (전체 개수)" data-property-type="number" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td class="vocab-score">${formatScoreCircle(vScore)}</td>
                    <td><input type="number" class="editable-input" value="${st.readingWrong ?? ''}" defaultValue="${st.readingWrong ?? ''}" data-page-id="${st.pageId || ''}" data-property-name="독해 (틀린 개수)" data-property-type="number" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td><span class="reading-result-badge ${getReadingResultClass(st.readingResult)}">${st.readingResult || '-'}</span></td>
                    <td>${formatSelectDropdown(st.pageId, '독해 하브루타', st.havruta, ['완료함', '못하고감', '숙제없음'], '숙제없음')}</td>
                    <td><input type="number" class="editable-input" value="${st.grammarTotal ?? ''}" defaultValue="${st.grammarTotal ?? ''}" data-page-id="${st.pageId || ''}" data-property-name="문법 (전체 개수)" data-property-type="number" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td><input type="number" class="editable-input" value="${st.grammarWrong ?? ''}" defaultValue="${st.grammarWrong ?? ''}" data-page-id="${st.pageId || ''}" data-property-name="문법 (틀린 개수)" data-property-type="number" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td class="grammar-score">${formatScoreCircle(gScore)}</td>
                </tr>`
            }).join('');
        }

        function displayReadingData(data) {
             const tbody = document.getElementById('readingTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="9" class="no-data">데이터 없음</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `
                <tr id="row-reading-${st.pageId || Math.random()}">
                    <td class="student-name">${st.studentName || '이름 없음'}</td>
                    <td>${(st.teachers || []).join(', ') || '미배정'}</td>
                    <td>
                        ${formatSelectDropdown(st.pageId, '📖 영어독서', st.readingStatus, ['완료함', '못함'], '---')}
                    </td>
                    <td>
                        ${formatSelectDropdown(st.pageId, '어휘학습', st.vocabStatus, ['완료함', '못함', 'SKIP', '완료'], '---')}
                    </td>
                    <td class="book-title-cell">
                        <button
                            class="book-title-button ${st.bookTitle ? '' : 'empty'}"
                            data-page-id="${st.pageId}"
                            data-relation-id="${st.bookRelationId || ''}"
                            onclick="openBookSearchModal(this)">
                            ${st.bookTitle || '책 검색...'}
                        </button>
                    </td>
                    <td>${st.bookSeries || '-'}</td>
                    <td>${st.bookAR ?? '-'}</td>
                    <td>${st.bookLexile ?? '-'}</td>
                    <td>
                        ${formatSelectDropdown(st.pageId, 'Writing', st.writingStatus, ['SKIP', '북리포트', '3 SENTENCE'], '---')}
                    </td>
                </tr>`).join('');
        }

        // [신규] 리스닝 현황 데이터 표시
        function displayListeningData(data) {
            const tbody = document.getElementById('listeningTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="5" class="no-data">데이터 없음</td></tr>'; return; }

            // '상태' 옵션 (index.js의 update API와 일치해야 함)
            const listeningOptions = ['완료', '미완료', '진행하지 않음'];

            tbody.innerHTML = data.map(st => `
                <tr id="row-listening-${st.pageId || Math.random()}">
                    <td class="student-name">${st.studentName || '이름 없음'}</td>
                    <td>${(st.teachers || []).join(', ') || '미배정'}</td>
                    <td style="text-align: left; padding-left: 10px; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${st.listeningTextbook || ''}">
                        ${st.listeningTextbook || '-'}
                    </td>
                    <td>
                        ${formatHomeworkDropdown(st.pageId, '영어 더빙 학습 완료', st.listeningStudy, listeningOptions)}
                    </td>
                    <td>
                        ${formatHomeworkDropdown(st.pageId, '더빙 워크북 완료', st.listeningWorkbook, listeningOptions)}
                    </td>
                </tr>`).join('');
        }

        function handleEnterAsTab(event, tableBodyId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const formElements = Array.from(document.querySelectorAll(`#${tableBodyId} input, #${tableBodyId} select`));
                const currentIndex = formElements.indexOf(event.target);
                const nextElement = formElements[currentIndex + 1];
                if (nextElement) {
                    nextElement.focus();
                    if (nextElement.select) nextElement.select();
                } else {
                    event.target.blur();
                }
            }
        }

        // --- Helper Functions (Styling & Formatting) ---
        function getReadingResultClass(result) { if (result === 'PASS') return 'result-pass'; if (result === 'FAIL') return 'result-fail'; return 'result-none'; }

        function formatSelectDropdown(pageId, propertyName, currentValue, options, defaultValue = '---') { // 기본값을 '---'로 변경
            const displayValue = (currentValue && options.includes(currentValue)) ? currentValue : ""; // null이나 기본값은 "" (빈 값)으로 처리
            const statusClass = getSelectStatusClass(propertyName, currentValue); // [수정] currentValue로 클래스 계산

            const defaultOptionHtml = (defaultValue === '---')
                ? `<option value="" ${displayValue === "" ? 'selected' : ''}>---</option>`
                : `<option value="${defaultValue}" ${displayValue === defaultValue ? 'selected' : ''}>${defaultValue}</option>`;

            return `<select class="homework-dropdown ${statusClass}" data-page-id="${pageId || ''}" data-property-name="${propertyName}" data-property-type="select" onchange="updateField(this)">
                        ${defaultOptionHtml}
                        ${options.map(option => `<option value="${option}" ${option === displayValue ? 'selected' : ''}>${option}</option>`).join('')}
                    </select>`;
        }

        // [수정] formatHomeworkDropdown이 '상태' 옵션을 인자로 받도록 수정
        function formatHomeworkDropdown(pageId, propertyName, currentStatus, options = ['숙제 함', '안 해옴', '숙제 없음']) {
            const defaultStatus = options.includes('진행하지 않음') ? '진행하지 않음' : '숙제 없음';
            const displayStatus = options.includes(currentStatus) ? currentStatus : defaultStatus;
            const statusClass = getSelectStatusClass(propertyName, displayStatus); // 공통 함수 사용

            return `<select class="homework-dropdown ${statusClass}" data-page-id="${pageId || ''}" data-property-name="${propertyName}" data-property-type="status" onchange="updateField(this)">
                        ${options.map(option => `<option value="${option}" ${option === displayStatus ? 'selected' : ''}>${option}</option>`).join('')}
                    </select>`;
        }

        // [수정] 리스닝 상태 색상 추가
        function getSelectStatusClass(propertyName, value) {
            // 1. 숙제 현황 (Status)
            if (['⭕ 지난 문법 숙제 검사', '1️⃣ 어휘 클카 암기 숙제', '2️⃣ 독해 단어 클카 숙제', '4️⃣ Summary 숙제', '5️⃣ 매일 독해 숙제', '6️⃣ 영어일기 or 개인 독해서'].includes(propertyName)) {
                if (value === '숙제 함') return 'status-complete';
                if (value === '안 해옴') return 'status-incomplete';
                return 'status-none'; // 숙제 없음
            }
            // 2. 원서 독서 (Select)
            if (propertyName === '📖 영어독서') {
                if (value === '완료함') return 'status-reading-complete';
                if (value === '못함') return 'status-reading-incomplete';
            }
            if (propertyName === '어휘학습') {
                if (value === '완료함' || value === '완료') return 'status-vocab-complete';
                if (value === '못함') return 'status-vocab-incomplete';
                if (value === 'SKIP') return 'status-vocab-skip';
            }
            if (propertyName === 'Writing') {
                if (value === '북리포트') return 'status-writing-bookreport';
                if (value === '3 SENTENCE') return 'status-writing-3sentence';
                if (value === 'SKIP') return 'status-writing-skip';
            }
            // 3. 테스트 (Select)
            if (propertyName === '독해 하브루타') {
                if (value === '완료함') return 'status-complete';
                if (value === '못하고감') return 'status-incomplete';
            }
            // 4. [신규] 리스닝 (Status)
            if (propertyName === '영어 더빙 학습 완료' || propertyName === '더빙 워크북 완료') {
                if (value === '완료') return 'status-listening-complete';
                if (value === '미완료') return 'status-listening-incomplete';
                return 'status-listening-none'; // 진행하지 않음
            }
            return 'status-default'; // 기본
        }

        function rateClass(r){ if(r>=90)return'rate-excellent'; if(r>=70)return'rate-good'; return'rate-poor'; }

        function getScoreStyle(score) {
            let color = '#ef4444'; // 40점 미만 (빨강)
            if (score >= 80) color = '#10b981'; // 80점 이상 (초록)
            else if (score >= 60) color = '#f59e0b'; // 60점 이상 (주황)
            else if (score >= 40) color = '#facc15'; // 40점 이상 (노랑)
            return `style="--score-color: ${color}; --score-value: ${score}%"`;
        }

        function formatScoreCircle(score) {
            if (score === null || isNaN(score) || score === 0) return '<span class="score-none">-</span>'; // 0점이나 null이면 - 표시
            const style = getScoreStyle(score);
            return `
                <div class="score-circle" ${style}>
                    <span class="score-text">${Math.round(score)}%</span>
                </div>
            `;
        }

        async function refreshStudentRate(buttonElement, pageId) {
             if (!pageId) { showToast('페이지 ID가 없어 새로고침할 수 없습니다.', 'error'); return; }
             console.log(`개별 새로고침 요청: ${pageId}`);
             buttonElement.classList.add('loading'); buttonElement.disabled = true;
             try {
                const response = await fetch(`${API_BASE_URL}/api/student-homework/${pageId}`, { headers: { 'Authorization': 'Bearer ' + authToken } });
                if (!response.ok) { throw new Error('데이터 조회 실패'); }
                const result = await response.json();
                if (result.success) {
                    const row = buttonElement.closest('tr');
                    if (row) {
                        const rateSpan = row.querySelector('.completion-rate');
                        if (rateSpan) {
                            rateSpan.textContent = `${result.completionRate || 0}%`;
                            rateSpan.className = `completion-rate ${rateClass(result.completionRate)}`;
                            showToast(`${result.studentName} 학생 정보 업데이트 완료`, 'success');
                        }
                    }
                } else { throw new Error(result.message || '데이터 업데이트 실패'); }
             } catch (error) {
                console.error('개별 학생 새로고침 오류:', error);
                showToast(`새로고침 실패: ${error.message}`, 'error');
             } finally {
                buttonElement.classList.remove('loading'); buttonElement.disabled = false;
             }
        }

        function updateStats(data){
            const container = document.getElementById('statsContainer_hw');
            if (!container) return;
            if(!data || !data.length){ container.innerHTML = `<div class="stat-card"><div class="stat-value">0</div><div class="stat-label">총 학생 수</div></div><div class="stat-card"><div class="stat-value">0%</div><div class="stat-label">평균 수행율</div></div><div class="stat-card"><div class="stat-value">0</div><div class="stat-label">우수 학생</div></div>`; return; }

            const isTodayFilter = document.getElementById('periodFilter_hw').value === 'today';
            const today = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            const statsData = isTodayFilter ? data.filter(item => item.date === today) : data;
            const labelSuffix = isTodayFilter ? " (오늘)" : "";

            const uniqueStudents = new Set(statsData.map(item => item.studentName));
            const totalStudents = uniqueStudents.size;
            const avg = statsData.length > 0 ? Math.round(statsData.reduce((s,x)=>s+(x.completionRate||0),0)/statsData.length) : 0;
            const excellentStudents = new Set(statsData.filter(x => (x.completionRate || 0) === 100).map(item => item.studentName)).size;

            container.innerHTML=`<div class="stat-card"><div class="stat-value">${totalStudents}</div><div class="stat-label">총 학생 수${labelSuffix}</div></div><div class="stat-card"><div class="stat-value">${avg}%</div><div class="stat-label">평균 수행율${labelSuffix}</div></div><div class="stat-card"><div class="stat-value">${excellentStudents}</div><div class="stat-label">우수 학생 (100%)${labelSuffix}</div></div>`;
        }

        function updateTeacherFilterOptions(teachers){
            // [수정] 모든 탭의 셀렉터
            const selectors = [
                document.getElementById('teacherFilter_hw'),
                document.getElementById('teacherFilter_test'),
                document.getElementById('teacherFilter_reading'),
                document.getElementById('teacherFilter_listening')
            ];

            selectors.forEach(sel => {
                 if (!sel) return;
                 while(sel.children.length > 1) sel.removeChild(sel.lastChild); // '전체 보기' 옵션 남기기

                 teachers.forEach(t=>{
                     const o = document.createElement('option'); o.value=t.name; o.textContent=t.name;
                     sel.appendChild(o.cloneNode(true));
                 });

                 if (currentUserRole !== 'manager') {
                    sel.querySelector('option[value=""]').style.display = 'none'; // '전체 보기' 숨기기
                    if (!teachers.find(t => t.name === currentUserName)) {
                         const o = document.createElement('option'); o.value=currentUserName; o.textContent=currentUserName;
                         sel.appendChild(o);
                    }
                    sel.value = currentUserName;
                    sel.disabled = true;
                 } else {
                     sel.querySelector('option[value=""]').style.display = 'block'; // '전체 보기' 보이기
                     sel.disabled = false;
                 }
            });
        }

        async function updateField(element) {
            const pageId = element.getAttribute('data-page-id');
            const propertyName = element.getAttribute('data-property-name');
            const propertyType = element.getAttribute('data-property-type');
            let newValue = element.value;
            let originalValue;

            if (element.tagName.toUpperCase() === 'INPUT') {
                originalValue = element.defaultValue;
                if (propertyType === 'number') {
                    newValue = (newValue === '') ? null : Number(newValue);
                    if (newValue !== null && isNaN(newValue)) { showToast('유효한 숫자를 입력하세요.', 'error'); element.value = originalValue || ''; return; }
                }
            } else { // SELECT
                originalValue = Array.from(element.options).find(opt => opt.defaultSelected)?.value || element.options[0].value;
            }

            if (!pageId || !propertyName) { showToast('업데이트 정보 부족', 'error'); return; }

            await submitUpdate(pageId, propertyName, newValue, propertyType, element, originalValue);
        }

        async function submitUpdate(pageId, propertyName, newValue, propertyType, element = null, originalValue = null) {
            console.log('필드 업데이트 요청:', { pageId, propertyName, newValue, propertyType });
            if (element) { element.disabled = true; element.style.opacity = '0.6'; }

            try {
                const response = await fetch(`${API_BASE_URL}/api/update-homework`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ pageId, propertyName, newValue, propertyType })
                });
                if (!response.ok) {
                    if (response.status === 401) { alert('로그인이 만료되었습니다.'); logout(); return; }
                    const errorData = await response.json(); throw new Error(errorData.message || '업데이트 실패');
                }
                const result = await response.json();
                showToast('저장되었습니다!', 'success');
                console.log('필드 업데이트 성공:', result);

                // --- UI 즉시 업데이트 ---
                if (element) {
                    const tagName = element.tagName.toUpperCase();
                    if (tagName === 'INPUT') {
                        element.defaultValue = element.value;
                    }
                    if (tagName === 'SELECT') {
                        Array.from(element.options).forEach(opt => opt.defaultSelected = false);
                        const newSelectedOption = Array.from(element.options).find(opt => opt.value == newValue);
                        if(newSelectedOption) {
                            newSelectedOption.defaultSelected = true;
                        } else {
                            element.options[0].defaultSelected = true;
                        }
                        element.className = `homework-dropdown ${getSelectStatusClass(propertyName, newValue)}`;
                    }
                }

                const row = element?.closest('tr');
                if (row && (propertyName === '단어 (맞은 개수)' || propertyName === '단어 (전체 개수)')) {
                    const correct = Number(row.querySelector('[data-property-name="단어 (맞은 개수)"]').value);
                    const total = Number(row.querySelector('[data-property-name="단어 (전체 개수)"]').value);
                    const newScore = (total > 0) ? Math.round((correct / total) * 100) : 0;
                    row.querySelector('.vocab-score').innerHTML = formatScoreCircle(newScore);
                }
                if (row && (propertyName === '문법 (전체 개수)' || propertyName === '문법 (틀린 개수)')) {
                    const total = Number(row.querySelector('[data-property-name="문법 (전체 개수)"]').value);
                    const wrong = Number(row.querySelector('[data-property-name="문법 (틀린 개수)"]').value);
                    const newScore = (total > 0) ? Math.round(((total - wrong) / total) * 100) : 0;
                    row.querySelector('.grammar-score').innerHTML = formatScoreCircle(newScore);
                }

                if (propertyType === 'relation') {
                    showToast('책 정보를 업데이트합니다. 롤업 계산 후 새로고침됩니다...', 'success');
                    refreshReadingRow(pageId);
                }
                else if (propertyType === 'status') {
                    if (currentActiveTab === 'homework') {
                        const refreshButton = element?.closest('tr')?.querySelector('.refresh-rate-btn');
                        if (refreshButton) {
                            refreshStudentRate(refreshButton, pageId);
                        }
                    } else if (currentActiveTab === 'listening') {
                         // 리스닝은 롤업 없으므로 UI만 업데이트 (이미 됨)
                         // refreshListeningRow(pageId); // 롤업 있다면 호출
                    }
                }
                // Select, Number, Text 등 다른 타입은 UI만 업데이트 (이미 됨)

            } catch (error) {
                console.error('필드 업데이트 오류:', error);
                if (element) {
                    element.value = originalValue || '';
                    if (element.tagName.toUpperCase() === 'SELECT') {
                        element.className = `homework-dropdown ${getSelectStatusClass(propertyName, originalValue)}`;
                    }
                }
                showToast(`업데이트 실패: ${error.message}`, 'error');
            } finally {
                if (element) { element.disabled = false; element.style.opacity = '1'; }
            }
        }

        async function refreshReadingRow(pageId) {
             if (!pageId) return;
            const row = document.getElementById(`row-reading-${pageId}`);
            if (!row) return;
            row.style.opacity = '0.5';

            try {
                await new Promise(resolve => setTimeout(resolve, 1000));

                const response = await fetch(`${API_BASE_URL}/api/reading-status/${pageId}`, {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                if (!response.ok) { throw new Error('학생 정보를 새로고침하지 못했습니다.'); }
                const st = await response.json();

                const newRowContent = `
                    <td class="student-name">${st.studentName || '이름 없음'}</td>
                    <td>${(st.teachers || []).join(', ') || '미배정'}</td>
                    <td>
                        ${formatSelectDropdown(st.pageId, '📖 영어독서', st.readingStatus, ['완료함', '못함'], '---')}
                    </td>
                    <td>
                        ${formatSelectDropdown(st.pageId, '어휘학습', st.vocabStatus, ['완료함', '못함', 'SKIP', '완료'], '---')}
                    </td>
                    <td class="book-title-cell">
                        <button
                            class="book-title-button ${st.bookTitle ? '' : 'empty'}"
                            data-page-id="${st.pageId}"
                            data-relation-id="${st.bookRelationId || ''}"
                            onclick="openBookSearchModal(this)">
                            ${st.bookTitle || '책 검색...'}
                        </button>
                    </td>
                    <td>${st.bookSeries || '-'}</td>
                    <td>${st.bookAR ?? '-'}</td>
                    <td>${st.bookLexile ?? '-'}</td>
                    <td>
                        ${formatSelectDropdown(st.pageId, 'Writing', st.writingStatus, ['SKIP', '북리포트', '3 SENTENCE'], '---')}
                    </td>
                `;

                row.innerHTML = newRowContent;
                row.style.opacity = '1';
                showToast(`${st.studentName} 학생 롤업 정보 업데이트 완료!`, 'success');

            } catch (error) {
                console.error('개별 행 새로고침 오류:', error);
                showToast(error.message, 'error');
                if (row) row.style.opacity = '1';
            }
        }

        // [신규] 리스닝 현황 한 줄(row) 새로고침 (롤업이 있다면 사용)
        async function refreshListeningRow(pageId) {
            if (!pageId) return;
            const row = document.getElementById(`row-listening-${pageId}`);
            if (!row) return;
            row.style.opacity = '0.5';

            try {
                // 롤업이 있다면 1초 대기, 없다면 0초
                // await new Promise(resolve => setTimeout(resolve, 1000));

                const response = await fetch(`${API_BASE_URL}/api/listening-status/${pageId}`, {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                if (!response.ok) { throw new Error('학생 정보를 새로고침하지 못했습니다.'); }
                const st = await response.json();

                const listeningOptions = ['완료', '미완료', '진행하지 않음'];
                const newRowContent = `
                    <td class="student-name">${st.studentName || '이름 없음'}</td>
                    <td>${(st.teachers || []).join(', ') || '미배정'}</td>
                    <td style="text-align: left; padding-left: 10px; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${st.listeningTextbook || ''}">
                        ${st.listeningTextbook || '-'}
                    </td>
                    <td>
                        ${formatHomeworkDropdown(st.pageId, '영어 더빙 학습 완료', st.listeningStudy, listeningOptions)}
                    </td>
                    <td>
                        ${formatHomeworkDropdown(st.pageId, '더빙 워크북 완료', st.listeningWorkbook, listeningOptions)}
                    </td>
                `;

                row.innerHTML = newRowContent;
                row.style.opacity = '1';
                showToast(`${st.studentName} 학생 정보 업데이트 완료!`, 'success');

            } catch (error) {
                console.error('개별 행 새로고침 오류:', error);
                showToast(error.message, 'error');
                if (row) row.style.opacity = '1';
            }
        }


        function showToast(message, type = 'success') {
             const existingToast = document.querySelector('.toast-message');
             if (existingToast) existingToast.remove();
             const toast = document.createElement('div');
             toast.className = `toast-message toast-${type}`;
             toast.textContent = message;
             document.body.appendChild(toast);
             setTimeout(() => { toast.classList.add('show'); }, 100);
             setTimeout(() => {
                 toast.classList.remove('show');
                 setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
             }, 3000);
        }

        function logout(){ localStorage.removeItem('teacher_auth_token'); alert("로그아웃 되었습니다."); window.location.href='/teacher-login'; }

        function checkTokenExpiry() {
             const token = localStorage.getItem('teacher_auth_token');
             if (!token) { window.location.href = '/teacher-login'; return; }
             try {
                 const payload = JSON.parse(atob(token.split('.')[1]));
                 const now = Date.now() / 1000;
                 if (payload.exp < now) { alert('로그인이 만료되었습니다.'); logout(); }
             } catch (error) { console.error('토큰 검증 오류:', error); logout(); }
        }
        setInterval(checkTokenExpiry, 5 * 60 * 1000);

        // --- 탭 전환 함수 ---
        function showTab(tabName) {
            currentActiveTab = tabName;
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            const selectedContent = document.getElementById(tabName + '-view');
            if (selectedContent) selectedContent.classList.add('active');
            const selectedButton = document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`);
            if (selectedButton) selectedButton.classList.add('active');

            syncFilters(tabName);
            loadDataForCurrentTab();
        }

        // [수정] 탭 전환 시 필터 값 동기화 (리스닝 탭 추가)
        function syncFilters(targetTabName) {
            const sourceTabName = 'homework';
            if (targetTabName === sourceTabName) {
                 toggleCustomDateInputs('_hw');
                 return;
            }

            function getSuffixForTab(tabName) {
                if (tabName === 'homework') return '_hw';
                if (tabName === 'tests') return '_test';
                if (tabName === 'reading') return '_reading';
                if (tabName === 'listening') return '_listening'; // [신규]
                return '';
            }

            const sourceSuffix = getSuffixForTab(sourceTabName); // _hw
            const targetSuffix = getSuffixForTab(targetTabName); // _test, _reading, _listening

            if (!sourceSuffix || !targetSuffix) return;

            const periodEl = document.getElementById(`periodFilter${sourceSuffix}`);
            const periodTargetEl = document.getElementById(`periodFilter${targetSuffix}`);
            if(periodEl && periodTargetEl) periodTargetEl.value = periodEl.value;

            const startEl = document.getElementById(`startDate${sourceSuffix}`);
            const startTargetEl = document.getElementById(`startDate${targetSuffix}`);
            if(startEl && startTargetEl) startTargetEl.value = startEl.value;

            const endEl = document.getElementById(`endDate${sourceSuffix}`);
            const endTargetEl = document.getElementById(`endDate${targetSuffix}`);
            if(endEl && endTargetEl) endTargetEl.value = endEl.value;

            const teacherEl = document.getElementById(`teacherFilter${sourceSuffix}`);
            const teacherTargetEl = document.getElementById(`teacherFilter${targetSuffix}`);
            if(teacherEl && teacherTargetEl) teacherTargetEl.value = teacherEl.value;

            toggleCustomDateInputs(targetSuffix); // 타겟 탭의 커스텀 날짜 UI 토글
        }

        // --- 책 검색 모달 관련 함수 ---
        function openBookSearchModal(buttonElement) {
            currentModalContext.pageId = buttonElement.getAttribute('data-page-id');
            const currentTitle = buttonElement.textContent.trim();

            const modal = document.getElementById('bookSearchModal');
            const input = document.getElementById('modalSearchInput');

            if (currentTitle !== '책 검색...') {
                input.value = currentTitle;
            } else {
                input.value = '';
            }

            modal.classList.add('show');
            input.focus();
            searchBooks(input.value); // 현재 값으로 즉시 검색
        }

        function closeBookSearchModal() {
             document.getElementById('bookSearchModal').classList.remove('show');
             currentModalContext = {}; // 컨텍스트 초기화
        }

        async function searchBooks(query) {
            const resultsList = document.getElementById('modalSearchResults');
            if (!query || query.trim().length < 2) {
                resultsList.innerHTML = '<div class="no-data" style="padding: 30px;">검색어를 2자 이상 입력해주세요.</div>';
                return;
            }
            resultsList.innerHTML = '<div class="loading" style="padding: 30px;">검색 중...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/search-books?query=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                if (!response.ok) throw new Error('검색 API 오류');
                const books = await response.json();

                if (books.length === 0) {
                    resultsList.innerHTML = '<div class="no-data" style="padding: 30px;">검색 결과가 없습니다.</div>';
                    return;
                }

                resultsList.innerHTML = books.map(book => `
                    <div class="result-item" onclick="selectBook('${book.id}', '${book.title.replace(/'/g, "\\'")}')">
                        <div class="result-title">${book.title}</div>
                        <div class="result-meta">저자: ${book.author || 'N/A'} | 레벨: ${book.level || 'N/A'}</div>
                    </div>
                `).join('');

            } catch (error) {
                console.error("책 검색 오류:", error);
                resultsList.innerHTML = '<div class="no-data" style="color: red; padding: 30px;">검색 중 오류 발생</div>';
            }
        }

        async function selectBook(bookPageId, bookTitle) { // bookTitle은 '책 검색...'이 될 수도 있음
            if (!currentModalContext.pageId) return;

            const pageId = currentModalContext.pageId;

            // 1. 모달 닫기
            closeBookSearchModal();

            // 2. UI 즉시 업데이트 (버튼 텍스트 변경)
            const buttonElement = document.querySelector(`.book-title-button[data-page-id="${pageId}"]`);
            if (buttonElement) {
                buttonElement.textContent = bookTitle;
                if (bookPageId) {
                    buttonElement.classList.remove('empty');
                    buttonElement.setAttribute('data-relation-id', bookPageId);
                } else {
                    buttonElement.classList.add('empty');
                    buttonElement.setAttribute('data-relation-id', '');
                }
            }

            // 3. 서버에 업데이트 요청 (공통 함수 사용)
            await submitUpdate(
                pageId,
                '오늘 읽은 영어 책', // 노션의 '관계형' 속성 이름
                bookPageId, // null 또는 pageId
                'relation' // 타입
            );
        }

    </script>
</body>
</html>

