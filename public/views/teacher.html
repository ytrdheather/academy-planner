<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ - ë¦¬ë””íŠœë“œ</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "NanumSquareRound", sans-serif; }
        body { background: #f8f9fa; color: #2d3748; min-height: 100vh; padding: 0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        
        /* í—¤ë” */
        .header { background: #ffffff; color: #6b46c1; padding: 20px 30px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; margin: 0; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-name { font-weight: 600; }
        .logout-btn { background: #6b46c1; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s; }
        .logout-btn:hover { background: #5a3eaa; }

        /* íƒ­ ë©”ë‰´ */
        .tab-menu { display: flex; background-color: #ffffff; border-bottom: 1px solid #e2e8f0; padding: 0 40px; margin-top: 20px; border-radius: 12px 12px 0 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-button { padding: 15px 25px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: 600; color: #6b7280; position: relative; transition: color 0.3s; }
        .tab-button.active { color: #6b46c1; }
        .tab-button.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: #8b5cf6; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { padding: 30px 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .content-section { background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); border: 1px solid #e9ecef; padding: 30px; margin-bottom: 30px; }
        .section-title { font-size: 1.6em; font-weight: 700; color: #6b46c1; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        
        /* í•„í„° ì˜ì—­ */
        .filters-container { display:flex; gap:15px; margin-bottom:25px; align-items:center; flex-wrap: wrap; }
        .refresh-btn { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; }
        .filter-group { display:flex; align-items:center; gap:8px; }
        .filter-label { font-weight: 600; color: #4a5568; margin-right: 5px; }
        .filter-select, .filter-input { padding:8px 12px; border-radius:8px; border:2px solid #e2e8f0; font-size: 14px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container { overflow-x: auto; border: 1px solid #e9ecef; border-radius: 12px; }
        .styled-table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 1000px; }
        .styled-table th { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; padding: 12px 10px; text-align: center; font-weight: 600; white-space: nowrap; }
        .styled-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #f1f3f4; vertical-align: middle; }
        .student-name { font-weight: 600; color: #2d3748; text-align: left; padding-left: 15px; min-width: 160px; }
        
        /* ë¡œë”© ë° ë°ì´í„° ì—†ìŒ */
        .loading, .no-data { text-align: center; padding: 40px; color: #718096; font-size: 16px; }

        /* ì±… íƒœê·¸ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .book-list-cell { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; justify-content: center; min-width: 250px; }
        .book-tag { background: #f3e8ff; color: #6b46c1; border: 1px solid #d8b4fe; border-radius: 12px; padding: 4px 10px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .book-tag .remove-btn { cursor: pointer; font-weight: bold; color: #9333ea; font-size: 14px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .book-tag .remove-btn:hover { background: #e9d5ff; }
        .book-add-btn { background: #e9d5ff; color: #6b46c1; border: 1px dashed #d8b4fe; border-radius: 12px; padding: 4px 10px; font-size: 12px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .book-add-btn:hover { background: #d8b4fe; transform: translateY(-1px); }

        /* ìˆ™ì œ ìƒíƒœ ë²„íŠ¼ (í† ê¸€ìš©) */
        .status-badge {
            padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; display: inline-block; min-width: 60px; text-align: center; border: 1px solid transparent; transition: all 0.2s; user-select: none;
        }
        .status-badge:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .status-complete { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .status-incomplete { background-color: #fecaca; color: #991b1b; border-color: #fca5a5; }
        .status-none { background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db; }
        
        /* 3ë‹¨ ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ ê·¸ë£¹ */
        .batch-controls {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        .batch-btn {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            flex: 1;
        }
        .batch-btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .batch-ok { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .batch-no { background-color: #fecaca; color: #991b1b; border-color: #fca5a5; }
        .batch-reset { background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db; }

        .homework-dropdown { padding: 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px; font-weight: 600; text-align: center; cursor: pointer; background: white; }
        .editable-input { padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center; width: 60px; }
        .editable-input:focus { border-color: #8b5cf6; outline: none; }
        .editable-text-input { width: 120px; text-align: left; }

        /* ì½”ë©˜íŠ¸ íƒ­ */
        .comment-textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; min-height: 60px; resize: none; overflow-y: hidden; line-height: 1.5; }
        .comment-textarea:focus { border-color: #8b5cf6; outline: none; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
        
        /* ë²„íŠ¼ ê·¸ë£¹ ì»¨í…Œì´ë„ˆ */
        .report-btn-group { display: flex; flex-direction: column; gap: 5px; align-items: stretch; min-width: 100px; }
        .action-btn { border: none; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; }
        .btn-save { background: #10b981; color: white; } .btn-save:hover { background: #059669; }
        .btn-daily-view { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; } .btn-daily-view:hover { background: #bae6fd; }
        .btn-daily-copy { background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; } .btn-daily-copy:hover { background: #e0e7ff; }
        .btn-monthly-view { background: #f3e8ff; color: #7e22ce; border: 1px solid #d8b4fe; } .btn-monthly-view:hover { background: #d8b4fe; }
        .btn-monthly-copy { background: #fdf4ff; color: #a855f7; border: 1px solid #f0abfc; } .btn-monthly-copy:hover { background: #fae8ff; }

        /* ëª¨ë‹¬ & í† ìŠ¤íŠ¸ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-search-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; font-size: 16px; }
        .modal-search-results { max-height: 300px; overflow-y: auto; border: 1px solid #f1f3f4; border-radius: 8px; }
        .result-item { padding: 12px; border-bottom: 1px solid #f1f3f4; cursor: pointer; transition: background 0.2s; }
        .result-item:hover { background: #f8f9ff; }
        .result-item:last-child { border-bottom: none; }
        
        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
        .toast-message { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; background: #333; color: white; opacity: 0; transform: translateX(100%); transition: all 0.3s; z-index: 3000; }
        .toast-message.show { opacity: 1; transform: translateX(0); }
        .toast-message.success { background: #10b981; } .toast-message.error { background: #ef4444; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“š ë¦¬ë””íŠœë“œ ì„ ìƒë‹˜</h1>
        <div class="user-info">
            <span class="user-name" id="userName">ë¡œë”©ì¤‘...</span>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="container">
        <div class="tab-menu">
            <button class="tab-button active" onclick="showTab('homework')">ìˆ™ì œ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('tests')">í…ŒìŠ¤íŠ¸ ê²°ê³¼</button>
            <button class="tab-button" onclick="showTab('reading')">ì›ì„œ ë…ì„œ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('listening')">ë¦¬ìŠ¤ë‹ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('comments')">ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</button>
        </div>

        <div class="main-content">
            
            <!-- 1. ìˆ™ì œ í˜„í™© íƒ­ -->
            <div id="homework-view" class="tab-content active">
                <div class="content-section">
                    <div class="section-title">ğŸ“‹ ë‹´ë‹¹ í•™ìƒ ìˆ™ì œ í˜„í™©</div>
                    <div class="filters-container">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        
                        <div class="filter-group">
                            <label class="filter-label">ê¸°ê°„:</label>
                            <select id="periodFilter_hw" class="filter-select" onchange="toggleDateInput('hw')">
                                <option value="today" selected>ì˜¤ëŠ˜</option>
                                <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                            </select>
                            <input type="date" id="specificDate_hw" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
                        </div>

                        <div class="filter-group" id="teacherFilterGroup_hw" style="display:none;">
                            <label class="filter-label">ë‹´ë‹¹ê°•ì‚¬:</label>
                            <select id="teacherFilter_hw" class="filter-select" onchange="filterDataByTeacher()">
                                <option value="">ì „ì²´ ë³´ê¸°</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>â­• ë¬¸ë²•</th> <th>1ï¸âƒ£ ì–´íœ˜</th> <th>2ï¸âƒ£ ë…í•´í´ê°€</th> <th>4ï¸âƒ£ Sum</th> <th>5ï¸âƒ£ ë§¤ì¼ ë…í•´</th> <th>6ï¸âƒ£ ì¼ê¸°</th> <th>ìˆ˜í–‰ìœ¨</th> </tr></thead>
                            <tbody id="homeworkTableBody"><tr><td colspan="9" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. í…ŒìŠ¤íŠ¸ ê²°ê³¼ íƒ­ -->
            <div id="tests-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ“ ë‹´ë‹¹ í•™ìƒ í…ŒìŠ¤íŠ¸ ê²°ê³¼</div>
                    <div class="filters-container">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        
                        <div class="filter-group">
                            <label class="filter-label">ê¸°ê°„:</label>
                            <select id="periodFilter_tests" class="filter-select" onchange="toggleDateInput('tests')">
                                <option value="today" selected>ì˜¤ëŠ˜</option>
                                <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                            </select>
                            <input type="date" id="specificDate_tests" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
                        </div>

                        <div class="filter-group" id="teacherFilterGroup_tests" style="display:none;">
                            <label class="filter-label">ë‹´ë‹¹ê°•ì‚¬:</label>
                            <select id="teacherFilter_tests" class="filter-select" onchange="filterDataByTeacher()">
                                <option value="">ì „ì²´ ë³´ê¸°</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ì–´íœ˜ìœ ë‹›</th> <th>ì–´íœ˜ì •ë‹µ</th> <th>ì´ê°¯ìˆ˜</th> <th>ì–´íœ˜ì ìˆ˜</th> <th>ë…í•´ì˜¤ë‹µ</th> <th>ë…í•´ê²°ê³¼</th> <th>í•˜ë¸Œë£¨íƒ€</th> <th>ë¬¸ë²•ë¬¸í•­</th> <th>ë¬¸ë²•ì˜¤ë‹µ</th> <th>ë¬¸ë²•ì ìˆ˜</th> </tr></thead>
                            <tbody id="testsTableBody"><tr><td colspan="11" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. ì›ì„œ ë…ì„œ í˜„í™© íƒ­ -->
            <div id="reading-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ“š ì›ì„œ ë…ì„œ í˜„í™© (ë‹¤ì¤‘ ì…ë ¥)</div>
                    <div class="filters-container">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        
                        <div class="filter-group">
                            <label class="filter-label">ê¸°ê°„:</label>
                            <select id="periodFilter_reading" class="filter-select" onchange="toggleDateInput('reading')">
                                <option value="today" selected>ì˜¤ëŠ˜</option>
                                <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                            </select>
                            <input type="date" id="specificDate_reading" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
                        </div>

                        <div class="filter-group" id="teacherFilterGroup_reading" style="display:none;">
                            <label class="filter-label">ë‹´ë‹¹ê°•ì‚¬:</label>
                            <select id="teacherFilter_reading" class="filter-select" onchange="filterDataByTeacher()">
                                <option value="">ì „ì²´ ë³´ê¸°</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ğŸ“– ì˜ì–´ë…ì„œ</th> <th>ì–´íœ˜í•™ìŠµ</th> <th>ğŸ“š ì½ì€ ì±… ëª©ë¡ (íƒœê·¸)</th> <th>Writing</th> </tr></thead>
                            <tbody id="readingTableBody"><tr><td colspan="6" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. ë¦¬ìŠ¤ë‹ í˜„í™© íƒ­ -->
            <div id="listening-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ§ ë¦¬ìŠ¤ë‹ í˜„í™©</div>
                    <div class="filters-container">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        
                        <div class="filter-group">
                            <label class="filter-label">ê¸°ê°„:</label>
                            <select id="periodFilter_listening" class="filter-select" onchange="toggleDateInput('listening')">
                                <option value="today" selected>ì˜¤ëŠ˜</option>
                                <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                            </select>
                            <input type="date" id="specificDate_listening" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
                        </div>

                        <div class="filter-group" id="teacherFilterGroup_listening" style="display:none;">
                            <label class="filter-label">ë‹´ë‹¹ê°•ì‚¬:</label>
                            <select id="teacherFilter_listening" class="filter-select" onchange="filterDataByTeacher()">
                                <option value="">ì „ì²´ ë³´ê¸°</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ë“£ê¸° í•™ìŠµ</th> <th>ë“£ê¸° ì›Œí¬ë¶</th> </tr></thead>
                            <tbody id="listeningTableBody"><tr><td colspan="4" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸ íƒ­ -->
            <div id="comments-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ’¬ ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</div>
                    <div class="filters-container">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        
                        <div class="filter-group">
                            <label class="filter-label">ê¸°ê°„:</label>
                            <select id="periodFilter_comments" class="filter-select" onchange="toggleDateInput('comments')">
                                <option value="today" selected>ì˜¤ëŠ˜</option>
                                <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                            </select>
                            <input type="date" id="specificDate_comments" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
                        </div>

                        <div class="filter-group" id="teacherFilterGroup_comments" style="display:none;">
                            <label class="filter-label">ë‹´ë‹¹ê°•ì‚¬:</label>
                            <select id="teacherFilter_comments" class="filter-select" onchange="filterDataByTeacher()">
                                <option value="">ì „ì²´ ë³´ê¸°</option>
                            </select>
                        </div>
                        
                        <button class="refresh-btn" style="background:#6b46c1; margin-left:auto;" onclick="saveAllComments(this)">ğŸ’¾ ì¼ê´„ ì €ì¥</button>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <colgroup><col style="width:8%"><col style="width:8%"><col style="width:10%"><col style="width:50%"><col style="width:24%"></colgroup>
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ë¬¸ë²• í´ë˜ìŠ¤</th> <th>ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</th> <th>ê´€ë¦¬</th> </tr></thead>
                            <tbody id="commentsTableBody"><tr><td colspan="5" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ì±… ê²€ìƒ‰ ëª¨ë‹¬, ë¦¬í¬íŠ¸ ëª¨ë‹¬ (ë™ì¼) -->
    <div id="bookSearchModal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-bottom:15px; color:#6b46c1;">ğŸ“š ì±… ì¶”ê°€í•˜ê¸°</h2>
            <input type="text" id="modalSearchInput" class="modal-search-input" placeholder="ì±… ì œëª© ê²€ìƒ‰..." autocomplete="off">
            <div id="modalSearchResults" class="modal-search-results"></div>
            <button onclick="document.getElementById('bookSearchModal').classList.remove('show')" style="width:100%; padding:10px; margin-top:15px; border:none; background:#f3f4f6; border-radius:8px; cursor:pointer;">ë‹«ê¸°</button>
        </div>
    </div>
    <div id="reportModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="reportModalTitle" style="margin-bottom:15px; color:#6b46c1;">ğŸ”— ë¦¬í¬íŠ¸ ë§í¬</h2>
            <p id="reportModalDesc" style="margin-bottom:15px; font-size:14px; color:#4b5563;"></p>
            <input type="text" id="reportLinkInput" class="modal-search-input" readonly>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button onclick="document.getElementById('reportModal').classList.remove('show')" style="padding:8px 16px; border:1px solid #e5e7eb; background:white; border-radius:6px; cursor:pointer;">ë‹«ê¸°</button>
                <button id="copyReportLinkBtn" onclick="copyReportLink()" style="padding:8px 16px; background:#6b46c1; color:white; border:none; border-radius:6px; cursor:pointer;">ë³µì‚¬í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let authToken = localStorage.getItem('teacher_auth_token');
        let allReportData = [];
        let currentActiveTab = 'homework';
        let bookSearchTimer = null;
        let currentEditingPageId = null;
        let currentUserRole = '';
        let currentUserName = '';

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) { window.location.href='/teacher-login'; return; }
            setAllFiltersToToday();
            loadUserInfo();
            showTab('homework');
            
            document.getElementById('modalSearchInput').addEventListener('input', (e) => {
                clearTimeout(bookSearchTimer);
                bookSearchTimer = setTimeout(() => searchEngBooks(e.target.value), 300);
            });
        });

        function setAllFiltersToToday() {
            const suffixes = ['hw', 'tests', 'reading', 'listening', 'comments'];
            suffixes.forEach(s => {
                const sel = document.getElementById(`periodFilter_${s}`);
                if(sel) sel.value = 'today';
                const dateInp = document.getElementById(`specificDate_${s}`);
                if(dateInp) dateInp.style.display = 'none';
            });
        }

        async function loadUserInfo() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/teacher/user-info`, { headers:{Authorization:'Bearer '+authToken} });
                const data = await res.json();
                currentUserName = data.userName;
                currentUserRole = data.userRole;
                document.getElementById('userName').textContent = `${data.userName} (${data.userRole === 'manager' ? 'ê´€ë¦¬ì' : 'ì„ ìƒë‹˜'})`;
                loadTeachersList();
            } catch (e) { logout(); }
        }

        async function loadTeachersList() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/teachers`, { headers:{Authorization:'Bearer '+authToken} });
                const teachers = await res.json();
                ['hw', 'tests', 'reading', 'listening', 'comments'].forEach(tabId => {
                    const container = document.getElementById(`teacherFilterGroup_${tabId}`);
                    const select = document.getElementById(`teacherFilter_${tabId}`);
                    if (currentUserRole === 'manager') {
                        container.style.display = 'flex';
                        teachers.forEach(t => { const opt = document.createElement('option'); opt.value = t.name; opt.textContent = t.name; select.appendChild(opt); });
                    } else {
                        container.style.display = 'flex';
                        const myOpt = document.createElement('option'); myOpt.value = currentUserName; myOpt.textContent = currentUserName + ' (ë‚˜)'; select.appendChild(myOpt);
                        select.value = currentUserName; select.disabled = true;
                    }
                });
            } catch(e) { console.error(e); }
        }

        function filterDataByTeacher() {
            const tabSuffix = currentActiveTab === 'homework' ? 'hw' : currentActiveTab;
            const teacherSelect = document.getElementById(`teacherFilter_${tabSuffix}`);
            const selectedTeacher = teacherSelect ? teacherSelect.value : '';
            let filteredData = allReportData;
            if (selectedTeacher) { filteredData = allReportData.filter(item => item.teachers && item.teachers.includes(selectedTeacher)); }
            displayDataForAllTabs(filteredData);
        }

        function toggleDateInput(tabId) {
            const period = document.getElementById(`periodFilter_${tabId}`).value;
            const dateInput = document.getElementById(`specificDate_${tabId}`);
            dateInput.style.display = period === 'specific_date' ? 'block' : 'none';
            if (period === 'today') loadDataForCurrentTab();
        }

        async function loadDataForCurrentTab() {
            const tabSuffix = currentActiveTab === 'homework' ? 'hw' : currentActiveTab;
            const periodElem = document.getElementById(`periodFilter_${tabSuffix}`);
            const dateElem = document.getElementById(`specificDate_${tabSuffix}`);
            const period = periodElem ? periodElem.value : 'today';
            const date = dateElem ? dateElem.value : '';
            let url = `${API_BASE_URL}/api/daily-report-data?period=${period}`;
            if (period === 'specific_date' && date) url += `&date=${date}`;

            try {
                const res = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!res.ok) throw new Error('Load failed');
                allReportData = await res.json();
                filterDataByTeacher();
            } catch (e) { console.error(e); alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'); }
        }

        function displayDataForAllTabs(data) {
            displayHomeworkData(data);
            displayTestData(data);
            displayReadingData(data);
            displayListeningData(data);
            displayCommentData(data);
        }

        // [1. ìˆ™ì œ í˜„í™©] 3ë‹¨ ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ ì¶”ê°€ + ì¦‰ì‹œ ë°˜ì˜ (Optimistic UI)
        function displayHomeworkData(data) {
            const tbody = document.getElementById('homeworkTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="9" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `<tr id="row-hw-${st.pageId}">
                <td class="student-name">
                    <div>${st.studentName}</div>
                    <div class="batch-controls">
                        <button class="batch-btn batch-ok" onclick="markAllHomework('${st.pageId}', 'ìˆ™ì œ í•¨')" title="ì „ì²´ ì™„ë£Œ">ì „ì²´O</button>
                        <button class="batch-btn batch-no" onclick="markAllHomework('${st.pageId}', 'ì•ˆ í•´ì˜´')" title="ì „ì²´ ë¯¸ì™„ë£Œ">ì „ì²´X</button>
                        <button class="batch-btn batch-reset" onclick="markAllHomework('${st.pageId}', 'í•´ë‹¹ ì—†ìŒ')" title="ëª¨ë‘ ì—†ìŒ">ì´ˆê¸°í™”</button>
                    </div>
                </td>
                <td>${(st.teachers||[]).join(', ')}</td>
                <td>${renderToggleBadge(st.pageId, 'â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬', st.homework.grammar)}</td>
                <td>${renderToggleBadge(st.pageId, '1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ', st.homework.vocabCards)}</td>
                <td>${renderToggleBadge(st.pageId, '2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ', st.homework.readingCards)}</td>
                <td>${renderToggleBadge(st.pageId, '4ï¸âƒ£ Summary ìˆ™ì œ', st.homework.summary)}</td>
                <td>${renderToggleBadge(st.pageId, '5ï¸âƒ£ ë§¤ì¼ ë…í•´ ìˆ™ì œ', st.homework.dailyReading)}</td>
                <td>${renderToggleBadge(st.pageId, '6ï¸âƒ£ ì˜ì–´ì¼ê¸° or ê°œì¸ ë…í•´ì„œ', st.homework.diary)}</td>
                <td style="font-weight:bold; color:${st.completionRate>=80?'#10b981':'#ef4444'}">${st.completionRate}%</td>
            </tr>`).join('');
        }

        function renderToggleBadge(pageId, prop, val) {
            const statusMap = { 'ìˆ™ì œ í•¨': 'status-complete', 'ì™„ë£Œ': 'status-complete', 'ì•ˆ í•´ì˜´': 'status-incomplete', 'ë¯¸ì™„ë£Œ': 'status-incomplete', 'ìˆ™ì œ ì—†ìŒ': 'status-none', 'í•´ë‹¹ ì—†ìŒ': 'status-none', 'ì§„í–‰í•˜ì§€ ì•ŠìŒ': 'status-none' };
            const displayVal = val || 'ìˆ™ì œ ì—†ìŒ';
            const cls = statusMap[displayVal] || 'status-none';
            // data ì†ì„±ì„ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ìƒíƒœ ì €ì¥
            return `<span class="status-badge ${cls}" data-page-id="${pageId}" data-prop="${prop}" data-val="${displayVal}" onclick="handleBadgeClick(this)">${displayVal}</span>`;
        }

        async function handleBadgeClick(el) {
            const pageId = el.getAttribute('data-page-id');
            const prop = el.getAttribute('data-prop');
            const currentVal = el.getAttribute('data-val');
            
            const sequence = ['ìˆ™ì œ í•¨', 'ì•ˆ í•´ì˜´', 'í•´ë‹¹ ì—†ìŒ'];
            let nextIndex = sequence.indexOf(currentVal) + 1;
            if (nextIndex >= sequence.length) nextIndex = 0;
            const nextVal = sequence[nextIndex];
            
            // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
            updateBadgeUI(el, nextVal);
            
            // API í˜¸ì¶œ
            await updateField(null, pageId, prop, 'status', nextVal);
        }

        function updateBadgeUI(el, val) {
            el.textContent = val;
            el.setAttribute('data-val', val);
            let cls = 'status-none';
            if (val === 'ìˆ™ì œ í•¨' || val === 'ì™„ë£Œ') cls = 'status-complete';
            else if (val === 'ì•ˆ í•´ì˜´' || val === 'ë¯¸ì™„ë£Œ') cls = 'status-incomplete';
            el.className = `status-badge ${cls}`;
        }

        // [ì¼ê´„ ì²˜ë¦¬ í•¨ìˆ˜] (status: ìˆ™ì œ í•¨ / ì•ˆ í•´ì˜´ / í•´ë‹¹ ì—†ìŒ)
        async function markAllHomework(pageId, status) {
            const msg = status === 'ìˆ™ì œ í•¨' ? 'ì™„ë£Œ' : (status === 'ì•ˆ í•´ì˜´' ? 'ë¯¸ì™„ë£Œ' : 'ì—†ìŒ(ì´ˆê¸°í™”)');
            if (!confirm(`ì´ í•™ìƒì˜ ëª¨ë“  ìˆ™ì œë¥¼ "${msg}" ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const props = ['â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬', '1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ', '2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ', '4ï¸âƒ£ Summary ìˆ™ì œ', '5ï¸âƒ£ ë§¤ì¼ ë…í•´ ìˆ™ì œ', '6ï¸âƒ£ ì˜ì–´ì¼ê¸° or ê°œì¸ ë…í•´ì„œ'];
            
            // 1. ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (Optimistic UI)
            const row = document.getElementById(`row-hw-${pageId}`);
            if (row) {
                const badges = row.querySelectorAll('.status-badge');
                badges.forEach(badge => {
                    updateBadgeUI(badge, status);
                });
            }

            try {
                // 2. ë°±ê·¸ë¼ìš´ë“œ API ì—…ë°ì´íŠ¸
                await Promise.all(props.map(prop => fetch(`${API_BASE_URL}/api/update-homework`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ pageId, propertyName: prop, newValue: status, propertyType: 'status' })
                })));
                showToast(`ëª¨ë‘ "${status}" ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                // loadDataForCurrentTab(); // UIê°€ ì´ë¯¸ ì—…ë°ì´íŠ¸ë˜ì—ˆìœ¼ë¯€ë¡œ êµ³ì´ ë¦¬ë¡œë“œ ì•ˆ í•´ë„ ë¨ (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
            } catch(e) { 
                showToast('ì²˜ë¦¬ ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨ í•„ìš”)', 'error'); 
                loadDataForCurrentTab(); // ì‹¤íŒ¨ ì‹œ ì›ìƒë³µêµ¬ ìœ„í•´ ë¦¬ë¡œë“œ
            }
        }

        // --- ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜ë“¤ ---
        function displayReadingData(data) {
            const tbody = document.getElementById('readingTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="6" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => {
                const books = st.reading.englishBooks || [];
                const bookTags = books.map(book => {
                    let infoText = '';
                    if (book.ar || book.lexile) {
                        const parts = []; if (book.ar) parts.push(`AR ${book.ar}`); if (book.lexile) parts.push(`Lex ${book.lexile}`);
                        infoText = ` <span style="opacity:0.7; font-weight:normal; font-size:0.9em;">(${parts.join(' / ')})</span>`;
                    }
                    return `<span class="book-tag">${book.title}${infoText} <span class="remove-btn" onclick="removeBook('${st.pageId}', '${book.id}')">Ã—</span></span>`;
                }).join('');
                const addButton = `<button class="book-add-btn" onclick="openAddBookModal('${st.pageId}')">+ ì¶”ê°€</button>`;
                return `<tr>
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers || []).join(', ')}</td>
                    <td>${formatSelect(st.pageId, 'ğŸ“– ì˜ì–´ë…ì„œ', st.reading.readingStatus, ['ì™„ë£Œí•¨', 'ëª»í•¨'])}</td>
                    <td>${formatSelect(st.pageId, 'ì–´íœ˜í•™ìŠµ', st.reading.vocabStatus, ['ì™„ë£Œ', 'SKIP', 'ë¯¸ì™„ë£Œ'])}</td>
                    <td class="book-list-cell">${bookTags}${addButton}</td>
                    <td>${formatSelect(st.pageId, 'Writing', st.reading.writingStatus, ['SKIP', 'ë¶ë¦¬í¬íŠ¸', '3 SENTENCE'])}</td>
                </tr>`;
            }).join('');
        }

        function openAddBookModal(pageId) { currentEditingPageId = pageId; const modal = document.getElementById('bookSearchModal'); document.getElementById('modalSearchInput').value = ''; document.getElementById('modalSearchResults').innerHTML = ''; modal.classList.add('show'); document.getElementById('modalSearchInput').focus(); }
        async function searchEngBooks(query) { const list = document.getElementById('modalSearchResults'); if(query.length < 2) { list.innerHTML = ''; return; } list.innerHTML = '<div class="loading">ê²€ìƒ‰ì¤‘...</div>'; try { const res = await fetch(`${API_BASE_URL}/api/search-books?query=${encodeURIComponent(query)}`, { headers: { 'Authorization': 'Bearer ' + authToken } }); const books = await res.json(); if(!books.length) { list.innerHTML = '<div class="no-data">ê²°ê³¼ ì—†ìŒ</div>'; return; } list.innerHTML = books.map(b => `<div class="result-item" onclick="addBook('${b.id}')"><div style="font-weight:bold;">${b.title}</div><div style="font-size:12px; color:#666;">${b.author || ''}</div></div>`).join(''); } catch(e) { list.innerHTML = 'ì˜¤ë¥˜'; } }
        async function addBook(newId) { if(!currentEditingPageId) return; document.getElementById('bookSearchModal').classList.remove('show'); const row = allReportData.find(d => d.pageId === currentEditingPageId); const currIds = (row.reading.englishBooks || []).map(b => b.id).filter(id => id); if(currIds.includes(newId)) { showToast('ì´ë¯¸ ìˆìŒ', 'error'); return; } await updateBookRelation(currentEditingPageId, [...currIds, newId]); }
        async function removeBook(pid, rid) { if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; const row = allReportData.find(d => d.pageId === pid); const currIds = (row.reading.englishBooks || []).map(b => b.id).filter(id => id); await updateBookRelation(pid, currIds.filter(id => id !== rid)); }
        async function updateBookRelation(pid, ids) { try { await fetch(`${API_BASE_URL}/api/update-homework`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify({ pageId: pid, propertyName: 'ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…', newValue: ids, propertyType: 'relation' }) }); showToast('ì—…ë°ì´íŠ¸ ì™„ë£Œ'); loadDataForCurrentTab(); } catch(e) { showToast('ì‹¤íŒ¨', 'error'); } }

        function displayTestData(data) { const tbody = document.getElementById('testsTableBody'); if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="11" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; } tbody.innerHTML = data.map(st => `<tr><td class="student-name">${st.studentName}</td><td><input class="editable-input editable-text-input" value="${st.tests.vocabUnit||''}" onchange="updateField(this, '${st.pageId}', 'ì–´íœ˜ìœ ë‹›', 'rich_text')"></td><td><input class="editable-input" type="number" value="${st.tests.vocabCorrect||''}" onchange="updateField(this, '${st.pageId}', 'ë‹¨ì–´(ë§ì€ ê°œìˆ˜)', 'number')"></td><td><input class="editable-input" type="number" value="${st.tests.vocabTotal||''}" onchange="updateField(this, '${st.pageId}', 'ë‹¨ì–´(ì „ì²´ ê°œìˆ˜)', 'number')"></td><td>${st.tests.vocabScore}</td><td><input class="editable-input" type="number" value="${st.tests.readingWrong||''}" onchange="updateField(this, '${st.pageId}', 'ë…í•´(í‹€ë¦° ê°œìˆ˜)', 'number')"></td><td>${st.tests.readingResult}</td><td>${formatSelect(st.pageId, 'ë…í•´ í•˜ë¸Œë£¨íƒ€', st.tests.havruta, ['ì™„ë£Œí•¨', 'ëª»í•˜ê³ ê°', 'ìˆ™ì œì—†ìŒ'])}</td><td><input class="editable-input" type="number" value="${st.tests.grammarTotal||''}" onchange="updateField(this, '${st.pageId}', 'ë¬¸ë²•(ì „ì²´ ê°œìˆ˜)', 'number')"></td><td><input class="editable-input" type="number" value="${st.tests.grammarWrong||''}" onchange="updateField(this, '${st.pageId}', 'ë¬¸ë²•(í‹€ë¦° ê°œìˆ˜)', 'number')"></td><td>${st.tests.grammarScore}</td></tr>`).join(''); }
        function displayListeningData(data) { const tbody = document.getElementById('listeningTableBody'); if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="4" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; } tbody.innerHTML = data.map(st => `<tr><td class="student-name">${st.studentName}</td><td>${(st.teachers||[]).join(', ')}</td><td>${formatStatus(st.pageId, 'ì˜ì–´ ë”ë¹™ í•™ìŠµ ì™„ë£Œ', st.listening.study)}</td><td>${formatStatus(st.pageId, 'ë”ë¹™ ì›Œí¬ë¶ ì™„ë£Œ', st.listening.workbook)}</td></tr>`).join(''); }
        function displayCommentData(data) { const tbody = document.getElementById('commentsTableBody'); if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="5" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; } tbody.innerHTML = data.map(st => `<tr id="row-comment-${st.pageId}"><td class="student-name">${st.studentName}</td><td>${(st.teachers||[]).join(', ')}</td><td>${st.comment.grammarClass||'-'}</td><td style="vertical-align:top;"><textarea class="comment-textarea" oninput="autoResizeTextarea(this); markCommentAsChanged(this)" data-page-id="${st.pageId}" defaultValue="${st.comment.teacherComment || ''}">${st.comment.teacherComment || ''}</textarea></td><td style="vertical-align:top;"><div class="report-btn-group"><button class="action-btn btn-save comment-save-btn" onclick="updateComment(this, '${st.pageId}')">ì €ì¥</button><button class="action-btn btn-daily-view" onclick="window.open('${API_BASE_URL}/report?pageId=${st.pageId}&date=${st.date}', '_blank')">ë°ì¼ë¦¬ ë³´ê¸°</button><button class="action-btn btn-daily-copy" onclick="copyText('${API_BASE_URL}/report?pageId=${st.pageId}&date=${st.date}')">ë°ì¼ë¦¬ ë³µì‚¬</button><button class="action-btn btn-monthly-view" onclick="viewMonthlyReport('${st.studentName}', '${st.date}')">ì›”ê°„ ë³´ê¸°</button><button class="action-btn btn-monthly-copy" onclick="openMonthlyReportModal('${st.studentName}', '${st.date}')">ì›”ê°„ ë³µì‚¬</button></div></td></tr>`).join(''); document.querySelectorAll('.comment-textarea').forEach(el => autoResizeTextarea(el)); }

        function autoResizeTextarea(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }
        function markCommentAsChanged(el) { const row = el.closest('tr'); const btn = row.querySelector('.comment-save-btn'); if(el.value !== el.defaultValue) { el.style.backgroundColor = '#fffbeb'; btn.textContent = 'ì €ì¥*'; btn.style.background = '#ef4444'; row.classList.add('needs-save'); } else { el.style.backgroundColor = 'white'; btn.textContent = 'ì €ì¥'; btn.style.background = '#10b981'; row.classList.remove('needs-save'); } }
        async function updateComment(btn, pageId) { const row = btn.closest('tr'); const ta = row.querySelector('.comment-textarea'); const val = ta.value; btn.disabled = true; btn.textContent = 'ì €ì¥ì¤‘...'; try { await fetch(`${API_BASE_URL}/api/update-homework`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify({ pageId, propertyName: "â¤ Today's Notice!", newValue: val, propertyType: 'rich_text' }) }); showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); ta.defaultValue = val; markCommentAsChanged(ta); } catch(e) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); } finally { btn.disabled = false; } }
        async function saveAllComments(batchBtn) { const rows = document.querySelectorAll('tr.needs-save'); if(!rows.length) { showToast('ì €ì¥í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.'); return; } batchBtn.disabled = true; let count = 0; for(const row of rows) { const btn = row.querySelector('.comment-save-btn'); const pageId = row.id.replace('row-comment-', ''); await updateComment(btn, pageId); count++; batchBtn.textContent = `ì €ì¥ì¤‘... ${count}/${rows.length}`; } batchBtn.disabled = false; batchBtn.textContent = 'ğŸ’¾ ì¼ê´„ ì €ì¥'; showToast(`${count}ê°œ ì½”ë©˜íŠ¸ ì €ì¥ ì™„ë£Œ`); }
        function copyText(text) { navigator.clipboard.writeText(text).then(() => showToast('ë§í¬ ë³µì‚¬ ì™„ë£Œ!')).catch(() => showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error')); }
        async function viewMonthlyReport(name, date) { try { const res = await fetch(`${API_BASE_URL}/api/monthly-report-url?studentName=${encodeURIComponent(name)}&date=${date}`, { headers: { 'Authorization': 'Bearer ' + authToken } }); const d = await res.json(); if(d.success) window.open(d.url, '_blank'); else alert(d.message); } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); } }
        async function openMonthlyReportModal(name, date) { try { const res = await fetch(`${API_BASE_URL}/api/monthly-report-url?studentName=${encodeURIComponent(name)}&date=${date}`, { headers: { 'Authorization': 'Bearer ' + authToken } }); const d = await res.json(); if(d.success) { const modal = document.getElementById('reportModal'); document.getElementById('reportModalTitle').textContent = 'ğŸ“… ì›”ê°„ ë¦¬í¬íŠ¸ ë§í¬'; document.getElementById('reportModalDesc').textContent = `${name} í•™ìƒì˜ ì§€ë‚œë‹¬ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.`; const inp = document.getElementById('reportLinkInput'); inp.value = d.url; modal.classList.add('show'); } else alert(d.message); } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); } }
        function copyReportLink() { const inp = document.getElementById('reportLinkInput'); inp.select(); document.execCommand('copy'); showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); document.getElementById('reportModal').classList.remove('show'); }

        function formatSelect(pageId, prop, val, opts) { return `<select class="homework-dropdown" onchange="updateField(this, '${pageId}', '${prop}', 'select')"><option value="">---</option>${opts.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('')}</select>`; }
        function formatStatus(pageId, prop, val) { const opts = ['ìˆ™ì œ í•¨', 'ì•ˆ í•´ì˜´', 'í•´ë‹¹ ì—†ìŒ', 'ì™„ë£Œ', 'ë¯¸ì™„ë£Œ', 'ì§„í–‰í•˜ì§€ ì•ŠìŒ']; const cls = val==='ìˆ™ì œ í•¨'||val==='ì™„ë£Œ'?'status-complete':(val==='ì•ˆ í•´ì˜´'||val==='ë¯¸ì™„ë£Œ'?'status-incomplete':'status-none'); return `<select class="homework-dropdown ${cls}" onchange="updateField(this, '${pageId}', '${prop}', 'status'); this.className='homework-dropdown '+ (this.value==='ìˆ™ì œ í•¨'||this.value==='ì™„ë£Œ'?'status-complete':(this.value==='ì•ˆ í•´ì˜´'||this.value==='ë¯¸ì™„ë£Œ'?'status-incomplete':'status-none'))">${opts.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('')}</select>`; }
        async function updateField(el, pageId, prop, type, manualVal) { const val = manualVal || el.value; try { await fetch(`${API_BASE_URL}/api/update-homework`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify({ pageId, propertyName: prop, newValue: val, propertyType: type }) }); showToast('ì €ì¥ë¨'); } catch (e) { showToast('ì‹¤íŒ¨', 'error'); } }
        function showToast(msg, type='success') { const t = document.createElement('div'); t.className = `toast-message ${type==='error'?'toast-error':'toast-success'}`; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 2000); }
        function logout() { localStorage.removeItem('teacher_auth_token'); window.location.href='/teacher-login'; }
        function showTab(tab) { currentActiveTab = tab; document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.getElementById(tab+'-view').classList.add('active'); document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active')); document.querySelector(`button[onclick="showTab('${tab}')"]`).classList.add('active'); loadDataForCurrentTab(); }
    </script>
</body>
</html>