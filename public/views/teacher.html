<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ - ë¦¬ë””íŠœë“œ</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "NanumSquareRound", sans-serif; }
        body { background: #f8f9fa; color: #2d3748; min-height: 100vh; padding: 0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        
        /* í—¤ë” */
        .header { background: #ffffff; color: #6b46c1; padding: 20px 30px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; margin: 0; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-name { font-weight: 600; }
        .logout-btn { background: #6b46c1; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s; }
        .logout-btn:hover { background: #5a3eaa; }

        /* íƒ­ ë©”ë‰´ */
        .tab-menu { display: flex; background-color: #ffffff; border-bottom: 1px solid #e2e8f0; padding: 0 40px; margin-top: 20px; border-radius: 12px 12px 0 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-button { padding: 15px 25px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: 600; color: #6b7280; position: relative; transition: color 0.3s; }
        .tab-button.active { color: #6b46c1; }
        .tab-button.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: #8b5cf6; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { padding: 30px 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .content-section { background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); border: 1px solid #e9ecef; padding: 30px; margin-bottom: 30px; }
        .section-title { font-size: 1.6em; font-weight: 700; color: #6b46c1; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        
        /* í•„í„° ì˜ì—­ */
        .filters-container { display:flex; gap:15px; margin-bottom:25px; align-items:center; flex-wrap: wrap; }
        .refresh-btn { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; }
        .filter-group { display:flex; align-items:center; gap:8px; }
        .filter-label { font-weight: 600; color: #4a5568; margin-right: 5px; }
        .filter-select, .filter-input { padding:8px 12px; border-radius:8px; border:2px solid #e2e8f0; font-size: 14px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ (Compact) */
        .table-container { overflow-x: auto; border: 1px solid #e9ecef; border-radius: 12px; }
        .styled-table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 1000px; }
        .styled-table th { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; padding: 12px 10px; text-align: center; font-weight: 600; white-space: nowrap; }
        .styled-table td { padding: 6px 8px; text-align: center; border-bottom: 1px solid #f1f3f4; vertical-align: middle; }
        
        /* í•™ìƒ ì´ë¦„ ì…€ ìŠ¤íƒ€ì¼ (ì¤‘ì•™ ì •ë ¬) */
        .student-name { 
            font-weight: 700; 
            color: #2d3748; 
            text-align: center;
            padding: 10px; 
            min-width: 300px;
            background-color: #fcf7ff; 
        }
        
        /* í•™ìƒ ì´ë¦„ ë˜í¼ (ê°€ë¡œ + ì¤‘ì•™ ì •ë ¬) */
        .student-name-wrapper {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        
        /* ë¡œë”© ë° ë°ì´í„° ì—†ìŒ */
        .loading, .no-data { text-align: center; padding: 40px; color: #718096; font-size: 16px; }

        /* ì±… íƒœê·¸ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .book-list-cell { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; justify-content: center; min-width: 250px; padding: 8px !important; }
        .book-tag { background: #f3e8ff; color: #6b46c1; border: 1px solid #d8b4fe; border-radius: 12px; padding: 4px 10px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .book-tag .remove-btn { cursor: pointer; font-weight: bold; color: #9333ea; font-size: 14px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-left: 4px; }
        .book-tag .remove-btn:hover { background: #e9d5ff; }
        .book-add-btn { background: #e9d5ff; color: #6b46c1; border: 1px dashed #d8b4fe; border-radius: 12px; padding: 4px 10px; font-size: 12px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .book-add-btn:hover { background: #d8b4fe; transform: translateY(-1px); }

        /* ìˆ™ì œ ìƒíƒœ ë²„íŠ¼ */
        .status-badge { padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; display: inline-block; min-width: 60px; text-align: center; border: 1px solid transparent; transition: all 0.2s; user-select: none; }
        .status-badge:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .status-complete { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .status-incomplete { background-color: #fecaca; color: #991b1b; border-color: #fca5a5; }
        .status-none { background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db; }
        
        /* 3ë‹¨ ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼ */
        .batch-controls { display: flex; gap: 4px; margin-top: 0; }
        .batch-btn { font-size: 11px; padding: 4px 10px; border-radius: 6px; border-width: 1px; border-style: solid; cursor: pointer; font-weight: 700; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .batch-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .batch-ok { background-color: #f0fdf4; color: #15803d; border-color: #16a34a; }
        .batch-no { background-color: #fef2f2; color: #b91c1c; border-color: #dc2626; }
        .batch-reset { background-color: #f8fafc; color: #475569; border-color: #94a3b8; }

        /* ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        .homework-dropdown { padding: 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px; font-weight: 600; text-align: center; cursor: pointer; background: white; }
        .homework-dropdown.status-listening-replace { background-color: #e0f2fe; color: #0369a1; border-color: #bae6fd; }
        .homework-dropdown.status-listening-textbook { background-color: #f0fdf4; color: #15803d; border-color: #bbf7d0; }
        .homework-dropdown.status-default { background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db; }
        .homework-dropdown.status-complete { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .homework-dropdown.status-incomplete { background-color: #fecaca; color: #991b1b; border-color: #fca5a5; }
        
        .editable-input { padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center; width: 60px; font-size: 13px; }
        .editable-input:focus { border-color: #8b5cf6; outline: none; }
        .editable-text-input { width: 120px; text-align: left; }

        /* ì ìˆ˜ ê·¸ë˜í”„ & ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .score-circle { position: relative; width: 40px; height: 40px; border-radius: 50%; background: conic-gradient(var(--score-color, #e5e7eb) 0% var(--score-value, 0%), #e5e7eb var(--score-value, 0%) 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto; }
        .score-circle::before { content: ''; position: absolute; width: 75%; height: 75%; background: white; border-radius: 50%; }
        .score-text { position: relative; font-size: 12px; font-weight: 700; color: var(--score-color, #6b7280); }
        .score-none { font-size: 13px; font-weight: 600; color: #9ca3af; }
        .reading-result-badge { padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 11px; display: inline-block; }
        .result-pass { background-color: #dcfce7; color: #166534; }
        .result-fail { background-color: #fecaca; color: #991b1b; }
        .result-none { background-color: #f3f4f6; color: #6b7280; }

        /* ì½”ë©˜íŠ¸ íƒ­ */
        .comment-textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; min-height: 60px; resize: none; overflow-y: hidden; line-height: 1.5; }
        .comment-textarea:focus { border-color: #8b5cf6; outline: none; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
        
        /* ë²„íŠ¼ ê·¸ë£¹ ì»¨í…Œì´ë„ˆ */
        .report-btn-group { display: flex; flex-direction: row; gap: 5px; align-items: center; justify-content: flex-start; flex-wrap: wrap; min-width: 300px; }
        .action-btn { border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; white-space: nowrap; }
        .btn-save { background: #10b981; color: white; } .btn-save:hover { background: #059669; }
        .btn-daily-view { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; } .btn-daily-view:hover { background: #bae6fd; }
        .btn-daily-copy { background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; } .btn-daily-copy:hover { background: #e0e7ff; }
        .btn-monthly-view { background: #f3e8ff; color: #7e22ce; border: 1px solid #d8b4fe; } .btn-monthly-view:hover { background: #d8b4fe; }
        .btn-monthly-copy { background: #fdf4ff; color: #a855f7; border: 1px solid #f0abfc; } .btn-monthly-copy:hover { background: #fae8ff; }

        /* ê´€ë¦¬ì ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .admin-links-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .admin-link-button { background: #ffffff; color: #6b46c1; border: 2px solid #e2e8f0; padding: 20px; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 700; text-align: left; transition: all 0.2s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .admin-link-button:hover { border-color: #c0b3e2; background-color: #fcfbfe; box-shadow: 0 6px 15px rgba(0,0,0,0.05); transform: translateY(-2px); }
        .admin-section-title { font-size: 1.3em; font-weight: 700; color: #333; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .manager-only-link { display: none; background-color: #fcfbfe; border-color: #c0b3e2; }

        /* ë¬¸ë²• ì¼ê´„ ì…ë ¥ ìŠ¤íƒ€ì¼ */
        .grammar-input-container {
            background-color: #f3e8ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #d8b4fe;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        .grammar-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .grammar-label {
            font-size: 13px;
            font-weight: 600;
            color: #6b46c1;
        }
        .grammar-input {
            padding: 8px 12px;
            border: 1px solid #d8b4fe;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }
        .grammar-btn {
            padding: 10px 20px;
            background-color: #8b5cf6;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }
        .grammar-btn:hover {
            background-color: #7c3aed;
        }

        .notice-text { background-color: #f8f9ff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px 20px; margin-bottom: 25px; font-size: 14px; color: #4b5563; line-height: 1.6; }
        .notice-text strong { color: #ef4444; font-weight: 700; }

        /* ëª¨ë‹¬ & í† ìŠ¤íŠ¸ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-search-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; font-size: 16px; }
        .modal-search-results { max-height: 300px; overflow-y: auto; border: 1px solid #f1f3f4; border-radius: 8px; }
        .result-item { padding: 12px; border-bottom: 1px solid #f1f3f4; cursor: pointer; transition: background 0.2s; }
        .result-item:hover { background: #f8f9ff; }
        .result-item:last-child { border-bottom: none; }
        
        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
        .toast-message { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; background: #333; color: white; opacity: 0; transform: translateX(100%); transition: all 0.3s; z-index: 3000; }
        .toast-message.show { opacity: 1; transform: translateX(0); }
        .toast-message.success { background: #10b981; } .toast-message.error { background: #ef4444; }

        /* [ì‹ ê·œ] AI í‚¤ì›Œë“œ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .keyword-input-container {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            align-items: center;
        }
        .keyword-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d8b4fe;
            border-radius: 8px;
            font-size: 13px;
            background: #fcf7ff;
            transition: all 0.2s;
        }
        .keyword-input:focus {
            outline: none;
            border-color: #8b5cf6;
            background: white;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
        }
        .btn-ai-generate {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 5px rgba(139, 92, 246, 0.3);
            transition: all 0.2s;
        }
        .btn-ai-generate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.4);
        }
        .btn-ai-generate:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“š ë¦¬ë””íŠœë“œ ì„ ìƒë‹˜</h1>
        <div class="user-info">
            <span class="user-name" id="userName">ë¡œë”©ì¤‘...</span>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="container">
        <div class="tab-menu">
            <button class="tab-button active" onclick="showTab('homework')">ìˆ™ì œ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('tests')">í…ŒìŠ¤íŠ¸ ê²°ê³¼</button>
            <button class="tab-button" onclick="showTab('reading')">ì›ì„œ ë…ì„œ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('listening')">ë¦¬ìŠ¤ë‹ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('grammar')">ğŸ“š ë¬¸ë²• ê´€ë¦¬</button>
            <button class="tab-button" onclick="showTab('comments')">ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</button>
            <button class="tab-button" id="tab-admin" onclick="showTab('admin')" style="color: #d946ef; font-weight: 700;">
                âš™ï¸ ê´€ë¦¬ì ë©”ë‰´
            </button>
        </div>

        <div class="main-content">
            
            <!-- 1. ìˆ™ì œ í˜„í™© íƒ­ -->
            <div id="homework-view" class="tab-content active">
                <div class="content-section">
                    <div class="section-title">ğŸ“‹ ë‹´ë‹¹ í•™ìƒ ìˆ™ì œ í˜„í™©</div>
                    <div class="filters-container">
                        <button class="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        <div class="filter-group">
                            <select id="periodFilter_hw" class="filter-select" onchange="toggleDateInput('hw')">
                                <option value="today" selected>ì˜¤ëŠ˜</option>
                                <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                            </select>
                            <input type="date" id="specificDate_hw" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
                        </div>
                        <div class="filter-group" id="teacherFilterGroup_hw" style="display:none;">
                            <select id="teacherFilter_hw" class="filter-select" onchange="filterDataByTeacher()"><option value="">ì „ì²´ ë³´ê¸°</option></select>
                        </div>
                    </div>
                    <div class="notice-text">
                        ğŸ“¢ ë§¤ë‹¬ ìˆ™ì œ ìˆ˜í–‰ìœ¨ê³¼ ì„±ì‹¤ë„ ì ìˆ˜, RT-Check pointê°€ ì‚°ì¶œ ë©ë‹ˆë‹¤. 
                        <strong>RT í¬ì¸íŠ¸ 70ì  ì´í•˜ë¥¼ 2ë‹¬ ì—°ì† ë§ê²Œ ë˜ë©´ íŒ¨ë„í‹° ë¶€ê³¼ ë° ì¡°ì¹˜ê°€ ìˆìœ¼ë‹ˆ</strong> 
                        ë§¤ì¼ì˜ ì„±ì‹¤í•¨ì„ ì§€í‚¬ ìˆ˜ ìˆë„ë¡ í•´ì£¼ì„¸ìš”!
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>â­• ë¬¸ë²•ìˆ™ì œ</th> <th>1ï¸âƒ£ ì–´íœ˜í´ì¹´</th> <th>2ï¸âƒ£ ë…í•´í´ì¹´</th> <th>4ï¸âƒ£ Summary</th> <th>5ï¸âƒ£ ë…í•´ì„œ í’€ê¸°</th> <th>6ï¸âƒ£ ë¶€&ë§¤&ì¼</th> <th>ìˆ˜í–‰ìœ¨</th> </tr></thead>
                            <tbody id="homeworkTableBody"><tr><td colspan="9" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. í…ŒìŠ¤íŠ¸ ê²°ê³¼ íƒ­ -->
            <div id="tests-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ“ ë‹´ë‹¹ í•™ìƒ í…ŒìŠ¤íŠ¸ ê²°ê³¼</div>
                    <div class="filters-container">
                        <button class="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        <div class="filter-group">
                            <select id="periodFilter_tests" class="filter-select" onchange="toggleDateInput('tests')">
                                <option value="today" selected>ì˜¤ëŠ˜</option>
                                <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                            </select>
                            <input type="date" id="specificDate_tests" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
                        </div>
                        <div class="filter-group" id="teacherFilterGroup_tests" style="display:none;">
                            <select id="teacherFilter_tests" class="filter-select" onchange="filterDataByTeacher()"><option value="">ì „ì²´ ë³´ê¸°</option></select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ì–´íœ˜ìœ ë‹›</th> <th>ì–´íœ˜ì •ë‹µ</th> <th>ì´ê°¯ìˆ˜</th> <th>ì–´íœ˜ì ìˆ˜</th> <th>ë…í•´ì˜¤ë‹µ</th> <th>ë…í•´ê²°ê³¼</th> <th>í•˜ë¸Œë£¨íƒ€</th> <th>ë¬¸ë²•ë¬¸í•­</th> <th>ë¬¸ë²•ì˜¤ë‹µ</th> <th>ë¬¸ë²•ì ìˆ˜</th> </tr></thead>
                            <tbody id="testsTableBody"><tr><td colspan="11" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. ì›ì„œ ë…ì„œ í˜„í™© íƒ­ -->
            <div id="reading-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ“š ì›ì„œ ë…ì„œ í˜„í™© (ë‹¤ì¤‘ ì…ë ¥)</div>
                    <div class="filters-container">
                        <button class="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        <div class="filter-group">
                            <select id="periodFilter_reading" class="filter-select" onchange="toggleDateInput('reading')">
                                <option value="today" selected>ì˜¤ëŠ˜</option>
                                <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                            </select>
                            <input type="date" id="specificDate_reading" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
                        </div>
                        <div class="filter-group" id="teacherFilterGroup_reading" style="display:none;">
                            <select id="teacherFilter_reading" class="filter-select" onchange="filterDataByTeacher()"><option value="">ì „ì²´ ë³´ê¸°</option></select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ğŸ“– ì˜ì–´ë…ì„œ</th> <th>ì–´íœ˜í•™ìŠµ</th> <th>ğŸ“š ì½ì€ ì±… ëª©ë¡ (íƒœê·¸)</th> <th>Writing</th> </tr></thead>
                            <tbody id="readingTableBody"><tr><td colspan="6" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. ë¦¬ìŠ¤ë‹ & ì±…ê±° í˜„í™© íƒ­ -->
            <div id="listening-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ§ ë¦¬ìŠ¤ë‹ & ì±…ê±° í˜„í™©</div>
                    <div class="filters-container">
                        <button class="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        <div class="filter-group">
                            <select id="periodFilter_listening" class="filter-select" onchange="toggleDateInput('listening')">
                                <option value="today" selected>ì˜¤ëŠ˜</option>
                                <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                            </select>
                            <input type="date" id="specificDate_listening" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
                        </div>
                        <div class="filter-group" id="teacherFilterGroup_listening" style="display:none;">
                            <select id="teacherFilter_listening" class="filter-select" onchange="filterDataByTeacher()"><option value="">ì „ì²´ ë³´ê¸°</option></select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>í•™ìƒ ì´ë¦„</th>
                                    <th>ë‹´ë‹¹ê°•ì‚¬</th>
                                    <th>ë“£ê¸° í•™ìŠµ</th>
                                    <th>ë“£ê¸° ì›Œí¬ë¶</th>
                                    <th>êµ­ì–´ ë…ì„œ(íƒœê·¸)</th>
                                    <th>ì±… ì½ëŠ” ê±°ì¸</th>
                                </tr>
                            </thead>
                            <tbody id="listeningTableBody"><tr><td colspan="6" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- [ì‹ ê·œ] ë¬¸ë²• ê´€ë¦¬ íƒ­ -->
            <div id="grammar-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title" style="--icon:'ğŸ“š'">ë¬¸ë²• ìˆ™ì œ ê´€ë¦¬</div>
                    
                    <!-- ìƒë‹¨: ë¬¸ë²• ìˆ™ì œ ì…ë ¥ë€ -->
                    <div class="grammar-input-container">
                        <div class="grammar-group">
                            <label class="grammar-label">ëŒ€ìƒ ë°˜ ì„ íƒ</label>
                            <select id="grammarClassSelect" class="grammar-input">
                                <option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <!-- JSë¡œ ë¡œë“œëœ ë°˜ ëª©ë¡ì´ ë“¤ì–´ê° -->
                            </select>
                        </div>
                        <div class="grammar-group">
                            <label class="grammar-label">ì˜¤ëŠ˜ ë¬¸ë²• ì§„ë„</label>
                            <input type="text" id="grammarTopicInput" class="grammar-input" placeholder="ì˜ˆ: toë¶€ì •ì‚¬">
                        </div>
                        <div class="grammar-group" style="flex-grow: 1;">
                            <label class="grammar-label">ë¬¸ë²• ê³¼ì œ ë‚´ìš©</label>
                            <input type="text" id="grammarHomeworkInput" class="grammar-input" style="width: 100%;" placeholder="ì˜ˆ: P.20~24 í’€ê¸°">
                        </div>
                        <button class="grammar-btn" onclick="updateGrammarByClass()">ë°˜ ì „ì²´ ì ìš©</button>
                    </div>

                    <!-- í•˜ë‹¨: í•™ìƒ ë¦¬ìŠ¤íŠ¸ -->
                    <div class="filters-container">
                         <button class="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                         <!-- í•„í„° ìƒëµ (ìë™ ë¡œë“œ) -->
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <colgroup><col style="width:10%"><col style="width:10%"><col style="width:40%"><col style="width:40%"></colgroup>
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë¬¸ë²• ë°˜</th> <th>ì˜¤ëŠ˜ ë¬¸ë²• ì§„ë„</th> <th>ë¬¸ë²• ê³¼ì œ ë‚´ìš©</th> </tr></thead>
                            <tbody id="grammarTableBody"><tr><td colspan="4" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸ íƒ­ -->
            <div id="comments-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ’¬ ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</div>
                     <div class="filters-container">
                        <button class="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        <div class="filter-group">
                            <select id="periodFilter_comments" class="filter-select" onchange="toggleDateInput('comments')">
                                <option value="today" selected>ì˜¤ëŠ˜</option>
                                <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                            </select>
                            <input type="date" id="specificDate_comments" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
                        </div>
                        <div class="filter-group" id="teacherFilterGroup_comments" style="display:none;">
                            <select id="teacherFilter_comments" class="filter-select" onchange="filterDataByTeacher()"><option value="">ì „ì²´ ë³´ê¸°</option></select>
                        </div>
                        <!-- [ì‹ ê·œ] ë¬¸ë²• ë°˜ í•„í„° ì¶”ê°€ -->
                        <div class="filter-group">
                            <select id="grammarClassFilter_comments" class="filter-select" onchange="filterDataByTeacher()">
                                <option value="">ì „ì²´ ë¬¸ë²•ë°˜</option>
                            </select>
                        </div>
                        <button class="refresh-btn batch-save-btn" onclick="saveAllComments(this)">ğŸ’¾ ì¼ê´„ ì €ì¥</button>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <colgroup><col style="width:5%"><col style="width:5%"><col style="width:6%"><col style="width:44%"><col style="width:40%"></colgroup>
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ë¬¸ë²• í´ë˜ìŠ¤</th> <th>ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</th> <th>ê´€ë¦¬</th> </tr></thead>
                            <tbody id="commentsTableBody"><tr><td colspan="5" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ê´€ë¦¬ì ë©”ë‰´ íƒ­ -->
            <div id="admin-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">âš™ï¸ ê´€ë¦¬ì ë°”ë¡œê°€ê¸° (Notion DB)</div>
                    <h3 class="admin-section-title">&lt;ë¦¬ë””íŠœë“œ ë…¸ì…˜&gt;</h3>
                    <p style="margin-bottom: 25px; color: #4b5563;">ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ë…¸ì…˜ DBë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ìƒˆ ìœˆë„ìš°ê°€ ì—´ë¦½ë‹ˆë‹¤.</p>
                    <div class="admin-links-container">
                        <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/NEW-25e09320bce28039a575c1405c9c0d4f?source=copy_link')">ë¬¸ë²• ìˆ™ì œ ê´€ë¦¬</button>
                        <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/20009320bce28012b740dc6df5e1303c?source=copy_link')">êµì¬ë¹„ ì…ê¸ˆ ë‚´ì—­</button>
                        <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/NEW-26109320bce280b38808dc57f5bd5978?source=copy_link')">ì›ìƒ êµì¬ ê´€ë¦¬</button>
                        <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/18f09320bce280a29d3cc25d117511a7?source=copy_link')">êµì¬ ë°ì´í„° ë² ì´ìŠ¤</button>
                        <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/9ef2bbaeec19466daa0d0c0677b9eb90?v=064779482df2493699322be11a41dcbf&source=copy_link')">ì›ì„œ ë…ì„œ ë¦¬ìŠ¤íŠ¸</button>
                        <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/cf82d56634574d7e83d893fbf1b1a4e3?v=1c903b34bd3746c6be6cfb932cd9fabd&source=copy_link')">êµ­ì–´ ë…ì„œ ë¦¬ìŠ¤íŠ¸</button>
                        <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/NEW-25409320bce280819167cae477b16fe6?source=copy_link')">í•™ìƒ ëª…ë¶€ ê´€ë¦¬</button>
                        <button class="admin-link-button manager-only-link" onclick="openNotionWindow('https://www.notion.so/readitude/1a109320bce28078a744ff94e98f8792?source=copy_link')">ğŸ§‘â€ğŸ’¼ ìƒë‹´ ê´€ë¦¬ ë©”ë‰´ (ê´€)</button>
                        <button class="admin-link-button manager-only-link" onclick="openNotionWindow('https://www.notion.so/readitude/25409320bce2807697ede3f1c1b62ada?v=25409320bce2815da94b000c1cc63b2f&source=copy_link')">ğŸ§‘â€ğŸ’¼ í•™ìƒ ì§„ë„ ê´€ë¦¬ (ê´€)</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ì±… ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div id="bookSearchModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">ğŸ“š ì±… ì œëª© ê²€ìƒ‰</h2>
            <input type="text" id="modalSearchInput" class="modal-search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <div id="modalSearchResults" class="modal-search-results">
                <div class="no-data" style="padding: 30px;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...</div>
            </div>
            <button onclick="document.getElementById('bookSearchModal').classList.remove('show')" style="width:100%; padding:10px; margin-top:15px; border:none; background:#f3f4f6; border-radius:8px; cursor:pointer;">ë‹«ê¸°</button>
        </div>
    </div>
    <div id="reportModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="reportModalTitle" style="margin-bottom:15px; color:#6b46c1;">ğŸ”— ë¦¬í¬íŠ¸ ë§í¬</h2>
            <p id="reportModalDesc" style="margin-bottom:15px; font-size:14px; color:#4b5563;"></p>
            <input type="text" id="reportLinkInput" class="modal-search-input" readonly>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button onclick="document.getElementById('reportModal').classList.remove('show')" style="padding:8px 16px; border:1px solid #e5e7eb; background:white; border-radius:6px; cursor:pointer;">ë‹«ê¸°</button>
                <button id="copyReportLinkBtn" onclick="copyReportLink()" style="padding:8px 16px; background:#6b46c1; color:white; border:none; border-radius:6px; cursor:pointer;">ë³µì‚¬í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let authToken = localStorage.getItem('teacher_auth_token');
        let allReportData = [];
        let currentActiveTab = 'homework';
        let bookSearchTimer = null;
        let currentEditingPageId = null;
        let currentBookType = 'english'; // [ì‹ ê·œ] í˜„ì¬ ì±… ê²€ìƒ‰ íƒ€ì…
        let currentUserRole = '';
        let currentUserName = '';
        const autoSaveMap = new Map();
        let currentSearchResults = [];

        function getSuffixForTab(tabName) {
            if (tabName === 'homework') return '_hw';
            if (tabName === 'tests') return '_test';
            if (tabName === 'reading') return '_reading';
            if (tabName === 'listening') return '_listening';
            if (tabName === 'grammar') return '_grammar'; // [ì‹ ê·œ]
            if (tabName === 'comments') return '_comments';
            return '';
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) { window.location.href='/teacher-login'; return; }
            setAllFiltersToToday();
            loadUserInfo();
            showTab('homework');
            
            document.getElementById('modalSearchInput').addEventListener('input', (e) => {
                clearTimeout(bookSearchTimer);
                const query = e.target.value;
                bookSearchTimer = setTimeout(() => {
                     searchBooks(query); // [ìˆ˜ì •] í†µí•© ê²€ìƒ‰ í•¨ìˆ˜ í˜¸ì¶œ
                }, 300);
            });
            
            // [ì¤‘ìš”] ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            const refreshButtons = document.querySelectorAll('.refresh-btn');
            refreshButtons.forEach(btn => {
                btn.addEventListener('click', loadDataForCurrentTab);
            });
        });

        function setAllFiltersToToday() {
            const suffixes = ['hw', 'tests', 'reading', 'listening', 'comments'];
            suffixes.forEach(s => {
                const sel = document.getElementById(`periodFilter_${s}`);
                if(sel) sel.value = 'today';
                const dateInp = document.getElementById(`specificDate_${s}`);
                if(dateInp) dateInp.style.display = 'none';
            });
        }

        async function loadUserInfo() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/teacher/user-info`, { headers:{Authorization:'Bearer '+authToken} });
                const data = await res.json();
                currentUserName = data.userName;
                currentUserRole = data.userRole;
                document.getElementById('userName').textContent = `${data.userName} (${data.userRole === 'manager' ? 'ê´€ë¦¬ì' : 'ì„ ìƒë‹˜'})`;
                loadTeachersList();
            } catch (e) { logout(); }
        }

        async function loadTeachersList() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/teachers`, { headers:{Authorization:'Bearer '+authToken} });
                const teachers = await res.json();
                ['hw', 'tests', 'reading', 'listening', 'comments'].forEach(tabId => {
                    const container = document.getElementById(`teacherFilterGroup_${tabId}`);
                    const select = document.getElementById(`teacherFilter_${tabId}`);
                    if (container && select) { // admin íƒ­ ë“± ì˜ˆì™¸ ì²˜ë¦¬
                        if (currentUserRole === 'manager') {
                            container.style.display = 'flex';
                            teachers.forEach(t => { const opt = document.createElement('option'); opt.value = t.name; opt.textContent = t.name; select.appendChild(opt); });
                        } else {
                            container.style.display = 'flex';
                            const myOpt = document.createElement('option'); myOpt.value = currentUserName; myOpt.textContent = currentUserName + ' (ë‚˜)'; select.appendChild(myOpt);
                            select.value = currentUserName; select.disabled = true;
                        }
                    }
                });
            } catch(e) { console.error(e); }
        }

        // [ìˆ˜ì •] í†µí•© í•„í„°ë§ í•¨ìˆ˜ (ì„ ìƒë‹˜ + ë¬¸ë²• ë°˜)
        function filterDataByTeacher() {
            const tabSuffix = currentActiveTab === 'homework' ? 'hw' : currentActiveTab;
            const teacherSelect = document.getElementById(`teacherFilter_${tabSuffix}`);
            
            // 1. ê¸°ë³¸ ë°ì´í„°ì—ì„œ ì‹œì‘
            let filteredData = allReportData;

            // 2. ì„ ìƒë‹˜ í•„í„° ì ìš©
            if (teacherSelect && teacherSelect.value) { 
                const selectedTeacher = teacherSelect.value;
                filteredData = filteredData.filter(item => item.teachers && item.teachers.includes(selectedTeacher));
            }

            // 3. [ì‹ ê·œ] ë¬¸ë²• ë°˜ í•„í„° ì ìš© (ì½”ë©˜íŠ¸ íƒ­ì¼ ê²½ìš°ë§Œ)
            if (currentActiveTab === 'comments') {
                const grammarSelect = document.getElementById('grammarClassFilter_comments');
                if (grammarSelect && grammarSelect.value) {
                    const selectedClass = grammarSelect.value;
                    filteredData = filteredData.filter(item => item.comment && item.comment.grammarClass === selectedClass);
                }
            }

            // 4. ê²°ê³¼ í‘œì‹œ
            displayDataForAllTabs(filteredData);
        }

        function toggleDateInput(tabId) {
            const period = document.getElementById(`periodFilter_${tabId}`).value;
            const dateInput = document.getElementById(`specificDate_${tabId}`);
            dateInput.style.display = period === 'specific_date' ? 'block' : 'none';
            if (period === 'today') loadDataForCurrentTab();
        }

        async function loadDataForCurrentTab() {
            const tabSuffix = currentActiveTab === 'homework' ? 'hw' : currentActiveTab;
            // ë¬¸ë²• íƒ­ì€ ë³„ë„ í•„í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ê¸°ë³¸ê°’ ì‚¬ìš©
            const periodElem = document.getElementById(`periodFilter_${tabSuffix}`) || { value: 'today' };
            const dateElem = document.getElementById(`specificDate_${tabSuffix}`) || { value: '' };
            
            const period = periodElem.value;
            const date = dateElem.value;
            let url = `${API_BASE_URL}/api/daily-report-data?period=${period}`;
            if (period === 'specific_date' && date) url += `&date=${date}`;

            try {
                const res = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!res.ok) throw new Error('Load failed');
                allReportData = await res.json();
                
                // [ì‹ ê·œ] ë¬¸ë²• íƒ­ì¼ ê²½ìš° ë°˜ ëª©ë¡ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ìš©)
                if (currentActiveTab === 'grammar') {
                    updateGrammarClassList(allReportData);
                }
                
                // [ì‹ ê·œ] ì½”ë©˜íŠ¸ íƒ­ì¼ ê²½ìš° ë¬¸ë²• ë°˜ í•„í„° ëª©ë¡ ì—…ë°ì´íŠ¸ (í•„í„°ìš©)
                if (currentActiveTab === 'comments') {
                    updateCommentGrammarFilterList(allReportData);
                }
                
                filterDataByTeacher();
            } catch (e) { console.error(e); alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'); }
        }

        function displayDataForAllTabs(data) {
            displayHomeworkData(data);
            displayTestData(data);
            displayReadingData(data);
            displayListeningData(data);
            displayCommentData(data);
            displayGrammarData(data); // [ì‹ ê·œ]
        }

        // [ì‹ ê·œ] ì½”ë©˜íŠ¸ íƒ­ìš© ë¬¸ë²• ë°˜ í•„í„° ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateCommentGrammarFilterList(data) {
            const select = document.getElementById('grammarClassFilter_comments');
            if(!select) return;
            const savedValue = select.value;
            // ë°ì´í„°ì—ì„œ ë¬¸ë²• ë°˜ ëª©ë¡ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
            const classes = new Set(data.map(st => st.comment?.grammarClass).filter(c => c && c !== 'ì§„ë„ í•´ë‹¹ ì—†ìŒ'));
            
            select.innerHTML = '<option value="">ì „ì²´ ë¬¸ë²•ë°˜</option>';
            
            // ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬í•˜ì—¬ ì˜µì…˜ ì¶”ê°€
            [...classes].sort().forEach(cls => {
                const opt = document.createElement('option');
                opt.value = cls;
                opt.textContent = cls;
                select.appendChild(opt);
            });
            
            // ê¸°ì¡´ ì„ íƒê°’ ìœ ì§€ ì‹œë„
            if(savedValue && classes.has(savedValue)) select.value = savedValue;
        }

        // [ì‹ ê·œ] ë¬¸ë²• ë°ì´í„° ë Œë”ë§
        function displayGrammarData(data) {
             const tbody = document.getElementById('grammarTableBody');
             if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="4" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
             tbody.innerHTML = data.map(st => `
                <tr>
                    <td class="student-name">${st.studentName}</td>
                    <td>${st.comment.grammarClass || '-'}</td>
                    <td><input type="text" class="editable-input editable-text-input" style="width: 100%;" value="${st.comment.grammarTopic === 'ì§„ë„ í•´ë‹¹ ì—†ìŒ' ? '' : st.comment.grammarTopic}" placeholder="ì§„ë„ í•´ë‹¹ ì—†ìŒ" data-page-id="${st.pageId}" data-property-name="ì˜¤ëŠ˜ ë¬¸ë²• ì§„ë„" data-property-type="rich_text" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'grammarTableBody')"></td>
                    <td><input type="text" class="editable-input editable-text-input" style="width: 100%;" value="${st.comment.grammarHomework === 'ìˆ™ì œ ë‚´ìš© ì—†ìŒ' ? '' : st.comment.grammarHomework}" placeholder="ìˆ™ì œ ë‚´ìš© ì—†ìŒ" data-page-id="${st.pageId}" data-property-name="ë¬¸ë²• ìˆ™ì œ ë‚´ìš©" data-property-type="rich_text" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'grammarTableBody')"></td>
                </tr>
             `).join('');
        }

        // [ì‹ ê·œ] ë¬¸ë²• ë°˜ ëª©ë¡ ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ì œê±°)
        function updateGrammarClassList(data) {
            const select = document.getElementById('grammarClassSelect');
            const classes = new Set(data.map(st => st.comment.grammarClass).filter(c => c && c !== 'ì§„ë„ í•´ë‹¹ ì—†ìŒ'));
            
            // ê¸°ì¡´ ì˜µì…˜ ìœ ì§€ (ì²« ë²ˆì§¸ 'ë°˜ì„ ì„ íƒí•˜ì„¸ìš”')
            select.innerHTML = '<option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            classes.forEach(cls => {
                const opt = document.createElement('option');
                opt.value = cls;
                opt.textContent = cls;
                select.appendChild(opt);
            });
        }

        // [ìˆ˜ì •] ë¬¸ë²• ì¼ê´„ ì—…ë°ì´íŠ¸ (ì…ë ¥ê°’ ê²€ì¦ ê°•í™”)
        async function updateGrammarByClass() {
            const classSelect = document.getElementById('grammarClassSelect');
            const topicInput = document.getElementById('grammarTopicInput');
            const homeworkInput = document.getElementById('grammarHomeworkInput');

            if (!classSelect || !topicInput || !homeworkInput) {
                showToast('ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const className = classSelect.value;
            const topic = topicInput.value.trim();
            const homework = homeworkInput.value.trim();
            
            if (!className) { 
                alert('ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); 
                classSelect.focus();
                return; 
            }

            // ë‚´ìš©ì´ ë‘˜ ë‹¤ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³  (ì‹¤ìˆ˜ ë°©ì§€)
            if (!topic && !homework) {
                if (!confirm('ì§„ë„ì™€ ìˆ™ì œ ë‚´ìš©ì´ ëª¨ë‘ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë‚´ìš© ì‚­ì œë¨)')) return;
            }

            if (!confirm(`${className}ë°˜ í•™ìƒë“¤ì˜ ë¬¸ë²• ì§„ë„ì™€ ìˆ™ì œë¥¼ ì¼ê´„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            // í˜„ì¬ ë³´ê³  ìˆëŠ” ë‚ ì§œ (í•„í„° ê¸°ì¤€)
            const periodElem = document.getElementById('periodFilter_hw'); // ë©”ì¸ í•„í„° ì°¸ì¡° (ìˆ™ì œ íƒ­ í•„í„° ê¸°ì¤€)
            const dateElem = document.getElementById('specificDate_hw');
            let targetDate = new Date().toISOString().split('T')[0]; // ê¸°ë³¸ê°’ ì˜¤ëŠ˜
            
            // ë§Œì•½ ë‹¤ë¥¸ íƒ­(ì˜ˆ: ë¬¸ë²• íƒ­)ì— ìˆë‹¤ë©´ í•´ë‹¹ íƒ­ì˜ í•„í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ê¸°ë³¸ê°’(ì˜¤ëŠ˜)ì„ ì‚¬ìš©í•˜ê±°ë‚˜
            // ê³µí†µ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì™€ì•¼ í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” 'ìˆ™ì œ í˜„í™©' íƒ­ì˜ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.
            if (periodElem && periodElem.value === 'specific_date' && dateElem && dateElem.value) {
                targetDate = dateElem.value;
            } else {
                // í•„í„°ê°€ ì—†ëŠ” ê²½ìš°(ì´ˆê¸° ìƒíƒœ ë“±) ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
                 // [ìˆ˜ì •] KST ë‚ ì§œ êµ¬í•˜ê¸°
                 const now = new Date();
                 const kstNow = new Date(now.getTime() + 9 * 60 * 60 * 1000);
                 targetDate = kstNow.toISOString().split('T')[0];
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            const btn = document.querySelector('.grammar-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'ì €ì¥ ì¤‘...';

            try {
                const res = await fetch(`${API_BASE_URL}/api/update-grammar-by-class`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ 
                        className, 
                        topic, 
                        homework,
                        date: targetDate
                    })
                });
                
                const result = await res.json();
                
                if (res.ok && result.success) {
                    showToast(result.message, 'success');
                    loadDataForCurrentTab(); // í™”ë©´ ê°±ì‹  (ë¦¬ìŠ¤íŠ¸ì— ë°˜ì˜)
                    
                    // ì…ë ¥ì°½ ì´ˆê¸°í™” (ì„ íƒ ì‚¬í•­ - ì—°ì† ì…ë ¥ì„ ìœ„í•´ ë‚¨ê²¨ë‘˜ ìˆ˜ë„ ìˆìŒ)
                    // topicInput.value = '';
                    // homeworkInput.value = '';
                } else {
                    throw new Error(result.message || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
            } catch (e) {
                console.error(e);
                showToast(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ... (ë‚˜ë¨¸ì§€ display í•¨ìˆ˜ë“¤, í—¬í¼ í•¨ìˆ˜ë“¤ ê¸°ì¡´ê³¼ ë™ì¼) ...
        function displayHomeworkData(data) {
            const tbody = document.getElementById('homeworkTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="9" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `<tr id="row-hw-${st.pageId}">
                <td class="student-name">
                    <div class="student-name-wrapper">
                        <span>${st.studentName}</span>
                        <div class="batch-controls">
                            <button class="batch-btn batch-ok" onclick="markAllHomework('${st.pageId}', 'ìˆ™ì œ í•¨')" title="ì „ì²´ ì™„ë£Œ">ì „ì²´O</button>
                            <button class="batch-btn batch-no" onclick="markAllHomework('${st.pageId}', 'ì•ˆ í•´ì˜´')" title="ì „ì²´ ë¯¸ì™„ë£Œ">ì „ì²´X</button>
                            <button class="batch-btn batch-reset" onclick="markAllHomework('${st.pageId}', 'ìˆ™ì œ ì—†ìŒ')" title="ìˆ™ì œ ì—†ìŒ">ìˆ™ì œì—†ìŒ</button>
                        </div>
                    </div>
                </td>
                <td>${(st.teachers||[]).join(', ')}</td>
                <td>${renderToggleBadge(st.pageId, 'â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬', st.homework.grammar)}</td>
                <td>${renderToggleBadge(st.pageId, '1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ', st.homework.vocabCards)}</td>
                <td>${renderToggleBadge(st.pageId, '2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ', st.homework.readingCards)}</td>
                <td>${renderToggleBadge(st.pageId, '4ï¸âƒ£ Summary ìˆ™ì œ', st.homework.summary)}</td>
                <td>${renderToggleBadge(st.pageId, '5ï¸âƒ£ ë…í•´ì„œ í’€ê¸°', st.homework.dailyReading)}</td>
                <td>${renderToggleBadge(st.pageId, '6ï¸âƒ£ ë¶€&ë§¤&ì¼', st.homework.diary)}</td>
                <td style="font-weight:bold; color:${st.completionRate>=80?'#10b981':'#ef4444'}">${st.completionRate}%</td>
            </tr>`).join('');
        }

        function renderToggleBadge(pageId, prop, val) {
            const statusMap = { 'ìˆ™ì œ í•¨': 'status-complete', 'ì™„ë£Œ': 'status-complete', 'ì•ˆ í•´ì˜´': 'status-incomplete', 'ë¯¸ì™„ë£Œ': 'status-incomplete', 'ìˆ™ì œ ì—†ìŒ': 'status-none', 'í•´ë‹¹ ì—†ìŒ': 'status-none', 'ì§„í–‰í•˜ì§€ ì•ŠìŒ': 'status-none' };
            const displayVal = val || 'ìˆ™ì œ ì—†ìŒ';
            const cls = statusMap[displayVal] || 'status-none';
            return `<span class="status-badge ${cls}" onclick="toggleStatus(this, '${pageId}', '${prop}', '${displayVal}')">${displayVal}</span>`;
        }

        async function toggleStatus(el, pageId, prop, currentVal) {
            const sequence = ['ìˆ™ì œ í•¨', 'ì•ˆ í•´ì˜´', 'ìˆ™ì œ ì—†ìŒ'];
            let nextIndex = sequence.indexOf(currentVal) + 1;
            if (nextIndex >= sequence.length) nextIndex = 0;
            const nextVal = sequence[nextIndex];
            el.textContent = nextVal;
            el.className = `status-badge ${nextVal === 'ìˆ™ì œ í•¨' ? 'status-complete' : (nextVal === 'ì•ˆ í•´ì˜´' ? 'status-incomplete' : 'status-none')}`;
            el.onclick = () => toggleStatus(el, pageId, prop, nextVal);
            await updateField(null, pageId, prop, 'status', nextVal);
        }

        async function markAllHomework(pageId, status) {
            let statusText = status;
            let apiValue = status;
            
            if (status === 'ì´ˆê¸°í™”') {
                statusText = 'ìˆ™ì œ ì—†ìŒ';
                apiValue = 'ìˆ™ì œ ì—†ìŒ';
            }

            const msg = apiValue === 'ìˆ™ì œ í•¨' ? 'ì™„ë£Œ' : (apiValue === 'ì•ˆ í•´ì˜´' ? 'ë¯¸ì™„ë£Œ' : 'ì—†ìŒ(ì´ˆê¸°í™”)');
            if (!confirm(`ì´ í•™ìƒì˜ ëª¨ë“  ìˆ™ì œë¥¼ "${msg}" ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const props = ['â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬', '1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ', '2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ', '4ï¸âƒ£ Summary ìˆ™ì œ', '5ï¸âƒ£ ë…í•´ì„œ í’€ê¸°', '6ï¸âƒ£ ë¶€&ë§¤&ì¼'];
            
            const row = document.getElementById(`row-hw-${pageId}`);
            if (row) {
                const badges = row.querySelectorAll('.status-badge');
                badges.forEach(badge => {
                    badge.textContent = apiValue;
                    badge.className = `status-badge ${apiValue === 'ìˆ™ì œ í•¨' ? 'status-complete' : (apiValue === 'ì•ˆ í•´ì˜´' ? 'status-incomplete' : 'status-none')}`;
                    badge.onclick = () => toggleStatus(badge, pageId, badge.getAttribute('data-prop') || '', apiValue);
                });
            }
            try {
                const updates = {};
                props.forEach(prop => { updates[prop] = { value: apiValue, type: 'status' }; });
                await fetch(`${API_BASE_URL}/api/update-homework`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ pageId: pageId, updates: updates })
                });
                showToast(`ëª¨ë‘ "${msg}" ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch(e) { showToast('ì²˜ë¦¬ ì‹¤íŒ¨', 'error'); loadDataForCurrentTab(); }
        }

        function displayTestData(data) {
            const tbody = document.getElementById('testsTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="11" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `<tr>
                <td class="student-name">${st.studentName}</td>
                <td><input class="editable-input editable-text-input" value="${st.tests.vocabUnit||''}" onchange="updateField(this, '${st.pageId}', 'ì–´íœ˜ìœ ë‹›', 'rich_text')" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                <td><input class="editable-input" type="number" value="${st.tests.vocabCorrect||''}" onchange="updateField(this, '${st.pageId}', 'ë‹¨ì–´(ë§ì€ ê°œìˆ˜)', 'number')" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                <td><input class="editable-input" type="number" value="${st.tests.vocabTotal||''}" onchange="updateField(this, '${st.pageId}', 'ë‹¨ì–´(ì „ì²´ ê°œìˆ˜)', 'number')" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                <td class="vocab-score">${formatScoreCircle(st.tests.vocabScore)}</td>
                <td><input class="editable-input" type="number" value="${st.tests.readingWrong||''}" onchange="updateField(this, '${st.pageId}', 'ë…í•´(í‹€ë¦° ê°œìˆ˜)', 'number')" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                <td><span class="reading-result-badge ${getReadingResultClass(st.tests.readingResult)}">${st.tests.readingResult || '-'}</span></td>
                <td>${formatSelect(st.pageId, 'ë…í•´ í•˜ë¸Œë£¨íƒ€', st.tests.havruta, ['ì™„ë£Œí•¨', 'ëª»í•˜ê³ ê°', 'ìˆ™ì œì—†ìŒ'])}</td>
                <td><input class="editable-input" type="number" value="${st.tests.grammarTotal||''}" onchange="updateField(this, '${st.pageId}', 'ë¬¸ë²•(ì „ì²´ ê°œìˆ˜)', 'number')" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                <td><input class="editable-input" type="number" value="${st.tests.grammarWrong||''}" onchange="updateField(this, '${st.pageId}', 'ë¬¸ë²•(í‹€ë¦° ê°œìˆ˜)', 'number')" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                <td class="grammar-score">${formatScoreCircle(st.tests.grammarScore)}</td>
            </tr>`).join('');
        }

        function handleEnterAsTab(event, tableBodyId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const formElements = Array.from(document.querySelectorAll(`#${tableBodyId} input, #${tableBodyId} select`));
                const currentIndex = formElements.indexOf(event.target);
                const nextElement = formElements[currentIndex + 1];
                if (nextElement) { nextElement.focus(); if (nextElement.select) nextElement.select(); } 
                else { event.target.blur(); }
            }
        }

        function getReadingResultClass(result) { if (result === 'PASS') return 'result-pass'; if (result === 'FAIL') return 'result-fail'; return 'result-none'; }
        function getScoreStyle(score) { let color = '#ef4444'; if (score >= 80) color = '#10b981'; else if (score >= 60) color = '#f59e0b'; else if (score >= 40) color = '#facc15'; return `style="--score-color: ${color}; --score-value: ${score}%"`; }
        function formatScoreCircle(score) { 
            if (score === null || isNaN(score) || score === 0 || score === 'N/A') return '<span class="score-none">-</span>'; 
            const style = getScoreStyle(score); 
            return `<div class="score-circle" ${style}><span class="score-text">${Math.round(score)}%</span></div>`; 
        }

        function displayReadingData(data) {
            const tbody = document.getElementById('readingTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="6" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => {
                const books = st.reading.englishBooks || [];
                const bookTags = books.map(book => {
                    let infoText = '';
                    if (book.ar || book.lexile) {
                        const parts = []; if (book.ar) parts.push(`AR ${book.ar}`); if (book.lexile) parts.push(`Lex ${book.lexile}`);
                        infoText = ` <span style="opacity:0.7; font-weight:normal; font-size:0.9em;">(${parts.join(' / ')})</span>`;
                    }
                    return `<span class="book-tag">${book.title}${infoText} <span class="remove-btn" onclick="removeBook('${st.pageId}', '${book.id}', 'english')">Ã—</span></span>`;
                }).join('');
                const addButton = `<button class="book-add-btn" onclick="openAddBookModal('${st.pageId}', 'english')">+ ì¶”ê°€</button>`;
                return `<tr>
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers || []).join(', ')}</td>
                    <td>${formatSelect(st.pageId, 'ğŸ“– ì˜ì–´ë…ì„œ', st.reading.readingStatus, ['ì™„ë£Œí•¨', 'ëª»í•¨'])}</td>
                    <td>${formatSelect(st.pageId, 'ì–´íœ˜í•™ìŠµ', st.reading.vocabStatus, ['ì™„ë£Œ', 'SKIP', 'ë¯¸ì™„ë£Œ'])}</td>
                    <td class="book-list-cell">${bookTags}${addButton}</td>
                    <td>${formatSelect(st.pageId, 'Writing', st.reading.writingStatus, ['SKIP', 'ë¶ë¦¬í¬íŠ¸', '3 SENTENCE'])}</td>
                </tr>`;
            }).join('');
        }

        function openAddBookModal(pageId, type) { currentEditingPageId = pageId; currentBookType = type; const modal = document.getElementById('bookSearchModal'); document.getElementById('modalSearchInput').value = ''; document.getElementById('modalSearchResults').innerHTML = '<div class="no-data" style="padding: 30px;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...</div>'; document.getElementById('modalTitle').textContent = type === 'english' ? 'ğŸ“š ì˜ì–´ ì›ì„œ ê²€ìƒ‰' : 'ğŸ“• êµ­ì–´ ë„ì„œ ê²€ìƒ‰'; modal.classList.add('show'); document.getElementById('modalSearchInput').focus(); }
        // [ìˆ˜ì •] í•¨ìˆ˜ ì´ë¦„ ë³€ê²½: searchEngBooks -> searchBooks (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ í˜¸ì¶œí•˜ëŠ” ì´ë¦„ê³¼ ì¼ì¹˜ì‹œí‚´)
        async function searchBooks(query) { 
            const list = document.getElementById('modalSearchResults'); 
            if(query.length < 2) { list.innerHTML = ''; return; } 
            list.innerHTML = '<div class="loading">ê²€ìƒ‰ì¤‘...</div>'; 
            const endpoint = currentBookType === 'english' ? '/api/search-books' : '/api/search-sayu-books'; 
            try { 
                const res = await fetch(`${API_BASE_URL}${endpoint}?query=${encodeURIComponent(query)}`, { headers: { 'Authorization': 'Bearer ' + authToken } }); 
                const books = await res.json(); 
                if(!books.length) { list.innerHTML = '<div class="no-data">ê²°ê³¼ ì—†ìŒ</div>'; return; } 
                list.innerHTML = books.map((b, i) => { 
                    let meta = ''; 
                    if (currentBookType === 'english') { meta = `ì €ì: ${b.author || ''}`; } else { meta = `ì €ì: ${b.author || ''} | ì¶œíŒ: ${b.publisher || ''}`; } 
                    return `<div class="result-item" onclick="selectBookByIndex(${i})"><div style="font-weight:bold;">${b.title}</div><div style="font-size:12px; color:#666;">${meta}</div></div>`; 
                }).join(''); 
                currentSearchResults = books; 
            } catch(e) { list.innerHTML = 'ì˜¤ë¥˜'; } 
        }
        function selectBookByIndex(index) { const book = currentSearchResults[index]; if (book) addBook(book.id); }
        async function addBook(newId) { if(!currentEditingPageId) return; document.getElementById('bookSearchModal').classList.remove('show'); const row = allReportData.find(d => d.pageId === currentEditingPageId); let currIds = []; let propertyName = ''; if (currentBookType === 'english') { currIds = (row.reading.englishBooks || []).map(b => b.id).filter(id => id); propertyName = 'ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…'; } else { currIds = (row.listening.koreanBooks || []).map(b => b.id).filter(id => id); propertyName = 'êµ­ì–´ ë…ì„œ ì œëª©'; } if(currIds.includes(newId)) { showToast('ì´ë¯¸ ìˆìŒ', 'error'); return; } await updateBookRelation(currentEditingPageId, [...currIds, newId], propertyName); }
        async function removeBook(pid, rid, type) { if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; const row = allReportData.find(d => d.pageId === pid); let currIds = []; let propertyName = ''; if (type === 'english') { currIds = (row.reading.englishBooks || []).map(b => b.id).filter(id => id); propertyName = 'ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…'; } else { currIds = (row.listening.koreanBooks || []).map(b => b.id).filter(id => id); propertyName = 'êµ­ì–´ ë…ì„œ ì œëª©'; } await updateBookRelation(pid, currIds.filter(id => id !== rid), propertyName); }
        async function updateBookRelation(pid, ids, propertyName) { try { await fetch(`${API_BASE_URL}/api/update-homework`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify({ pageId: pid, propertyName: propertyName, newValue: ids, propertyType: 'relation' }) }); showToast('ì—…ë°ì´íŠ¸ ì™„ë£Œ'); loadDataForCurrentTab(); } catch(e) { showToast('ì‹¤íŒ¨', 'error'); } }

        function displayListeningData(data) { 
            const tbody = document.getElementById('listeningTableBody'); 
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="6" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; } 
            
            const listeningOptions = ['ì™„ë£Œ', 'ë¯¸ì™„ë£Œ', 'ì§„í–‰í•˜ì§€ ì•ŠìŒ', 'ì›ì„œë…ì„œë¡œ ëŒ€ì²´', 'ë“£ê¸°í‰ê°€êµì¬ ì™„ë£Œ'];
            const giantOptions = ['ì§„í–‰í•˜ì§€ ì•ŠìŒ', 'ë¯¸ì™„ë£Œ', 'ì™„ë£Œ', 'ì‹œì‘í•¨', 'ì ˆë°˜', 'ê±°ì˜ë‹¤ì½ìŒ', 'ëª»í•¨', 'ì™„ë£Œí•¨'];

            tbody.innerHTML = data.map(st => {
                const kBooks = st.listening.koreanBooks || [];
                const kBookTags = kBooks.map(b => `<span class="book-tag">${b.title} <span class="remove-btn" onclick="removeBook('${st.pageId}', '${b.id}', 'korean')">Ã—</span></span>`).join('');
                const addButton = `<button class="book-add-btn" onclick="openAddBookModal('${st.pageId}', 'korean')">+ ì¶”ê°€</button>`;
                
                return `
                <tr>
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers||[]).join(', ')}</td>
                    <td>${formatHomeworkDropdown(st.pageId, 'ì˜ì–´ ë”ë¹™ í•™ìŠµ ì™„ë£Œ', st.listening.study, listeningOptions)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, 'ë”ë¹™ ì›Œí¬ë¶ ì™„ë£Œ', st.listening.workbook, listeningOptions)}</td>
                    <td class="book-list-cell">${kBookTags}${addButton}</td>
                    <td>${formatSelect(st.pageId, 'ğŸ“• ì±… ì½ëŠ” ê±°ì¸', st.listening.giantStatus, giantOptions)}</td>
                </tr>`;
            }).join('');
        }
        
        // [ìˆ˜ì •] displayCommentData í•¨ìˆ˜: í‚¤ì›Œë“œ ì…ë ¥ì°½ê³¼ AI ë²„íŠ¼ ì¶”ê°€
        function displayCommentData(data) { 
            const tbody = document.getElementById('commentsTableBody'); 
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="5" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; } 
            
            tbody.innerHTML = data.map(st => `
                <tr id="row-comment-${st.pageId}">
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers||[]).join(', ')}</td>
                    <td>${st.comment.grammarClass||'-'}</td>
                    <td style="vertical-align:top;">
                        <!-- [ì‹ ê·œ] í‚¤ì›Œë“œ ì…ë ¥ ë° AI ë²„íŠ¼ -->
                        <div class="keyword-input-container">
                            <input type="text" class="keyword-input" id="keywords-${st.pageId}" placeholder="í‚¤ì›Œë“œ ì…ë ¥ (ì˜ˆ: ì§‘ì¤‘ êµ¿, ë‹¨ì–´ í†µê³¼, ì¡°ê¸ˆ ì¡¸ì•˜ìŒ)" onkeydown="if(event.key==='Enter') generateAIComment('${st.pageId}', '${st.studentName}')">
                            <button class="btn-ai-generate" onclick="generateAIComment('${st.pageId}', '${st.studentName}')">âœ¨ AI ìƒì„±</button>
                        </div>
                        <textarea class="comment-textarea" oninput="autoResizeTextarea(this); markCommentAsChanged(this)" data-page-id="${st.pageId}" id="comment-area-${st.pageId}" defaultValue="${st.comment.teacherComment || ''}">${st.comment.teacherComment || ''}</textarea>
                    </td>
                    <td style="vertical-align:top;">
                        <div class="report-btn-group">
                            <button class="action-btn btn-save comment-save-btn" onclick="updateComment(this, '${st.pageId}')">ì €ì¥</button>
                            <button class="action-btn btn-daily-view" onclick="window.open('${API_BASE_URL}/report?pageId=${st.pageId}&date=${st.date}', '_blank')">ë°ì¼ë¦¬ ë³´ê¸°</button>
                            <button class="action-btn btn-daily-copy" onclick="copyText('${API_BASE_URL}/report?pageId=${st.pageId}&date=${st.date}')">ë°ì¼ë¦¬ ë³µì‚¬</button>
                            <button class="action-btn btn-monthly-view" onclick="viewMonthlyReport('${st.studentName}', '${st.date}')">ì›”ê°„ ë³´ê¸°</button>
                            <button class="action-btn btn-monthly-copy" onclick="openMonthlyReportModal('${st.studentName}', '${st.date}')">ì›”ê°„ ë³µì‚¬</button>
                        </div>
                    </td>
                </tr>`).join(''); 
            
            document.querySelectorAll('.comment-textarea').forEach(el => autoResizeTextarea(el)); 
        }
    
        // [ì‹ ê·œ] AI ì½”ë©˜íŠ¸ ìƒì„± ìš”ì²­ í•¨ìˆ˜
        async function generateAIComment(pageId, studentName) {
            const keywordInput = document.getElementById(`keywords-${pageId}`);
            const textArea = document.getElementById(`comment-area-${pageId}`);
            const keywords = keywordInput.value.trim();
    
            if (!keywords) {
                showToast('í‚¤ì›Œë“œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
                keywordInput.focus();
                return;
            }
    
            // ë¡œë”© í‘œì‹œ
            const originalText = textArea.value;
            textArea.value = "ğŸ¤– AI ì„ ìƒë‹˜ì´ ì½”ë©˜íŠ¸ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...\n(ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!)";
            textArea.disabled = true;
    
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate-daily-comment`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken 
                    },
                    body: JSON.stringify({ 
                        pageId: pageId,
                        studentName: studentName, // ì´ë¦„ë„ ì „ë‹¬
                        keywords: keywords
                    })
                });
    
                const result = await response.json();
    
                if (result.success) {
                    textArea.value = result.comment;
                    showToast('AI ì½”ë©˜íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');
                    
                    // ë³€ê²½ ê°ì§€ íŠ¸ë¦¬ê±° (ì €ì¥ ë²„íŠ¼ í™œì„±í™”)
                    markCommentAsChanged(textArea);
                    autoResizeTextarea(textArea);
                } else {
                    throw new Error(result.message || 'ìƒì„± ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error(error);
                showToast('AI ì½”ë©˜íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                textArea.value = originalText; // ì›ë³µ
            } finally {
                textArea.disabled = false;
            }
        }

        function autoResizeTextarea(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }
        function markCommentAsChanged(el) { const row = el.closest('tr'); const btn = row.querySelector('.comment-save-btn'); if(el.value !== el.defaultValue) { el.style.backgroundColor = '#fffbeb'; btn.textContent = 'ì €ì¥*'; btn.style.background = '#ef4444'; row.classList.add('needs-save'); } else { el.style.backgroundColor = 'white'; btn.textContent = 'ì €ì¥'; btn.style.background = '#10b981'; row.classList.remove('needs-save'); } }
        async function updateComment(btn, pageId, isAutoSave = false) { 
            const row = btn.closest('tr'); const ta = row.querySelector('.comment-textarea'); const val = ta.value; 
            if (!isAutoSave) { btn.disabled = true; btn.textContent = 'ì €ì¥ì¤‘...'; } else { btn.textContent = 'ì €ì¥ì¤‘..'; }
            try { 
                await fetch(`${API_BASE_URL}/api/update-homework`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify({ pageId, propertyName: "â¤ Today's Notice!", newValue: val, propertyType: 'rich_text' }) }); 
                if (!isAutoSave) showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); 
                ta.defaultValue = val; ta.style.backgroundColor = 'white'; btn.textContent = 'ì €ì¥ë¨'; btn.style.background = '#10b981'; row.classList.remove('needs-save');
                if (isAutoSave) { setTimeout(() => { if(btn.textContent === 'ì €ì¥ë¨') btn.textContent = 'ì €ì¥'; }, 2000); }
            } catch(e) { if (!isAutoSave) showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); console.error(e); } 
            finally { if (!isAutoSave) btn.disabled = false; } 
        }
        async function saveAllComments(batchBtn) { const rows = document.querySelectorAll('tr.needs-save'); if(!rows.length) { showToast('ì €ì¥í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.'); return; } batchBtn.disabled = true; let count = 0; for(const row of rows) { const btn = row.querySelector('.comment-save-btn'); const pageId = row.id.replace('row-comment-', ''); await updateComment(btn, pageId); count++; batchBtn.textContent = `ì €ì¥ì¤‘... ${count}/${rows.length}`; } batchBtn.disabled = false; batchBtn.textContent = 'ğŸ’¾ ì¼ê´„ ì €ì¥'; showToast(`${count}ê°œ ì½”ë©˜íŠ¸ ì €ì¥ ì™„ë£Œ`); }
        function copyText(text) { navigator.clipboard.writeText(text).then(() => showToast('ë§í¬ ë³µì‚¬ ì™„ë£Œ!')).catch(() => showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error')); }
        async function viewMonthlyReport(name, date) { try { const res = await fetch(`${API_BASE_URL}/api/monthly-report-url?studentName=${encodeURIComponent(name)}&date=${date}`, { headers: { 'Authorization': 'Bearer ' + authToken } }); const d = await res.json(); if(d.success) window.open(d.url, '_blank'); else alert(d.message); } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); } }
        async function openMonthlyReportModal(name, date) { try { const res = await fetch(`${API_BASE_URL}/api/monthly-report-url?studentName=${encodeURIComponent(name)}&date=${date}`, { headers: { 'Authorization': 'Bearer ' + authToken } }); const d = await res.json(); if(d.success) { const modal = document.getElementById('reportModal'); document.getElementById('reportModalTitle').textContent = 'ğŸ“… ì›”ê°„ ë¦¬í¬íŠ¸ ë§í¬'; document.getElementById('reportModalDesc').textContent = `${name} í•™ìƒì˜ ì§€ë‚œë‹¬ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.`; const inp = document.getElementById('reportLinkInput'); inp.value = d.url; modal.classList.add('show'); } else alert(d.message); } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); } }
        function copyReportLink() { const inp = document.getElementById('reportLinkInput'); inp.select(); document.execCommand('copy'); showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); document.getElementById('reportModal').classList.remove('show'); }
        function openNotionWindow(url) { if (!url || url.startsWith('https://www.notion.so/...')) { alert('ì—°ê²°ëœ ë…¸ì…˜ URLì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'); return; } const windowOptions = 'width=1200,height=800,resizable=yes,scrollbars=yes'; window.open(url, '_blank', windowOptions); }

        function formatSelect(pageId, prop, val, opts) { return `<select class="homework-dropdown" onchange="updateField(this, '${pageId}', '${prop}', 'select')"><option value="">---</option>${opts.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('')}</select>`; }
        function formatStatus(pageId, prop, val) { const opts = ['ìˆ™ì œ í•¨', 'ì•ˆ í•´ì˜´', 'í•´ë‹¹ ì—†ìŒ', 'ì™„ë£Œ', 'ë¯¸ì™„ë£Œ', 'ì§„í–‰í•˜ì§€ ì•ŠìŒ']; const cls = val==='ìˆ™ì œ í•¨'||val==='ì™„ë£Œ'?'status-complete':(val==='ì•ˆ í•´ì˜´'||val==='ë¯¸ì™„ë£Œ'?'status-incomplete':'status-none'); return `<select class="homework-dropdown ${cls}" onchange="updateField(this, '${pageId}', '${prop}', 'status'); this.className='homework-dropdown '+ (this.value==='ìˆ™ì œ í•¨'||this.value==='ì™„ë£Œ'?'status-complete':(this.value==='ì•ˆ í•´ì˜´'||this.value==='ë¯¸ì™„ë£Œ'?'status-incomplete':'status-none'))">${opts.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('')}</select>`; }
        
        // [ìˆ˜ì •] updateField: ì¸ìê°€ ë¶€ì¡±í•  ê²½ìš° data ì†ì„±ì—ì„œ ì½ì–´ì˜¤ë„ë¡ ë³´ê°•
        async function updateField(el, pageId, prop, type, manualVal) { 
            // [ì¶”ê°€] 1. ì¸ìê°€ ë¶€ì¡±í•˜ë©´ elì˜ data ì†ì„± ì‚¬ìš©
            if (!pageId && el && el.dataset) {
                pageId = el.dataset.pageId;
                prop = el.dataset.propertyName;
                type = el.dataset.propertyType;
            }

            // [ì¶”ê°€] 2. ê°’ ê²°ì • (manualValì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ el.value)
            const val = (manualVal !== undefined) ? manualVal : (el ? el.value : '');

            // [ì¶”ê°€] 3. í•„ìˆ˜ ì •ë³´ í™•ì¸
            if (!pageId || !prop) {
                console.error("ì—…ë°ì´íŠ¸ ì •ë³´ ëˆ„ë½:", { el, pageId, prop, type, val });
                showToast('ì—…ë°ì´íŠ¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            try { 
                await fetch(`${API_BASE_URL}/api/update-homework`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, 
                    body: JSON.stringify({ pageId, propertyName: prop, newValue: val, propertyType: type }) 
                }); 
                showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); 
            } catch (e) { 
                showToast('ì‹¤íŒ¨', 'error'); 
            } 
        }
        
        function showToast(msg, type='success') { const t = document.createElement('div'); t.className = `toast-message ${type==='error'?'toast-error':'toast-success'}`; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 2000); }
        function logout() { localStorage.removeItem('teacher_auth_token'); window.location.href='/teacher-login'; }
        function showTab(tab) { currentActiveTab = tab; document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.getElementById(tab+'-view').classList.add('active'); document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active')); document.querySelector(`button[onclick="showTab('${tab}')"]`).classList.add('active'); loadDataForCurrentTab(); }
        
        // [ì‹ ê·œ] ëˆ„ë½ëœ formatHomeworkDropdown ë³µêµ¬
        function formatHomeworkDropdown(pageId, propertyName, currentStatus, options) {
            const defaultStatus = options.includes('ì§„í–‰í•˜ì§€ ì•ŠìŒ') ? 'ì§„í–‰í•˜ì§€ ì•ŠìŒ' : (options.includes('í•´ë‹¹ ì—†ìŒ') ? 'í•´ë‹¹ ì—†ìŒ' : 'ìˆ™ì œ ì—†ìŒ');
            let displayStatus = options.includes(currentStatus) ? currentStatus : defaultStatus;
            const statusClass = getSelectStatusClass(propertyName, displayStatus);
            
            return `<select class="homework-dropdown ${statusClass}" data-page-id="${pageId}" data-property-name="${propertyName}" data-property-type="status" onchange="updateField(this)">
                        ${options.map(option => `<option value="${option}" ${option === displayStatus ? 'selected' : ''}>${option}</option>`).join('')}
                    </select>`;
        }

        // [ì‹ ê·œ] ëˆ„ë½ëœ getSelectStatusClass ë³µêµ¬ (ë¦¬ìŠ¤ë‹ ì˜µì…˜ ì¶”ê°€)
        function getSelectStatusClass(propertyName, value) {
            if (propertyName === 'ì˜ì–´ ë”ë¹™ í•™ìŠµ ì™„ë£Œ' || propertyName === 'ë”ë¹™ ì›Œí¬ë¶ ì™„ë£Œ') {
                if (value === 'ì™„ë£Œ') return 'status-listening-complete';
                if (value === 'ë¯¸ì™„ë£Œ') return 'status-listening-incomplete';
                if (value === 'ì›ì„œë…ì„œë¡œ ëŒ€ì²´') return 'status-listening-replace';
                if (value === 'ë“£ê¸°í‰ê°€êµì¬ ì™„ë£Œ') return 'status-listening-textbook';
                return 'status-listening-none';
            }
            // ê¸°ì¡´ ë¡œì§ í†µí•©
            if (value === 'ìˆ™ì œ í•¨' || value === 'ì™„ë£Œí•¨' || value === 'ì™„ë£Œ') return 'status-complete';
            if (value === 'ì•ˆ í•´ì˜´' || value === 'ëª»í•¨' || value === 'ë¯¸ì™„ë£Œ' || value === 'ëª»í•˜ê³ ê°') return 'status-incomplete';
            return 'status-none';
        }

    </script>
</body>
</html>