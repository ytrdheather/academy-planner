<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ - ë¦¬ë””íŠœë“œ</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ & ë ˆì´ì•„ì›ƒ --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "NanumSquareRound", sans-serif; }
        
        /* [í•µì‹¬] í™”ë©´ ì „ì²´ë¥¼ ê³ ì •í•˜ê³  ë‚´ë¶€ ìŠ¤í¬ë¡¤ë¡œ ë³€ê²½ */
        body { 
            background: #f8f9fa; 
            color: #2d3748; 
            height: 100vh; /* í™”ë©´ ì „ì²´ ë†’ì´ ì‚¬ìš© */
            overflow: hidden; /* ìœˆë„ìš° ìŠ¤í¬ë¡¤ ì œê±° */
            display: flex;
            flex-direction: column; /* ìƒë‹¨ ê³ ì •ì˜ì—­ - í•˜ë‹¨ í…Œì´ë¸”ì˜ì—­ ìˆ˜ì§ ë°°ì¹˜ */
        }

        /* 1. ìƒë‹¨ ê³ ì • ì˜ì—­ (ë¡œê³  + íƒ­ + í•„í„° + ê³µì§€) */
        .fixed-layout-top {
            flex: 0 0 auto; /* í¬ê¸° ìë™ ì¡°ì ˆ (ì¤„ì–´ë“¤ì§€ ì•ŠìŒ) */
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }

        /* 2. í•˜ë‹¨ ë°ì´í„° ì˜ì—­ (ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ + ìŠ¤í¬ë¡¤) */
        .scrollable-layout-bottom {
            flex: 1 1 auto; /* ë‚¨ì€ ê³µê°„ ì±„ìš°ê¸° */
            overflow: hidden; /* ë‚´ë¶€ ì»¨í…Œì´ë„ˆì—ì„œ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ */
            position: relative;
            padding: 0 20px 20px 20px; /* ì¢Œìš° í•˜ë‹¨ ì—¬ë°± */
            display: flex;
            flex-direction: column;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        /* ë©”ì¸ í—¤ë” ìŠ¤íƒ€ì¼ */
        .header { 
            padding: 15px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 70px; 
            border-bottom: 1px solid #e2e8f0;
        }
        .header h1 { font-size: 1.8em; margin: 0; color: #6b46c1; } /* íƒ€ì´í‹€ë„ ì‚´ì§ í‚¤ì›€ */
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-name { font-weight: 600; font-size: 16px; } /* ì´ë¦„ í°íŠ¸ í‚¤ì›€ */
        .logout-btn { background: #6b46c1; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 15px; transition: background 0.2s; } /* 13px -> 15px */
        .logout-btn:hover { background: #5a3eaa; }

        /* íƒ­ ë©”ë‰´ */
        .tab-menu { 
            display: flex; 
            padding: 0 20px; 
            gap: 5px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            background: white;
            flex-wrap: wrap;
        }
        .tab-button { padding: 12px 16px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: 600; color: #6b7280; position: relative; transition: color 0.3s; white-space: nowrap; } /* 14px -> 16px */
        .tab-button.active { color: #6b46c1; }
        .tab-button.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: #8b5cf6; }

        /* í•„í„° ë°” */
        .filter-bar {
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-start;
        }
        .refresh-btn { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px; display:flex; align-items:center; gap:4px; } /* 13px -> 15px */
        .filter-group { display:flex; align-items:center; gap:6px; }
        .filter-label { font-weight: 600; color: #4a5568; font-size: 15px; } /* 13px -> 15px */
        .filter-select, .filter-input { padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 15px; background: white; } /* 13px -> 15px */

        /* ê³µì§€ì‚¬í•­ (ê³ ì • ì˜ì—­ì— í¬í•¨) */
        .notice-wrapper {
            background: #fffbeb;
            border-bottom: 1px solid #e2e8f0;
            padding: 10px 20px;
            font-size: 15px; /* 13px -> 15px */
            color: #744210;
            line-height: 1.4;
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            text-align: center;
        }
        .notice-wrapper strong { color: #b7791f; }

        /* íƒ­ ì»¨í…ì¸  ì»¨í…Œì´ë„ˆ (ìŠ¤í¬ë¡¤ì˜ ì£¼ì²´) */
        .tab-content { 
            display: none; 
            height: 100%; /* ë¶€ëª¨ ë†’ì´ ê½‰ ì±„ì›€ */
            flex-direction: column;
            padding-top: 15px;
        }
        .tab-content.active { display: flex; }

        .section-title { font-size: 1.6em; font-weight: 700; color: #4a5568; margin-bottom: 10px; padding-left: 5px; flex: 0 0 auto; } /* 1.4em -> 1.6em */

        /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ (ì—¬ê¸°ê°€ ì§„ì§œ ìŠ¤í¬ë¡¤ë˜ëŠ” ê³³) */
        .table-scroll-area {
            flex: 1; /* ë‚¨ì€ ë†’ì´ ëª¨ë‘ ì‚¬ìš© */
            overflow: auto; /* ìƒí•˜ì¢Œìš° ìŠ¤í¬ë¡¤ */
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative; /* Sticky ê¸°ì¤€ì  */
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .styled-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 15px; min-width: 1000px; } /* 13px -> 15px */
        
        /* [3ë‹¨ ê³ ì •] í…Œì´ë¸” í—¤ë” (top: 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ìŠ¤í¬ë¡¤ ì˜ì—­ ë§¨ ìœ„ì— ë¶™ìŒ) */
        .styled-table th { 
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); 
            color: white; 
            padding: 12px 10px; 
            text-align: center; 
            font-weight: 600; 
            white-space: nowrap; 
            position: sticky;
            top: 0; /* ìŠ¤í¬ë¡¤ ì˜ì—­ ìµœìƒë‹¨ ê³ ì • */
            z-index: 100; 
            border-bottom: 1px solid #7c3aed;
        }
        
        .styled-table td { padding: 10px 10px; text-align: center; border-bottom: 1px solid #f1f3f4; vertical-align: middle; } /* íŒ¨ë”© ì‚´ì§ ì¦ê°€ */
        .styled-table tr:last-child td { border-bottom: none; }
        
        /* í•™ìƒ ì´ë¦„ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì‹œ ê³ ì • (ì™¼ìª½) */
        .student-name { 
            font-weight: 700; color: #2d3748; text-align: center; padding: 10px; 
            min-width: 300px; /* [ìˆ˜ì •] ë„ˆë¹„ ë„“í˜ (ë²„íŠ¼ í¬í•¨ ê³µê°„) */
            background-color: #fcf7ff; 
            position: sticky; 
            left: 0; 
            z-index: 50; /* í—¤ë”ë³´ë‹¨ ë‚®ê²Œ */
            border-right: 2px solid #e9ecef;
        }
        /* í—¤ë”ì˜ ì²« ë²ˆì§¸ ì…€(í•™ìƒì´ë¦„)ì€ z-indexê°€ ë” ë†’ì•„ì•¼ í•¨ */
        .styled-table th:first-child { z-index: 110; left: 0; }

        .student-name-wrapper { 
            display: flex; 
            flex-direction: row; /* [ì¤‘ìš”] ê°€ë¡œ ë°°ì¹˜ */
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            width: 100%; 
        }
        
        .loading, .no-data { text-align: center; padding: 40px; color: #718096; font-size: 16px; } /* 14px -> 16px */

        /* ê¸°íƒ€ UI ì»´í¬ë„ŒíŠ¸ */
        .book-tag { background: #f3e8ff; color: #6b46c1; border: 1px solid #d8b4fe; border-radius: 12px; padding: 3px 10px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; margin: 2px; } /* 11px -> 13px */
        .book-tag .remove-btn { cursor: pointer; color: #9333ea; font-size: 16px; font-weight: bold; } /* 14px -> 16px */
        .book-add-btn { background: #e9d5ff; color: #6b46c1; border: 1px dashed #d8b4fe; border-radius: 8px; padding: 3px 10px; font-size: 13px; cursor: pointer; font-weight: bold; margin-left: 4px; } /* 11px -> 13px */

        .status-badge { padding: 6px 10px; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; display: inline-block; min-width: 50px; text-align: center; border: 1px solid transparent; transition: all 0.2s; user-select: none; } /* 11px -> 13px */
        .status-complete { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .status-incomplete { background-color: #fecaca; color: #991b1b; border-color: #fca5a5; }
        .status-none { background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db; }
        
        .batch-controls { display: flex; gap: 4px; margin-top: 0; justify-content: center; }
        .batch-btn { font-size: 12px; padding: 3px 8px; border-radius: 4px; border-width: 1px; border-style: solid; cursor: pointer; font-weight: 700; background: white; white-space: nowrap; } /* 10px -> 12px */
        .batch-ok { color: #15803d; border-color: #16a34a; }
        .batch-no { color: #b91c1c; border-color: #dc2626; }
        .batch-reset { color: #475569; border-color: #94a3b8; }

        .homework-dropdown { padding: 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; font-weight: 600; text-align: center; cursor: pointer; background: white; width: 100%; max-width: 130px; } /* 11px -> 13px, max-width ì¦ê°€ */
        .homework-dropdown.status-complete { background-color: #dcfce7; color: #166534; }
        .homework-dropdown.status-incomplete { background-color: #fecaca; color: #991b1b; }
        .homework-dropdown.status-default { background-color: #f3f4f6; color: #6b7280; }
        
        /* [ë³µêµ¬] íŒŒë€ìƒ‰ ì„œì‹ ì¶”ê°€ */
        .homework-dropdown.status-blue { background-color: #e0f2fe; color: #0369a1; border-color: #bae6fd; }

        .editable-input { padding: 5px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center; width: 55px; font-size: 14px; } /* 12px -> 14px */
        .editable-text-input { width: 110px; text-align: left; }

        .score-circle { width: 36px; height: 36px; border-radius: 50%; background: conic-gradient(var(--score-color, #e5e7eb) 0% var(--score-value, 0%), #e5e7eb var(--score-value, 0%) 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto; position: relative; } /* í¬ê¸° ì•½ê°„ ì¦ê°€ */
        .score-circle::before { content: ''; position: absolute; width: 75%; height: 75%; background: white; border-radius: 50%; }
        .score-text { position: relative; font-size: 12px; font-weight: 700; color: var(--score-color, #6b7280); } /* 10px -> 12px */
        .score-none { font-size: 13px; font-weight: 600; color: #9ca3af; } /* 11px -> 13px */
        .reading-result-badge { padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 12px; } /* 10px -> 12px */
        .result-pass { background-color: #dcfce7; color: #166534; }
        .result-fail { background-color: #fecaca; color: #991b1b; }

        /* [ë³µêµ¬] ì½”ë©˜íŠ¸ ì…ë ¥ì°½ ëŠ˜ì–´ë‚˜ëŠ” ìŠ¤íƒ€ì¼ì€ JSë¡œ ì²˜ë¦¬í•˜ì§€ë§Œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .comment-textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; min-height: 55px; resize: none; overflow: hidden; line-height: 1.5; } /* 12px -> 14px */
        .report-btn-group { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; }
        .action-btn { border: none; padding: 6px 10px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; } /* 11px -> 13px */
        .btn-save { background: #10b981; color: white; }
        .btn-daily-view { background: #e0f2fe; color: #0284c7; }
        .btn-daily-copy { background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; }
        .btn-monthly-view { background: #f3e8ff; color: #7e22ce; border: 1px solid #d8b4fe; }
        .btn-monthly-copy { background: #fdf4ff; color: #a855f7; border: 1px solid #f0abfc; }

        /* ê´€ë¦¬ì ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .admin-links-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 15px; }
        .admin-link-button { background: #ffffff; color: #6b46c1; border: 2px solid #e2e8f0; padding: 22px; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 700; text-align: center; transition: all 0.2s; } /* 14px -> 16px */
        .admin-link-button:hover { border-color: #8b5cf6; background: #fcf7ff; transform: translateY(-2px); }
        .manager-only-link { display: none; background-color: #f8fafc; border-color: #cbd5e0; color: #4a5568; }

        .grammar-input-container { background: #f3e8ff; padding: 15px; border-radius: 8px; border: 1px solid #d8b4fe; display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; margin-bottom: 10px; }
        .grammar-group { display: flex; flex-direction: column; gap: 4px; }
        .grammar-label { font-size: 14px; font-weight: 700; color: #6b46c1; } /* 12px -> 14px */
        .grammar-input { padding: 8px 12px; border: 1px solid #d8b4fe; border-radius: 6px; font-size: 15px; } /* 13px -> 15px */
        .grammar-btn { padding: 8px 18px; background: #8b5cf6; color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 14px; }

        /* ìœ í‹¸ë¦¬í‹° */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 5000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 480px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-search-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }
        .modal-search-results { max-height: 250px; overflow-y: auto; border: 1px solid #f1f3f4; }
        .result-item { padding: 12px; border-bottom: 1px solid #f1f3f4; cursor: pointer; font-size: 15px; }
        .result-item:hover { background: #f8f9ff; }
        
        .toast-message { position: fixed; top: 20px; right: 20px; padding: 12px 20px; background: #333; color: white; border-radius: 8px; z-index: 6000; opacity: 0; transition: opacity 0.3s; pointer-events: none; font-size: 15px; }
        .toast-message.show { opacity: 1; }
        
        .keyword-input-container { display: flex; gap: 4px; margin-bottom: 5px; }
        .keyword-input { flex: 1; padding: 8px; border: 1px solid #d8b4fe; border-radius: 6px; font-size: 14px; } /* 12px -> 14px */
        .btn-ai-generate { padding: 8px 12px; background: #8b5cf6; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; } /* 11px -> 13px */
        
        .report-modal-desc { margin-bottom: 15px; font-size: 15px; color: #4b5563; } /* 13px -> 15px */

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- 1. ìƒë‹¨ ê³ ì • ì˜ì—­ (í™”ë©´ì—ì„œ ì ˆëŒ€ ì›€ì§ì´ì§€ ì•ŠìŒ) -->
    <div class="fixed-layout-top">
        <div class="header">
            <h1>ğŸ“š ë¦¬ë””íŠœë“œ ì„ ìƒë‹˜</h1>
            <div class="user-info">
                <span class="user-name" id="userName">ë¡œë”©ì¤‘...</span>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="tab-menu">
            <button class="tab-button active" onclick="showTab('homework')">ìˆ™ì œ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('tests')">í…ŒìŠ¤íŠ¸ ê²°ê³¼</button>
            <button class="tab-button" onclick="showTab('reading')">ì›ì„œ ë…ì„œ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('listening')">ë¦¬ìŠ¤ë‹ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('grammar')">ğŸ“š ë¬¸ë²• ê´€ë¦¬</button>
            <button class="tab-button" onclick="showTab('comments')">ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</button>
            <button class="tab-button" id="tab-admin" onclick="showTab('admin')" style="color: #d946ef; font-weight: 700;">âš™ï¸ ê´€ë¦¬ì</button>
        </div>

        <div class="filter-bar" id="commonFilterBar">
            <button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            
            <div class="filter-group">
                <span class="filter-label">ë‚ ì§œ:</span>
                <select id="commonPeriodFilter" class="filter-select" onchange="toggleCommonDateInput()">
                    <option value="today" selected>ì˜¤ëŠ˜</option>
                    <option value="specific_date">ë‚ ì§œ ì§€ì •</option>
                </select>
                <input type="date" id="commonSpecificDate" class="filter-input" style="display:none;" onchange="loadDataForCurrentTab()">
            </div>
            
            <div class="filter-group" id="commonTeacherFilterGroup" style="display:none;">
                <span class="filter-label">ë‹´ë‹¹:</span>
                <select id="commonTeacherFilter" class="filter-select" onchange="filterDataByTeacher()"><option value="">ì „ì²´ ë³´ê¸°</option></select>
            </div>

            <div class="filter-group hidden" id="grammarClassFilterGroup">
                <span class="filter-label">ë¬¸ë²•ë°˜:</span>
                <select id="grammarClassFilter" class="filter-select" onchange="filterDataByTeacher()"><option value="">ì „ì²´ ë¬¸ë²•ë°˜</option></select>
            </div>
            <button class="refresh-btn batch-save-btn hidden" id="batchSaveBtn" onclick="saveAllComments(this)">ğŸ’¾ ì¼ê´„ ì €ì¥</button>
        </div>

        <!-- ê³µì§€ì‚¬í•­ (ìˆ™ì œ íƒ­ ì „ìš©) -->
        <div id="stickyNoticeWrapper" class="notice-wrapper">
            ğŸ“¢ ë§¤ë‹¬ ìˆ™ì œ ìˆ˜í–‰ìœ¨ê³¼ ì„±ì‹¤ë„ ì ìˆ˜, RT-Check pointê°€ ì‚°ì¶œ ë©ë‹ˆë‹¤. 
            <strong>RT í¬ì¸íŠ¸ 70ì  ì´í•˜ë¥¼ 2ë‹¬ ì—°ì† ë§ê²Œ ë˜ë©´ íŒ¨ë„í‹° ë¶€ê³¼ ë° ì¡°ì¹˜ê°€ ìˆìœ¼ë‹ˆ</strong> 
            ë§¤ì¼ì˜ ì„±ì‹¤í•¨ì„ ì§€í‚¬ ìˆ˜ ìˆë„ë¡ í•´ì£¼ì„¸ìš”!
        </div>
    </div>

    <!-- 2. í•˜ë‹¨ ë°ì´í„° ì˜ì—­ (ì—¬ê¸°ë§Œ ìŠ¤í¬ë¡¤ ë¨) -->
    <div class="scrollable-layout-bottom">
        
        <!-- 1. ìˆ™ì œ í˜„í™© -->
        <div id="homework-view" class="tab-content active">
            <div class="section-title">ğŸ“‹ ë‹´ë‹¹ í•™ìƒ ìˆ™ì œ í˜„í™©</div>
            <div class="table-scroll-area">
                <table class="styled-table">
                    <thead><tr> <th>í•™ìƒì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ì¶œì„</th> <th>â­• ë¬¸ë²•ìˆ™ì œ</th> <th>1ï¸âƒ£ ì–´íœ˜í´ì¹´</th> <th>2ï¸âƒ£ ë…í•´í´ì¹´</th> <th>4ï¸âƒ£ Summary</th> <th>5ï¸âƒ£ ë…í•´ì„œ í’€ê¸°</th> <th>6ï¸âƒ£ ë¶€&ë§¤&ì¼</th> <th>ìˆ˜í–‰ìœ¨</th> </tr></thead>
                    <tbody id="homeworkTableBody"><tr><td colspan="10" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- 2. í…ŒìŠ¤íŠ¸ ê²°ê³¼ -->
        <div id="tests-view" class="tab-content">
            <div class="section-title">ğŸ“ ë‹´ë‹¹ í•™ìƒ í…ŒìŠ¤íŠ¸ ê²°ê³¼</div>
            <div class="table-scroll-area">
                <table class="styled-table">
                    <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ì–´íœ˜ìœ ë‹›</th> <th>ì–´íœ˜ì •ë‹µ</th> <th>ì´ê°¯ìˆ˜</th> <th>ì–´íœ˜ì ìˆ˜</th> <th>ë…í•´ì˜¤ë‹µ</th> <th>ë…í•´ê²°ê³¼</th> <th>í•˜ë¸Œë£¨íƒ€</th> <th>ë¬¸ë²•ë¬¸í•­</th> <th>ë¬¸ë²•ì˜¤ë‹µ</th> <th>ë¬¸ë²•ì ìˆ˜</th> </tr></thead>
                    <tbody id="testsTableBody"><tr><td colspan="11" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- 3. ì›ì„œ ë…ì„œ í˜„í™© -->
        <div id="reading-view" class="tab-content">
            <div class="section-title">ğŸ“š ì›ì„œ ë…ì„œ í˜„í™©</div>
            <div class="table-scroll-area">
                <table class="styled-table">
                    <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ğŸ“– ì˜ì–´ë…ì„œ</th> <th>ì–´íœ˜í•™ìŠµ</th> <th>ğŸ“š ì½ì€ ì±… ëª©ë¡ (íƒœê·¸)</th> <th>Writing</th> </tr></thead>
                    <tbody id="readingTableBody"><tr><td colspan="6" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- 4. ë¦¬ìŠ¤ë‹ í˜„í™© -->
        <div id="listening-view" class="tab-content">
            <div class="section-title">ğŸ§ ë¦¬ìŠ¤ë‹ & ì±…ê±° í˜„í™©</div>
            <div class="table-scroll-area">
                <table class="styled-table">
                    <thead>
                        <tr><th>í•™ìƒ ì´ë¦„</th><th>ë‹´ë‹¹ê°•ì‚¬</th><th>ì˜ì–´ ë”ë¹™ í•™ìŠµ</th><th>ë”ë¹™ ì›Œí¬ë¶</th><th>êµ­ì–´ ë…ì„œ(íƒœê·¸)</th><th>ì±… ì½ëŠ” ê±°ì¸</th></tr>
                    </thead>
                    <tbody id="listeningTableBody"><tr><td colspan="6" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- 5. ë¬¸ë²• ê´€ë¦¬ -->
        <div id="grammar-view" class="tab-content">
            <div class="section-title">ğŸ“š ë¬¸ë²• ìˆ™ì œ ê´€ë¦¬</div>
            <div class="grammar-input-container">
                <div class="grammar-group">
                    <label class="grammar-label">ëŒ€ìƒ ë°˜ ì„ íƒ</label>
                    <select id="grammarClassSelect" class="grammar-input"><option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
                </div>
                <div class="grammar-group">
                    <label class="grammar-label">ì˜¤ëŠ˜ ë¬¸ë²• ì§„ë„</label>
                    <input type="text" id="grammarTopicInput" class="grammar-input" placeholder="ì˜ˆ: toë¶€ì •ì‚¬">
                </div>
                <div class="grammar-group" style="flex-grow: 1;">
                    <label class="grammar-label">ë¬¸ë²• ê³¼ì œ ë‚´ìš©</label>
                    <input type="text" id="grammarHomeworkInput" class="grammar-input" style="width: 100%;" placeholder="ì˜ˆ: P.20~24 í’€ê¸°">
                </div>
                <button class="grammar-btn" onclick="updateGrammarByClass()">ë°˜ ì „ì²´ ì ìš©</button>
            </div>
            <div class="table-scroll-area">
                <table class="styled-table">
                    <colgroup><col style="width:15%"><col style="width:10%"><col style="width:37%"><col style="width:38%"></colgroup>
                    <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë¬¸ë²• ë°˜</th> <th>ì˜¤ëŠ˜ ë¬¸ë²• ì§„ë„</th> <th>ë¬¸ë²• ê³¼ì œ ë‚´ìš©</th> </tr></thead>
                    <tbody id="grammarTableBody"><tr><td colspan="4" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- 6. ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸ -->
        <div id="comments-view" class="tab-content">
            <div class="section-title">ğŸ’¬ ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</div>
            <div class="table-scroll-area">
                <table class="styled-table">
                    <colgroup><col style="width:10%"><col style="width:8%"><col style="width:8%"><col style="width:44%"><col style="width:30%"></colgroup>
                    <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ë¬¸ë²• í´ë˜ìŠ¤</th> <th>ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</th> <th>ê´€ë¦¬</th> </tr></thead>
                    <tbody id="commentsTableBody"><tr><td colspan="5" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                </table>
            </div>
        </div>
        
        <!-- 7. ê´€ë¦¬ì ë©”ë‰´ -->
        <div id="admin-view" class="tab-content">
            <div class="section-title">âš™ï¸ ê´€ë¦¬ì ë°”ë¡œê°€ê¸° (Notion DB)</div>
            <div class="table-scroll-area" style="padding: 20px; border:none; background: transparent; box-shadow: none;">
                <div class="admin-links-container">
                    <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/NEW-25e09320bce28039a575c1405c9c0d4f?source=copy_link')">ë¬¸ë²• ìˆ™ì œ ê´€ë¦¬</button>
                    <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/20009320bce28012b740dc6df5e1303c?source=copy_link')">êµì¬ë¹„ ì…ê¸ˆ ë‚´ì—­</button>
                    <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/NEW-26109320bce280b38808dc57f5bd5978?source=copy_link')">ì›ìƒ êµì¬ ê´€ë¦¬</button>
                    <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/18f09320bce280a29d3cc25d117511a7?source=copy_link')">êµì¬ ë°ì´í„° ë² ì´ìŠ¤</button>
                    <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/9ef2bbaeec19466daa0d0c0677b9eb90?v=064779482df2493699322be11a41dcbf&source=copy_link')">ì›ì„œ ë…ì„œ ë¦¬ìŠ¤íŠ¸</button>
                    <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/cf82d56634574d7e83d893fbf1b1a4e3?v=1c903b34bd3746c6be6cfb932cd9fabd&source=copy_link')">êµ­ì–´ ë…ì„œ ë¦¬ìŠ¤íŠ¸</button>
                    <button class="admin-link-button" onclick="openNotionWindow('https://www.notion.so/readitude/NEW-25409320bce280819167cae477b16fe6?source=copy_link')">í•™ìƒ ëª…ë¶€ ê´€ë¦¬</button>
                    <button class="admin-link-button manager-only-link" onclick="openNotionWindow('https://www.notion.so/readitude/1a109320bce28078a744ff94e98f8792?source=copy_link')">ğŸ§‘â€ğŸ’¼ ìƒë‹´ ê´€ë¦¬ ë©”ë‰´ (ê´€)</button>
                    <button class="admin-link-button manager-only-link" onclick="openNotionWindow('https://www.notion.so/readitude/25409320bce2807697ede3f1c1b62ada?v=25409320bce2815da94b000c1cc63b2f&source=copy_link')">ğŸ§‘â€ğŸ’¼ í•™ìƒ ì§„ë„ ê´€ë¦¬ (ê´€)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ë“± -->
    <div id="bookSearchModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="section-title" id="modalTitle">ğŸ“š ì±… ì œëª© ê²€ìƒ‰</h2>
            <input type="text" id="modalSearchInput" class="modal-search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <div id="modalSearchResults" class="modal-search-results"><div class="no-data">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...</div></div>
            <button onclick="document.getElementById('bookSearchModal').classList.remove('show')" style="width:100%; padding:10px; margin-top:15px; border:none; background:#f3f4f6; border-radius:8px; cursor:pointer;">ë‹«ê¸°</button>
        </div>
    </div>
    
    <div id="reportModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="section-title" id="reportModalTitle">ğŸ”— ë¦¬í¬íŠ¸ ë§í¬</h2>
            <p id="reportModalDesc" class="report-modal-desc"></p>
            <input type="text" id="reportLinkInput" class="modal-search-input" readonly>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button onclick="document.getElementById('reportModal').classList.remove('show')" style="padding:8px 16px; border:1px solid #e5e7eb; background:white; border-radius:6px; cursor:pointer;">ë‹«ê¸°</button>
                <button id="copyReportLinkBtn" onclick="copyReportLink()" style="padding:8px 16px; background:#6b46c1; color:white; border:none; border-radius:6px; cursor:pointer;">ë³µì‚¬í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let authToken = localStorage.getItem('teacher_auth_token');
        let allReportData = [];
        let currentActiveTab = 'homework';
        let bookSearchTimer = null;
        let currentEditingPageId = null;
        let currentBookType = 'english';
        let currentUserRole = '';
        let currentUserName = '';
        let currentSearchResults = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) { window.location.href='/teacher-login'; return; }
            
            document.getElementById('commonPeriodFilter').value = 'today';
            document.getElementById('commonSpecificDate').style.display = 'none';

            loadUserInfo();
            showTab('homework');
            
            document.getElementById('modalSearchInput').addEventListener('input', (e) => {
                clearTimeout(bookSearchTimer);
                const query = e.target.value;
                bookSearchTimer = setTimeout(() => searchBooks(query), 300);
            });
        });

        async function loadUserInfo() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/teacher/user-info`, { headers:{Authorization:'Bearer '+authToken} });
                const data = await res.json();
                currentUserName = data.userName;
                currentUserRole = data.userRole;
                document.getElementById('userName').textContent = `${data.userName} (${data.userRole === 'manager' ? 'ê´€ë¦¬ì' : 'ì„ ìƒë‹˜'})`;
                loadTeachersList();
                
                // ê´€ë¦¬ì ë©”ë‰´ ë²„íŠ¼ í‘œì‹œ ì œì–´
                const managerLinks = document.querySelectorAll('.manager-only-link');
                managerLinks.forEach(link => {
                    link.style.display = (currentUserRole === 'manager') ? 'block' : 'none';
                });
            } catch (e) { logout(); }
        }

        async function loadTeachersList() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/teachers`, { headers:{Authorization:'Bearer '+authToken} });
                const teachers = await res.json();
                const container = document.getElementById('commonTeacherFilterGroup');
                const select = document.getElementById('commonTeacherFilter');
                
                if (currentUserRole === 'manager') {
                    container.style.display = 'flex';
                    teachers.forEach(t => { const opt = document.createElement('option'); opt.value = t.name; opt.textContent = t.name; select.appendChild(opt); });
                } else {
                    container.style.display = 'flex';
                    const myOpt = document.createElement('option'); myOpt.value = currentUserName; myOpt.textContent = currentUserName + ' (ë‚˜)'; select.appendChild(myOpt);
                    select.value = currentUserName; select.disabled = true;
                }
            } catch(e) { console.error(e); }
        }

        function toggleCommonDateInput() {
            const period = document.getElementById('commonPeriodFilter').value;
            const dateInput = document.getElementById('commonSpecificDate');
            dateInput.style.display = period === 'specific_date' ? 'block' : 'none';
            if (period === 'today') loadDataForCurrentTab();
        }

        function filterDataByTeacher() {
            const teacherSelect = document.getElementById('commonTeacherFilter');
            let filteredData = allReportData;

            if (teacherSelect && teacherSelect.value) { 
                const selectedTeacher = teacherSelect.value;
                filteredData = filteredData.filter(item => item.teachers && item.teachers.includes(selectedTeacher));
            }

            if (currentActiveTab === 'comments') {
                const grammarSelect = document.getElementById('grammarClassFilter');
                if (grammarSelect && grammarSelect.value) {
                    const selectedClass = grammarSelect.value;
                    filteredData = filteredData.filter(item => item.comment && item.comment.grammarClass === selectedClass);
                }
            }
            displayDataForAllTabs(filteredData);
        }

        async function loadDataForCurrentTab() {
            const period = document.getElementById('commonPeriodFilter').value;
            const date = document.getElementById('commonSpecificDate').value;
            let url = `${API_BASE_URL}/api/daily-report-data?period=${period}`;
            if (period === 'specific_date' && date) url += `&date=${date}`;

            try {
                const res = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!res.ok) throw new Error('Load failed');
                allReportData = await res.json();
                
                if (currentActiveTab === 'grammar') updateGrammarClassList(allReportData);
                if (currentActiveTab === 'comments') updateCommentGrammarFilterList(allReportData);
                
                filterDataByTeacher();
            } catch (e) { console.error(e); showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error'); }
        }

        function showTab(tab) {
            currentActiveTab = tab;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tab+'-view').classList.add('active');
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.querySelector(`button[onclick="showTab('${tab}')"]`).classList.add('active');
            
            const grammarFilter = document.getElementById('grammarClassFilterGroup');
            const batchSaveBtn = document.getElementById('batchSaveBtn');
            const notice = document.getElementById('stickyNoticeWrapper');
            
            if (tab === 'comments') {
                grammarFilter.classList.remove('hidden');
                batchSaveBtn.classList.remove('hidden');
            } else {
                grammarFilter.classList.add('hidden');
                batchSaveBtn.classList.add('hidden');
            }

            if (tab === 'homework') notice.style.display = 'block';
            else notice.style.display = 'none';
            
            loadDataForCurrentTab();
        }

        // --- í¬ë§·íŒ… í•¨ìˆ˜ë“¤ ---
        function formatSelect(pageId, propertyName, currentValue, options) {
            // [ë³µêµ¬] ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ í´ë˜ìŠ¤ ì ìš©
            const defaultStatus = 'status-default';
            let statusClass = 'status-default';
            
            if (currentValue === 'ì™„ë£Œí•¨' || currentValue === 'ì™„ë£Œ') statusClass = 'status-complete';
            else if (currentValue === 'ëª»í•¨' || currentValue === 'ë¯¸ì™„ë£Œ') statusClass = 'status-incomplete';
            else if (currentValue === 'skip' || currentValue === 'SKIP' || currentValue === 'ì›ì„œë…ì„œë¡œ ëŒ€ì²´' || currentValue === 'ë“£ê¸°í‰ê°€êµì¬ ì™„ë£Œ') statusClass = 'status-blue'; // íŒŒë€ìƒ‰

            return `<select class="homework-dropdown ${statusClass}" 
                        data-page-id="${pageId}" 
                        data-property-name="${propertyName}" 
                        data-property-type="select" 
                        onchange="updateField(this)">
                        <option value="">ì„ íƒ</option>
                        ${options.map(option => `<option value="${option}" ${option === currentValue ? 'selected' : ''}>${option}</option>`).join('')}
                    </select>`;
        }

        function formatHomeworkDropdown(pageId, propertyName, currentStatus, options) {
            const defaultStatus = options.includes('ì§„í–‰í•˜ì§€ ì•ŠìŒ') ? 'ì§„í–‰í•˜ì§€ ì•ŠìŒ' : (options.includes('í•´ë‹¹ ì—†ìŒ') ? 'í•´ë‹¹ ì—†ìŒ' : 'ìˆ™ì œ ì—†ìŒ');
            let displayStatus = options.includes(currentStatus) ? currentStatus : defaultStatus;
            
            // [ë³µêµ¬] ìƒ‰ìƒ ì ìš© ë¡œì§
            let statusClass = 'status-default';
            if (displayStatus.includes('ì™„ë£Œ') || displayStatus.includes('ìˆ™ì œ í•¨')) statusClass = 'status-complete';
            else if (displayStatus.includes('ë¯¸ì™„ë£Œ') || displayStatus.includes('ì•ˆ í•´ì˜´') || displayStatus.includes('ëª»í•¨')) statusClass = 'status-incomplete';
            else if (displayStatus.includes('ì›ì„œë…ì„œë¡œ ëŒ€ì²´') || displayStatus.includes('ë“£ê¸°í‰ê°€êµì¬ ì™„ë£Œ')) statusClass = 'status-blue'; // íŒŒë€ìƒ‰

            return `<select class="homework-dropdown ${statusClass}" data-page-id="${pageId}" data-property-name="${propertyName}" data-property-type="status" onchange="updateField(this)">
                        ${options.map(option => `<option value="${option}" ${option === displayStatus ? 'selected' : ''}>${option}</option>`).join('')}
                    </select>`;
        }

        function displayDataForAllTabs(data) {
            displayHomeworkData(data);
            displayTestData(data);
            displayReadingData(data);
            displayListeningData(data);
            displayCommentData(data);
            displayGrammarData(data);
        }

        // --- íƒ­ë³„ ë””ìŠ¤í”Œë ˆì´ í•¨ìˆ˜ë“¤ ---
        function displayHomeworkData(data) {
            const tbody = document.getElementById('homeworkTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="10" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `<tr id="row-hw-${st.pageId}">
                <td class="student-name">
                    <div class="student-name-wrapper">
                        <span>${st.studentName}</span>
                        <div class="batch-controls">
                            <button class="batch-btn batch-ok" onclick="markAllHomework('${st.pageId}', 'ìˆ™ì œ í•¨')">ì „ì²´O</button>
                            <button class="batch-btn batch-no" onclick="markAllHomework('${st.pageId}', 'ì•ˆ í•´ì˜´')">ì „ì²´X</button>
                            <button class="batch-btn batch-reset" onclick="markAllHomework('${st.pageId}', 'ìˆ™ì œ ì—†ìŒ')">ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                </td>
                <td>${(st.teachers||[]).join(', ')}</td>
                <td><input type="checkbox" ${st.homework.attendance ? 'checked' : ''} onchange="updateField(this, '${st.pageId}', 'ì¶œì„', 'checkbox', this.checked)"></td>
                <td>${renderToggleBadge(st.pageId, 'â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬', st.homework.grammar)}</td>
                <td>${renderToggleBadge(st.pageId, '1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ', st.homework.vocabCards)}</td>
                <td>${renderToggleBadge(st.pageId, '2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ', st.homework.readingCards)}</td>
                <td>${renderToggleBadge(st.pageId, '4ï¸âƒ£ Summary ìˆ™ì œ', st.homework.summary)}</td>
                <td>${renderToggleBadge(st.pageId, '5ï¸âƒ£ ë…í•´ì„œ í’€ê¸°', st.homework.dailyReading)}</td>
                <td>${renderToggleBadge(st.pageId, '6ï¸âƒ£ ë¶€&ë§¤&ì¼', st.homework.diary)}</td>
                <td style="font-weight:bold; color:${(st.completionRate === null || st.completionRate === 'N/A') ? '#9ca3af' : (st.completionRate >= 80 ? '#10b981' : '#ef4444')}">${st.completionRate === null ? 'N/A' : st.completionRate + '%'}</td>
            </tr>`).join('');
        }

        function renderToggleBadge(pageId, prop, val) {
            const statusMap = { 'ìˆ™ì œ í•¨': 'status-complete', 'ì™„ë£Œ': 'status-complete', 'ì•ˆ í•´ì˜´': 'status-incomplete', 'ë¯¸ì™„ë£Œ': 'status-incomplete', 'ìˆ™ì œ ì—†ìŒ': 'status-none', 'í•´ë‹¹ ì—†ìŒ': 'status-none', 'ì§„í–‰í•˜ì§€ ì•ŠìŒ': 'status-none' };
            const displayVal = val || 'ìˆ™ì œ ì—†ìŒ';
            const cls = statusMap[displayVal] || 'status-none';
            return `<span class="status-badge ${cls}" onclick="toggleStatus(this, '${pageId}', '${prop}', '${displayVal}')">${displayVal}</span>`;
        }

        async function toggleStatus(el, pageId, prop, currentVal) {
            const sequence = ['ìˆ™ì œ í•¨', 'ì•ˆ í•´ì˜´', 'ìˆ™ì œ ì—†ìŒ'];
            let nextIndex = sequence.indexOf(currentVal) + 1;
            if (nextIndex >= sequence.length) nextIndex = 0;
            const nextVal = sequence[nextIndex];
            el.textContent = nextVal;
            el.className = `status-badge ${nextVal === 'ìˆ™ì œ í•¨' ? 'status-complete' : (nextVal === 'ì•ˆ í•´ì˜´' ? 'status-incomplete' : 'status-none')}`;
            el.onclick = () => toggleStatus(el, pageId, prop, nextVal);
            await updateField(null, pageId, prop, 'status', nextVal);
        }

        async function markAllHomework(pageId, status) {
            let apiValue = status === 'ì´ˆê¸°í™”' ? 'ìˆ™ì œ ì—†ìŒ' : status;
            if (!confirm(`ëª¨ë“  ìˆ™ì œë¥¼ "${apiValue}"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const props = ['â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬', '1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ', '2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ', '4ï¸âƒ£ Summary ìˆ™ì œ', '5ï¸âƒ£ ë…í•´ì„œ í’€ê¸°', '6ï¸âƒ£ ë¶€&ë§¤&ì¼'];
            
            try {
                const updates = {};
                props.forEach(prop => { updates[prop] = { value: apiValue, type: 'status' }; });
                await fetch(`${API_BASE_URL}/api/update-homework`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ pageId: pageId, updates: updates })
                });
                showToast(`ì²˜ë¦¬ ì™„ë£Œ`);
                loadDataForCurrentTab();
            } catch(e) { showToast('ì²˜ë¦¬ ì‹¤íŒ¨', 'error'); }
        }

        function displayTestData(data) {
            const tbody = document.getElementById('testsTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="11" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `<tr>
                <td class="student-name">${st.studentName}</td>
                <td><input class="editable-input editable-text-input" value="${st.tests.vocabUnit||''}" onchange="updateField(this, '${st.pageId}', 'ì–´íœ˜ìœ ë‹›', 'rich_text')"></td>
                <td><input class="editable-input" type="number" value="${st.tests.vocabCorrect||''}" onchange="updateField(this, '${st.pageId}', 'ë‹¨ì–´(ë§ì€ ê°œìˆ˜)', 'number')"></td>
                <td><input class="editable-input" type="number" value="${st.tests.vocabTotal||''}" onchange="updateField(this, '${st.pageId}', 'ë‹¨ì–´(ì „ì²´ ê°œìˆ˜)', 'number')"></td>
                <td>${formatScoreCircle(st.tests.vocabScore)}</td>
                <td><input class="editable-input" type="number" value="${st.tests.readingWrong||''}" onchange="updateField(this, '${st.pageId}', 'ë…í•´(í‹€ë¦° ê°œìˆ˜)', 'number')"></td>
                <td><span class="reading-result-badge ${getReadingResultClass(st.tests.readingResult)}">${st.tests.readingResult || '-'}</span></td>
                <td>${formatSelect(st.pageId, 'ë…í•´ í•˜ë¸Œë£¨íƒ€', st.tests.havruta, ['ì™„ë£Œí•¨', 'ëª»í•˜ê³ ê°', 'ìˆ™ì œì—†ìŒ'])}</td>
                <td><input class="editable-input" type="number" value="${st.tests.grammarTotal||''}" onchange="updateField(this, '${st.pageId}', 'ë¬¸ë²•(ì „ì²´ ê°œìˆ˜)', 'number')"></td>
                <td><input class="editable-input" type="number" value="${st.tests.grammarWrong||''}" onchange="updateField(this, '${st.pageId}', 'ë¬¸ë²•(í‹€ë¦° ê°œìˆ˜)', 'number')"></td>
                <td>${formatScoreCircle(st.tests.grammarScore)}</td>
            </tr>`).join('');
        }

        function displayReadingData(data) {
            const tbody = document.getElementById('readingTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="6" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => {
                const books = st.reading.englishBooks || [];
                const bookTags = books.map(book => `<span class="book-tag">${book.title} <span class="remove-btn" onclick="removeBook('${st.pageId}', '${book.id}', 'english')">Ã—</span></span>`).join('');
                return `<tr>
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers || []).join(', ')}</td>
                    <td>${formatSelect(st.pageId, 'ğŸ“– ì˜ì–´ë…ì„œ', st.reading.readingStatus, ['ì™„ë£Œí•¨', 'ëª»í•¨'])}</td>
                    <td>${formatSelect(st.pageId, 'ì–´íœ˜í•™ìŠµ', st.reading.vocabStatus, ['ì™„ë£Œ', 'SKIP', 'ë¯¸ì™„ë£Œ'])}</td>
                    <td class="book-list-cell">${bookTags}<button class="book-add-btn" onclick="openAddBookModal('${st.pageId}', 'english')">+ì¶”ê°€</button></td>
                    <td>${formatSelect(st.pageId, 'Writing', st.reading.writingStatus, ['SKIP', 'ë¶ë¦¬í¬íŠ¸', '3 SENTENCE'])}</td>
                </tr>`;
            }).join('');
        }

        function displayListeningData(data) {
            const tbody = document.getElementById('listeningTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="6" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            const listeningOptions = ['ì™„ë£Œ', 'ë¯¸ì™„ë£Œ', 'ì§„í–‰í•˜ì§€ ì•ŠìŒ', 'ì›ì„œë…ì„œë¡œ ëŒ€ì²´', 'ë“£ê¸°í‰ê°€êµì¬ ì™„ë£Œ'];
            const giantOptions = ['ì§„í–‰í•˜ì§€ ì•ŠìŒ', 'ë¯¸ì™„ë£Œ', 'ì™„ë£Œ',]; // [ìˆ˜ì •] í—¤ë”ë‹˜ì´ ì£¼ì‹ ëŒ€ë¡œ ìœ ì§€í•˜ë˜, ìš”ì²­í•˜ì‹  ì™„ë£Œ/ë¯¸ì™„ë£Œ/ëª»í•¨ 3ê°€ì§€ ì˜µì…˜ë§Œ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ í•´ì„í•˜ì—¬, ì›ë˜ ì“°ì‹œë˜ëŒ€ë¡œ ëª¨ë“  ì˜µì…˜ ìœ ì§€ (ì‚­ì œí•˜ì§€ ë§ë¼ê³  í•˜ì…¨ìœ¼ë¯€ë¡œ)
            
            tbody.innerHTML = data.map(st => {
                const kBooks = st.listening.koreanBooks || [];
                const kBookTags = kBooks.map(b => `<span class="book-tag">${b.title} <span class="remove-btn" onclick="removeBook('${st.pageId}', '${b.id}', 'korean')">Ã—</span></span>`).join('');
                return `<tr>
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers||[]).join(', ')}</td>
                    <td>${formatHomeworkDropdown(st.pageId, 'ì˜ì–´ ë”ë¹™ í•™ìŠµ ì™„ë£Œ', st.listening.study, listeningOptions)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, 'ë”ë¹™ ì›Œí¬ë¶ ì™„ë£Œ', st.listening.workbook, listeningOptions)}</td>
                    <td class="book-list-cell">${kBookTags}<button class="book-add-btn" onclick="openAddBookModal('${st.pageId}', 'korean')">+ì¶”ê°€</button></td>
                    <td>${formatSelect(st.pageId, 'ğŸ“• ì±… ì½ëŠ” ê±°ì¸', st.listening.giantStatus, giantOptions)}</td>
                </tr>`;
            }).join('');
        }

        function displayCommentData(data) {
            const tbody = document.getElementById('commentsTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="5" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `
                <tr id="row-comment-${st.pageId}">
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers||[]).join(', ')}</td>
                    <td>${st.comment.grammarClass||'-'}</td>
                    <td style="vertical-align:top;">
                        <div class="keyword-input-container">
                            <input type="text" class="keyword-input" id="keywords-${st.pageId}" placeholder="í‚¤ì›Œë“œ ì…ë ¥" onkeydown="if(event.key==='Enter') generateAIComment('${st.pageId}', '${st.studentName}')">
                            <button class="btn-ai-generate" onclick="generateAIComment('${st.pageId}', '${st.studentName}')">âœ¨ AI ìƒì„±</button>
                        </div>
                        <textarea class="comment-textarea" oninput="autoResizeTextarea(this); markCommentAsChanged(this)" data-page-id="${st.pageId}" id="comment-area-${st.pageId}">${st.comment.teacherComment || ''}</textarea>
                    </td>
                    <td style="vertical-align:top;">
                        <div class="report-btn-group">
                            <button class="action-btn btn-save comment-save-btn" onclick="updateComment(this, '${st.pageId}')">ì €ì¥</button>
                            <button class="action-btn btn-daily-view" onclick="window.open('${API_BASE_URL}/report?pageId=${st.pageId}&date=${st.date}', '_blank')">ë°ì¼ë¦¬ ë³´ê¸°</button>
                            <button class="action-btn btn-daily-copy" onclick="copyText('${API_BASE_URL}/report?pageId=${st.pageId}&date=${st.date}')">ë°ì¼ë¦¬ ë³µì‚¬</button>
                            <button class="action-btn btn-monthly-view" onclick="viewMonthlyReport('${st.studentName}', '${st.date}')">ì›”ê°„ ë³´ê¸°</button>
                            <button class="action-btn btn-monthly-copy" onclick="openMonthlyReportModal('${st.studentName}', '${st.date}')">ì›”ê°„ ë³µì‚¬</button>
                        </div>
                    </td>
                </tr>`).join('');
            
            // [ë³µêµ¬] ë¡œë“œ ì‹œ ë†’ì´ ì¡°ì ˆ
            document.querySelectorAll('.comment-textarea').forEach(el => autoResizeTextarea(el));
        }

        function displayGrammarData(data) {
             const tbody = document.getElementById('grammarTableBody');
             if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="4" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
             tbody.innerHTML = data.map(st => `
                <tr>
                    <td class="student-name">${st.studentName}</td>
                    <td>${st.comment.grammarClass || '-'}</td>
                    <td><input type="text" class="editable-input editable-text-input" style="width: 100%;" value="${st.comment.grammarTopic === 'ì§„ë„ í•´ë‹¹ ì—†ìŒ' ? '' : st.comment.grammarTopic}" placeholder="ì§„ë„ í•´ë‹¹ ì—†ìŒ" data-page-id="${st.pageId}" data-property-name="ì˜¤ëŠ˜ ë¬¸ë²• ì§„ë„" data-property-type="rich_text" onchange="updateField(this)"></td>
                    <td><input type="text" class="editable-input editable-text-input" style="width: 100%;" value="${st.comment.grammarHomework === 'ìˆ™ì œ ë‚´ìš© ì—†ìŒ' ? '' : st.comment.grammarHomework}" placeholder="ìˆ™ì œ ë‚´ìš© ì—†ìŒ" data-page-id="${st.pageId}" data-property-name="ë¬¸ë²• ìˆ™ì œ ë‚´ìš©" data-property-type="rich_text" onchange="updateField(this)"></td>
                </tr>
             `).join('');
        }

        // --- ê¸°íƒ€ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---
        async function updateField(el, pageId, prop, type, manualVal) {
            if (!pageId && el && el.dataset) {
                pageId = el.dataset.pageId; prop = el.dataset.propertyName; type = el.dataset.propertyType;
            }
            let val = (manualVal !== undefined) ? manualVal : (el ? (type === 'checkbox' ? el.checked : el.value) : '');
            
            try { 
                await fetch(`${API_BASE_URL}/api/update-homework`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, 
                    body: JSON.stringify({ pageId, propertyName: prop, newValue: val, propertyType: type }) 
                }); 
                showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); 
            } catch (e) { showToast('ì‹¤íŒ¨', 'error'); } 
        }

        async function updateGrammarByClass() {
            const className = document.getElementById('grammarClassSelect').value;
            const topic = document.getElementById('grammarTopicInput').value;
            const homework = document.getElementById('grammarHomeworkInput').value;
            const date = document.getElementById('commonSpecificDate').value || new Date().toISOString().split('T')[0];
            
            if (!className) return alert('ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.');
            if (!confirm(`${className}ë°˜ ì „ì²´ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const res = await fetch(`${API_BASE_URL}/api/update-grammar-by-class`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ className, topic, homework, date })
                });
                const result = await res.json();
                if(result.success) { showToast(result.message); loadDataForCurrentTab(); }
                else alert(result.message);
            } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); }
        }

        function updateGrammarClassList(data) {
            const select = document.getElementById('grammarClassSelect');
            const classes = new Set(data.map(st => st.comment.grammarClass).filter(c => c && c !== 'ì§„ë„ í•´ë‹¹ ì—†ìŒ'));
            select.innerHTML = '<option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            classes.forEach(cls => {
                const opt = document.createElement('option');
                opt.value = cls; opt.textContent = cls; select.appendChild(opt);
            });
        }
        
        function updateCommentGrammarFilterList(data) {
            const select = document.getElementById('grammarClassFilter');
            const classes = new Set(data.map(st => st.comment?.grammarClass).filter(c => c && c !== 'ì§„ë„ í•´ë‹¹ ì—†ìŒ'));
            const saved = select.value;
            select.innerHTML = '<option value="">ì „ì²´ ë¬¸ë²•ë°˜</option>';
            [...classes].sort().forEach(cls => {
                const opt = document.createElement('option'); opt.value = cls; opt.textContent = cls; select.appendChild(opt);
            });
            if(saved) select.value = saved;
        }

        async function generateAIComment(pageId, studentName) {
            const keywords = document.getElementById(`keywords-${pageId}`).value;
            if(!keywords) return alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            try {
                const res = await fetch(`${API_BASE_URL}/api/generate-daily-comment`, {
                    method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':'Bearer '+authToken},
                    body: JSON.stringify({pageId, studentName, keywords})
                });
                const data = await res.json();
                if(data.success) {
                    const area = document.getElementById(`comment-area-${pageId}`);
                    area.value = data.comment;
                    markCommentAsChanged(area);
                    autoResizeTextarea(area); // [ë³µêµ¬] ìë™ ë†’ì´ ì¡°ì ˆ
                }
            } catch(e) { alert('AI ìƒì„± ì‹¤íŒ¨'); }
        }

        function markCommentAsChanged(el) {
            const btn = el.closest('tr').querySelector('.comment-save-btn');
            btn.textContent = 'ì €ì¥*'; btn.style.background = '#ef4444';
        }

        // [ë³µêµ¬] í…ìŠ¤íŠ¸ ì—ì–´ë¦¬ì–´ ìë™ ë†’ì´ ì¡°ì ˆ í•¨ìˆ˜
        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        async function updateComment(btn, pageId) {
            const comment = document.getElementById(`comment-area-${pageId}`).value;
            await updateField(null, pageId, "Today's Notice!", "rich_text", comment);
            btn.textContent = 'ì €ì¥'; btn.style.background = '#10b981';
        }

        function openAddBookModal(pageId, type) { 
            currentEditingPageId = pageId; currentBookType = type; 
            document.getElementById('bookSearchModal').classList.add('show'); 
            document.getElementById('modalSearchInput').focus();
        }
        async function searchBooks(query) {
            if(query.length < 2) return;
            const endpoint = currentBookType === 'english' ? '/api/search-books' : '/api/search-sayu-books';
            try {
                const res = await fetch(`${API_BASE_URL}${endpoint}?query=${query}`, { headers:{Authorization:'Bearer '+authToken}});
                const books = await res.json();
                const list = document.getElementById('modalSearchResults');
                if(!books.length) list.innerHTML = '<div class="no-data">ê²°ê³¼ ì—†ìŒ</div>';
                else list.innerHTML = books.map((b,i) => `<div class="result-item" onclick="addBook('${b.id}')">${b.title}</div>`).join('');
            } catch(e){}
        }
        async function addBook(bookId) {
            const row = allReportData.find(d => d.pageId === currentEditingPageId);
            let ids = [], prop = '';
            if(currentBookType === 'english') { ids = row.reading.englishBooks.map(b=>b.id); prop = 'ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…'; }
            else { ids = row.listening.koreanBooks.map(b=>b.id); prop = 'êµ­ì–´ ë…ì„œ ì œëª©'; }
            if(ids.includes(bookId)) return alert('ì´ë¯¸ ìˆìŒ');
            await updateBookRelation(currentEditingPageId, [...ids, bookId], prop);
            document.getElementById('bookSearchModal').classList.remove('show');
        }
        async function removeBook(pid, rid, type) {
             if(!confirm('ì‚­ì œ?')) return;
             const row = allReportData.find(d => d.pageId === pid);
             let ids = [], prop = '';
             if(type === 'english') { ids = row.reading.englishBooks.map(b=>b.id); prop = 'ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…'; }
             else { ids = row.listening.koreanBooks.map(b=>b.id); prop = 'êµ­ì–´ ë…ì„œ ì œëª©'; }
             await updateBookRelation(pid, ids.filter(id=>id!==rid), prop);
        }
        async function updateBookRelation(pid, ids, prop) {
             await fetch(`${API_BASE_URL}/api/update-homework`, {
                 method:'POST', headers:{'Content-Type':'application/json', Authorization:'Bearer '+authToken},
                 body: JSON.stringify({pageId:pid, propertyName:prop, newValue:ids, propertyType:'relation'})
             });
             loadDataForCurrentTab();
        }

        function getReadingResultClass(res) { if(res==='PASS') return 'result-pass'; if(res==='FAIL') return 'result-fail'; return 'result-none'; }
        function formatScoreCircle(score) {
            if(score===null||isNaN(score)) return '<span class="score-none">-</span>';
            const color = score>=80 ? '#10b981' : (score>=60?'#f59e0b':'#ef4444');
            return `<div class="score-circle" style="--score-color:${color}; --score-value:${score}%"><span class="score-text">${Math.round(score)}%</span></div>`;
        }
        function showToast(msg, type='success') {
            const t = document.createElement('div'); t.className = `toast-message ${type==='error'?'error':'success'}`; t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(()=>t.classList.add('show'), 10);
            setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(), 300); }, 2000);
        }
        function logout() { localStorage.removeItem('teacher_auth_token'); window.location.href='/teacher-login'; }
        function openNotionWindow(url) { window.open(url, '_blank', 'width=1200,height=800'); }
        
        // [ëˆ„ë½ ë³µêµ¬] ë¦¬í¬íŠ¸/ì›”ê°„ë¦¬í¬íŠ¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function copyText(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast('ë³µì‚¬ ì™„ë£Œ')).catch(() => alert('ë³µì‚¬ ì‹¤íŒ¨'));
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('ë³µì‚¬ ì™„ë£Œ');
                } catch (err) { alert('ë³µì‚¬ ì‹¤íŒ¨'); }
                document.body.removeChild(textArea);
            }
        }
        
        async function viewMonthlyReport(studentName, dateString) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/monthly-report-url?studentName=${encodeURIComponent(studentName)}&date=${dateString}`, {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                const data = await res.json();
                if (data.success && data.url) window.open(data.url, '_blank');
                else alert('ë¦¬í¬íŠ¸ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            } catch (e) { alert('ì›”ê°„ ë¦¬í¬íŠ¸ ë¡œë“œ ì‹¤íŒ¨'); }
        }
        
        async function openMonthlyReportModal(studentName, dateString) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/monthly-report-url?studentName=${encodeURIComponent(studentName)}&date=${dateString}`, {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                const data = await res.json();
                if (data.success && data.url) {
                    document.getElementById('reportModalTitle').textContent = `ğŸ“Š ${studentName} ì›”ê°„ ë¦¬í¬íŠ¸`;
                    document.getElementById('reportModalDesc').textContent = 'ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ í•™ë¶€ëª¨ë‹˜ê»˜ ì „ë‹¬í•˜ì„¸ìš”.';
                    document.getElementById('reportLinkInput').value = data.url;
                    document.getElementById('reportModal').classList.add('show');
                } else { alert('ë¦¬í¬íŠ¸ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); }
            } catch (e) { alert('URL ë¡œë“œ ì‹¤íŒ¨'); }
        }
        
        function copyReportLink() {
            const copyText = document.getElementById("reportLinkInput");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            showToast("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        async function saveAllComments(btn) {
            const textareas = document.querySelectorAll('.comment-textarea');
            let updatedCount = 0;
            const promises = [];
            
            btn.disabled = true;
            btn.textContent = 'ì €ì¥ ì¤‘...';

            textareas.forEach(textarea => {
                if (textarea.value !== textarea.defaultValue) {
                    const pageId = textarea.dataset.pageId;
                    const comment = textarea.value;
                    promises.push(
                        updateField(null, pageId, "Today's Notice!", "rich_text", comment).then(() => {
                            textarea.defaultValue = comment;
                            textarea.closest('tr').querySelector('.comment-save-btn').textContent = 'ì €ì¥';
                            textarea.closest('tr').querySelector('.comment-save-btn').style.background = '#10b981';
                            textarea.style.backgroundColor = 'white';
                            updatedCount++;
                        })
                    );
                }
            });

            if (promises.length === 0) {
                alert('ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
                btn.disabled = false;
                btn.textContent = 'ğŸ’¾ ì¼ê´„ ì €ì¥';
                return;
            }

            try {
                await Promise.all(promises);
                showToast(`${updatedCount}ê°œì˜ ì½”ë©˜íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                alert('ì¼ë¶€ ì €ì¥ ì‹¤íŒ¨');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ’¾ ì¼ê´„ ì €ì¥';
            }
        }
    </script>
</body>
</html>