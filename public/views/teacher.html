<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ - ë¦¬ë””íŠœë“œ</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "NanumSquareRound", sans-serif; }
        body { background: #f8f9fa; color: #2d3748; min-height: 100vh; padding: 0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        
        /* í—¤ë” */
        .header { background: #ffffff; color: #6b46c1; padding: 20px 30px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; margin: 0; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-name { font-weight: 600; }
        .logout-btn { background: #6b46c1; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s; }
        .logout-btn:hover { background: #5a3eaa; }

        /* íƒ­ ë©”ë‰´ */
        .tab-menu { display: flex; background-color: #ffffff; border-bottom: 1px solid #e2e8f0; padding: 0 40px; margin-top: 20px; border-radius: 12px 12px 0 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-button { padding: 15px 25px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: 600; color: #6b7280; position: relative; transition: color 0.3s; }
        .tab-button.active { color: #6b46c1; }
        .tab-button.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: #8b5cf6; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { padding: 30px 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .content-section { background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); border: 1px solid #e9ecef; padding: 30px; margin-bottom: 30px; }
        .section-title { font-size: 1.6em; font-weight: 700; color: #6b46c1; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        
        /* í•„í„° ì˜ì—­ */
        .filters-container { display:flex; gap:15px; margin-bottom:25px; align-items:center; flex-wrap: wrap; }
        .refresh-btn { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; }
        .filter-group { display:flex; align-items:center; gap:8px; }
        .filter-select, .filter-input { padding:8px 12px; border-radius:8px; border:2px solid #e2e8f0; font-size: 14px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container { overflow-x: auto; border: 1px solid #e9ecef; border-radius: 12px; }
        .styled-table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 1000px; }
        .styled-table th { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; padding: 12px 10px; text-align: center; font-weight: 600; white-space: nowrap; }
        .styled-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #f1f3f4; vertical-align: middle; }
        .student-name { font-weight: 600; color: #2d3748; text-align: left; padding-left: 15px; }
        
        /* ë¡œë”© ë° ë°ì´í„° ì—†ìŒ */
        .loading, .no-data { text-align: center; padding: 40px; color: #718096; font-size: 16px; }

        /* [ì‹ ê·œ] ì±… íƒœê·¸ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .book-list-cell { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; justify-content: center; min-width: 250px; }
        .book-tag { background: #f3e8ff; color: #6b46c1; border: 1px solid #d8b4fe; border-radius: 12px; padding: 4px 10px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .book-tag .remove-btn { cursor: pointer; font-weight: bold; color: #9333ea; font-size: 14px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .book-tag .remove-btn:hover { background: #e9d5ff; }
        .book-add-btn { background: #e9d5ff; color: #6b46c1; border: 1px dashed #d8b4fe; border-radius: 12px; padding: 4px 10px; font-size: 12px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .book-add-btn:hover { background: #d8b4fe; transform: translateY(-1px); }

        /* ë“œë¡­ë‹¤ìš´ ë° ì…ë ¥ í•„ë“œ */
        .homework-dropdown { padding: 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px; font-weight: 600; text-align: center; cursor: pointer; background: white; }
        .status-complete { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .status-incomplete { background-color: #fecaca; color: #991b1b; border-color: #fca5a5; }
        .status-none { background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db; }
        
        .editable-input { padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center; width: 60px; }
        .editable-input:focus { border-color: #8b5cf6; outline: none; }
        .editable-text-input { width: 120px; text-align: left; }

        /* ì½”ë©˜íŠ¸ íƒ­ */
        .comment-textarea { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; resize: vertical; min-height: 40px; }
        .comment-save-btn { background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; margin-left: 5px; }
        
        /* ëª¨ë‹¬ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-search-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; font-size: 16px; }
        .modal-search-results { max-height: 300px; overflow-y: auto; border: 1px solid #f1f3f4; border-radius: 8px; }
        .result-item { padding: 12px; border-bottom: 1px solid #f1f3f4; cursor: pointer; transition: background 0.2s; }
        .result-item:hover { background: #f8f9ff; }
        .result-item:last-child { border-bottom: none; }
        
        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
        .toast-message { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; background: #333; color: white; opacity: 0; transform: translateX(100%); transition: all 0.3s; z-index: 3000; }
        .toast-message.show { opacity: 1; transform: translateX(0); }
        .toast-message.success { background: #10b981; }
        .toast-message.error { background: #ef4444; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“š ë¦¬ë””íŠœë“œ ì„ ìƒë‹˜</h1>
        <div class="user-info">
            <span class="user-name" id="userName">ë¡œë”©ì¤‘...</span>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="container">
        <div class="tab-menu">
            <button class="tab-button active" onclick="showTab('homework')">ìˆ™ì œ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('tests')">í…ŒìŠ¤íŠ¸ ê²°ê³¼</button>
            <button class="tab-button" onclick="showTab('reading')">ì›ì„œ ë…ì„œ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('listening')">ë¦¬ìŠ¤ë‹ í˜„í™©</button>
            <button class="tab-button" onclick="showTab('comments')">ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</button>
        </div>

        <div class="main-content">
            
            <!-- 1. ìˆ™ì œ í˜„í™© íƒ­ -->
            <div id="homework-view" class="tab-content active">
                <div class="content-section">
                    <div class="section-title">ğŸ“‹ ë‹´ë‹¹ í•™ìƒ ìˆ™ì œ í˜„í™©</div>
                    <div class="filters-container">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        <div class="filter-group">
                            <select id="periodFilter_hw" class="filter-select"><option value="today">ì˜¤ëŠ˜</option><option value="specific_date">ë‚ ì§œ ì§€ì •</option></select>
                            <input type="date" id="specificDate_hw" class="filter-input" style="display:none;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>â­• ë¬¸ë²•</th> <th>1ï¸âƒ£ ì–´íœ˜</th> <th>2ï¸âƒ£ ë…í•´í´ê°€</th> <th>4ï¸âƒ£ Sum</th> <th>5ï¸âƒ£ ë§¤ì¼ ë…í•´</th> <th>6ï¸âƒ£ ì¼ê¸°</th> <th>ìˆ˜í–‰ìœ¨</th> </tr></thead>
                            <tbody id="homeworkTableBody"><tr><td colspan="9" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. í…ŒìŠ¤íŠ¸ ê²°ê³¼ íƒ­ -->
            <div id="tests-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ“ ë‹´ë‹¹ í•™ìƒ í…ŒìŠ¤íŠ¸ ê²°ê³¼</div>
                    <div class="filters-container"><button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button></div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ì–´íœ˜ìœ ë‹›</th> <th>ì–´íœ˜ì •ë‹µ</th> <th>ì´ê°¯ìˆ˜</th> <th>ì–´íœ˜ì ìˆ˜</th> <th>ë…í•´ì˜¤ë‹µ</th> <th>ë…í•´ê²°ê³¼</th> <th>í•˜ë¸Œë£¨íƒ€</th> <th>ë¬¸ë²•ë¬¸í•­</th> <th>ë¬¸ë²•ì˜¤ë‹µ</th> <th>ë¬¸ë²•ì ìˆ˜</th> </tr></thead>
                            <tbody id="testsTableBody"><tr><td colspan="11" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. [í•µì‹¬] ì›ì„œ ë…ì„œ í˜„í™© íƒ­ -->
            <div id="reading-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ“š ì›ì„œ ë…ì„œ í˜„í™© (ë‹¤ì¤‘ ì…ë ¥)</div>
                    <div class="filters-container"><button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button></div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ğŸ“– ì˜ì–´ë…ì„œ</th> <th>ì–´íœ˜í•™ìŠµ</th> <th>ğŸ“š ì½ì€ ì±… ëª©ë¡ (íƒœê·¸)</th> <th>Writing</th> </tr></thead>
                            <tbody id="readingTableBody"><tr><td colspan="6" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. ë¦¬ìŠ¤ë‹ í˜„í™© íƒ­ -->
            <div id="listening-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ§ ë¦¬ìŠ¤ë‹ í˜„í™©</div>
                    <div class="filters-container"><button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button></div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ë“£ê¸° í•™ìŠµ</th> <th>ë“£ê¸° ì›Œí¬ë¶</th> </tr></thead>
                            <tbody id="listeningTableBody"><tr><td colspan="4" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸ íƒ­ -->
            <div id="comments-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title">ğŸ’¬ ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</div>
                    <div class="filters-container"><button class="refresh-btn" onclick="loadDataForCurrentTab()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button></div>
                    <div class="table-container">
                        <table class="styled-table">
                            <colgroup><col style="width:10%"><col style="width:10%"><col style="width:15%"><col style="width:65%"></colgroup>
                            <thead><tr> <th>í•™ìƒ ì´ë¦„</th> <th>ë‹´ë‹¹ê°•ì‚¬</th> <th>ë¬¸ë²• í´ë˜ìŠ¤</th> <th>ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸</th> </tr></thead>
                            <tbody id="commentsTableBody"><tr><td colspan="4" class="loading">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ì±… ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div id="bookSearchModal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-bottom:15px; color:#6b46c1;">ğŸ“š ì±… ì¶”ê°€í•˜ê¸°</h2>
            <input type="text" id="modalSearchInput" class="modal-search-input" placeholder="ì±… ì œëª© ê²€ìƒ‰..." autocomplete="off">
            <div id="modalSearchResults" class="modal-search-results"></div>
            <button onclick="document.getElementById('bookSearchModal').classList.remove('show')" style="width:100%; padding:10px; margin-top:15px; border:none; background:#f3f4f6; border-radius:8px; cursor:pointer;">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let authToken = localStorage.getItem('teacher_auth_token');
        let allReportData = [];
        let currentActiveTab = 'homework';
        let bookSearchTimer = null;
        let currentEditingPageId = null; // ì±… ì¶”ê°€í•  ë•Œ ì‚¬ìš©í•  í˜ì´ì§€ ID

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) { window.location.href='/teacher-login'; return; }
            loadUserInfo();
            showTab('homework');
            
            // ê²€ìƒ‰ ëª¨ë‹¬ ì´ë²¤íŠ¸
            document.getElementById('modalSearchInput').addEventListener('input', (e) => {
                clearTimeout(bookSearchTimer);
                bookSearchTimer = setTimeout(() => searchEngBooks(e.target.value), 300);
            });

            // ë‚ ì§œ í•„í„° ì´ë²¤íŠ¸
            const dateInput = document.getElementById('specificDate_hw');
            document.getElementById('periodFilter_hw').addEventListener('change', (e) => {
                dateInput.style.display = e.target.value === 'specific_date' ? 'block' : 'none';
                if (e.target.value === 'today') loadDataForCurrentTab();
            });
            dateInput.addEventListener('change', loadDataForCurrentTab);
        });

        async function loadUserInfo() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/teacher/user-info`, { headers:{Authorization:'Bearer '+authToken} });
                const data = await res.json();
                document.getElementById('userName').textContent = data.userName;
            } catch (e) { logout(); }
        }

        async function loadDataForCurrentTab() {
            const period = document.getElementById('periodFilter_hw').value;
            const date = document.getElementById('specificDate_hw').value;
            let url = `${API_BASE_URL}/api/daily-report-data?period=${period}`;
            if (period === 'specific_date' && date) url += `&date=${date}`;

            try {
                const res = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!res.ok) throw new Error('Load failed');
                allReportData = await res.json();
                displayDataForAllTabs(allReportData);
            } catch (e) { console.error(e); alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'); }
        }

        function displayDataForAllTabs(data) {
            displayHomeworkData(data);
            displayTestData(data);
            displayReadingData(data);
            displayListeningData(data);
            displayCommentData(data);
        }

        // --- [í•µì‹¬] ì›ì„œ ë…ì„œ íƒ­ ë Œë”ë§ (ë‹¤ì¤‘ ì±… íƒœê·¸ + ì¶”ê°€ ë²„íŠ¼ + AR/Lexile í‘œì‹œ) ---
        function displayReadingData(data) {
            const tbody = document.getElementById('readingTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="6" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            
            tbody.innerHTML = data.map(st => {
                // ì±… íƒœê·¸ ìƒì„±
                const books = st.reading.englishBooks || [];
                const bookTags = books.map(book => {
                    // [ìˆ˜ì •] AR, Lexile ì •ë³´ê°€ ìˆìœ¼ë©´ íƒœê·¸ì— í‘œì‹œ
                    let infoText = '';
                    if (book.ar || book.lexile) {
                        const parts = [];
                        if (book.ar) parts.push(`AR ${book.ar}`);
                        if (book.lexile) parts.push(`Lex ${book.lexile}`);
                        infoText = ` <span style="opacity:0.7; font-weight:normal; font-size:0.9em;">(${parts.join(' / ')})</span>`;
                    }
                    return `<span class="book-tag">${book.title}${infoText} <span class="remove-btn" onclick="removeBook('${st.pageId}', '${book.id}')">Ã—</span></span>`;
                }).join('');
                
                // ì¶”ê°€ ë²„íŠ¼
                const addButton = `<button class="book-add-btn" onclick="openAddBookModal('${st.pageId}')">+ ì¶”ê°€</button>`;

                return `
                <tr>
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers || []).join(', ')}</td>
                    <td>${formatSelect(st.pageId, 'ğŸ“– ì˜ì–´ë…ì„œ', st.reading.readingStatus, ['ì™„ë£Œí•¨', 'ëª»í•¨'])}</td>
                    <td>${formatSelect(st.pageId, 'ì–´íœ˜í•™ìŠµ', st.reading.vocabStatus, ['ì™„ë£Œ', 'SKIP', 'ë¯¸ì™„ë£Œ'])}</td>
                    <td class="book-list-cell">
                        ${bookTags}
                        ${addButton}
                    </td>
                    <td>${formatSelect(st.pageId, 'Writing', st.reading.writingStatus, ['SKIP', 'ë¶ë¦¬í¬íŠ¸', '3 SENTENCE'])}</td>
                </tr>`;
            }).join('');
        }

        // --- ì±… ê´€ë¦¬ ë¡œì§ ---
        function openAddBookModal(pageId) {
            currentEditingPageId = pageId;
            document.getElementById('modalSearchInput').value = '';
            document.getElementById('modalSearchResults').innerHTML = '';
            document.getElementById('bookSearchModal').classList.add('show');
            document.getElementById('modalSearchInput').focus();
        }

        async function searchEngBooks(query) {
            const resList = document.getElementById('modalSearchResults');
            if (query.length < 2) { resList.innerHTML = ''; return; }
            resList.innerHTML = '<div class="loading">ê²€ìƒ‰ì¤‘...</div>';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/search-books?query=${encodeURIComponent(query)}`, { headers: { 'Authorization': 'Bearer ' + authToken } });
                const books = await res.json();
                if(books.length === 0) { resList.innerHTML = '<div class="no-data">ê²°ê³¼ ì—†ìŒ</div>'; return; }
                
                resList.innerHTML = books.map(book => `
                    <div class="result-item" onclick="addBook('${book.id}')">
                        <div style="font-weight:bold;">${book.title}</div>
                        <div style="font-size:12px; color:#666;">${book.author || ''}</div>
                    </div>
                `).join('');
            } catch (e) { resList.innerHTML = '<div class="no-data">ì˜¤ë¥˜ ë°œìƒ</div>'; }
        }

        async function addBook(newBookId) {
            if (!currentEditingPageId) return;
            document.getElementById('bookSearchModal').classList.remove('show');
            
            // ê¸°ì¡´ ì±… ëª©ë¡ + ìƒˆ ì±…
            const rowData = allReportData.find(d => d.pageId === currentEditingPageId);
            const currentIds = (rowData.reading.englishBooks || []).map(b => b.id).filter(id => id);
            
            if (currentIds.includes(newBookId)) { showToast('ì´ë¯¸ ì¶”ê°€ëœ ì±…ì…ë‹ˆë‹¤.', 'error'); return; }
            
            const newIds = [...currentIds, newBookId];
            await updateBookRelation(currentEditingPageId, newIds);
        }

        async function removeBook(pageId, removeId) {
            if (!confirm('ì´ ì±…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const rowData = allReportData.find(d => d.pageId === pageId);
            const currentIds = (rowData.reading.englishBooks || []).map(b => b.id).filter(id => id);
            const newIds = currentIds.filter(id => id !== removeId);
            
            await updateBookRelation(pageId, newIds);
        }

        async function updateBookRelation(pageId, newIds) {
            try {
                await fetch(`${API_BASE_URL}/api/update-homework`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ pageId, propertyName: 'ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…', newValue: newIds, propertyType: 'relation' })
                });
                showToast('ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                loadDataForCurrentTab(); // í™”ë©´ ê°±ì‹ 
            } catch (e) { showToast('ì‹¤íŒ¨', 'error'); }
        }

        // --- ê¸°íƒ€ íƒ­ ë Œë”ë§ ---
        function displayHomeworkData(data) {
            const tbody = document.getElementById('homeworkTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="9" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `<tr>
                <td class="student-name">${st.studentName}</td>
                <td>${(st.teachers||[]).join(', ')}</td>
                <td>${formatStatus(st.pageId, 'â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬', st.homework.grammar)}</td>
                <td>${formatStatus(st.pageId, '1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ', st.homework.vocabCards)}</td>
                <td>${formatStatus(st.pageId, '2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ', st.homework.readingCards)}</td>
                <td>${formatStatus(st.pageId, '4ï¸âƒ£ Summary ìˆ™ì œ', st.homework.summary)}</td>
                <td>${formatStatus(st.pageId, '5ï¸âƒ£ ë§¤ì¼ ë…í•´ ìˆ™ì œ', st.homework.dailyReading)}</td>
                <td>${formatStatus(st.pageId, '6ï¸âƒ£ ì˜ì–´ì¼ê¸° or ê°œì¸ ë…í•´ì„œ', st.homework.diary)}</td>
                <td style="font-weight:bold; color:${st.completionRate>=80?'#10b981':'#ef4444'}">${st.completionRate}%</td>
            </tr>`).join('');
        }

        function displayTestData(data) {
            const tbody = document.getElementById('testsTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="11" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `<tr>
                <td class="student-name">${st.studentName}</td>
                <td><input class="editable-input editable-text-input" value="${st.tests.vocabUnit||''}" onchange="updateField(this, '${st.pageId}', 'ì–´íœ˜ìœ ë‹›', 'rich_text')"></td>
                <td><input class="editable-input" type="number" value="${st.tests.vocabCorrect||''}" onchange="updateField(this, '${st.pageId}', 'ë‹¨ì–´(ë§ì€ ê°œìˆ˜)', 'number')"></td>
                <td><input class="editable-input" type="number" value="${st.tests.vocabTotal||''}" onchange="updateField(this, '${st.pageId}', 'ë‹¨ì–´(ì „ì²´ ê°œìˆ˜)', 'number')"></td>
                <td>${st.tests.vocabScore}</td>
                <td><input class="editable-input" type="number" value="${st.tests.readingWrong||''}" onchange="updateField(this, '${st.pageId}', 'ë…í•´(í‹€ë¦° ê°œìˆ˜)', 'number')"></td>
                <td>${st.tests.readingResult}</td>
                <td>${formatSelect(st.pageId, 'ë…í•´ í•˜ë¸Œë£¨íƒ€', st.tests.havruta, ['ì™„ë£Œí•¨', 'ëª»í•˜ê³ ê°', 'ìˆ™ì œì—†ìŒ'])}</td>
                <td><input class="editable-input" type="number" value="${st.tests.grammarTotal||''}" onchange="updateField(this, '${st.pageId}', 'ë¬¸ë²•(ì „ì²´ ê°œìˆ˜)', 'number')"></td>
                <td><input class="editable-input" type="number" value="${st.tests.grammarWrong||''}" onchange="updateField(this, '${st.pageId}', 'ë¬¸ë²•(í‹€ë¦° ê°œìˆ˜)', 'number')"></td>
                <td>${st.tests.grammarScore}</td>
            </tr>`).join('');
        }

        function displayListeningData(data) {
            const tbody = document.getElementById('listeningTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="4" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `<tr>
                <td class="student-name">${st.studentName}</td>
                <td>${(st.teachers||[]).join(', ')}</td>
                <td>${formatStatus(st.pageId, 'ì˜ì–´ ë”ë¹™ í•™ìŠµ ì™„ë£Œ', st.listening.study)}</td>
                <td>${formatStatus(st.pageId, 'ë”ë¹™ ì›Œí¬ë¶ ì™„ë£Œ', st.listening.workbook)}</td>
            </tr>`).join('');
        }

        function displayCommentData(data) {
            const tbody = document.getElementById('commentsTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="4" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `<tr>
                <td class="student-name">${st.studentName}</td>
                <td>${(st.teachers||[]).join(', ')}</td>
                <td>${st.comment.grammarClass}</td>
                <td>
                    <textarea class="comment-textarea" onchange="updateField(this, '${st.pageId}', 'â¤ Today\\'s Notice!', 'rich_text')">${st.comment.teacherComment}</textarea>
                    <button class="comment-save-btn" onclick="alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ìë™ì €ì¥)')">ì €ì¥ë¨</button>
                </td>
            </tr>`).join('');
        }

        // --- í—¬í¼ í•¨ìˆ˜ ---
        function formatSelect(pageId, prop, val, opts) {
            return `<select class="homework-dropdown" onchange="updateField(this, '${pageId}', '${prop}', 'select')">
                <option value="">---</option>
                ${opts.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('')}
            </select>`;
        }
        function formatStatus(pageId, prop, val) {
            const opts = ['ìˆ™ì œ í•¨', 'ì•ˆ í•´ì˜´', 'í•´ë‹¹ ì—†ìŒ', 'ì™„ë£Œ', 'ë¯¸ì™„ë£Œ', 'ì§„í–‰í•˜ì§€ ì•ŠìŒ'];
            const cls = val==='ìˆ™ì œ í•¨'||val==='ì™„ë£Œ'?'status-complete':(val==='ì•ˆ í•´ì˜´'||val==='ë¯¸ì™„ë£Œ'?'status-incomplete':'status-none');
            return `<select class="homework-dropdown ${cls}" onchange="updateField(this, '${pageId}', '${prop}', 'status'); this.className='homework-dropdown '+ (this.value==='ìˆ™ì œ í•¨'||this.value==='ì™„ë£Œ'?'status-complete':(this.value==='ì•ˆ í•´ì˜´'||this.value==='ë¯¸ì™„ë£Œ'?'status-incomplete':'status-none'))">
                ${opts.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('')}
            </select>`;
        }

        async function updateField(el, pageId, prop, type) {
            const val = el.value;
            try {
                await fetch(`${API_BASE_URL}/api/update-homework`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ pageId, propertyName: prop, newValue: val, propertyType: type })
                });
                showToast('ì €ì¥ë¨');
            } catch (e) { showToast('ì‹¤íŒ¨', 'error'); }
        }

        function showToast(msg, type='success') {
            const t = document.createElement('div'); t.className = `toast-message ${type==='error'?'toast-error':'toast-success'}`; t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 2000);
        }
        function logout() { localStorage.removeItem('teacher_auth_token'); window.location.href='/teacher-login'; }
        function showTab(tab) {
            currentActiveTab = tab;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tab+'-view').classList.add('active');
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.querySelector(`button[onclick="showTab('${tab}')"]`).classList.add('active');
            if(!allReportData.length) loadDataForCurrentTab();
        }
    </script>
</body>
</html>