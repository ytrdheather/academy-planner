<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ - ìˆ™ì œ ìˆ˜í–‰ í˜„í™©</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "NanumSquareRound", sans-serif; }
        body { background: #ffffff; color: #2d3748; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #ffffff; color: #6b46c1; padding: 25px 30px; text-align: center;
            position: relative; border-bottom: 2px solid #e2e8f0; }
        .header h1 { font-size: 2.2em; font-weight: 700; margin-bottom: 10px; color: #6b46c1; }
        .header p { font-size: 1.1em; color: #718096; }
        .user-info { position: absolute; top: 30px; right: 30px; text-align: right; }
        .user-name { font-size: 1.1em; font-weight: 600; margin-bottom: 5px; color: #6b46c1; }
        .logout-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none;
            padding: 8px 16px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500;
            transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3); }
        .logout-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
        .main-content { padding: 40px; }
        .section-title { font-size: 1.6em; font-weight: 700; color: #6b46c1; margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: "ğŸ“‹"; font-size: 1.2em; }
        .homework-table-container { background: white; border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #e9ecef; }
        .homework-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .homework-table th { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white;
            padding: 10px 8px; text-align: center; font-weight: 600; font-size: 12px;
            border-right: 1px solid rgba(255,255,255,0.2); }
        .homework-table td { padding: 8px 6px; text-align: center; border-bottom: 1px solid #f1f3f4;
            border-right: 1px solid #f1f3f4; vertical-align: middle; font-size: 13px; }
        .homework-table tr:hover { background-color: #f8f9ff; }
        .student-name { font-weight: 600; color: #2d3748; font-size: 14px; background: #f9fafc; }
        .homework-status { display: inline-flex; align-items: center; justify-content: center;
            padding: 4px 8px; border-radius: 12px; font-weight: 600; font-size: 11px; }
        .status-complete { background: linear-gradient(135deg, #48bb78, #38a169); color: white; }
        .status-incomplete { background: linear-gradient(135deg, #f56565, #e53e3e); color: white; }
        .status-none { background: linear-gradient(135deg, #a0aec0, #718096); color: white; }
        .completion-rate { font-weight: 700; font-size: 14px; }
        .rate-excellent { color: #10b981; } .rate-good { color: #8b5cf6; } .rate-poor { color: #ef4444; }
        .loading, .no-data { text-align: center; padding: 60px; color: #718096; font-size: 18px; }
        .loading::before { content: "â³ "; } .no-data::before { content: "ğŸ“ "; }
        .refresh-btn { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white;
            border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;
            font-size: 14px; font-weight: 600; margin-bottom: 20px; }
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .stat-value { font-size: 2.0em; font-weight: 700; color: #6b46c1; margin-bottom: 5px; }
        .stat-label { color: #718096; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š ìˆ™ì œ ìˆ˜í–‰ í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>
            <p>í•™ìƒë“¤ì˜ ì‹¤ì‹œê°„ ìˆ™ì œ ì™„ë£Œ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            <div class="user-info">
                <div class="user-name" id="userName">ë¡œë”©ì¤‘...</div>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="main-content">
            <div class="stats-summary" id="statsContainer"></div>

            <div class="homework-section">
                <div class="section-title">ë‹´ë‹¹ í•™ìƒ ìˆ™ì œ í˜„í™©</div>
                <div style="display:flex; gap:15px; margin-bottom:20px; align-items:center;">
                    <button class="refresh-btn" onclick="loadHomeworkStatus()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>

                    <div style="display:flex; align-items:center; gap:8px;">
                        <label for="periodFilter" style="font-weight:600; color:#6b46c1;">ê¸°ê°„ í•„í„°:</label>
                        <select id="periodFilter" onchange="toggleCustomDateInputs(); loadHomeworkStatus()"
                                style="padding:8px 12px; border-radius:8px; border:2px solid #e2e8f0; background:white;">
                            <option value="today">ì˜¤ëŠ˜</option>
                            <option value="week">ì´ë²ˆ ì£¼</option>
                            <option value="month">ì´ë²ˆ ë‹¬</option>
                            <option value="custom">ì‚¬ìš©ì ì§€ì •</option>
                        </select>
                    </div>
                    <div id="customDateContainer" style="display:none; align-items:center; gap:8px;">
                        <input type="date" id="startDate" onchange="loadHomeworkStatus()" style="padding:8px; border-radius:8px; border:2px solid #e2e8f0;">
                        <span>~</span>
                        <input type="date" id="endDate" onchange="loadHomeworkStatus()" style="padding:8px; border-radius:8px; border:2px solid #e2e8f0;">
                    </div>

                    <div id="teacherFilterContainer" style="display:none;">
                        <label for="teacherFilter" style="font-weight:600; color:#6b46c1; margin-right:8px;">ë‹´ë‹¹ê°•ì‚¬:</label>
                        <select id="teacherFilter" onchange="filterByTeacher()"
                                style="padding:8px 12px; border-radius:8px; border:2px solid #e2e8f0; background:white; min-width:150px;">
                            <option value="">ì „ì²´ ë³´ê¸°</option>
                        </select>
                    </div>
                </div>

                <div class="homework-table-container">
                    <table class="homework-table">
                        <thead>
                            <tr>
                                <th>í•™ìƒ ì´ë¦„</th>
                                <th>ë‹´ë‹¹ê°•ì‚¬</th>
                                <th>â­• ë¬¸ë²•ìˆ™ì œ</th>
                                <th>1ï¸âƒ£ ì–´íœ˜í´ì¹´</th>
                                <th>2ï¸âƒ£ ë…í•´í´ì¹´</th>
                                <th>4ï¸âƒ£ Summary</th>
                                <th>5ï¸âƒ£ ë…í•´ì„œ</th>
                                <th>6ï¸âƒ£ ì¼ê¸°/ë¶€êµì¬</th>
                                <th>ìˆ˜í–‰ìœ¨</th>
                            </tr>
                        </thead>
                        <tbody id="homeworkTableBody">
                            <tr><td colspan="9" class="loading">ìˆ™ì œ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('teacher_auth_token');
        let allHomeworkData = [];
        let currentUserRole = '';
        let currentUserName = ''; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì„ ìƒë‹˜ ì´ë¦„ ì €ì¥

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); window.location.href='/teacher-login'; return; }
            initializePage();
        });

        async function initializePage() {
            try {
                await loadUserInfo(); // ì‚¬ìš©ì ì •ë³´ ë¨¼ì € ë¡œë“œ
                await loadHomeworkStatus(); // ìˆ™ì œ ë°ì´í„° ë¡œë“œ
            } catch (e) { console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", e); }
        }

        async function loadUserInfo() {
            try {
                const userInfoResponse = await fetch('/api/teacher/user-info', { headers:{Authorization:'Bearer '+authToken} });
                if (!userInfoResponse.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
                const data = await userInfoResponse.json();

                if (data.userName) {
                    document.getElementById('userName').textContent = data.userName + ' ('+data.userRole+')';
                    currentUserRole = data.userRole;
                    currentUserName = data.userName; // ë¡œê·¸ì¸í•œ ì„ ìƒë‹˜ ì´ë¦„ ì €ì¥

                    // ë§¤ë‹ˆì €ì¼ ê²½ìš° ê°•ì‚¬ í•„í„° ë¡œë“œ ë° í‘œì‹œ
                    if (data.userRole === 'manager') {
                        document.getElementById('teacherFilterContainer').style.display='flex'; // flex ë¡œ ë³€ê²½
                        const teachersResponse = await fetch('/api/teachers', { headers:{Authorization:'Bearer '+authToken} });
                        if (!teachersResponse.ok) throw new Error('ê°•ì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                        const teachers = await teachersResponse.json();
                        updateTeacherFilterFromData(teachers);
                    }
                } else {
                    throw new Error('ì‚¬ìš©ì ì •ë³´ í˜•ì‹ì´ ì˜ëª»ë¨');
                }
            } catch (error) {
                 console.error("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:", error);
                 alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                 logout(); // ì—ëŸ¬ ì‹œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
            }
        }

        async function loadHomeworkStatus() {
            const tbody=document.getElementById('homeworkTableBody');
            tbody.innerHTML='<tr><td colspan="9" class="loading">ìˆ™ì œ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>';
            try {
                const period = document.getElementById('periodFilter').value;
                let url = `/api/homework-status?period=${period}`;
                if (period==='custom') {
                    const s=document.getElementById('startDate').value, e=document.getElementById('endDate').value;
                    if (s&&e) url += `&startDate=${s}&endDate=${e}`;
                    else { tbody.innerHTML='<tr><td colspan="9" class="no-data">ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</td></tr>'; return; }
                }

                // ë§¤ë‹ˆì €ê°€ íŠ¹ì • ê°•ì‚¬ë¥¼ ì„ íƒí•œ ê²½ìš° í•„í„° ì¶”ê°€
                if (currentUserRole === 'manager') {
                    const selectedTeacher = document.getElementById('teacherFilter').value;
                    if (selectedTeacher && selectedTeacher !== "") { // "" ëŠ” 'ì „ì²´ ë³´ê¸°'
                        url += `&teacher=${encodeURIComponent(selectedTeacher)}`;
                    }
                }

                const response = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
                const homeworkData = await response.json();
                allHomeworkData = homeworkData; // ì „ì²´ ë°ì´í„°ë¥¼ ì €ì¥í•´ ë‘¡ë‹ˆë‹¤ (í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ìš©)

                // ë§¤ë‹ˆì €ê°€ ì•„ë‹ˆê³  'ì „ì²´ë³´ê¸°'ê°€ ì•„ë‹ ë•Œ í´ë¼ì´ì–¸íŠ¸ ì¸¡ í•„í„°ë§ (ì„œë²„ì—ì„œ í•„í„°ë§í•˜ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì )
                // í˜„ì¬ ë¡œì§ì€ ì„œë²„ì—ì„œ ì—­í•  ê¸°ë°˜ í•„í„°ë§ì„ í•˜ê³  ìˆìœ¼ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ì€ ë¶ˆí•„ìš”
                displayHomeworkData(homeworkData);
                updateStats(homeworkData);
            } catch(e) {
                console.error("ìˆ™ì œ ë¡œë“œ ì˜¤ë¥˜:", e);
                tbody.innerHTML='<tr><td colspan="9" class="no-data">ìˆ™ì œ í˜„í™© ë¡œë“œ ì‹¤íŒ¨</td></tr>';
                updateStats([]); // í†µê³„ ì´ˆê¸°í™”
            }
        }

        function toggleCustomDateInputs() {
            document.getElementById('customDateContainer').style.display =
                (document.getElementById('periodFilter').value==='custom')?'flex':'none';
        }

        function displayHomeworkData(data) {
            const tbody=document.getElementById('homeworkTableBody');
            if(!data||!data.length){ tbody.innerHTML='<tr><td colspan="9" class="no-data">í•´ë‹¹ ê¸°ê°„ì˜ ìˆ™ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; updateStats([]); return;}

            tbody.innerHTML=data.map(st=>`
                <tr>
                    <td class="student-name">${st.studentName || 'ì´ë¦„ ì—†ìŒ'}</td> <td>${(st.teachers||[]).join(', ')||'ë¯¸ë°°ì •'}</td>
                    <td>${formatStatus(st.grammarHomework)}</td>
                    <td>${formatStatus(st.vocabCards)}</td>
                    <td>${formatStatus(st.readingCards)}</td>
                    <td>${formatStatus(st.summary)}</td>
                    <td>${formatStatus(st.readingHomework)}</td>
                    <td>${formatStatus(st.diary)}</td>
                    <td><span class="completion-rate ${rateClass(st.completionRate)}">${st.completionRate||0}%</span></td>
                </tr>`).join('');
        }

        function formatStatus(s){
            if(s==='ìˆ™ì œ í•¨') return'<span class="homework-status status-complete">OK</span>';
            if(s==='ì•ˆ í•´ì˜´' || s === 'ì•ˆí•´ì˜´') return'<span class="homework-status status-incomplete">NO</span>';
            return'<span class="homework-status status-none">-</span>'; // '-', 'ìˆ™ì œ ì—†ìŒ' ë“±
        }
        function rateClass(r){ if(r>=90)return'rate-excellent'; if(r>=70)return'rate-good'; return'rate-poor'; }

        function updateStats(data){
             const container = document.getElementById('statsContainer');
             if(!data || !data.length){
                 container.innerHTML = `
                    <div class="stat-card"><div class="stat-value">0</div><div class="stat-label">ì´ í•™ìƒ ìˆ˜</div></div>
                    <div class="stat-card"><div class="stat-value">0%</div><div class="stat-label">í‰ê·  ìˆ˜í–‰ìœ¨</div></div>
                    <div class="stat-card"><div class="stat-value">0</div><div class="stat-label">ìš°ìˆ˜ í•™ìƒ</div></div>`;
                 return;
             }
            const uniqueStudents = new Set(data.map(item => item.studentName)); // ì´ë¦„ ê¸°ì¤€ìœ¼ë¡œ ê³ ìœ  í•™ìƒ ìˆ˜ ê³„ì‚°
            const totalStudents = uniqueStudents.size;
            const avg = Math.round(data.reduce((s,x)=>s+(x.completionRate||0),0)/data.length); // ê°œë³„ ë°ì´í„° ê¸°ì¤€ í‰ê· 
            const excellent=data.filter(x=>(x.completionRate||0)>=90).length;
            container.innerHTML=`
                <div class="stat-card"><div class="stat-value">${totalStudents}</div><div class="stat-label">ì´ í•™ìƒ ìˆ˜ (í‘œì‹œëœ ê¸°ê°„)</div></div>
                <div class="stat-card"><div class="stat-value">${avg}%</div><div class="stat-label">í‰ê·  ìˆ˜í–‰ìœ¨ (í‘œì‹œëœ í•­ëª©)</div></div>
                <div class="stat-card"><div class="stat-value">${excellent}</div><div class="stat-label">ìˆ˜í–‰ìœ¨ 90% ì´ìƒ í•­ëª© ìˆ˜</div></div>`;
        }

        function updateTeacherFilterFromData(teachers){
            const sel=document.getElementById('teacherFilter');
            while(sel.children.length>1)sel.removeChild(sel.lastChild); // 'ì „ì²´ ë³´ê¸°' ì˜µì…˜ì€ ë‚¨ê¹€
            teachers.forEach(t=>{ const o=document.createElement('option'); o.value=t.name; o.textContent=t.name; sel.appendChild(o); });
        }

        function filterByTeacher(){
            // í•„í„° ë³€ê²½ ì‹œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ í˜¸ì¶œ
            loadHomeworkStatus();
        }

        function logout(){ localStorage.removeItem('teacher_auth_token'); alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤."); window.location.href='/teacher-login'; }
    </script>
</body>
</html>