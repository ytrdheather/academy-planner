<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÑ†ÏÉùÎãò ÎåÄÏãúÎ≥¥Îìú - Î¶¨ÎîîÌäúÎìú</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <style>
        /* --- Í∏∞Î≥∏ Ïä§ÌÉÄÏùº --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "NanumSquareRound", sans-serif; }
        body { background: #f8f9fa; color: #2d3748; min-height: 100vh; padding: 0; }
        .container { max-width: 1400px; margin: 0 auto; background: none; box-shadow: none; overflow: visible; padding: 0 20px; }
        .header { background: #ffffff; color: #6b46c1; padding: 20px 30px; text-align: left; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; margin: 0; }
        .user-info { position: static; text-align: right; display: flex; align-items: center; gap: 15px;}
        .user-name { font-size: 1em; margin-bottom: 0; display: inline-block; font-weight: 600; }
        .logout-btn { background: #6b46c1; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s ease; box-shadow: none; }
        .logout-btn:hover { background: #5a3eaa; }

        /* --- ÌÉ≠ Î©îÎâ¥ --- */
        .tab-menu { display: flex; background-color: #ffffff; border-bottom: 1px solid #e2e8f0; padding: 0 40px; margin-top: 20px; border-radius: 12px 12px 0 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .tab-button { padding: 15px 25px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: 600; color: #6b7280; position: relative; transition: color 0.3s ease; /* <a> ÌÉúÍ∑∏Ïö© Ïä§ÌÉÄÏùº */ text-decoration: none; display: inline-block; }
        .tab-button::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: #8b5cf6; transform: scaleX(0); transition: transform 0.3s ease; }
        .tab-button.active { color: #6b46c1; }
        .tab-button.active::after { transform: scaleX(1); }

        /* --- Ïª®ÌÖêÏ∏† Í≥µÌÜµ --- */
        .main-content { padding: 30px 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .content-section { background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); border: 1px solid #e9ecef; padding: 30px; margin: 0 20px 30px; }
        .section-title { font-size: 1.6em; font-weight: 700; color: #6b46c1; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: var(--icon, "üìã"); font-size: 1.2em; }
        .loading, .no-data { text-align: center; padding: 60px; color: #718096; font-size: 16px; }
        .loading::before { content: "‚è≥ "; } .no-data::before { content: "üìù "; }

        /* --- ÌÜµÍ≥Ñ Ïπ¥Îìú --- */
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 0 20px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .stat-value { font-size: 2.0em; font-weight: 700; color: #6b46c1; margin-bottom: 5px; }
        .stat-label { color: #718096; font-size: 14px; }

        /* --- ÌïÑÌÑ∞ --- */
        .filters-container { display:flex; gap:15px; margin-bottom:25px; align-items:center; flex-wrap: wrap; }
        .refresh-btn { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .filter-group { display:flex; align-items:center; gap:8px; }
        .filter-label { font-weight:600; color:#6b46c1; }
        .filter-select, .filter-input { padding:8px 12px; border-radius:8px; border:2px solid #e2e8f0; background:white; font-size: 14px; }
        #specificDateContainer_hw, #specificDateContainer_test, #specificDateContainer_reading, #specificDateContainer_listening, #specificDateContainer_comments { display:none; align-items:center; gap:8px; }
        #teacherFilterContainer_hw, #teacherFilterContainer_test, #teacherFilterContainer_reading, #teacherFilterContainer_listening, #teacherFilterContainer_comments { display:none; }
        #commonFilters_management { display: none; }

        /* --- ÌÖåÏù¥Î∏î --- */
        .table-container { overflow-x: auto; border: 1px solid #e9ecef; border-radius: 12px; }
        .styled-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .styled-table th { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; padding: 12px 10px; text-align: center; font-weight: 600; font-size: 13px; border-right: 1px solid rgba(255,255,255,0.2); white-space: nowrap; }
        .styled-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #f1f3f4; border-right: 1px solid #f1f3f4; vertical-align: middle; font-size: 13px; }
        .styled-table tr:hover { background-color: #f8f9ff; }
        .student-name { font-weight: 600; color: #2d3748; font-size: 14px; background: #f9fafc; text-align: left; padding-left: 15px; }

        /* --- ÌÖåÏù¥Î∏î ÎÇ¥ ÏöîÏÜå --- */
        .editable-input { padding: 4px 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; text-align: center; max-width: 60px; background-color: #f9fafb; transition: all 0.2s ease; }
        .editable-input:focus { border-color: #8b5cf6; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); background-color: white; }
        .editable-text-input { max-width: 100px; text-align: left; }
        .reading-result-badge { padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 11px; display: inline-block; }
        .result-pass { background-color: #dcfce7; color: #166534; }
        .result-fail { background-color: #fecaca; color: #991b1b; }
        .result-none { background-color: #f3f4f6; color: #6b7280; }
        .completion-rate { font-weight: 700; font-size: 14px; }
        .rate-excellent { color: #10b981; } .rate-good { color: #8b5cf6; } .rate-poor { color: #ef4444; }
        .refresh-rate-btn { background: none; border: none; cursor: pointer; font-size: 1.1em; vertical-align: middle; margin-left: 5px; opacity: 0.6; transition: opacity 0.2s ease, transform 0.2s ease; }
        .refresh-rate-btn:hover { opacity: 1; transform: rotate(90deg); }
        .refresh-rate-btn.loading { opacity: 0.5; cursor: default; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .homework-dropdown { padding: 4px 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 11px; font-weight: 600; text-align: center; min-width: 50px; background: white; cursor: pointer; transition: all 0.2s ease; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%239ca3af'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em 1em; padding-right: 1.8em; }
        .homework-dropdown:hover { border-color: #6b46c1; box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.1); }
        .homework-dropdown:focus { outline: none; border-color: #6b46c1; box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1); }
        .homework-dropdown.status-default, .homework-dropdown.status-none, .homework-dropdown.status-listening-none { background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db; }
        .homework-dropdown.status-complete, .homework-dropdown.status-reading-complete, .homework-dropdown.status-vocab-complete, .homework-dropdown.status-writing-bookreport, .homework-dropdown.status-listening-complete { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .homework-dropdown.status-incomplete, .homework-dropdown.status-reading-incomplete, .homework-dropdown.status-vocab-incomplete, .homework-dropdown.status-listening-incomplete { background-color: #fecaca; color: #991b1b; border-color: #fca5a5; }
        .homework-dropdown.status-vocab-skip, .homework-dropdown.status-writing-skip { background-color: #ffedd5; color: #9a3412; border-color: #fed7aa; }
        .homework-dropdown.status-writing-3sentence { background-color: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
        .score-circle { position: relative; width: 45px; height: 45px; border-radius: 50%; background: conic-gradient(var(--score-color, #e5e7eb) 0% var(--score-value, 0%), #e5e7eb var(--score-value, 0%) 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto; }
        .score-circle::before { content: ''; position: absolute; width: 75%; height: 75%; background: white; border-radius: 50%; }
        .score-text { position: relative; font-size: 13px; font-weight: 700; color: var(--score-color, #6b7280); }
        .score-none { font-size: 14px; font-weight: 600; color: #9ca3af; }
        .book-title-cell { padding: 5px !important; }
        .book-title-button { width: 100%; min-height: 30px; padding: 6px 8px; border: 1px solid transparent; border-radius: 4px; background-color: transparent; cursor: pointer; text-align: left; font-size: 13px; color: #111827; transition: all 0.2s ease; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.4; }
        .book-title-button:hover { border-color: #d1d5db; background-color: #f9fafb; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1); }
        .book-title-button.empty { color: #6b7280; font-style: italic; text-align: center; }

        /* --- ÏΩîÎ©òÌä∏ ÌÉ≠ Ïä§ÌÉÄÏùº --- */
        .comment-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            font-family: "NanumSquareRound", sans-serif;
            resize: vertical;
            min-height: 38px;
            transition: all 0.2s ease;
        }
        .comment-textarea:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
            outline: none;
        }
        .comment-save-btn {
            background: #10b981; /* Ï¥àÎ°ùÏÉâ (Ï†ÄÏû•Îê®) */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s ease;
        }
        .comment-save-btn:hover { background: #059669; }
        .comment-save-btn:disabled { background: #d1d5db; cursor: not-allowed; }
        .batch-save-btn {
            background: #6b46c1;
            color: white;
            margin-left: auto; /* Îß® Ïò§Î•∏Ï™ΩÏúºÎ°ú Î∞ÄÏñ¥ÎÇ¥Í∏∞ */
        }
        .batch-save-btn:hover { background: #5a3eaa; }
        .batch-save-btn.loading {
            background: #a78bfa;
            cursor: wait;
        }
        .comment-textarea.changed { /* Î≥ÄÍ≤ΩÎêú textarea Ïä§ÌÉÄÏùº */
            background-color: #fffbeb; 
            border-color: #f59e0b;
        }

        /* --- Ï±Ö Í≤ÄÏÉâ Î™®Îã¨ --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        .modal-title { font-size: 1.4em; font-weight: 700; color: #6b46c1; margin-bottom: 20px; }
        .modal-search-input { width: 100%; padding: 12px 15px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; }
        .modal-search-results { max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; }
        .result-item { padding: 12px 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer; }
        .result-item:hover { background-color: #f8f9ff; }
        .result-item:last-child { border-bottom: none; }
        .result-title { font-weight: 600; color: #2d3748; }
        .result-meta { font-size: 13px; color: #718096; margin-top: 4px; }
        .modal-actions { margin-top: 20px; display: flex; justify-content: space-between; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: #f3f4f6; color: #4b5563; }
        .btn-clear { background: #fee2e2; color: #991b1b; }

        /* --- ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ --- */
        .toast-message { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; font-weight: 600; z-index: 3000; opacity: 0; transform: translateX(100%); transition: all 0.3s ease; }
        .toast-message.show { opacity: 1; transform: translateX(0); }
        .toast-success { background: #dcfce7; border: 1px solid #bbf7d0; color: #166534; }
        .toast-error { background: #fecaca; border: 1px solid #fca5a5; color: #991b1b; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö Î¶¨ÎîîÌäúÎìú ÏÑ†ÏÉùÎãò</h1>
        <div class="user-info">
            <span class="user-name" id="userName">Î°úÎî©Ï§ë...</span>
            <button class="logout-btn" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
        </div>
    </div>

    <div class="container">
        <div class="tab-menu">
            <button class="tab-button active" onclick="showTab('homework')">ÏàôÏ†ú ÌòÑÌô©</button>
            <button class="tab-button" onclick="showTab('tests')">ÌÖåÏä§Ìä∏ Í≤∞Í≥º</button>
            <button class="tab-button" onclick="showTab('reading')">ÏõêÏÑú ÎèÖÏÑú ÌòÑÌô©</button>
            <button class="tab-button" onclick="showTab('listening')">Î¶¨Ïä§Îãù ÌòÑÌô©</button>
            <button class="tab-button" onclick="showTab('comments')">Ïò§ÎäòÏùò ÏΩîÎ©òÌä∏</button>
            
            <a href="/management" target="_blank" class="tab-button" id="tab-management" style="display: none; color: #d946ef; font-weight: 700;">
                üßë‚Äçüéì ÌïôÏÉù Î™ÖÎ∂Ä Í¥ÄÎ¶¨
            </a>
            </div>

        <div class="main-content">
            <div id="homework-view" class="tab-content active">
                <div class="stats-summary" id="statsContainer_hw"></div>
                <div class="content-section">
                    <div class="section-title" style="--icon:'üìã'">Îã¥Îãπ ÌïôÏÉù ÏàôÏ†ú ÌòÑÌô©</div>
                    <div class="filters-container" id="commonFilters_hw">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                        <div class="filter-group">
                            <label for="periodFilter_hw" class="filter-label">Í∏∞Í∞Ñ:</label>
                            <select id="periodFilter_hw" class="filter-select">
                                <option value="today" selected>Ïò§Îäò</option>
                                <option value="specific_date">ÎÇ†Ïßú ÏßÄÏ†ï</option>
                            </select>
                        </div>
                        <div id="specificDateContainer_hw" style="display:none;" class="filter-group">
                            <input type="date" id="specificDate_hw" class="filter-input">
                        </div>
                        <div id="teacherFilterContainer_hw" style="display:none;" class="filter-group">
                            <label for="teacherFilter_hw" class="filter-label">Îã¥ÎãπÍ∞ïÏÇ¨:</label>
                            <select id="teacherFilter_hw" class="filter-select">
                                <option value="">Ï†ÑÏ≤¥ Î≥¥Í∏∞</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr> <th>ÌïôÏÉù Ïù¥Î¶Ñ</th> <th>Îã¥ÎãπÍ∞ïÏÇ¨</th> <th>‚≠ï Î¨∏Î≤ï</th> <th>1Ô∏è‚É£ Ïñ¥Ìúò</th> <th>2Ô∏è‚É£ ÎèÖÌï¥</th> <th>4Ô∏è‚É£ Sum</th> <th>5Ô∏è‚É£ ÎèÖÌï¥</th> <th>6Ô∏è‚É£ ÏùºÍ∏∞ Îì±</th> <th>ÏàòÌñâÏú®</th> </tr>
                            </thead>
                            <tbody id="homeworkTableBody">
                                <tr><td colspan="9" class="loading">ÏàôÏ†ú ÌòÑÌô©ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tests-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title" style="--icon:'üìù'">Îã¥Îãπ ÌïôÏÉù ÌÖåÏä§Ìä∏ Í≤∞Í≥º</div>
                    <div class="filters-container" id="commonFilters_test">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                        <div class="filter-group">
                            <label for="periodFilter_test" class="filter-label">Í∏∞Í∞Ñ:</label>
                            <select id="periodFilter_test" class="filter-select">
                                <option value="today" selected>Ïò§Îäò</option>
                                <option value="specific_date">ÎÇ†Ïßú ÏßÄÏ†ï</option>
                            </select>
                        </div>
                        <div id="specificDateContainer_test" style="display:none;" class="filter-group">
                            <input type="date" id="specificDate_test" class="filter-input">
                        </div>
                        <div id="teacherFilterContainer_test" style="display:none;" class="filter-group">
                            <label for="teacherFilter_test" class="filter-label">Îã¥ÎãπÍ∞ïÏÇ¨:</label>
                            <select id="teacherFilter_test" class="filter-select">
                                <option value="">Ï†ÑÏ≤¥ Î≥¥Í∏∞</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>ÌïôÏÉù Ïù¥Î¶Ñ</th>
                                    <th>Ïñ¥ÌúòÏú†Îãõ</th>
                                    <th>Ïñ¥ÌúòÏ†ïÎãµ</th>
                                    <th>Ï¥ùÍ∞ØÏàò</th>
                                    <th>Ïñ¥ÌúòÏ†êÏàò</th>
                                    <th>ÎèÖÌï¥Ïò§Îãµ</th>
                                    <th>ÎèÖÌï¥Í≤∞Í≥º</th>
                                    <th>ÌïòÎ∏åÎ£®ÌÉÄ</th>
                                    <th>Î¨∏Î≤ïÎ¨∏Ìï≠</th> <th>Î¨∏Î≤ïÏò§Îãµ</th> <th>Î¨∏Î≤ïÏ†êÏàò</th>
                                </tr>
                            </thead>
                            <tbody id="testsTableBody">
                                <tr><td colspan="11" class="loading">ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÎ•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="reading-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title" style="--icon:'üìö'">ÏõêÏÑú ÎèÖÏÑú ÌòÑÌô©</div>
                    <div class="filters-container" id="commonFilters_reading">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                        <div class="filter-group">
                            <label for="periodFilter_reading" class="filter-label">Í∏∞Í∞Ñ:</label>
                            <select id="periodFilter_reading" class="filter-select">
                                <option value="today" selected>Ïò§Îäò</option>
                                <option value="specific_date">ÎÇ†Ïßú ÏßÄÏ†ï</option>
                            </select>
                        </div>
                        <div id="specificDateContainer_reading" style="display:none;" class="filter-group">
                            <input type="date" id="specificDate_reading" class="filter-input">
                        </div>
                        <div id="teacherFilterContainer_reading" style="display:none;" class="filter-group">
                            <label for="teacherFilter_reading" class="filter-label">Îã¥ÎãπÍ∞ïÏÇ¨:</label>
                            <select id="teacherFilter_reading" class="filter-select">
                                <option value="">Ï†ÑÏ≤¥ Î≥¥Í∏∞</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>ÌïôÏÉù Ïù¥Î¶Ñ</th>
                                    <th>Îã¥ÎãπÍ∞ïÏÇ¨</th>
                                    <th>üìñ ÏòÅÏñ¥ÎèÖÏÑú</th>
                                    <th>Ïñ¥ÌúòÌïôÏäµ</th>
                                    <th>üìö Ï±Ö Ï†úÎ™©</th>
                                    <th>ÏãúÎ¶¨Ï¶à</th>
                                    <th>AR</th>
                                    <th>Lexile</th>
                                    <th>Writing ÌïôÏäµ</th>
                                </tr>
                            </thead>
                            <tbody id="readingTableBody">
                                <tr><td colspan="9" class="loading">ÏõêÏÑú ÎèÖÏÑú ÌòÑÌô©ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="listening-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title" style="--icon:'üéß'">Î¶¨Ïä§Îãù ÌòÑÌô©</div>
                    <div class="filters-container" id="commonFilters_listening">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                        <div class="filter-group">
                            <label for="periodFilter_listening" class="filter-label">Í∏∞Í∞Ñ:</label>
                            <select id="periodFilter_listening" class="filter-select">
                                <option value="today" selected>Ïò§Îäò</option>
                                <option value="specific_date">ÎÇ†Ïßú ÏßÄÏ†ï</option>
                            </select>
                        </div>
                        <div id="specificDateContainer_listening" style="display:none;" class="filter-group">
                            <input type="date" id="specificDate_listening" class="filter-input">
                        </div>
                        <div id="teacherFilterContainer_listening" style="display:none;" class="filter-group">
                            <label for="teacherFilter_listening" class="filter-label">Îã¥ÎãπÍ∞ïÏÇ¨:</label>
                            <select id="teacherFilter_listening" class="filter-select">
                                <option value="">Ï†ÑÏ≤¥ Î≥¥Í∏∞</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>ÌïôÏÉù Ïù¥Î¶Ñ</th>
                                    <th>Îã¥ÎãπÍ∞ïÏÇ¨</th>
                                    <th>Îì£Í∏∞ ÌïôÏäµ</th>
                                    <th>Îì£Í∏∞ ÏõåÌÅ¨Î∂Å</th>
                                </tr>
                            </thead>
                            <tbody id="listeningTableBody">
                                <tr><td colspan="4" class="loading">Î¶¨Ïä§Îãù ÌòÑÌô©ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="comments-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title" style="--icon:'üí¨'">üí¨ Ïò§ÎäòÏùò ÏΩîÎ©òÌä∏</div>
                     <div class="filters-container" id="commonFilters_comments">
                        <button class="refresh-btn" onclick="loadDataForCurrentTab()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                        <div class="filter-group">
                            <label for="periodFilter_comments" class="filter-label">Í∏∞Í∞Ñ:</label>
                            <select id="periodFilter_comments" class="filter-select">
                                <option value="today" selected>Ïò§Îäò</option>
                                <option value="specific_date">ÎÇ†Ïßú ÏßÄÏ†ï</option>
                            </select>
                        </div>
                        <div id="specificDateContainer_comments" style="display:none;" class="filter-group">
                            <input type="date" id="specificDate_comments" class="filter-input">
                        </div>
                        <div id="teacherFilterContainer_comments" style="display:none;" class="filter-group">
                            <label for="teacherFilter_comments" class="filter-label">Îã¥ÎãπÍ∞ïÏÇ¨:</label>
                            <select id="teacherFilter_comments" class="filter-select">
                                <option value="">Ï†ÑÏ≤¥ Î≥¥Í∏∞</option>
                            </select>
                        </div>
                        <button class="refresh-btn batch-save-btn" id="batchSaveBtn" onclick="saveAllComments(this)">
                            üíæ ÏùºÍ¥Ñ Ï†ÄÏû•
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <colgroup>
                                <col style="width: 15%;">
                                <col style="width: 10%;"> <col style="width: 10%;"> <col style="width: 55%;"> <col style="width: 10%;">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>ÌïôÏÉù Ïù¥Î¶Ñ</th>
                                    <th>Îã¥ÎãπÍ∞ïÏÇ¨</th>
                                    <th>Î¨∏Î≤ï ÌÅ¥ÎûòÏä§</th> <th>Ïò§ÎäòÏùò ÏΩîÎ©òÌä∏</th>
                                    <th>Ï†ÄÏû•</th>
                                </tr>
                            </thead>
                            <tbody id="commentsTableBody">
                                <tr><td colspan="5" class="loading">Ïò§ÎäòÏùò ÏΩîÎ©òÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="management-view" class="tab-content">
                <div class="content-section">
                    <div class="section-title" style="--icon:'üßë‚Äçüéì'">ÌïôÏÉù Î™ÖÎ∂Ä Í¥ÄÎ¶¨ (Îß§ÎãàÏ†Ä Ï†ÑÏö©)</div>
                    <div class="filters-container" id="commonFilters_management" style="display: block;"> <button class="refresh-btn" onclick="loadDataForCurrentTab()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                         <div class="filter-group">
                            <label for="studentSearch_management" class="filter-label">ÌïôÏÉù Í≤ÄÏÉâ:</label>
                            <input type="text" id="studentSearch_management" class="filter-input" placeholder="Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ...">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>ÌïôÏÉù Ïù¥Î¶Ñ</th>
                                    <th>ÌïôÎÖÑ</th>
                                    <th>ÌïôÍµê</th>
                                    <th>ÏòÅÏñ¥ ÎçîÎπô OR Îì£Í∏∞ ÍµêÏû¨ (ÏàòÏ†ï)</th>
                                </tr>
                            </thead>
                            <tbody id="managementTableBody">
                                <tr><td colspan="4" class="loading">ÌïôÏÉù Î™ÖÎ∂Ä Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="bookSearchModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">üìö Ï±Ö Ï†úÎ™© Í≤ÄÏÉâ</h2>
            <input type="text" id="modalSearchInput" class="modal-search-input" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
            <div id="modalSearchResults" class="modal-search-results">
                <div class="no-data" style="padding: 30px;">Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...</div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-clear" onclick="selectBook(null, 'Ï±Ö Í≤ÄÏÉâ...')">üö´ Í¥ÄÍ≥Ñ Ïó∞Í≤∞ Ìï¥Ï†ú</button>
                <button class="modal-btn btn-cancel" onclick="closeBookSearchModal()">Îã´Í∏∞</button>
            </div>
        </div>
    </div>

    <script>
        // --- Ï†ÑÏó≠ Î≥ÄÏàò Î∞è Ï¥àÍ∏∞Ìôî ---
        const API_BASE_URL = 'http://localhost:5001';
        let authToken = localStorage.getItem('teacher_auth_token');
        let allCombinedData = [];
        let allReadingData = [];
        let allListeningData = [];
        let allCommentData = [];
        let allRosterData = []; // [Ïã†Í∑ú] ÌïôÏÉù Î™ÖÎ∂Ä Îç∞Ïù¥ÌÑ∞ Ï∫êÏãú
        let currentUserRole = '';
        let currentUserName = '';
        let currentActiveTab = 'homework';
        let currentModalContext = {}; // { pageId, propertyName, type }
        let bookSearchTimer = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) { console.error('Ïù∏Ï¶ù ÌÜ†ÌÅ∞ ÏóÜÏùå'); window.location.href='/teacher-login'; return; }
            initializePage();
        });

        async function initializePage() {
            try {
                await loadUserInfo();
                setupEventListeners();
                showTab('homework');
            } catch (e) { console.error("Ï¥àÍ∏∞Ìôî Ïò§Î•ò:", e); }
        }

        function setupEventListeners() {
            ['hw', 'test', 'reading', 'listening', 'comments'].forEach(suffix => {
                const s = `_${suffix}`;
                document.getElementById(`periodFilter${s}`)?.addEventListener('change', () => {
                    toggleSpecificDateInput(s);
                    loadDataForCurrentTab();
                });
                document.getElementById(`specificDate${s}`)?.addEventListener('change', loadDataForCurrentTab);
                document.getElementById(`teacherFilter${s}`)?.addEventListener('change', loadDataForCurrentTab);
            });
            
            // ÌïôÏÉù Î™ÖÎ∂Ä Í≤ÄÏÉâ
            document.getElementById('studentSearch_management')?.addEventListener('input', (e) => {
                filterStudentRoster(e.target.value);
            });

            // Ï±Ö Í≤ÄÏÉâ Î™®Îã¨ ÎîîÎ∞îÏö¥Ïä§ ÏûÖÎ†•
            document.getElementById('modalSearchInput')?.addEventListener('input', (e) => {
                clearTimeout(bookSearchTimer);
                const query = e.target.value;
                bookSearchTimer = setTimeout(() => {
                    // Î™®Îã¨ Ïª®ÌÖçÏä§Ìä∏Ïóê Îî∞Îùº Îã§Î•∏ Í≤ÄÏÉâ API Ìò∏Ï∂ú
                    if (currentModalContext.type === 'listeningBook') {
                        searchListeningBooks(query); // Î¶¨Ïä§Îãù ÍµêÏû¨ Í≤ÄÏÉâ (Ï∂îÌõÑ ENG_BOOKS_IDÏôÄ Îã§Î•º Í≤ΩÏö∞ ÎåÄÎπÑ)
                    } else {
                        searchEngBooks(query); // Í∏∞Î≥∏Í∞í: ÏòÅÏñ¥ ÏõêÏÑú Í≤ÄÏÉâ
                    }
                }, 300);
            });
            document.querySelector('.btn-cancel').addEventListener('click', closeBookSearchModal);
        }

        // --- Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìï®Ïàò ---
        async function loadUserInfo() {
             try {
                const userInfoResponse = await fetch(`${API_BASE_URL}/api/teacher/user-info`, { headers:{Authorization:'Bearer '+authToken} });
                if (!userInfoResponse.ok) throw new Error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®');
                const data = await userInfoResponse.json();
                if (data.userName) {
                    document.getElementById('userName').textContent = data.userName + ' ('+data.userRole+')';
                    currentUserRole = data.userRole;
                    currentUserName = data.userName;
                    const filterContainers = document.querySelectorAll('#teacherFilterContainer_hw, #teacherFilterContainer_test, #teacherFilterContainer_reading, #teacherFilterContainer_listening, #teacherFilterContainer_comments');

                    if (data.userRole === 'manager') {
                        const teachersResponse = await fetch(`${API_BASE_URL}/api/teachers`, { headers:{Authorization:'Bearer '+authToken} });
                        if (!teachersResponse.ok) throw new Error('Í∞ïÏÇ¨ Î™©Î°ù Î°úÎìú Ïã§Ìå®');
                        const teachers = await teachersResponse.json();
                        updateTeacherFilterOptions(teachers);
                        filterContainers.forEach(el => { if (el) el.style.display='flex'; });
                        const mgmtTab = document.getElementById('tab-management');
                        if (mgmtTab) mgmtTab.style.display = 'block'; 
                    } else {
                        updateTeacherFilterOptions([]);
                        filterContainers.forEach(el => { if (el) el.style.display='none'; });
                    }
                } else { throw new Error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌòïÏãùÏù¥ ÏûòÎ™ªÎê®'); }
             } catch (error) {
                 console.error("ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:", error);
                 alert('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                 logout();
             }
        }

        async function loadDataForCurrentTab() {
            console.log(`Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë: ${currentActiveTab}`);
            if (currentActiveTab === 'homework' || currentActiveTab === 'tests') {
                await loadHomeworkAndTestData();
            } else if (currentActiveTab === 'reading') {
                await loadReadingStatusData();
            } else if (currentActiveTab === 'listening') {
                await loadListeningStatusData();
            } else if (currentActiveTab === 'comments') {
                await loadCommentData();
            } else if (currentActiveTab === 'management') {
                // [ÏàòÏ†ï] management ÌÉ≠ÏùÄ <button>Ïù¥ ÏïÑÎãå <a> ÌÉúÍ∑∏Ïù¥ÎØÄÎ°ú,
                // showTab() Ìï®ÏàòÏóêÏÑú Ïù¥ Ìï®ÏàòÎ•º Ìò∏Ï∂úÌïòÏßÄ ÏïäÏäµÎãàÎã§.
                // ÎßåÏïΩ Ïù¥ ÌÉ≠(teacher.html) ÎÇ¥Î∂ÄÏóê Î™ÖÎ∂Ä Îç∞Ïù¥ÌÑ∞Î•º ÌëúÏãúÌï¥Ïïº ÌïúÎã§Î©¥
                // showTab() Ìï®ÏàòÎ•º ÏàòÏ†ïÌï¥Ïïº Ìï©ÎãàÎã§.
                // ÌïòÏßÄÎßå ÌòÑÏû¨ <a> ÌÉúÍ∑∏Î°ú ÏÉà Ï∞ΩÏùÑ Ïó¨Îäî Î∞©ÏãùÏù¥ÎØÄÎ°ú, Ïù¥ Î∂ÄÎ∂ÑÏùÄ 
                // /management.html ÌéòÏù¥ÏßÄÏùò JavaScriptÍ∞Ä Ï≤òÎ¶¨ÌïòÍ≤å Îê©ÎãàÎã§.
                // Îî∞ÎùºÏÑú Ïó¨Í∏∞ÏÑúÎäî `loadStudentRosterData()`Î•º Ìò∏Ï∂úÌï† ÌïÑÏöîÍ∞Ä ÏóÜÏäµÎãàÎã§.
                // await loadStudentRosterData(); // Ïù¥ Ï§ÑÏùÄ Ï†úÍ±∞ÌïòÍ±∞ÎÇò Ï£ºÏÑù Ï≤òÎ¶¨
                console.log('ÌïôÏÉù Î™ÖÎ∂Ä ÌÉ≠ÏùÄ ÏÉà Ï∞ΩÏóêÏÑú Ïó¥Î¶ΩÎãàÎã§.');
            }
        }

        function getFilterParams(suffix) {
            const period = document.getElementById(`periodFilter${suffix}`)?.value || 'today';
            const teacherSelect = document.getElementById(`teacherFilter${suffix}`);
            const teacher = (currentUserRole === 'manager' && teacherSelect) ? teacherSelect.value : (currentUserRole === 'teacher' ? currentUserName : '');
            let params = `period=${period}`;
            if (period === 'specific_date') {
                const specificDateValue = document.getElementById(`specificDate${suffix}`)?.value;
                if (specificDateValue) {
                    params += `&date=${specificDateValue}`;
                } else {
                    params = 'period=today'; 
                    const periodSelect = document.getElementById(`periodFilter${suffix}`);
                    if(periodSelect) periodSelect.value = 'today';
                    toggleSpecificDateInput(suffix);
                }
            }
            if (currentUserRole === 'manager' && teacher && teacher !== "") {
                params += `&teacher=${encodeURIComponent(teacher)}`;
            }
            return params;
        }

        async function loadHomeworkAndTestData() {
            const hwTbody = document.getElementById('homeworkTableBody');
            const testTbody = document.getElementById('testsTableBody');
            hwTbody.innerHTML = '<tr><td colspan="9" class="loading">Î°úÎî©Ï§ë...</td></tr>';
            testTbody.innerHTML = '<tr><td colspan="11" class="loading">Î°úÎî©Ï§ë...</td></tr>';
            try {
                const filterSuffix = (currentActiveTab === 'tests') ? '_test' : '_hw';
                const params = getFilterParams(filterSuffix);
                const url = `${API_BASE_URL}/api/homework-status?${params}`;
                const response = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò"); }
                const combinedData = await response.json();
                allCombinedData = combinedData;
                displayHomeworkData(combinedData);
                displayTestData(combinedData);
                updateStats(combinedData);
            } catch(e) {
                console.error("ÏàôÏ†ú/ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:", e);
                const errorMsg = `<tr><td colspan="11" class="no-data">${e.message || 'Î°úÎìú Ïã§Ìå®'}</td></tr>`;
                hwTbody.innerHTML = errorMsg.replace('colspan="11"', 'colspan="9"');
                testTbody.innerHTML = errorMsg;
                updateStats([]);
            }
        }

        async function loadReadingStatusData() {
            const tbody = document.getElementById('readingTableBody');
            tbody.innerHTML = '<tr><td colspan="9" class="loading">Î°úÎî©Ï§ë...</td></tr>';
            try {
                const params = getFilterParams('_reading');
                const url = `${API_BASE_URL}/api/reading-status?${params}`;
                const response = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || "ÏõêÏÑú ÎèÖÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®"); }
                const readingData = await response.json();
                allReadingData = readingData;
                displayReadingData(readingData);
            } catch(e) {
                console.error("ÏõêÏÑú ÎèÖÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:", e);
                tbody.innerHTML = `<tr><td colspan="9" class="no-data">${e.message || 'Î°úÎìú Ïã§Ìå®'}</td></tr>`;
            }
        }

        async function loadListeningStatusData() {
            const tbody = document.getElementById('listeningTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="loading">Î°úÎî©Ï§ë...</td></tr>';
            try {
                const params = getFilterParams('_listening');
                const url = `${API_BASE_URL}/api/listening-status?${params}`;
                const response = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || "Î¶¨Ïä§Îãù Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®"); }
                const listeningData = await response.json();
                allListeningData = listeningData;
                displayListeningData(listeningData);
            } catch(e) {
                console.error("Î¶¨Ïä§Îãù Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:", e);
                tbody.innerHTML = `<tr><td colspan="4" class="no-data">${e.message || 'Î°úÎìú Ïã§Ìå®'}</td></tr>`;
            }
        }
        
        async function loadCommentData() {
            const tbody = document.getElementById('commentsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Î°úÎî©Ï§ë...</td></tr>';
            try {
                const params = getFilterParams('_comments');
                const url = `${API_BASE_URL}/api/comment-status?${params}`;
                const response = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || "ÏΩîÎ©òÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®"); }
                const commentData = await response.json();
                allCommentData = commentData;
                displayCommentData(commentData);
            } catch(e) {
                console.error("ÏΩîÎ©òÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:", e);
                tbody.innerHTML = `<tr><td colspan="5" class="no-data">${e.message || 'Î°úÎìú Ïã§Ìå®'}</td></tr>`;
            }
        }

        // [ÏàòÏ†ï] Ïù¥ Ìï®ÏàòÎäî management.html ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï† ÏòàÏ†ïÏù¥ÎØÄÎ°ú 
        // teacher.htmlÏóêÏÑúÎäî ÏÇ¨Ïã§ÏÉÅ ÌïÑÏöîÍ∞Ä ÏóÜÏäµÎãàÎã§.
        async function loadStudentRosterData() {
            const tbody = document.getElementById('managementTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="loading">Î°úÎî©Ï§ë...</td></tr>';
            try {
                const url = `${API_BASE_URL}/api/student-roster`;
                const response = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || "ÌïôÏÉù Î™ÖÎ∂Ä Î°úÎìú Ïã§Ìå®"); }
                const rosterData = await response.json();
                allRosterData = rosterData; // Ï∫êÏãú
                displayStudentRosterData(rosterData);
            } catch(e) {
                console.error("ÌïôÏÉù Î™ÖÎ∂Ä Î°úÎìú Ïò§Î•ò:", e);
                tbody.innerHTML = `<tr><td colspan="4" class="no-data">${e.message || 'Î°úÎìú Ïã§Ìå®'}</td></tr>`;
            }
        }


        // --- UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò ---
        function toggleSpecificDateInput(suffixWithUnderscore) {
             const periodEl = document.getElementById(`periodFilter${suffixWithUnderscore}`);
             const specificDateEl = document.getElementById(`specificDateContainer${suffixWithUnderscore}`); 
             if (periodEl && specificDateEl) {
                 specificDateEl.style.display = (periodEl.value === 'specific_date') ? 'flex' : 'none'; 
                 if (periodEl.value === 'specific_date') {
                     const dateInput = document.getElementById(`specificDate${suffixWithUnderscore}`);
                     if (dateInput && !dateInput.value) {
                         dateInput.valueAsDate = new Date();
                     }
                 }
             }
        }

        function displayHomeworkData(data) {
            const tbody = document.getElementById('homeworkTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="9" class="no-data">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `
                <tr id="row-hw-${st.pageId}">
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers || []).join(', ')}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '‚≠ï ÏßÄÎÇú Î¨∏Î≤ï ÏàôÏ†ú Í≤ÄÏÇ¨', st.grammarHomework)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '1Ô∏è‚É£ Ïñ¥Ìúò ÌÅ¥Ïπ¥ ÏïîÍ∏∞ ÏàôÏ†ú', st.vocabCards)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '2Ô∏è‚É£ ÎèÖÌï¥ Îã®Ïñ¥ ÌÅ¥Ïπ¥ ÏàôÏ†ú', st.readingCards)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '4Ô∏è‚É£ Summary ÏàôÏ†ú', st.summary)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '5Ô∏è‚É£ Îß§Ïùº ÎèÖÌï¥ ÏàôÏ†ú', st.readingHomework)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '6Ô∏è‚É£ ÏòÅÏñ¥ÏùºÍ∏∞ or Í∞úÏù∏ ÎèÖÌï¥ÏÑú', st.diary)}</td>
                    <td>
                        <span class="completion-rate ${rateClass(st.completionRate)}">${st.completionRate || 0}%</span>
                        <button class="refresh-rate-btn" onclick="refreshStudentRate(this, '${st.pageId}')" title="ÏàòÌñâÏú® ÏÉàÎ°úÍ≥†Ïπ®">üîÑ</button>
                    </td>
                </tr>`).join('');
        }

        function displayTestData(data) {
            const tbody = document.getElementById('testsTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="11" class="no-data">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</td></tr>'; return; }
            tbody.innerHTML = data.map(st => {
                const vScore = (st.vocabTotal > 0) ? Math.round((st.vocabCorrect / st.vocabTotal) * 100) : 0;
                const gScore = (st.grammarTotal > 0) ? Math.round(((st.grammarTotal - (st.grammarWrong || 0)) / st.grammarTotal) * 100) : 0;
                return `
                <tr id="row-test-${st.pageId}">
                    <td class="student-name">${st.studentName}</td>
                    <td><input type="text" class="editable-input editable-text-input" value="${st.vocabUnit || ''}" defaultValue="${st.vocabUnit || ''}" data-page-id="${st.pageId}" data-property-name="Ïñ¥ÌúòÏú†Îãõ" data-property-type="rich_text" onblur="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td><input type="number" class="editable-input" value="${st.vocabCorrect ?? ''}" defaultValue="${st.vocabCorrect ?? ''}" data-page-id="${st.pageId}" data-property-name="Îã®Ïñ¥ (ÎßûÏùÄ Í∞úÏàò)" data-property-type="number" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td><input type="number" class="editable-input" value="${st.vocabTotal ?? ''}" defaultValue="${st.vocabTotal ?? ''}" data-page-id="${st.pageId}" data-property-name="Îã®Ïñ¥ (Ï†ÑÏ≤¥ Í∞úÏàò)" data-property-type="number" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td class="vocab-score">${formatScoreCircle(vScore)}</td>
                    <td><input type="number" class="editable-input" value="${st.readingWrong ?? ''}" defaultValue="${st.readingWrong ?? ''}" data-page-id="${st.pageId}" data-property-name="ÎèÖÌï¥ (ÌãÄÎ¶∞ Í∞úÏàò)" data-property-type="number" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td><span class="reading-result-badge ${getReadingResultClass(st.readingResult)}">${st.readingResult || '-'}</span></td>
                    <td>${formatSelectDropdown(st.pageId, 'ÎèÖÌï¥ ÌïòÎ∏åÎ£®ÌÉÄ', st.havruta, ['ÏôÑÎ£åÌï®', 'Î™ªÌïòÍ≥†Í∞ê', 'ÏàôÏ†úÏóÜÏùå'], 'ÏàôÏ†úÏóÜÏùå')}</td>
                    <td><input type="number" class="editable-input" value="${st.grammarTotal ?? ''}" defaultValue="${st.grammarTotal ?? ''}" data-page-id="${st.pageId}" data-property-name="Î¨∏Î≤ï (Ï†ÑÏ≤¥ Í∞úÏàò)" data-property-type="number" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td><input type="number" class="editable-input" value="${st.grammarWrong ?? ''}" defaultValue="${st.grammarWrong ?? ''}" data-page-id="${st.pageId}" data-property-name="Î¨∏Î≤ï (ÌãÄÎ¶∞ Í∞úÏàò)" data-property-type="number" onchange="updateField(this)" onkeydown="handleEnterAsTab(event, 'testsTableBody')"></td>
                    <td class="grammar-score">${formatScoreCircle(gScore)}</td>
                </tr>`
            }).join('');
        }

        function displayReadingData(data) {
             const tbody = document.getElementById('readingTableBody');
             if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="9" class="no-data">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `
                <tr id="row-reading-${st.pageId}">
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers || []).join(', ')}</td>
                    <td>${formatSelectDropdown(st.pageId, 'üìñ ÏòÅÏñ¥ÎèÖÏÑú', st.readingStatus, ['ÏôÑÎ£åÌï®', 'Î™ªÌï®'], '---')}</td>
                    <td>${formatSelectDropdown(st.pageId, 'Ïñ¥ÌúòÌïôÏäµ', st.vocabStatus, ['ÏôÑÎ£åÌï®', 'Î™ªÌï®', 'SKIP', 'ÏôÑÎ£å'], '---')}</td>
                    <td class="book-title-cell">
                        <button class="book-title-button ${st.bookTitle ? '' : 'empty'}" data-page-id="${st.pageId}" data-relation-id="${st.bookRelationId || ''}" onclick="openEngBookModal(this)">
                            ${st.bookTitle || 'Ï±Ö Í≤ÄÏÉâ...'}
                        </button>
                    </td>
                    <td>${st.bookSeries || '-'}</td>
                    <td>${st.bookAR ?? '-'}</td>
                    <td>${st.bookLexile ?? '-'}</td>
                    <td>${formatSelectDropdown(st.pageId, 'Writing', st.writingStatus, ['SKIP', 'Î∂ÅÎ¶¨Ìè¨Ìä∏', '3 SENTENCE'], '---')}</td>
                </tr>`).join('');
        }

        function displayListeningData(data) {
            const tbody = document.getElementById('listeningTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="4" class="no-data">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</td></tr>'; }
            const listeningOptions = ['ÏôÑÎ£å', 'ÎØ∏ÏôÑÎ£å', 'ÏßÑÌñâÌïòÏßÄ ÏïäÏùå'];
            tbody.innerHTML = data.map(st => `
                <tr id="row-listening-${st.pageId}">
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers || []).join(', ')}</td>
                    <td>${formatHomeworkDropdown(st.pageId, 'ÏòÅÏñ¥ ÎçîÎπô ÌïôÏäµ ÏôÑÎ£å', st.listeningStudy, listeningOptions)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, 'ÎçîÎπô ÏõåÌÅ¨Î∂Å ÏôÑÎ£å', st.listeningWorkbook, listeningOptions)}</td>
                </tr>`).join('');
        }

        function displayCommentData(data) {
            const tbody = document.getElementById('commentsTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="5" class="no-data">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `
                <tr id="row-comment-${st.pageId}">
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers || []).join(', ')}</td>
                    <td>${st.grammarClass || '-'}</td>
                    <td style="padding: 5px;">
                        <textarea class="comment-textarea" rows="2" data-page-id="${st.pageId}" defaultValue="${st.comment || ''}" oninput="markCommentAsChanged(this)">${st.comment || ''}</textarea>
                    </td>
                    <td style="vertical-align: middle;">
                        <button class="comment-save-btn" onclick="updateComment(this, '${st.pageId}')">Ï†ÄÏû•</button>
                    </td>
                </tr>`).join('');
        }

        // [ÏàòÏ†ï] Ïù¥ Ìï®ÏàòÎèÑ management.html ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï† ÏòàÏ†ï
        function displayStudentRosterData(data) {
            const tbody = document.getElementById('managementTableBody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="4" class="no-data">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</td></tr>'; return; }
            tbody.innerHTML = data.map(st => `
                <tr id="row-management-${st.pageId}">
                    <td class="student-name">${st.studentName}</td>
                    <td>${st.grade || '-'}</td>
                    <td>${st.school || '-'}</td>
                    <td class="book-title-cell">
                        <button 
                            class="book-title-button ${st.listeningBookTitle ? '' : 'empty'}" 
                            data-page-id="${st.pageId}" 
                            data-relation-ids="${(st.listeningBookRelationIds || []).join(',')}"
                            onclick="openListeningBookModal(this)">
                            ${st.listeningBookTitle || 'ÍµêÏû¨ ÏóÜÏùå'}
                        </button>
                    </td>
                </tr>`).join('');
        }
        
        // [ÏàòÏ†ï] Ïù¥ Ìï®ÏàòÎèÑ management.html ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï† ÏòàÏ†ï
        function filterStudentRoster(query) {
            const normalizedQuery = query.toLowerCase().trim();
            if (!normalizedQuery) {
                displayStudentRosterData(allRosterData); // Í≤ÄÏÉâÏñ¥ ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ ÌëúÏãú
                return;
            }
            const filteredData = allRosterData.filter(st => 
                st.studentName.toLowerCase().includes(normalizedQuery)
            );
            displayStudentRosterData(filteredData);
        }

        function handleEnterAsTab(event, tableBodyId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const formElements = Array.from(document.querySelectorAll(`#${tableBodyId} input, #${tableBodyId} select`));
                const currentIndex = formElements.indexOf(event.target);
                const nextElement = formElements[currentIndex + 1];
                if (nextElement) { nextElement.focus(); if (nextElement.select) nextElement.select(); } 
                else { event.target.blur(); }
            }
        }

        // --- Helper Functions (Styling & Formatting) ---
        function getReadingResultClass(result) { if (result === 'PASS') return 'result-pass'; if (result === 'FAIL') return 'result-fail'; return 'result-none'; }
        function formatSelectDropdown(pageId, propertyName, currentValue, options, defaultValue = '---') {
            const displayValue = (currentValue && options.includes(currentValue)) ? currentValue : "";
            const statusClass = getSelectStatusClass(propertyName, currentValue);
            const defaultOptionHtml = (defaultValue === '---')
                ? `<option value="" ${displayValue === "" ? 'selected' : ''}>---</option>`
                : `<option value="${defaultValue}" ${displayValue === defaultValue ? 'selected' : ''}>${defaultValue}</option>`;
            return `<select class="homework-dropdown ${statusClass}" data-page-id="${pageId}" data-property-name="${propertyName}" data-property-type="select" onchange="updateField(this)">
                        ${defaultOptionHtml}
                        ${options.map(option => `<option value="${option}" ${option === displayValue ? 'selected' : ''}>${option}</option>`).join('')}
                    </select>`;
        }
        function formatHomeworkDropdown(pageId, propertyName, currentStatus, options = ['ÏàôÏ†ú Ìï®', 'Ïïà Ìï¥Ïò¥', 'ÏàôÏ†ú ÏóÜÏùå']) {
            const defaultStatus = options.includes('ÏßÑÌñâÌïòÏßÄ ÏïäÏùå') ? 'ÏßÑÌñâÌïòÏßÄ ÏïäÏùå' : 'ÏàôÏ†ú ÏóÜÏùå';
            const displayStatus = options.includes(currentStatus) ? currentStatus : defaultStatus;
            const statusClass = getSelectStatusClass(propertyName, displayStatus);
            return `<select class="homework-dropdown ${statusClass}" data-page-id="${pageId}" data-property-name="${propertyName}" data-property-type="status" onchange="updateField(this)">
                        ${options.map(option => `<option value="${option}" ${option === displayStatus ? 'selected' : ''}>${option}</option>`).join('')}
                    </select>`;
        }
        function getSelectStatusClass(propertyName, value) {
            if (['‚≠ï ÏßÄÎÇú Î¨∏Î≤ï ÏàôÏ†ú Í≤ÄÏÇ¨', '1Ô∏è‚É£ Ïñ¥Ìúò ÌÅ¥Ïπ¥ ÏïîÍ∏∞ ÏàôÏ†ú', '2Ô∏è‚É£ ÎèÖÌï¥ Îã®Ïñ¥ ÌÅ¥Ïπ¥ ÏàôÏ†ú', '4Ô∏è‚É£ Summary ÏàôÏ†ú', '5Ô∏è‚É£ Îß§Ïùº ÎèÖÌï¥ ÏàôÏ†ú', '6Ô∏è‚É£ ÏòÅÏñ¥ÏùºÍ∏∞ or Í∞úÏù∏ ÎèÖÌï¥ÏÑú'].includes(propertyName)) {
                if (value === 'ÏàôÏ†ú Ìï®') return 'status-complete'; if (value === 'Ïïà Ìï¥Ïò¥') return 'status-incomplete'; return 'status-none';
            }
            if (propertyName === 'üìñ ÏòÅÏñ¥ÎèÖÏÑú') { if (value === 'ÏôÑÎ£åÌï®') return 'status-reading-complete'; if (value === 'Î™ªÌï®') return 'status-reading-incomplete'; }
            if (propertyName === 'Ïñ¥ÌúòÌïôÏäµ') { if (value === 'ÏôÑÎ£åÌï®' || value === 'ÏôÑÎ£å') return 'status-vocab-complete'; if (value === 'Î™ªÌï®') return 'status-vocab-incomplete'; if (value === 'SKIP') return 'status-vocab-skip'; }
            if (propertyName === 'Writing') { if (value === 'Î∂ÅÎ¶¨Ìè¨Ìä∏') return 'status-writing-bookreport'; if (value === '3 SENTENCE') return 'status-writing-3sentence'; if (value === 'SKIP') return 'status-writing-skip'; }
            if (propertyName === 'ÎèÖÌï¥ ÌïòÎ∏åÎ£®ÌÉÄ') { if (value === 'ÏôÑÎ£åÌï®') return 'status-complete'; if (value === 'Î™ªÌïòÍ≥†Í∞ê') return 'status-incomplete'; }
            if (propertyName === 'ÏòÅÏñ¥ ÎçîÎπô ÌïôÏäµ ÏôÑÎ£å' || propertyName === 'ÎçîÎπô ÏõåÌÅ¨Î∂Å ÏôÑÎ£å') { if (value === 'ÏôÑÎ£å') return 'status-listening-complete'; if (value === 'ÎØ∏ÏôÑÎ£å') return 'status-listening-incomplete'; return 'status-listening-none'; }
            return 'status-default';
        }
        function rateClass(r){ if(r>=90)return'rate-excellent'; if(r>=70)return'rate-good'; return'rate-poor'; }
        function getScoreStyle(score) { let color = '#ef4444'; if (score >= 80) color = '#10b981'; else if (score >= 60) color = '#f59e0b'; else if (score >= 40) color = '#facc15'; return `style="--score-color: ${color}; --score-value: ${score}%"`; }
        function formatScoreCircle(score) { if (score === null || isNaN(score) || score === 0) return '<span class="score-none">-</span>'; const style = getScoreStyle(score); return `<div class="score-circle" ${style}><span class="score-text">${Math.round(score)}%</span></div>`; }
        async function refreshStudentRate(buttonElement, pageId) {
             if (!pageId) { showToast('ÌéòÏù¥ÏßÄ IDÍ∞Ä ÏóÜÏñ¥ ÏÉàÎ°úÍ≥†Ïπ®Ìï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error'); return; }
             buttonElement.classList.add('loading'); buttonElement.disabled = true;
             try {
                const response = await fetch(`${API_BASE_URL}/api/student-homework/${pageId}`, { headers: { 'Authorization': 'Bearer ' + authToken } });
                if (!response.ok) { throw new Error('Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®'); } const result = await response.json();
                if (result.success) {
                    const row = buttonElement.closest('tr');
                    if (row) { const rateSpan = row.querySelector('.completion-rate'); if (rateSpan) { rateSpan.textContent = `${result.completionRate || 0}%`; rateSpan.className = `completion-rate ${rateClass(result.completionRate)}`; showToast(`${result.studentName} ÌïôÏÉù Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å`, 'success'); } }
                } else { throw new Error(result.message || 'Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®'); }
             } catch (error) { console.error('Í∞úÎ≥Ñ ÌïôÏÉù ÏÉàÎ°úÍ≥†Ïπ® Ïò§Î•ò:', error); showToast(`ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®: ${error.message}`, 'error'); }
             finally { buttonElement.classList.remove('loading'); buttonElement.disabled = false; }
        }
        function updateStats(data){
            const container = document.getElementById('statsContainer_hw'); if (!container) return;
            if(!data || !data.length){ container.innerHTML = `<div class="stat-card"><div class="stat-value">0</div><div class="stat-label">Ï¥ù ÌïôÏÉù Ïàò</div></div><div class="stat-card"><div class="stat-value">0%</div><div class="stat-label">ÌèâÍ∑† ÏàòÌñâÏú®</div></div><div class="stat-card"><div class="stat-value">0</div><div class="stat-label">Ïö∞Ïàò ÌïôÏÉù</div></div>`; return; }
            const periodSelect = document.getElementById('periodFilter_hw'); const isTodayFilter = periodSelect ? periodSelect.value === 'today' : true;
            const today = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            let statsData = data; let labelSuffix = "";
            if (isTodayFilter) { statsData = data.filter(item => item.date === today); labelSuffix = " (Ïò§Îäò)"; } 
            else { const specificDate = document.getElementById('specificDate_hw')?.value; if (specificDate) { statsData = data.filter(item => item.date === specificDate); labelSuffix = ` (${specificDate})`; } else { statsData = data.filter(item => item.date === today); labelSuffix = " (Ïò§Îäò)"; } }
            const uniqueStudents = new Set(statsData.map(item => item.studentName)); const totalStudents = uniqueStudents.size;
            const avg = statsData.length > 0 ? Math.round(statsData.reduce((s,x)=>s+(x.completionRate||0),0)/statsData.length) : 0;
            const excellentStudents = new Set(statsData.filter(x => (x.completionRate || 0) === 100).map(item => item.studentName)).size;
            container.innerHTML=`<div class="stat-card"><div class="stat-value">${totalStudents}</div><div class="stat-label">Ï¥ù ÌïôÏÉù Ïàò${labelSuffix}</div></div><div class="stat-card"><div class="stat-value">${avg}%</div><div class="stat-label">ÌèâÍ∑† ÏàòÌñâÏú®${labelSuffix}</div></div><div class="stat-card"><div class="stat-value">${excellentStudents}</div><div class="stat-label">Ïö∞Ïàò ÌïôÏÉù (100%)${labelSuffix}</div></div>`;
        }
        function updateTeacherFilterOptions(teachers){
            const selectors = document.querySelectorAll('#teacherFilter_hw, #teacherFilter_test, #teacherFilter_reading, #teacherFilter_listening, #teacherFilter_comments');
            selectors.forEach(sel => {
                 if (!sel) return;
                 while(sel.children.length > 1) sel.removeChild(sel.lastChild);
                 teachers.forEach(t=>{ const o = document.createElement('option'); o.value=t.name; o.textContent=t.name; sel.appendChild(o.cloneNode(true)); });
                 if (currentUserRole !== 'manager') {
                    sel.querySelector('option[value=""]').style.display = 'none';
                    if (!teachers.find(t => t.name === currentUserName)) { const o = document.createElement('option'); o.value=currentUserName; o.textContent=currentUserName; sel.appendChild(o); }
                    sel.value = currentUserName; sel.disabled = true;
                 } else { sel.querySelector('option[value=""]').style.display = 'block'; sel.disabled = false; }
            });
        }
        function updateComment(buttonElement, pageId) {
            const row = buttonElement.closest('tr'); const textarea = row.querySelector('.comment-textarea');
            const newValue = textarea.value; const originalValue = textarea.defaultValue;
            submitUpdate(pageId, '‚ù§ Today\'s Notice!', newValue, 'rich_text', textarea, originalValue, false);
        }
        async function updateField(element) {
            const pageId = element.getAttribute('data-page-id'); const propertyName = element.getAttribute('data-property-name'); const propertyType = element.getAttribute('data-property-type');
            let newValue = element.value; let originalValue;
            if (element.tagName.toUpperCase() === 'INPUT') {
                originalValue = element.defaultValue;
                if (propertyType === 'number') { newValue = (newValue === '') ? null : Number(newValue); if (newValue !== null && isNaN(newValue)) { showToast('Ïú†Ìö®Ìïú Ïà´ÏûêÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error'); element.value = originalValue || ''; return; } }
            } else { originalValue = Array.from(element.options).find(opt => opt.defaultSelected)?.value || element.options[0].value; }
            if (!pageId || !propertyName) { showToast('ÏóÖÎç∞Ïù¥Ìä∏ Ï†ïÎ≥¥ Î∂ÄÏ°±', 'error'); return; }
            await submitUpdate(pageId, propertyName, newValue, propertyType, element, originalValue, false);
        }
        async function submitUpdate(pageId, propertyName, newValue, propertyType, element = null, originalValue = null, isBatch = false) {
            console.log('ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏ ÏöîÏ≤≠:', { pageId, propertyName, newValue, propertyType, isBatch });
            let targetElement = (element && element.tagName.toUpperCase() === 'TEXTAREA') ? element.closest('tr').querySelector('.comment-save-btn') : element;
            if (targetElement && !isBatch) { targetElement.disabled = true; targetElement.style.opacity = '0.6'; }

            try {
                // [ÏàòÏ†ï] ÌïôÏÉù Î™ÖÎ∂Ä(management) ÌÉ≠ÏùÄ Îã§Î•∏ API ÏóîÎìúÌè¨Ïù∏Ìä∏ ÏÇ¨Ïö©
                // [ÏàòÏ†ï] currentActiveTabÏùÄ 'management'Í∞Ä ÏïÑÎãå, elementÏùò ÏÜåÏÜçÏùÑ Í∏∞Ï§ÄÏúºÎ°ú Ìï¥Ïïº Ìï®.
                // ÌïòÏßÄÎßå Ïù¥ ÌéòÏù¥ÏßÄ(teacher.html)ÏóêÎäî ÌïôÏÉù Î™ÖÎ∂Ä ÌÖåÏù¥Î∏îÏù¥ ÏóÜÏúºÎØÄÎ°ú
                // /api/update-homeworkÎ•º Ìò∏Ï∂úÌïòÎäî Í≤ÉÏù¥ ÎßûÏäµÎãàÎã§.
                // (management-view ÎÇ¥Î∂ÄÏùò Î°úÏßÅÏùÄ management.htmlÎ°ú Ïù¥Îèô/Î∂ÑÎ¶¨ÎêòÏñ¥Ïïº Ìï®)
                // ÌòÑÏû¨ Î°úÏßÅ(management-viewÍ∞Ä teacher.htmlÏóê ÏûàÏùå) Í∏∞Ï§ÄÏúºÎ°úÎäî
                // currentActiveTabÏùÑ ÌôïÏù∏ÌïòÎäî Í≤ÉÏù¥ ÎßûÏäµÎãàÎã§.
                const isRosterUpdate = (currentActiveTab === 'management');
                const updateUrl = isRosterUpdate ? `${API_BASE_URL}/api/update-student-roster` : `${API_BASE_URL}/api/update-homework`;
                
                const response = await fetch(updateUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify({ pageId, propertyName, newValue, propertyType }) });
                if (!response.ok) { if (response.status === 401) { alert('Î°úÍ∑∏Ïù∏Ïù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.'); logout(); return; } const errorData = await response.json(); throw new Error(errorData.message || 'ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®'); }
                
                const result = await response.json(); 
                if (!isBatch) { showToast('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success'); }
                console.log('ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ:', result);
                
                if (element) {
                    const tagName = element.tagName.toUpperCase();
                    if (tagName === 'INPUT' || tagName === 'TEXTAREA') {
                        element.defaultValue = element.value; 
                        if (tagName === 'TEXTAREA') { 
                            element.classList.remove('changed'); 
                            const saveButton = element.closest('tr').querySelector('.comment-save-btn');
                            if(saveButton) saveButton.style.background = '#10b981';
                        }
                    }
                    if (tagName === 'SELECT') { Array.from(element.options).forEach(opt => opt.defaultSelected = false); const newSelectedOption = Array.from(element.options).find(opt => opt.value == newValue); if(newSelectedOption) { newSelectedOption.defaultSelected = true; } else { element.options[0].defaultSelected = true; } element.className = `homework-dropdown ${getSelectStatusClass(propertyName, newValue)}`; }
                }
                
                const row = element?.closest('tr');
                if (row) { row.classList.remove('needs-save'); } 
                
                if (row && (propertyName === 'Îã®Ïñ¥ (ÎßûÏùÄ Í∞úÏàò)' || propertyName === 'Îã®Ïñ¥ (Ï†ÑÏ≤¥ Í∞úÏàò)')) { const correct = Number(row.querySelector('[data-property-name="Îã®Ïñ¥ (ÎßûÏùÄ Í∞úÏàò)"]').value); const total = Number(row.querySelector('[data-property-name="Îã®Ïñ¥ (Ï†ÑÏ≤¥ Í∞úÏàò)"]').value); const newScore = (total > 0) ? Math.round((correct / total) * 100) : 0; row.querySelector('.vocab-score').innerHTML = formatScoreCircle(newScore); }
                if (row && (propertyName === 'Î¨∏Î≤ï (Ï†ÑÏ≤¥ Í∞úÏàò)' || propertyName === 'Î¨∏Î≤ï (ÌãÄÎ¶∞ Í∞úÏàò)')) { const total = Number(row.querySelector('[data-property-name="Î¨∏Î≤ï (Ï†ÑÏ≤¥ Í∞úÏàò)"]').value); const wrong = Number(row.querySelector('[data-property-name="Î¨∏Î≤ï (ÌãÄÎ¶∞ Í∞úÏàò)"]').value); const newScore = (total > 0) ? Math.round(((total - wrong) / total) * 100) : 0; row.querySelector('.grammar-score').innerHTML = formatScoreCircle(newScore); }
                
                if (propertyType === 'relation' && currentActiveTab === 'reading') { showToast('Ï±Ö Ï†ïÎ≥¥Î•º ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§...', 'success'); refreshReadingRow(pageId); }
                // [ÏàòÏ†ï] ÌïôÏÉù Î™ÖÎ∂Ä Ìñâ ÏÉàÎ°úÍ≥†Ïπ® (Ïù¥ Î°úÏßÅÎèÑ management.htmlÎ°ú Ïù¥ÎèôÌï¥Ïïº Ìï®)
                else if (propertyType === 'relation' && currentActiveTab === 'management') { showToast('ÍµêÏû¨ Ï†ïÎ≥¥Î•º ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§...', 'success'); refreshStudentRosterRow(pageId); } 
                else if (propertyType === 'status' && currentActiveTab === 'homework') { const refreshButton = element?.closest('tr')?.querySelector('.refresh-rate-btn'); if (refreshButton) { refreshStudentRate(refreshButton, pageId); } }
                else if (propertyType === 'status' && currentActiveTab === 'listening') { refreshListeningRow(pageId); }
                else if (propertyType === 'rich_text' && currentActiveTab === 'comments' && !isBatch) { refreshCommentRow(pageId); }

            } catch (error) { 
                console.error('ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error); 
                if (element) { 
                    if (element.tagName.toUpperCase() !== 'BUTTON') { element.value = originalValue || ''; }
                    if (element.tagName.toUpperCase() === 'SELECT') { element.className = `homework-dropdown ${getSelectStatusClass(propertyName, originalValue)}`; } 
                } 
                if (!isBatch) { showToast(`ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${error.message}`, 'error'); } 
                else { throw error; }
            }
            finally { 
                if (targetElement && !isBatch) { targetElement.disabled = false; targetElement.style.opacity = '1'; }
            }
        }
        async function refreshReadingRow(pageId) {
             if (!pageId) return; const row = document.getElementById(`row-reading-${pageId}`); if (!row) return; row.style.opacity = '0.5';
             try {
                 await new Promise(resolve => setTimeout(resolve, 1000));
                 const response = await fetch(`${API_BASE_URL}/api/reading-status/${pageId}`, { headers: { 'Authorization': 'Bearer ' + authToken } }); if (!response.ok) { throw new Error('ÌïôÏÉù Ï†ïÎ≥¥Î•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.'); } const st = await response.json();
                 const newRowContent = `
                     <td class="student-name">${st.studentName}</td> <td>${(st.teachers || []).join(', ')}</td> <td>${formatSelectDropdown(st.pageId, 'üìñ ÏòÅÏñ¥ÎèÖÏÑú', st.readingStatus, ['ÏôÑÎ£åÌï®', 'Î™ªÌï®'], '---')}</td> <td>${formatSelectDropdown(st.pageId, 'Ïñ¥ÌúòÌïôÏäµ', st.vocabStatus, ['ÏôÑÎ£åÌï®', 'Î™ªÌï®', 'SKIP', 'ÏôÑÎ£å'], '---')}</td> <td class="book-title-cell"><button class="book-title-button ${st.bookTitle ? '' : 'empty'}" data-page-id="${st.pageId}" data-relation-id="${st.bookRelationId || ''}" onclick="openEngBookModal(this)">${st.bookTitle || 'Ï±Ö Í≤ÄÏÉâ...'}</button></td> <td>${st.bookSeries || '-'}</td> <td>${st.bookAR ?? '-'}</td> <td>${st.bookLexile ?? '-'}</td> <td>${formatSelectDropdown(st.pageId, 'Writing', st.writingStatus, ['SKIP', 'Î∂ÅÎ¶¨Ìè¨Ìä∏', '3 SENTENCE'], '---')}</td>`;
                 row.innerHTML = newRowContent; row.style.opacity = '1'; showToast(`${st.studentName} ÌïôÏÉù Î°§ÏóÖ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å!`, 'success');
             } catch (error) { console.error('Í∞úÎ≥Ñ Ìñâ ÏÉàÎ°úÍ≥†Ïπ® Ïò§Î•ò:', error); showToast(error.message, 'error'); if (row) row.style.opacity = '1'; }
        }
        async function refreshListeningRow(pageId) {
            if (!pageId) return; const row = document.getElementById(`row-listening-${pageId}`); if (!row) return; row.style.opacity = '0.5';
            try {
                const response = await fetch(`${API_BASE_URL}/api/listening-status/${pageId}`, { headers: { 'Authorization': 'Bearer ' + authToken } }); if (!response.ok) { throw new Error('ÌïôÏÉù Ï†ïÎ≥¥Î•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.'); } const st = await response.json();
                const listeningOptions = ['ÏôÑÎ£å', 'ÎØ∏ÏôÑÎ£å', 'ÏßÑÌñâÌïòÏßÄ ÏïäÏùå'];
                const newRowContent = `
                    <td class="student-name">${st.studentName}</td> <td>${(st.teachers || []).join(', ')}</td> 
                    <td>${formatHomeworkDropdown(st.pageId, 'ÏòÅÏñ¥ ÎçîÎπô ÌïôÏäµ ÏôÑÎ£å', st.listeningStudy, listeningOptions)}</td> 
                    <td>${formatHomeworkDropdown(st.pageId, 'ÎçîÎπô ÏõåÌÅ¨Î∂Å ÏôÑÎ£å', st.listeningWorkbook, listeningOptions)}</td>`;
                row.innerHTML = newRowContent; row.style.opacity = '1'; showToast(`${st.studentName} ÌïôÏÉù Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å!`, 'success');
            } catch (error) { console.error('Í∞úÎ≥Ñ Ìñâ ÏÉàÎ°úÍ≥†Ïπ® Ïò§Î•ò:', error); showToast(error.message, 'error'); if (row) row.style.opacity = '1'; }
        }
        async function refreshCommentRow(pageId) {
            if (!pageId) return; const row = document.getElementById(`row-comment-${pageId}`); if (!row) return; row.style.opacity = '0.5';
            try {
                const response = await fetch(`${API_BASE_URL}/api/comment-status/${pageId}`, { headers: { 'Authorization': 'Bearer ' + authToken } }); if (!response.ok) { throw new Error('ÌïôÏÉù Ï†ïÎ≥¥Î•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.'); } const st = await response.json();
                const newRowContent = `
                    <td class="student-name">${st.studentName}</td>
                    <td>${(st.teachers || []).join(', ')}</td>
                    <td>${st.grammarClass || '-'}</td>
                    <td style="padding: 5px;">
                        <textarea class="comment-textarea" rows="2" data-page-id="${st.pageId}" defaultValue="${st.comment || ''}" oninput="markCommentAsChanged(this)">${st.comment || ''}</textarea>
                    </td>
                    <td style="vertical-align: middle;">
                        <button class="comment-save-btn" onclick="updateComment(this, '${st.pageId}')">Ï†ÄÏû•</button>
                    </td>
                `;
                row.innerHTML = newRowContent; row.style.opacity = '1'; 
            } catch (error) { console.error('Í∞úÎ≥Ñ Ìñâ ÏÉàÎ°úÍ≥†Ïπ® Ïò§Î•ò:', error); showToast(error.message, 'error'); if (row) row.style.opacity = '1'; }
        }
        // [ÏàòÏ†ï] Ïù¥ Ìï®ÏàòÎèÑ management.html ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï† ÏòàÏ†ï
        async function refreshStudentRosterRow(pageId) {
            if (!pageId) return; const row = document.getElementById(`row-management-${pageId}`); if (!row) return; row.style.opacity = '0.5';
            try {
                // (ÌïôÏÉù Î™ÖÎ∂Ä DBÎäî Î≥ÑÎèÑÏùò Í∞úÎ≥Ñ Ï°∞Ìöå APIÍ∞Ä ÏóÜÏúºÎØÄÎ°ú, Ï†ÑÏ≤¥ Î™©Î°ùÏùÑ Îã§Ïãú Î∂àÎü¨ÏôÄÏÑú Ìï¥Îãπ ÌïôÏÉù Îç∞Ïù¥ÌÑ∞Î°ú ÍµêÏ≤¥)
                // (Îçî ÎÇòÏùÄ Î∞©Î≤ï: /api/student-roster/:pageId APIÎ•º index.jsÏóê Ï∂îÍ∞Ä)
                // (ÏùºÎã®ÏùÄ, Í∞ÑÎã®ÌïòÍ≤å Ï†ÑÏ≤¥ Îã§Ïãú Î°úÎìú)
                await loadStudentRosterData();
                showToast(`ÌïôÏÉù Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å!`, 'success');
            } catch (error) { console.error('ÌïôÏÉù Î™ÖÎ∂Ä Ìñâ ÏÉàÎ°úÍ≥†Ïπ® Ïò§Î•ò:', error); showToast(error.message, 'error'); if (row) row.style.opacity = '1'; }
        }

        function showToast(message, type = 'success') {
             const existingToast = document.querySelector('.toast-message'); if (existingToast) existingToast.remove(); const toast = document.createElement('div'); toast.className = `toast-message toast-${type}`; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => { toast.classList.add('show'); }, 100); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300); }, 3000);
        }
        function logout(){ localStorage.removeItem('teacher_auth_token'); alert("Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§."); window.location.href='/teacher-login'; }
        function checkTokenExpiry() {
             const token = localStorage.getItem('teacher_auth_token'); if (!token) { window.location.href = '/teacher-login'; return; } try { const payload = JSON.parse(atob(token.split('.')[1])); const now = Date.now() / 1000; if (payload.exp < now) { alert('Î°úÍ∑∏Ïù∏Ïù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.'); logout(); } } catch (error) { console.error('ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù Ïò§Î•ò:', error); logout(); }
        }
        setInterval(checkTokenExpiry, 5 * 60 * 1000);

        // --- ÌÉ≠ Ï†ÑÌôò Ìï®Ïàò ---
        function showTab(tabName) {
            currentActiveTab = tabName;
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            const selectedContent = document.getElementById(tabName + '-view');
            if (selectedContent) selectedContent.classList.add('active');
            const selectedButton = document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`);
            if (selectedButton) selectedButton.classList.add('active');
            syncFilters(tabName);
            
            // [ÏàòÏ†ï] management ÌÉ≠ÏùÄ <a> ÌÉúÍ∑∏Î°ú Ïô∏Î∂Ä ÎßÅÌÅ¨Ïù¥ÎØÄÎ°ú, 
            // Ïù¥ Ìï®ÏàòÏóêÏÑú loadDataForCurrentTab()ÏùÑ Ìò∏Ï∂úÌïòÏßÄ ÏïäÏïÑÏïº Ìï©ÎãàÎã§.
            if (tabName !== 'management') {
                loadDataForCurrentTab();
            }
        }

        function syncFilters(targetTabName) {
            const sourceTabName = 'homework';
            if (targetTabName === sourceTabName) { toggleSpecificDateInput('_hw'); return; }
            function getSuffixForTab(tabName) {
                if (tabName === 'homework') return '_hw';
                if (tabName === 'tests') return '_test';
                if (tabName === 'reading') return '_reading';
                if (tabName === 'listening') return '_listening';
                if (tabName === 'comments') return '_comments';
                if (tabName === 'management') return '_management';
                return '';
            }
            const sourceSuffix = getSuffixForTab(sourceTabName);
            const targetSuffix = getSuffixForTab(targetTabName); 
            if (!sourceSuffix || !targetSuffix) return;
            // [ÏàòÏ†ï] management ÌÉ≠ÏùÄ ÌïÑÌÑ∞Î•º ÎèôÍ∏∞ÌôîÌï† ÌïÑÏöî ÏóÜÏùå
            if (targetTabName === 'management') return; 

            const periodSourceEl = document.getElementById(`periodFilter${sourceSuffix}`);
            const periodTargetEl = document.getElementById(`periodFilter${targetSuffix}`);
            const dateSourceEl = document.getElementById(`specificDate${sourceSuffix}`); 
            const dateTargetEl = document.getElementById(`specificDate${targetSuffix}`); 
            const teacherSourceEl = document.getElementById(`teacherFilter${sourceSuffix}`);
            const teacherTargetEl = document.getElementById(`teacherFilter${targetSuffix}`);

            if(periodSourceEl && periodTargetEl) periodTargetEl.value = periodSourceEl.value;
            if(dateSourceEl && dateTargetEl) dateTargetEl.value = dateSourceEl.value;
            if(teacherSourceEl && teacherTargetEl) teacherTargetEl.value = teacherSourceEl.value;
            toggleSpecificDateInput(targetSuffix);
        }

        // --- Ï±Ö Í≤ÄÏÉâ Î™®Îã¨ Í¥ÄÎ†® Ìï®Ïàò ---
        // [ÏàòÏ†ï] Î™®Îã¨ Ïó¨Îäî Ìï®Ïàò Î∂ÑÎ¶¨
        function openEngBookModal(buttonElement) {
            const pageId = buttonElement.getAttribute('data-page-id');
            const currentTitle = buttonElement.textContent.trim();
            currentModalContext = {
                pageId: pageId,
                propertyName: 'Ïò§Îäò ÏùΩÏùÄ ÏòÅÏñ¥ Ï±Ö',
                type: 'engBook',
                updateUrl: `${API_BASE_URL}/api/update-homework` // ÏßÑÎèÑ DB ÏóÖÎç∞Ïù¥Ìä∏
            };
            
            document.getElementById('modalTitle').textContent = 'üìö ÏòÅÏñ¥ ÏõêÏÑú Í≤ÄÏÉâ';
            const input = document.getElementById('modalSearchInput');
            if (currentTitle !== 'Ï±Ö Í≤ÄÏÉâ...') { input.value = currentTitle; } else { input.value = ''; }
            document.getElementById('bookSearchModal').classList.add('show');
            input.focus();
            searchEngBooks(input.value); // ÏòÅÏñ¥ ÏõêÏÑú Í≤ÄÏÉâ
        }
        
        // [Ïã†Í∑ú] Î¶¨Ïä§Îãù ÍµêÏû¨ Î™®Îã¨ Ïó¨Îäî Ìï®Ïàò
        function openListeningBookModal(buttonElement) {
            const pageId = buttonElement.getAttribute('data-page-id');
            const currentTitle = buttonElement.textContent.trim();
            currentModalContext = {
                pageId: pageId, // ÌïôÏÉù Î™ÖÎ∂Ä DBÏùò pageId
                propertyName: 'ÏòÅÏñ¥ ÎçîÎπô OR Îì£Í∏∞ ÍµêÏû¨',
                type: 'listeningBook',
                // [ÏàòÏ†ï] Ïù¥ ÌéòÏù¥ÏßÄ(teacher.html)ÏóêÏÑú management ÌÉ≠Ïùò ÎÇ¥Ïö©ÏùÑ 
                // ÏàòÏ†ïÌïòÎäî Í≤ΩÏö∞, Ïò¨Î∞îÎ•∏ API ÏóîÎìúÌè¨Ïù∏Ìä∏Î•º ÏÇ¨Ïö©Ìï¥Ïïº Ìï©ÎãàÎã§.
                updateUrl: `${API_BASE_URL}/api/update-student-roster` // ÌïôÏÉù Î™ÖÎ∂Ä DB ÏóÖÎç∞Ïù¥Ìä∏
            };
            
            document.getElementById('modalTitle').textContent = 'üéß Î¶¨Ïä§Îãù ÍµêÏû¨ Í≤ÄÏÉâ';
            const input = document.getElementById('modalSearchInput');
            if (currentTitle !== 'ÍµêÏû¨ ÏóÜÏùå') { input.value = currentTitle; } else { input.value = ''; }
            document.getElementById('bookSearchModal').classList.add('show');
            input.focus();
            searchListeningBooks(input.value); // Î¶¨Ïä§Îãù ÍµêÏû¨ Í≤ÄÏÉâ (ÏûÑÏãúÎ°ú ÏòÅÏñ¥ ÏõêÏÑú DB ÏÇ¨Ïö©)
        }

        function closeBookSearchModal() { document.getElementById('bookSearchModal').classList.remove('show'); currentModalContext = {}; }

        // [ÏàòÏ†ï] ÏòÅÏñ¥ ÏõêÏÑú Í≤ÄÏÉâ
        async function searchEngBooks(query) {
            const resultsList = document.getElementById('modalSearchResults');
            if (!query || query.trim().length < 2) { resultsList.innerHTML = '<div class="no-data" style="padding: 30px;">Í≤ÄÏÉâÏñ¥Î•º 2Ïûê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</div>'; return; }
            resultsList.innerHTML = '<div class="loading" style="padding: 30px;">Í≤ÄÏÉâ Ï§ë...</div>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/search-books?query=${encodeURIComponent(query)}`, { headers: { 'Authorization': 'Bearer ' + authToken } });
                if (!response.ok) throw new Error('Í≤ÄÏÉâ API Ïò§Î•ò'); const books = await response.json();
                if (books.length === 0) { resultsList.innerHTML = '<div class="no-data" style="padding: 30px;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>'; return; }
                resultsList.innerHTML = books.map(book => `
                    <div class="result-item" onclick="selectBook('${book.id}', '${book.title.replace(/'/g, "\\'")}')">
                        <div class="result-title">${book.title}</div>
                        <div class="result-meta">Ï†ÄÏûê: ${book.author || 'N/A'} | Î†àÎ≤®: ${book.level || 'N/A'}</div>
                    </div>`).join('');
            } catch (error) { console.error("ÏòÅÏñ¥ ÏõêÏÑú Í≤ÄÏÉâ Ïò§Î•ò:", error); resultsList.innerHTML = '<div class="no-data" style="color: red; padding: 30px;">Í≤ÄÏÉâ Ï§ë Ïò§Î•ò Î∞úÏÉù</div>'; }
        }
        
        // [Ïã†Í∑ú] Î¶¨Ïä§Îãù ÍµêÏû¨ Í≤ÄÏÉâ (ÏùºÎã® ÏòÅÏñ¥ ÏõêÏÑú DB ÏÇ¨Ïö©, Ï∂îÌõÑ ÍµêÏû¨ DB ID ÌôòÍ≤Ω Î≥ÄÏàò Ï∂îÍ∞Ä Ïãú Î≥ÄÍ≤Ω)
        async function searchListeningBooks(query) {
             const resultsList = document.getElementById('modalSearchResults');
            if (!query || query.trim().length < 2) { resultsList.innerHTML = '<div class="no-data" style="padding: 30px;">Í≤ÄÏÉâÏñ¥Î•º 2Ïûê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</div>'; return; }
            resultsList.innerHTML = '<div class="loading" style="padding: 30px;">Í≤ÄÏÉâ Ï§ë...</div>';
            try {
                // [ÏûÑÏãú] ENG_BOOKS_IDÎ•º Î¶¨Ïä§Îãù ÍµêÏû¨ DBÎ°ú Í∞ÄÏ†ïÌïòÍ≥† search-books API ÏÇ¨Ïö©
                // Ï∂îÌõÑ Î¶¨Ïä§Îãù ÍµêÏû¨ DB IDÎ•º .envÏóê Ï∂îÍ∞ÄÌïòÍ≥† Î≥ÑÎèÑ API(/api/search-listening-books)Î•º ÎßåÎìúÎäî Í≤ÉÏù¥ Ï¢ãÏùå
                const response = await fetch(`${API_BASE_URL}/api/search-books?query=${encodeURIComponent(query)}`, { headers: { 'Authorization': 'Bearer ' + authToken } });
                if (!response.ok) throw new Error('Í≤ÄÏÉâ API Ïò§Î•ò'); const books = await response.json();
                if (books.length === 0) { resultsList.innerHTML = '<div class="no-data" style="padding: 30px;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>'; return; }
                resultsList.innerHTML = books.map(book => `
                    <div class="result-item" onclick="selectBook('${book.id}', '${book.title.replace(/'/g, "\\'")}')">
                        <div class="result-title">${book.title}</div>
                        <div class="result-meta">Ï†ÄÏûê: ${book.author || 'N/A'} | Î†àÎ≤®: ${book.level || 'N/A'}</div>
                    </div>`).join('');
            } catch (error) { console.error("Î¶¨Ïä§Îãù ÍµêÏû¨ Í≤ÄÏÉâ Ïò§Î•ò:", error); resultsList.innerHTML = '<div class="no-data" style="color: red; padding: 30px;">Í≤ÄÏÉâ Ï§ë Ïò§Î•ò Î∞úÏÉù</div>'; }
        }

        // [ÏàòÏ†ï] ÏÑ†ÌÉùÌïú Ï±Ö/ÍµêÏû¨Î•º ÏïåÎßûÏùÄ APIÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
        async function selectBook(bookPageId, bookTitle) {
            if (!currentModalContext.pageId) return;
            
            const { pageId, propertyName, type, updateUrl } = currentModalContext;
            const emptyTitle = (type === 'listeningBook') ? 'ÍµêÏû¨ ÏóÜÏùå' : 'Ï±Ö Í≤ÄÏÉâ...';
            
            closeBookSearchModal();
            
            // 1. UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
            // [ÏàòÏ†ï] Ïò¨Î∞îÎ•∏ Î≤ÑÌäºÏùÑ Ï∞æÏïÑÏïº Ìï® (ÎèôÏùºÌïú pageIdÎ°ú Î≤ÑÌäºÏù¥ Ïó¨Îü¨ Í∞ú ÏûàÏùÑ Ïàò ÏûàÏùå)
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠(currentActiveTab) Í∏∞Ï§ÄÏúºÎ°ú Î≤ÑÌäºÏùÑ Ï∞æÏïÑÏïº Ìï®
            let buttonElement;
            if (currentActiveTab === 'reading') {
                buttonElement = document.querySelector(`#readingTableBody button[data-page-id="${pageId}"]`);
            } else if (currentActiveTab === 'management') {
                buttonElement = document.querySelector(`#managementTableBody button[data-page-id="${pageId}"]`);
            }

            if (buttonElement) {
                buttonElement.textContent = bookTitle || emptyTitle;
                if (bookPageId) {
                    buttonElement.classList.remove('empty');
                    buttonElement.setAttribute('data-relation-id', bookPageId);
                } else {
                    buttonElement.classList.add('empty');
                    buttonElement.setAttribute('data-relation-id', '');
                }
            }

            // 2. ÏÑúÎ≤ÑÏóê ÏóÖÎç∞Ïù¥Ìä∏ ÏöîÏ≤≠
            // submitUpdate Ìï®ÏàòÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ïò¨Î∞îÎ•∏ API ÏóîÎìúÌè¨Ïù∏Ìä∏Î°ú ÏöîÏ≤≠
            await submitUpdate(pageId, propertyName, bookPageId, 'relation', null, null, false);
        }
        
        // --- [Ïã†Í∑ú] ÏΩîÎ©òÌä∏ Í¥ÄÎ†® Ìï®Ïàò ---
        function updateComment(buttonElement, pageId) {
            const row = buttonElement.closest('tr');
            const textarea = row.querySelector('.comment-textarea');
            const newValue = textarea.value;
            const originalValue = textarea.defaultValue;
            submitUpdate(pageId, '‚ù§ Today\'s Notice!', newValue, 'rich_text', textarea, originalValue, false);
        }
        function markCommentAsChanged(textarea) {
            const row = textarea.closest('tr');
            const saveButton = row.querySelector('.comment-save-btn');
            if (textarea.value !== textarea.defaultValue) {
                textarea.classList.add('changed');
                saveButton.textContent = 'Ï†ÄÏû•';
                saveButton.style.background = '#3b82f6'; // ÌååÎûÄÏÉâ
                row.classList.add('needs-save');
            } else {
                textarea.classList.remove('changed');
                saveButton.textContent = 'Ï†ÄÏû•';
                saveButton.style.background = '#10b981'; // Ï¥àÎ°ùÏÉâ
                row.classList.remove('needs-save');
            }
        }
        async function saveAllComments(batchButton) {
            const rowsToSave = document.querySelectorAll('#commentsTableBody tr.needs-save');
            if (rowsToSave.length === 0) {
                showToast('Ï†ÄÏû•Ìï† Î≥ÄÍ≤Ω ÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.', 'success');
                return;
            }
            batchButton.disabled = true;
            batchButton.textContent = `Ï†ÄÏû•Ï§ë... (0/${rowsToSave.length})`;
            batchButton.classList.add('loading');
            const textareas = [];
            const saveButtons = [];
            try {
                rowsToSave.forEach(row => {
                    const textarea = row.querySelector('.comment-textarea');
                    const saveButton = row.querySelector('.comment-save-btn');
                    if (textarea) { textarea.disabled = true; textareas.push(textarea); }
                    if (saveButton) { saveButton.disabled = true; saveButtons.push(saveButton); }
                });
                let successCount = 0;
                for (let i = 0; i < textareas.length; i++) {
                    const textarea = textareas[i];
                    const pageId = textarea.getAttribute('data-page-id');
                    const newValue = textarea.value;
                    await submitUpdate(pageId, '‚ù§ Today\'s Notice!', newValue, 'rich_text', textarea, textarea.defaultValue, true);
                    successCount++;
                    batchButton.textContent = `Ï†ÄÏû•Ï§ë... (${successCount}/${rowsToSave.length})`;
                }
                showToast(`Ï¥ù ${successCount}Í∞ú ÏΩîÎ©òÌä∏ ÏùºÍ¥Ñ Ï†ÄÏû• ÏôÑÎ£å!`, 'success');
            } catch (error) {
                console.error('ÏùºÍ¥Ñ Ï†ÄÏû• Ï§ë Ïò§Î•ò:', error);
                showToast(`ÏùºÍ¥Ñ Ï†ÄÏû• Ïã§Ìå®: ${error.message}`, 'error');
            } finally {
                batchButton.disabled = false;
                batchButton.textContent = 'üíæ ÏùºÍ¥Ñ Ï†ÄÏû•';
                batchButton.classList.remove('loading');
                textareas.forEach(el => el.disabled = false);
                saveButtons.forEach(el => el.disabled = false);
            }
        }

    </script>
</body>
</html>