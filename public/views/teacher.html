<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>선생님 대시보드 - 리디튜드</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "NanumSquareRound", sans-serif; }
        body { background: #f8f9fa; color: #2d3748; min-height: 100vh; padding: 0; }
        .container { max-width: 1400px; margin: 0 auto; background: none; box-shadow: none; overflow: visible; padding: 0 20px; }
        .header { background: #ffffff; color: #6b46c1; padding: 20px 30px; text-align: left; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; margin: 0; }
        .user-info { position: static; text-align: right; display: flex; align-items: center; gap: 15px;} /* Flex 추가 */
        .user-name { font-size: 1em; margin-bottom: 0; display: inline-block; font-weight: 600; } /* margin-right 제거 */
        .logout-btn { background: #6b46c1; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s ease; box-shadow: none; }
        .logout-btn:hover { background: #5a3eaa; }

        /* --- 탭 메뉴 스타일 --- */
        .tab-menu { display: flex; background-color: #ffffff; border-bottom: 1px solid #e2e8f0; padding: 0 40px; margin-top: 20px; border-radius: 12px 12px 0 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-button { padding: 15px 25px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: 600; color: #6b7280; position: relative; transition: color 0.3s ease; }
        .tab-button::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: #8b5cf6; transform: scaleX(0); transition: transform 0.3s ease; }
        .tab-button.active { color: #6b46c1; }
        .tab-button.active::after { transform: scaleX(1); }
        /* --- 탭 메뉴 스타일 끝 --- */

        .main-content { padding: 30px 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 0 20px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .stat-value { font-size: 2.0em; font-weight: 700; color: #6b46c1; margin-bottom: 5px; }
        .stat-label { color: #718096; font-size: 14px; }
        .homework-section { background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); border: 1px solid #e9ecef; padding: 30px; margin: 0 20px 30px; }
        .section-title { font-size: 1.6em; font-weight: 700; color: #6b46c1; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: "📋"; font-size: 1.2em; }
        .filters-container { display:flex; gap:15px; margin-bottom:25px; align-items:center; flex-wrap: wrap; }
        .refresh-btn { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .filter-group { display:flex; align-items:center; gap:8px; }
        .filter-label { font-weight:600; color:#6b46c1; }
        .filter-select, .filter-input { padding:8px 12px; border-radius:8px; border:2px solid #e2e8f0; background:white; font-size: 14px; }
        #customDateContainer { display:none; align-items:center; gap:8px; }
        #teacherFilterContainer { display:none; }
        .homework-table-container { overflow-x: auto; border: 1px solid #e9ecef; border-radius: 12px; }
        .homework-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .homework-table th { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; padding: 12px 10px; text-align: center; font-weight: 600; font-size: 13px; border-right: 1px solid rgba(255,255,255,0.2); white-space: nowrap; }
        .homework-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #f1f3f4; border-right: 1px solid #f1f3f4; vertical-align: middle; font-size: 13px; }
        .homework-table tr:hover { background-color: #f8f9ff; }
        .student-name { font-weight: 600; color: #2d3748; font-size: 14px; background: #f9fafc; text-align: left; padding-left: 15px; }

        /* --- 드롭다운 색상 스타일 (복구됨) --- */
        .homework-dropdown { padding: 4px 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 11px; font-weight: 600; text-align: center; min-width: 50px; background: white; cursor: pointer; transition: all 0.2s ease; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%239ca3af'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em 1em; padding-right: 1.8em; }
        .homework-dropdown:hover { border-color: #6b46c1; box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.1); }
        .homework-dropdown:focus { outline: none; border-color: #6b46c1; box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1); }
        .homework-dropdown.status-complete { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .homework-dropdown.status-incomplete { background-color: #fecaca; color: #991b1b; border-color: #fca5a5; }
        .homework-dropdown.status-none { background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db; }
        /* --- 드롭다운 색상 스타일 끝 --- */

        .completion-rate { font-weight: 700; font-size: 14px; }
        .rate-excellent { color: #10b981; } .rate-good { color: #8b5cf6; } .rate-poor { color: #ef4444; }
        .refresh-rate-btn { background: none; border: none; cursor: pointer; font-size: 1.1em; vertical-align: middle; margin-left: 5px; opacity: 0.6; transition: opacity 0.2s ease, transform 0.2s ease; }
        .refresh-rate-btn:hover { opacity: 1; transform: rotate(90deg); }
        .refresh-rate-btn.loading { opacity: 0.5; cursor: default; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading, .no-data { text-align: center; padding: 60px; color: #718096; font-size: 16px; }
        .loading::before { content: "⏳ "; } .no-data::before { content: "📝 "; }
        .toast-message { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; font-weight: 600; z-index: 1000; opacity: 0; transform: translateX(100%); transition: all 0.3s ease; }
        .toast-message.show { opacity: 1; transform: translateX(0); }
        .toast-success { background: #dcfce7; border: 1px solid #bbf7d0; color: #166534; }
        .toast-error { background: #fecaca; border: 1px solid #fca5a5; color: #991b1b; }
    </style>
</head>
<body>
    <div class="header">
        <h1>📚 리디튜드 선생님</h1>
        <div class="user-info">
            <span class="user-name" id="userName">로딩중...</span>
            <button class="logout-btn" onclick="logout()">로그아웃</button>
        </div>
    </div>

    <div class="container">
        <div class="tab-menu">
            <button class="tab-button active" onclick="showTab('homework')">숙제 현황</button>
            <button class="tab-button" onclick="showTab('tests')">테스트 결과</button>
            <button class="tab-button" onclick="showTab('reading')">원서 독서 현황</button>
            <button class="tab-button" onclick="showTab('listening')">리스닝 현황</button>
        </div>

        <div class="main-content">
            <div id="homework-view" class="tab-content active">
                <div class="stats-summary" id="statsContainer"></div>
                <div class="homework-section">
                    <div class="section-title">담당 학생 숙제 현황</div>
                    <div class="filters-container">
                        <button class="refresh-btn" onclick="loadHomeworkStatus()">🔄 새로고침</button>
                        <div class="filter-group">
                            <label for="periodFilter" class="filter-label">기간:</label>
                            <select id="periodFilter" class="filter-select" onchange="toggleCustomDateInputs(); loadHomeworkStatus()">
                                <option value="today">오늘</option>
                                <option value="week">이번 주</option>
                                <option value="month">이번 달</option>
                                <option value="custom">사용자 지정</option>
                            </select>
                        </div>
                        <div id="customDateContainer" style="display:none;" class="filter-group">
                            <input type="date" id="startDate" class="filter-input" onchange="loadHomeworkStatus()">
                            <span>~</span>
                            <input type="date" id="endDate" class="filter-input" onchange="loadHomeworkStatus()">
                        </div>
                        <div id="teacherFilterContainer" style="display:none;" class="filter-group">
                            <label for="teacherFilter" class="filter-label">담당강사:</label>
                            <select id="teacherFilter" class="filter-select" onchange="loadHomeworkStatus()">
                                <option value="">전체 보기</option>
                            </select>
                        </div>
                    </div>
                    <div class="homework-table-container">
                        <table class="homework-table">
                            <thead>
                                <tr>
                                    <th>학생 이름</th>
                                    <th>담당강사</th>
                                    <th>⭕ 문법</th>
                                    <th>1️⃣ 어휘</th>
                                    <th>2️⃣ 독해</th>
                                    <th>4️⃣ Sum</th>
                                    <th>5️⃣ 독해</th>
                                    <th>6️⃣ 일기 등</th>
                                    <th>수행율</th>
                                </tr>
                            </thead>
                            <tbody id="homeworkTableBody">
                                <tr><td colspan="9" class="loading">숙제 현황을 불러오는 중입니다...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tests-view" class="tab-content"><div class="homework-section"><div class="section-title">📝 테스트 결과</div><p class="no-data">구현 예정</p></div></div>
            <div id="reading-view" class="tab-content"><div class="homework-section"><div class="section-title">📚 원서 독서 현황</div><p class="no-data">구현 예정</p></div></div>
            <div id="listening-view" class="tab-content"><div class="homework-section"><div class="section-title">🎧 리스닝 현황</div><p class="no-data">구현 예정</p></div></div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('teacher_auth_token');
        let allHomeworkData = [];
        let currentUserRole = '';
        let currentUserName = '';

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) { alert('로그인이 필요합니다.'); window.location.href='/teacher-login'; return; }
            initializePage();
            showTab('homework'); // 초기 탭 설정
        });

        async function initializePage() {
            try {
                await loadUserInfo();
                await loadHomeworkStatus();
            } catch (e) { console.error("초기화 오류:", e); }
        }

        async function loadUserInfo() {
             try {
                const userInfoResponse = await fetch('/api/teacher/user-info', { headers:{Authorization:'Bearer '+authToken} });
                if (!userInfoResponse.ok) throw new Error('사용자 정보 로드 실패');
                const data = await userInfoResponse.json();
                if (data.userName) {
                    document.getElementById('userName').textContent = data.userName + ' ('+data.userRole+')';
                    currentUserRole = data.userRole;
                    currentUserName = data.userName;
                    if (data.userRole === 'manager') {
                        document.getElementById('teacherFilterContainer').style.display='flex';
                        const teachersResponse = await fetch('/api/teachers', { headers:{Authorization:'Bearer '+authToken} });
                        if (!teachersResponse.ok) throw new Error('강사 목록 로드 실패');
                        const teachers = await teachersResponse.json();
                        updateTeacherFilterFromData(teachers);
                    }
                } else { throw new Error('사용자 정보 형식이 잘못됨'); }
            } catch (error) {
                 console.error("사용자 정보 로드 오류:", error);
                 alert('사용자 정보를 불러오는데 실패했습니다. 다시 로그인해주세요.');
                 logout();
            }
        }

        async function loadHomeworkStatus() {
            const tbody=document.getElementById('homeworkTableBody');
            tbody.innerHTML='<tr><td colspan="9" class="loading">숙제 현황을 불러오는 중입니다...</td></tr>';
            try {
                const period = document.getElementById('periodFilter').value;
                let url = `/api/homework-status?period=${period}`;
                if (period==='custom') {
                    const s=document.getElementById('startDate').value, e=document.getElementById('endDate').value;
                    if (s&&e) url += `&startDate=${s}&endDate=${e}`;
                    else { tbody.innerHTML='<tr><td colspan="9" class="no-data">시작일과 종료일을 입력해주세요.</td></tr>'; return; }
                }
                if (currentUserRole === 'manager') {
                    const selectedTeacher = document.getElementById('teacherFilter').value;
                    if (selectedTeacher && selectedTeacher !== "") { url += `&teacher=${encodeURIComponent(selectedTeacher)}`; }
                }
                const response = await fetch(url, { headers:{Authorization:'Bearer '+authToken} });
                if (!response.ok) throw new Error("네트워크 오류");
                const homeworkData = await response.json();
                allHomeworkData = homeworkData;
                displayHomeworkData(homeworkData);
                updateStats(homeworkData);
            } catch(e) {
                console.error("숙제 로드 오류:", e);
                tbody.innerHTML='<tr><td colspan="9" class="no-data">숙제 현황 로드 실패</td></tr>';
                updateStats([]);
            }
        }

        function toggleCustomDateInputs() {
            document.getElementById('customDateContainer').style.display = (document.getElementById('periodFilter').value==='custom')?'flex':'none';
        }

        function displayHomeworkData(data) {
            const tbody=document.getElementById('homeworkTableBody');
            if(!data||!data.length){ tbody.innerHTML='<tr><td colspan="9" class="no-data">해당 기간의 숙제 데이터가 없습니다.</td></tr>'; updateStats([]); return;}
            tbody.innerHTML=data.map(st=>`
                <tr id="row-${st.pageId || Math.random()}">
                    <td class="student-name">${st.studentName || '이름 없음'}</td>
                    <td>${(st.teachers||[]).join(', ')||'미배정'}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '⭕ 지난 문법 숙제 검사', st.grammarHomework)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '1️⃣ 어휘 클카 암기 숙제', st.vocabCards)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '2️⃣ 독해 단어 클카 숙제', st.readingCards)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '4️⃣ Summary 숙제', st.summary)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '5️⃣ 매일 독해 숙제', st.readingHomework)}</td>
                    <td>${formatHomeworkDropdown(st.pageId, '6️⃣ 영어일기 or 개인 독해서', st.diary)}</td>
                    <td>
                        <span class="completion-rate ${rateClass(st.completionRate)}">${st.completionRate||0}%</span>
                        <button class="refresh-rate-btn" onclick="refreshStudentRate(this, '${st.pageId}')" title="이 학생 수행율 새로고침">🔄</button>
                    </td>
                </tr>`).join('');
        }

        function formatHomeworkDropdown(pageId, propertyName, currentStatus) {
            const options = ['숙제 함', '안 해옴', '숙제 없음'];
            const statusClass = getHomeworkStatusClass(currentStatus);
            const displayStatus = options.includes(currentStatus) ? currentStatus : '숙제 없음';
            return `
                <select class="homework-dropdown ${statusClass}"
                        data-page-id="${pageId || ''}"
                        data-property-name="${propertyName}"
                        onchange="updateHomework(this)">
                    ${options.map(option => `<option value="${option}" ${option === displayStatus ? 'selected' : ''}>${option}</option>`).join('')}
                </select>
            `;
        }
        function getHomeworkStatusClass(status) {
            if (status === '숙제 함') return 'status-complete';
            if (status === '안 해옴') return 'status-incomplete';
            return 'status-none';
        }

        async function refreshStudentRate(buttonElement, pageId) {
             if (!pageId) { showToast('페이지 ID가 없어 새로고침할 수 없습니다.', 'error'); return; }
             console.log(`개별 새로고침 요청: ${pageId}`);
             buttonElement.classList.add('loading');
             buttonElement.disabled = true;
             try {
                 const response = await fetch(`/api/student-homework/${pageId}`, { headers: { 'Authorization': 'Bearer ' + authToken } });
                 if (!response.ok) { throw new Error('데이터 조회 실패'); }
                 const result = await response.json();
                 if (result.success) {
                     const row = buttonElement.closest('tr');
                     if (row) {
                        const rateSpan = row.querySelector('.completion-rate');
                        if (rateSpan) {
                             rateSpan.textContent = `${result.completionRate || 0}%`;
                             rateSpan.className = `completion-rate ${rateClass(result.completionRate)}`;
                             showToast(`${result.studentName} 학생 정보 업데이트 완료`, 'success');
                        }
                     }
                 } else { throw new Error(result.message || '데이터 업데이트 실패'); }
             } catch (error) {
                 console.error('개별 학생 새로고침 오류:', error);
                 showToast(`새로고침 실패: ${error.message}`, 'error');
             } finally {
                 buttonElement.classList.remove('loading');
                 buttonElement.disabled = false;
             }
        }

        function rateClass(r){ if(r>=90)return'rate-excellent'; if(r>=70)return'rate-good'; return'rate-poor'; }
        function updateStats(data){
             const container = document.getElementById('statsContainer');
             if(!data || !data.length){ container.innerHTML = `<div class="stat-card"><div class="stat-value">0</div><div class="stat-label">총 학생 수</div></div><div class="stat-card"><div class="stat-value">0%</div><div class="stat-label">평균 수행율</div></div><div class="stat-card"><div class="stat-value">0</div><div class="stat-label">우수 학생</div></div>`; return; }
            const uniqueStudents = new Set(data.map(item => item.studentName));
            const totalStudents = uniqueStudents.size;
            const avg = Math.round(data.reduce((s,x)=>s+(x.completionRate||0),0)/data.length);
            const excellent=data.filter(x=>(x.completionRate||0)>=90).length;
            container.innerHTML=`<div class="stat-card"><div class="stat-value">${totalStudents}</div><div class="stat-label">총 학생 수 (표시된 기간)</div></div><div class="stat-card"><div class="stat-value">${avg}%</div><div class="stat-label">평균 수행율 (표시된 항목)</div></div><div class="stat-card"><div class="stat-value">${excellent}</div><div class="stat-label">수행율 90% 이상 항목 수</div></div>`;
        }
        function updateTeacherFilterFromData(teachers){
            const sel=document.getElementById('teacherFilter');
            while(sel.children.length>1)sel.removeChild(sel.lastChild);
            teachers.forEach(t=>{ const o=document.createElement('option'); o.value=t.name; o.textContent=t.name; sel.appendChild(o); });
        }
        // 강사 필터 변경 시 함수 -> loadHomeworkStatus 호출
        // function filterByTeacher(){ loadHomeworkStatus(); }

        async function updateHomework(selectElement) {
             const pageId = selectElement.getAttribute('data-page-id');
             const propertyName = selectElement.getAttribute('data-property-name');
             const newValue = selectElement.value;
             const originalOption = selectElement.querySelector('option[selected]');
             const originalValue = originalOption ? originalOption.value : selectElement.options[0].value;
             const originalClass = selectElement.className;
             if (!pageId) { showToast('페이지 ID가 없어 업데이트할 수 없습니다.', 'error'); return; }
             console.log('숙제 업데이트 요청:', { pageId, propertyName, newValue });
             selectElement.disabled = true; selectElement.style.opacity = '0.6';
             try {
                 const response = await fetch('/api/update-homework', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify({ pageId, propertyName, newValue }) });
                 if (!response.ok) {
                     if (response.status === 401) { alert('로그인이 만료되었습니다.'); logout(); return; }
                     const errorData = await response.json(); throw new Error(errorData.message || '업데이트 실패');
                 }
                 const result = await response.json();
                 selectElement.className = `homework-dropdown ${getHomeworkStatusClass(newValue)}`;
                 if(originalOption) originalOption.removeAttribute('selected');
                 const newSelectedOption = selectElement.querySelector(`option[value="${newValue}"]`);
                 if(newSelectedOption) newSelectedOption.setAttribute('selected', '');
                 showToast('저장되었습니다!', 'success');
                 console.log('숙제 업데이트 성공:', result);
                 const refreshButton = selectElement.closest('tr').querySelector('.refresh-rate-btn');
                 if (refreshButton) { refreshStudentRate(refreshButton, pageId); }
             } catch (error) {
                 console.error('숙제 업데이트 오류:', error);
                 selectElement.value = originalValue; selectElement.className = originalClass;
                 showToast(`업데이트 실패: ${error.message}`, 'error');
             } finally { selectElement.disabled = false; selectElement.style.opacity = '1'; }
        }

        function showToast(message, type = 'success') {
             const existingToast = document.querySelector('.toast-message');
             if (existingToast) existingToast.remove();
             const toast = document.createElement('div');
             toast.className = `toast-message toast-${type}`;
             toast.textContent = message;
             document.body.appendChild(toast);
             setTimeout(() => { toast.classList.add('show'); }, 100);
             setTimeout(() => {
                 toast.classList.remove('show');
                 setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
             }, 3000);
        }

        document.getElementById('teacherFilter').addEventListener('change', loadHomeworkStatus);
        document.getElementById('periodFilter').addEventListener('change', loadHomeworkStatus);
        document.getElementById('startDate').addEventListener('change', loadHomeworkStatus);
        document.getElementById('endDate').addEventListener('change', loadHomeworkStatus);

        function logout(){ localStorage.removeItem('teacher_auth_token'); alert("로그아웃 되었습니다."); window.location.href='/teacher-login'; }
        function checkTokenExpiry() {
             const token = localStorage.getItem('teacher_auth_token');
             if (!token) { window.location.href = '/teacher-login'; return; }
             try {
                 const payload = JSON.parse(atob(token.split('.')[1]));
                 const now = Date.now() / 1000;
                 if (payload.exp < now) { alert('로그인이 만료되었습니다.'); logout(); }
             } catch (error) { console.error('토큰 검증 오류:', error); logout(); }
        }
        setInterval(checkTokenExpiry, 5 * 60 * 1000);

        // --- 탭 전환 함수 ---
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => { content.style.display = 'none'; content.classList.remove('active'); });
            document.querySelectorAll('.tab-button').forEach(button => { button.classList.remove('active'); });
            const selectedContent = document.getElementById(tabName + '-view');
            if (selectedContent) { selectedContent.style.display = 'block'; selectedContent.classList.add('active'); }
            const selectedButton = document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`);
            if (selectedButton) { selectedButton.classList.add('active'); }
            if (tabName === 'homework') { loadHomeworkStatus(); }
            // else if (tabName === 'tests') { loadTestData(); } // 나중에 추가
        }
    </script>
</body>
</html>