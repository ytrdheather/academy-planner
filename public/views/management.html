<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ëª…ë¶€ ê´€ë¦¬ - ë¦¬ë””íŠœë“œ</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ (teacher.htmlê³¼ ë™ì¼) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "NanumSquareRound", sans-serif; }
        body { background: #f8f9fa; color: #2d3748; min-height: 100vh; padding: 0; }
        .container { max-width: 1400px; margin: 20px auto; background: none; box-shadow: none; overflow: visible; padding: 0 20px; }
        
        /* --- í—¤ë” (ì´ í˜ì´ì§€ ì „ìš©) --- */
        .header { background: #ffffff; color: #6b46c1; padding: 20px 30px; text-align: left; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; margin: 0; }
        .close-btn { background: #6b46c1; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s ease; }
        .close-btn:hover { background: #5a3eaa; }

        /* --- ì»¨í…ì¸  ê³µí†µ --- */
        .content-section { background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); border: 1px solid #e9ecef; padding: 30px; margin: 0 20px 30px; }
        .section-title { font-size: 1.6em; font-weight: 700; color: #6b46c1; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: "ğŸ§‘â€ğŸ“"; font-size: 1.2em; }
        .loading, .no-data { text-align: center; padding: 60px; color: #718096; font-size: 16px; }
        .loading::before { content: "â³ "; } .no-data::before { content: "ğŸ“ "; }

        /* --- í•„í„° --- */
        .filters-container { display:flex; gap:15px; margin-bottom:25px; align-items:center; flex-wrap: wrap; }
        .refresh-btn { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .filter-group { display:flex; align-items:center; gap:8px; }
        .filter-label { font-weight:600; color:#6b46c1; }
        .filter-input { padding:8px 12px; border-radius:8px; border:2px solid #e2e8f0; background:white; font-size: 14px; }

        /* --- í…Œì´ë¸” --- */
        .table-container { overflow-x: auto; border: 1px solid #e9ecef; border-radius: 12px; }
        .styled-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .styled-table th { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; padding: 12px 10px; text-align: center; font-weight: 600; font-size: 13px; border-right: 1px solid rgba(255,255,255,0.2); white-space: nowrap; }
        .styled-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #f1f3f4; border-right: 1px solid #f1f3f4; vertical-align: middle; font-size: 13px; }
        .styled-table tr:hover { background-color: #f8f9ff; }
        .student-name { font-weight: 600; color: #2d3748; font-size: 14px; background: #f9fafc; text-align: left; padding-left: 15px; }
        .book-title-cell { padding: 5px !important; }
        .book-title-button { width: 100%; min-height: 30px; padding: 6px 8px; border: 1px solid transparent; border-radius: 4px; background-color: transparent; cursor: pointer; text-align: left; font-size: 13px; color: #111827; transition: all 0.2s ease; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.4; }
        .book-title-button:hover { border-color: #d1d5db; background-color: #f9fafb; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1); }
        .book-title-button.empty { color: #6b7280; font-style: italic; text-align: center; }

        /* --- ì±… ê²€ìƒ‰ ëª¨ë‹¬ --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        .modal-title { font-size: 1.4em; font-weight: 700; color: #6b46c1; margin-bottom: 20px; }
        .modal-search-input { width: 100%; padding: 12px 15px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; }
        .modal-search-results { max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; }
        .result-item { padding: 12px 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer; }
        .result-item:hover { background-color: #f8f9ff; }
        .result-item:last-child { border-bottom: none; }
        .result-title { font-weight: 600; color: #2d3748; }
        .result-meta { font-size: 13px; color: #718096; margin-top: 4px; }
        .modal-actions { margin-top: 20px; display: flex; justify-content: space-between; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: #f3f4f6; color: #4b5563; }
        .btn-clear { background: #fee2e2; color: #991b1b; }

        /* --- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ --- */
        .toast-message { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; font-weight: 600; z-index: 3000; opacity: 0; transform: translateX(100%); transition: all 0.3s ease; }
        .toast-message.show { opacity: 1; transform: translateX(0); }
        .toast-success { background: #dcfce7; border: 1px solid #bbf7d0; color: #166534; }
        .toast-error { background: #fecaca; border: 1px solid #fca5a5; color: #991b1b; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§‘â€ğŸ“ í•™ìƒ ëª…ë¶€ ê´€ë¦¬</h1>
        <div class="user-info">
            <button class="close-btn" onclick="window.close()">ì°½ ë‹«ê¸°</button>
        </div>
    </div>

    <div class="container">
        <div class="content-section">
            <div class="filters-container">
                <button class="refresh-btn" onclick="loadStudentRosterData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <div class="filter-group">
                    <label for="studentSearch_management" class="filter-label">í•™ìƒ ê²€ìƒ‰:</label>
                    <input type="text" id="studentSearch_management" class="filter-input" placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰...">
                </div>
            </div>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>í•™ìƒ ì´ë¦„</th>
                            <th>í•™ë…„</th>
                            <th>í•™êµ</th>
                            <th>ì˜ì–´ ë”ë¹™ OR ë“£ê¸° êµì¬ (ìˆ˜ì •)</th>
                        </tr>
                    </thead>
                    <tbody id="managementTableBody">
                        <tr><td colspan="4" class="loading">í•™ìƒ ëª…ë¶€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========== ì±… ê²€ìƒ‰ ëª¨ë‹¬ (ê³µí†µ ì‚¬ìš©) ========== -->
    <div id="bookSearchModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">ğŸ§ ë¦¬ìŠ¤ë‹ êµì¬ ê²€ìƒ‰</h2>
            <input type="text" id="modalSearchInput" class="modal-search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <div id="modalSearchResults" class="modal-search-results">
                <div class="no-data" style="padding: 30px;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...</div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-clear" onclick="selectBook(null, 'êµì¬ ì—†ìŒ')">ğŸš« ê´€ê³„ ì—°ê²° í•´ì œ</button>
                <button class="modal-btn btn-cancel" onclick="closeBookSearchModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™” ---
        const API_BASE_URL = 'http://localhost:5001';
        let authToken = localStorage.getItem('teacher_auth_token');
        let allRosterData = []; // í•™ìƒ ëª…ë¶€ ë°ì´í„° ìºì‹œ
        let currentModalContext = {}; // { pageId, propertyName, type }
        let bookSearchTimer = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                console.error('ì¸ì¦ í† í° ì—†ìŒ');
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = '/teacher-login';
                return;
            }
            initializePage();
        });

        async function initializePage() {
            try {
                await loadStudentRosterData();
                setupEventListeners();
            } catch (e) {
                console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
                const tbody = document.getElementById('managementTableBody');
                tbody.innerHTML = `<tr><td colspan="4" class="no-data">${e.message || 'í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨'}</td></tr>`;
            }
        }

        function setupEventListeners() {
            // í•™ìƒ ëª…ë¶€ ê²€ìƒ‰
            document.getElementById('studentSearch_management')?.addEventListener('input', (e) => {
                filterStudentRoster(e.target.value);
            });

            // ì±… ê²€ìƒ‰ ëª¨ë‹¬ ë””ë°”ìš´ìŠ¤ ì…ë ¥
            document.getElementById('modalSearchInput')?.addEventListener('input', (e) => {
                clearTimeout(bookSearchTimer);
                const query = e.target.value;
                bookSearchTimer = setTimeout(() => {
                    searchListeningBooks(query); // ì´ í˜ì´ì§€ëŠ” ë¦¬ìŠ¤ë‹ êµì¬ë§Œ ê²€ìƒ‰
                }, 300);
            });
            document.querySelector('.btn-cancel').addEventListener('click', closeBookSearchModal);
        }

        // --- ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ ---
        async function loadStudentRosterData() {
            const tbody = document.getElementById('managementTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="loading">ë¡œë”©ì¤‘...</td></tr>';
            try {
                const url = `${API_BASE_URL}/api/student-roster`;
                const response = await fetch(url, { headers: { Authorization: 'Bearer ' + authToken } });
                
                if (response.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    window.location.href = '/teacher-login';
                    return;
                }
                if (response.status === 403) {
                     throw new Error('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ë§¤ë‹ˆì € ê³„ì • ì „ìš©)');
                }
                if (!response.ok) { 
                    const errorText = await response.text(); 
                    throw new Error(errorText || "í•™ìƒ ëª…ë¶€ ë¡œë“œ ì‹¤íŒ¨"); 
                }
                
                const rosterData = await response.json();
                allRosterData = rosterData; // ìºì‹œ
                displayStudentRosterData(rosterData);
            } catch (e) {
                console.error("í•™ìƒ ëª…ë¶€ ë¡œë“œ ì˜¤ë¥˜:", e);
                tbody.innerHTML = `<tr><td colspan="4" class="no-data">${e.message || 'ë¡œë“œ ì‹¤íŒ¨'}</td></tr>`;
                throw e; // initializePageë¡œ ì˜¤ë¥˜ ì „íŒŒ
            }
        }

        // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function displayStudentRosterData(data) {
            const tbody = document.getElementById('managementTableBody');
            if (!data || !data.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(st => `
                <tr id="row-management-${st.pageId}">
                    <td class="student-name">${st.studentName}</td>
                    <td>${st.grade || '-'}</td>
                    <td>${st.school || '-'}</td>
                    <td class="book-title-cell">
                        <button 
                            class="book-title-button ${st.listeningBookTitle ? '' : 'empty'}" 
                            data-page-id="${st.pageId}" 
                            data-relation-ids="${(st.listeningBookRelationIds || []).join(',')}"
                            onclick="openListeningBookModal(this)">
                            ${st.listeningBookTitle || 'êµì¬ ì—†ìŒ'}
                        </button>
                    </td>
                </tr>`).join('');
        }
        
        // í•™ìƒ ëª…ë¶€ ì´ë¦„ìœ¼ë¡œ í•„í„°ë§
        function filterStudentRoster(query) {
            const normalizedQuery = query.toLowerCase().trim();
            if (!normalizedQuery) {
                displayStudentRosterData(allRosterData); // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì „ì²´ í‘œì‹œ
                return;
            }
            const filteredData = allRosterData.filter(st => 
                st.studentName.toLowerCase().includes(normalizedQuery)
            );
            displayStudentRosterData(filteredData);
        }

        // --- ì±… ê²€ìƒ‰ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ---
        function openListeningBookModal(buttonElement) {
            const pageId = buttonElement.getAttribute('data-page-id');
            const currentTitle = buttonElement.textContent.trim();
            currentModalContext = {
                pageId: pageId, // í•™ìƒ ëª…ë¶€ DBì˜ pageId
                propertyName: 'ì˜ì–´ ë”ë¹™ OR ë“£ê¸° êµì¬',
                type: 'listeningBook'
            };
            
            document.getElementById('modalTitle').textContent = 'ğŸ§ ë¦¬ìŠ¤ë‹ êµì¬ ê²€ìƒ‰';
            const input = document.getElementById('modalSearchInput');
            if (currentTitle !== 'êµì¬ ì—†ìŒ') { input.value = currentTitle; } else { input.value = ''; }
            document.getElementById('bookSearchModal').classList.add('show');
            input.focus();
            searchListeningBooks(input.value); 
        }

        function closeBookSearchModal() { 
            document.getElementById('bookSearchModal').classList.remove('show'); 
            currentModalContext = {}; 
        }

        // ë¦¬ìŠ¤ë‹ êµì¬ ê²€ìƒ‰ (ì„ì‹œë¡œ ì˜ì–´ ì›ì„œ DB ì‚¬ìš©)
        async function searchListeningBooks(query) {
             const resultsList = document.getElementById('modalSearchResults');
            if (!query || query.trim().length < 2) { 
                resultsList.innerHTML = '<div class="no-data" style="padding: 30px;">ê²€ìƒ‰ì–´ë¥¼ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>'; 
                return; 
            }
            resultsList.innerHTML = '<div class="loading" style="padding: 30px;">ê²€ìƒ‰ ì¤‘...</div>';
            try {
                // index.jsì˜ /api/search-books ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                const response = await fetch(`${API_BASE_URL}/api/search-books?query=${encodeURIComponent(query)}`, { headers: { 'Authorization': 'Bearer ' + authToken } });
                if (!response.ok) throw new Error('ê²€ìƒ‰ API ì˜¤ë¥˜'); 
                const books = await response.json();
                if (books.length === 0) { 
                    resultsList.innerHTML = '<div class="no-data" style="padding: 30px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; 
                    return; 
                }
                resultsList.innerHTML = books.map(book => `
                    <div class="result-item" onclick="selectBook('${book.id}', '${book.title.replace(/'/g, "\\'")}')">
                        <div class="result-title">${book.title}</div>
                        <div class="result-meta">ì €ì: ${book.author || 'N/A'} | ë ˆë²¨: ${book.level || 'N/A'}</div>
                    </div>`).join('');
            } catch (error) { 
                console.error("ë¦¬ìŠ¤ë‹ êµì¬ ê²€ìƒ‰ ì˜¤ë¥˜:", error); 
                resultsList.innerHTML = '<div class="no-data" style="color: red; padding: 30px;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</div>'; 
            }
        }

        // ì„ íƒí•œ ì±…/êµì¬ë¥¼ ì—…ë°ì´íŠ¸
        async function selectBook(bookPageId, bookTitle) {
            if (!currentModalContext.pageId) return;
            
            const { pageId, propertyName } = currentModalContext;
            const emptyTitle = 'êµì¬ ì—†ìŒ';
            
            closeBookSearchModal();
            
            // 1. UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            const buttonElement = document.querySelector(`#managementTableBody button[data-page-id="${pageId}"]`);
            if (buttonElement) {
                buttonElement.textContent = bookTitle || emptyTitle;
                if (bookPageId) {
                    buttonElement.classList.remove('empty');
                    buttonElement.setAttribute('data-relation-id', bookPageId);
                } else {
                    buttonElement.classList.add('empty');
                    buttonElement.setAttribute('data-relation-id', '');
                }
            }

            // 2. ì„œë²„ì— ì—…ë°ì´íŠ¸ ìš”ì²­
            await submitUpdate(pageId, propertyName, bookPageId, 'relation', buttonElement);
        }

        // --- ì„œë²„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        async function submitUpdate(pageId, propertyName, newValue, propertyType, element = null) {
            console.log('í•„ë“œ ì—…ë°ì´íŠ¸ ìš”ì²­:', { pageId, propertyName, newValue, propertyType });
            if (element) { 
                element.disabled = true; 
                element.style.opacity = '0.6'; 
            }

            try {
                // ì´ í˜ì´ì§€ëŠ” í•­ìƒ 'í•™ìƒ ëª…ë¶€' APIë¥¼ ì‚¬ìš©
                const updateUrl = `${API_BASE_URL}/api/update-student-roster`;
                
                const response = await fetch(updateUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, 
                    body: JSON.stringify({ pageId, propertyName, newValue, propertyType }) 
                });
                
                if (!response.ok) { 
                    if (response.status === 401) { alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); window.location.href = '/teacher-login'; return; } 
                    const errorData = await response.json(); 
                    throw new Error(errorData.message || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨'); 
                }
                
                const result = await response.json(); 
                showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                console.log('í•„ë“œ ì—…ë°ì´íŠ¸ ì„±ê³µ:', result);
                
                // ë¡¤ì—… ê°’(êµì¬ëª…)ì´ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í–‰ì„ ìƒˆë¡œê³ ì¹¨
                refreshStudentRosterRow(pageId); 

            } catch (error) { 
                console.error('í•„ë“œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error); 
                showToast(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error'); 
                // (ì˜¤ë¥˜ ì‹œ UI ë¡¤ë°±ì´ í•„ìš”í•˜ë©´ ì—¬ê¸° êµ¬í˜„)
            }
            finally { 
                if (element) { 
                    element.disabled = false; 
                    element.style.opacity = '1'; 
                }
            }
        }
        
        // í–‰ ìƒˆë¡œê³ ì¹¨ (ê°„ë‹¨í•˜ê²Œ ì „ì²´ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œ)
        async function refreshStudentRosterRow(pageId) {
            if (!pageId) return; 
            const row = document.getElementById(`row-management-${pageId}`); 
            if (row) row.style.opacity = '0.5';
            
            try {
                // (ë” ë‚˜ì€ ë°©ë²•: /api/student-roster/:pageId APIë¥¼ index.jsì— ì¶”ê°€)
                // (ì¼ë‹¨ì€, ê°„ë‹¨í•˜ê²Œ ì „ì²´ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ê°±ì‹ )
                await loadStudentRosterData();
                showToast(`í•™ìƒ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ!`, 'success');
            } catch (error) { 
                console.error('í•™ìƒ ëª…ë¶€ í–‰ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error); 
                showToast(error.message, 'error'); 
                if (row) row.style.opacity = '1'; 
            }
        }

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function showToast(message, type = 'success') {
             const existingToast = document.querySelector('.toast-message'); 
             if (existingToast) existingToast.remove(); 
             const toast = document.createElement('div'); 
             toast.className = `toast-message toast-${type}`; 
             toast.textContent = message; 
             document.body.appendChild(toast); 
             setTimeout(() => { toast.classList.add('show'); }, 100); 
             setTimeout(() => { 
                toast.classList.remove('show'); 
                setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300); 
             }, 3000);
        }
    </script>
</body>
</html>
