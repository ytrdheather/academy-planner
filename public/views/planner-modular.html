<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ì˜ í•™ìŠµ í”Œë˜ë„ˆ</title>
    <!-- Firebase SDK (í•„ìˆ˜) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <style>
        * { font-family: "NanumSquareRound", sans-serif !important; box-sizing: border-box; }
        body { background: #f7fafc; min-height: 100vh; color: #2d3748; margin: 0; padding: 20px; }
        .planner-container { max-width: 700px; margin: auto; background: #ffffff; padding: 0; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; overflow: hidden; min-height: 80vh; display: flex; flex-direction: column; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header { position: relative; background: #ffffff; color: #6b46c1; padding: 20px 30px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; flex-direction: column; gap: 4px; }
        .header-right { display: flex; gap: 10px; align-items: center; }
        .welcome-title { font-size: 20px; font-weight: 700; color: #6b46c1; }
        .current-date { font-size: 14px; color: #718096; }
        .home-btn { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; display: none; }
        .logout-btn { background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; }
        
        #menu-view { padding: 40px 20px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 20px; }
        .menu-btn { padding: 25px; font-size: 18px; font-weight: 700; border: 2px solid #e2e8f0; border-radius: 16px; background: white; color: #4a5568; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .sub-view { display: none; padding: 20px; flex: 1; flex-direction: column; }
        .sub-view.active { display: flex; }
        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .view-title { font-size: 20px; font-weight: 700; color: #2d3748; }
        .back-btn { background: #cbd5e0; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; }
        .section-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #edf2f7; margin-bottom: 20px; }
        h2 { color: #6b46c1; margin: 0 0 15px 0; font-size: 18px; font-weight: 700; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 6px; color: #4a5568; font-size: 14px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #cbd5e0; font-size: 15px; background: #f8fafc; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .submit-button { width: 100%; padding: 15px; background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 20px; }
        .status-message { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 20px; background: #333; color: white; z-index: 9999; display: none; }
        .hidden { display: none !important; }
        .file-upload-wrapper { margin-top: 5px; display: none; }
        .file-upload-btn { background: #f0fdf4; border: 1px dashed #16a34a; color: #166534; padding: 8px; width: 100%; border-radius: 8px; font-size: 13px; cursor: pointer; text-align: center; }
        .file-preview { font-size: 12px; color: #166534; margin-top: 4px; display: block; }
        .date-filter-container { display: flex; justify-content: flex-end; margin-bottom: 15px; align-items: center; gap: 10px; }
        .autocomplete-container { position: relative; }
        .autocomplete-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #cbd5e0; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
        .autocomplete-suggestion { padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .book-tags-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .book-tag { background: #f3e8ff; color: #6b46c1; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .book-tag .remove-btn { cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div class="planner-container">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="header-left">
                <div class="welcome-title"><span id="studentName">í•™ìƒ</span>ì˜ í”Œë˜ë„ˆ</div>
                <div class="current-date" id="currentDate"></div>
            </div>
            <div class="header-right">
                <button onclick="goToMenu()" class="home-btn" id="globalHomeBtn">ğŸ  í™ˆìœ¼ë¡œ</button>
                <button onclick="logout()" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <!-- 1. ë©”ë‰´ -->
        <div id="menu-view">
            <button class="menu-btn" onclick="goToView('homework')"><span class="menu-icon">ğŸ“¤</span> ìˆ™ì œ ì œì¶œí•˜ê¸°</button>
            <button class="menu-btn" onclick="goToView('planner')"><span class="menu-icon">ğŸ“</span> ìŠ¤í„°ë”” í”Œë˜ë„ˆ ì…ë ¥í•˜ê¸°</button>
            <button class="menu-btn" onclick="goToView('history')"><span class="menu-icon">ğŸ“…</span> ë‚˜ì˜ ìŠ¤í„°ë”” ë¡œê·¸ ë³´ê¸°</button>
        </div>

        <!-- 2. ìˆ™ì œ ì œì¶œ -->
        <div id="homework-view" class="sub-view">
            <div class="view-header">
                <div class="view-title">ğŸ“¤ ìˆ™ì œ ì œì¶œ</div>
                <button class="back-btn" onclick="goToMenu()">ë©”ë‰´ë¡œ</button>
            </div>
            <form id="homeworkForm">
                <div class="section-card">
                    <h2>ğŸ“‹ ìˆ™ì œ í™•ì¸</h2>
                    <div class="input-group">
                        <label>â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬</label>
                        <select name="â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬" onchange="toggleFileUpload(this, 'file-grammar')">
                            <option value="í•´ë‹¹ì—†ìŒ">í•´ë‹¹ì—†ìŒ</option><option value="ì•ˆ í•´ì˜´">ì•ˆ í•´ì˜´</option><option value="ìˆ™ì œ í•¨">ìˆ™ì œ í•¨</option>
                        </select>
                        <div class="file-upload-wrapper" id="wrapper-file-grammar">
                            <input type="file" id="file-grammar" accept="image/*" class="file-upload-btn">
                            <span class="file-preview">ğŸ“¸ ë¬¸ë²• ìˆ™ì œ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”</span>
                        </div>
                    </div>
                    
                    <div class="input-group input-row">
                        <div><label>1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸°</label><select name="1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ"><option value="í•´ë‹¹ì—†ìŒ">í•´ë‹¹ì—†ìŒ</option><option value="ì•ˆ í•´ì˜´">ì•ˆ í•´ì˜´</option><option value="ìˆ™ì œ í•¨">ìˆ™ì œ í•¨</option></select></div>
                        <div><label>2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´</label><select name="2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ"><option value="í•´ë‹¹ì—†ìŒ">í•´ë‹¹ì—†ìŒ</option><option value="ì•ˆ í•´ì˜´">ì•ˆ í•´ì˜´</option><option value="ìˆ™ì œ í•¨">ìˆ™ì œ í•¨</option></select></div>
                    </div>
                    
                    <div class="input-group">
                        <label>4ï¸âƒ£ Summary ìˆ™ì œ</label>
                        <select name="4ï¸âƒ£ Summary ìˆ™ì œ" onchange="toggleFileUpload(this, 'file-summary')">
                            <option value="í•´ë‹¹ì—†ìŒ">í•´ë‹¹ì—†ìŒ</option><option value="ì•ˆ í•´ì˜´">ì•ˆ í•´ì˜´</option><option value="ìˆ™ì œ í•¨">ìˆ™ì œ í•¨</option>
                        </select>
                        <div class="file-upload-wrapper" id="wrapper-file-summary">
                            <input type="file" id="file-summary" accept="image/*" class="file-upload-btn">
                            <span class="file-preview">ğŸ“¸ Summary ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>5ï¸âƒ£ ë…í•´ì„œ í’€ê¸° ìˆ™ì œ</label>
                        <select name="5ï¸âƒ£ ë…í•´ì„œ í’€ê¸° ìˆ™ì œ" onchange="toggleFileUpload(this, 'file-reading')">
                            <option value="í•´ë‹¹ì—†ìŒ">í•´ë‹¹ì—†ìŒ</option><option value="ì•ˆ í•´ì˜´">ì•ˆ í•´ì˜´</option><option value="ìˆ™ì œ í•¨">ìˆ™ì œ í•¨</option>
                        </select>
                        <div class="file-upload-wrapper" id="wrapper-file-reading">
                            <input type="file" id="file-reading" accept="image/*" class="file-upload-btn">
                            <span class="file-preview">ğŸ“¸ ë…í•´ì„œ í‘¼ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>6ï¸âƒ£ ë¶€&ë§¤&ì¼</label>
                        <select name="6ï¸âƒ£ ì˜ì–´ì¼ê¸° or ê°œì¸ ë…í•´ì„œ" onchange="toggleFileUpload(this, 'file-diary')">
                            <option value="í•´ë‹¹ì—†ìŒ">í•´ë‹¹ì—†ìŒ</option><option value="ì•ˆ í•´ì˜´">ì•ˆ í•´ì˜´</option><option value="ìˆ™ì œ í•¨">ìˆ™ì œ í•¨</option>
                        </select>
                        <div class="file-upload-wrapper" id="wrapper-file-diary">
                            <input type="file" id="file-diary" accept="image/*" class="file-upload-btn">
                            <span class="file-preview">ğŸ“¸ ë¶€&ë§¤&ì¼ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="submit-button">ìˆ™ì œ ì œì¶œí•˜ê¸°</button>
            </form>
        </div>

        <!-- 3. í”Œë˜ë„ˆ ì…ë ¥ -->
        <div id="planner-view" class="sub-view">
             <div class="view-header"><div class="view-title">ğŸ“ í”Œë˜ë„ˆ ì‘ì„±</div><button class="back-btn" onclick="goToMenu()">ë©”ë‰´ë¡œ</button></div>
             <form id="plannerForm">
                <div class="section-card"><h2>ğŸ“ ì‹œí—˜ ê²°ê³¼</h2>
                <!-- [ìˆ˜ì •] ë„ì–´ì“°ê¸° ì œê±°í•œ name ì†ì„± ì ìš© -->
                <div class="input-group input-row"><div><label>ë‹¨ì–´ (ë§ì€ ê°œìˆ˜)</label><input type="number" name="ë‹¨ì–´(ë§ì€ ê°œìˆ˜)" min="0"></div><div><label>ë‹¨ì–´ (ì „ì²´ ê°œìˆ˜)</label><input type="number" name="ë‹¨ì–´(ì „ì²´ ê°œìˆ˜)" min="0"></div></div><div class="input-group"><label>ì–´íœ˜ìœ ë‹›</label><input type="text" name="ì–´íœ˜ìœ ë‹›" placeholder="ì˜ˆ: Unit 1, Unit 2-3"></div><div class="input-group input-row"><div><label>ë¬¸ë²•(ì „ì²´ ê°œìˆ˜)</label><input type="number" name="ë¬¸ë²•(ì „ì²´ ê°œìˆ˜)" min="0"></div><div><label>ë¬¸ë²•(í‹€ë¦° ê°œìˆ˜)</label><input type="number" name="ë¬¸ë²•(í‹€ë¦° ê°œìˆ˜)" min="0"></div></div><div class="input-group input-row"><div><label>ë…í•´(í‹€ë¦° ê°œìˆ˜)</label><input type="number" name="ë…í•´(í‹€ë¦° ê°œìˆ˜)" min="0"></div><div><label>ë…í•´ í•˜ë¸Œë£¨íƒ€</label><select name="ë…í•´ í•˜ë¸Œë£¨íƒ€"><option value="ìˆ™ì œì—†ìŒ">ìˆ™ì œì—†ìŒ</option><option value="ì™„ë£Œí•¨">ì™„ë£Œí•¨</option><option value="ëª»í•˜ê³ ê°">ëª»í•˜ê³ ê°</option></select></div></div></div>
                <div class="section-card"><h2>ğŸ§ ë¦¬ìŠ¤ë‹ í•™ìŠµ</h2><div class="input-group input-row"><div><label>ì˜ì–´ ë”ë¹™ í•™ìŠµ</label><select name="ì˜ì–´ ë”ë¹™ í•™ìŠµ"><option value="ì§„í–‰í•˜ì§€ ì•ŠìŒ">ì§„í–‰í•˜ì§€ ì•ŠìŒ</option><option value="ë¯¸ì™„ë£Œ">ë¯¸ì™„ë£Œ</option><option value="ì›ì„œë…ì„œë¡œ ëŒ€ì²´">ì›ì„œë…ì„œë¡œ ëŒ€ì²´</option><option value="ë“£ê¸°í‰ê°€êµì¬ ì™„ë£Œ">ë“£ê¸°í‰ê°€êµì¬ ì™„ë£Œ</option><option value="ì™„ë£Œ">ì™„ë£Œ</option></select></div><div><label>ë”ë¹™ ì›Œí¬ë¶</label><select name="ë”ë¹™ ì›Œí¬ë¶"><option value="ì§„í–‰í•˜ì§€ ì•ŠìŒ">ì§„í–‰í•˜ì§€ ì•ŠìŒ</option><option value="ë¯¸ì™„ë£Œ">ë¯¸ì™„ë£Œ</option><option value="ì›ì„œë…ì„œë¡œ ëŒ€ì²´">ì›ì„œë…ì„œë¡œ ëŒ€ì²´</option><option value="ë“£ê¸°í‰ê°€êµì¬ ì™„ë£Œ">ë“£ê¸°í‰ê°€êµì¬ ì™„ë£Œ</option><option value="ì™„ë£Œ">ì™„ë£Œ</option></select></div></div></div>
                <div class="section-card"><h2>ğŸ“š ì›ì„œ ë…ì„œ</h2><div class="input-group"><label>ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…</label><div class="autocomplete-container"><input type="text" id="englishBookTitle" name="ì˜¤ëŠ˜ ì½ì€ ì˜ì–´ ì±…" placeholder="ê²€ìƒ‰..."><div id="bookSuggestions" class="autocomplete-suggestions"></div></div><div id="englishBookTags" class="book-tags-container"></div></div><div class="input-group input-row"><div><label>ì˜ì–´ë…ì„œ</label><select name="ğŸ“– ì˜ì–´ë…ì„œ"><option value="ëª»í•¨">ëª»í•¨</option><option value="ì™„ë£Œí•¨">ì™„ë£Œí•¨</option></select></div><div><label>ì–´íœ˜í•™ìŠµ</label><select name="ì–´íœ˜í•™ìŠµ"><option value="ì™„ë£Œ">ì™„ë£Œ</option><option value="ë¯¸ì™„ë£Œ">ë¯¸ì™„ë£Œ</option><option value="SKIP">SKIP</option></select></div><div><label>Writing</label><select name="Writing"><option value="SKIP">SKIP</option><option value="3 SENTENCE">3 SENTENCE</option><option value="ë¶ ë¦¬í¬íŠ¸">ë¶ë¦¬í¬íŠ¸</option></select></div></div></div>
                <div class="section-card"><h2>ğŸ“• ì±… ì½ëŠ” ê±°ì¸</h2><div class="input-group"><label>3ë… ë…ì„œ ì œëª©</label><div class="autocomplete-container"><input type="text" id="giantBookTitle" name="ì˜¤ëŠ˜ ì½ì€ í•œêµ­ ì±…" placeholder="ê²€ìƒ‰..."><div id="sayuBookSuggestions" class="autocomplete-suggestions"></div></div><div id="giantBookTags" class="book-tags-container"></div></div><div class="input-group"><label>ì™„ë£Œ ì—¬ë¶€</label><select name="ì™„ë£Œ ì—¬ë¶€"><option value="ì§„í–‰í•˜ì§€ ì•ŠìŒ">ì§„í–‰í•˜ì§€ ì•ŠìŒ</option><option value="ë¯¸ì™„ë£Œ">ë¯¸ì™„ë£Œ</option><option value="ì™„ë£Œ">ì™„ë£Œ</option></select></div></div>
                <div class="section-card"><h2>ğŸ’¬ ì˜¤ëŠ˜ì˜ ì†Œê°</h2><div class="input-group"><textarea name="ì˜¤ëŠ˜ì˜ ì†Œê°" rows="3" placeholder="ì˜¤ëŠ˜ í•™ìŠµí•˜ë©´ì„œ ëŠë‚€ ì ì„ ì ì–´ì£¼ì„¸ìš”."></textarea></div></div>
                <button type="submit" class="submit-button">í”Œë˜ë„ˆ ì €ì¥í•˜ê¸°</button>
             </form>
        </div>

        <!-- 4. ë¡œê·¸ ë³´ê¸° -->
        <div id="history-view" class="sub-view">
             <div class="view-header"><div class="view-title" id="historyTitle">ğŸ“… ìŠ¤í„°ë”” ë¡œê·¸</div><button class="back-btn" onclick="goToMenu()">ë©”ë‰´ë¡œ</button></div><div class="date-filter-container"><label>ë‚ ì§œ ì„ íƒ: </label><input type="date" id="historyDateInput" onchange="loadHistoryData()"></div><div id="historyContent">
                <!-- ì½ê¸° ì „ìš© í¼ -->
                <form id="historyForm">
                    <div class="section-card"><h2>ğŸ“‹ ìˆ™ì œ ê¸°ë¡</h2><div class="input-group input-row"><div><label>ë¬¸ë²• ìˆ™ì œ</label><input type="text" name="â­• ì§€ë‚œ ë¬¸ë²• ìˆ™ì œ ê²€ì‚¬" disabled></div><div><label>ì–´íœ˜ í´ì¹´</label><input type="text" name="1ï¸âƒ£ ì–´íœ˜ í´ì¹´ ì•”ê¸° ìˆ™ì œ" disabled></div></div><div class="input-group input-row"><div><label>ë…í•´ í´ì¹´</label><input type="text" name="2ï¸âƒ£ ë…í•´ ë‹¨ì–´ í´ì¹´ ìˆ™ì œ" disabled></div><div><label>Summary</label><input type="text" name="4ï¸âƒ£ Summary ìˆ™ì œ" disabled></div></div><div class="input-group input-row"><div><label>ë§¤ì¼ ë…í•´</label><input type="text" name="5ï¸âƒ£ ë…í•´ì„œ í’€ê¸°" disabled></div><div><label>ë¶€&ë§¤&ì¼</label><input type="text" name="6ï¸âƒ£ ë¶€&ë§¤&ì¼" disabled></div></div></div>
                    <div class="section-card"><h2>ğŸ“ ì‹œí—˜/í•™ìŠµ ê¸°ë¡</h2><div class="input-group"><label>ì–´íœ˜ìœ ë‹›</label><input type="text" name="ì–´íœ˜ìœ ë‹›" disabled></div><div class="input-group input-row"><div><label>ë‹¨ì–´ ë§ì€ê°œìˆ˜</label><input type="text" name="ë‹¨ì–´(ë§ì€ ê°œìˆ˜)" disabled></div><div><label>ë¬¸ë²• í‹€ë¦°ê°œìˆ˜</label><input type="text" name="ë¬¸ë²•(í‹€ë¦° ê°œìˆ˜)" disabled></div></div><div class="input-group"><label>ì˜ì–´ ë…ì„œ</label><input type="text" name="ğŸ“– ì˜ì–´ë…ì„œ" disabled></div><div class="input-group"><label>ì½ì€ ì±… ëª©ë¡</label><div id="historyBookList" style="padding:10px; background:#f1f5f9; border-radius:8px; min-height:40px;"></div></div><div class="input-group"><label>ì˜¤ëŠ˜ì˜ ì†Œê°</label><textarea name="ì˜¤ëŠ˜ì˜ í•™ìŠµ ì†Œê°" disabled rows="3"></textarea></div><div class="input-group"><label>ì„ ìƒë‹˜ ì½”ë©˜íŠ¸</label><div id="historyTeacherComment" style="padding:15px; background:#fffbeb; border:1px solid #fbd38d; border-radius:8px; white-space: pre-wrap;"></div></div></div>
                </form>
             </div>

        </div>

        <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
        // [ì¤‘ìš”] ì—¬ê¸°ì— Firebase ì„¤ì •ê°’ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
        const firebaseConfig = {
            // ì—¬ê¸°ì— ë³µì‚¬í•œ config ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
        };

        // Firebase ì´ˆê¸°í™”
        let storage;
        try {
            if (firebaseConfig.apiKey && firebase.apps.length === 0) { 
                firebase.initializeApp(firebaseConfig); 
                storage = firebase.storage();
                console.log("Firebase initialized");
            }
        } catch(e) { console.error("Firebase init failed:", e); }

        let authToken = localStorage.getItem('authToken');
        let selectedEnglishBooks = [];
        let selectedKoreanBooks = [];

        // UI ë¡œì§: íŒŒì¼ ì—…ë¡œë“œ ì¹¸ í† ê¸€
        window.toggleFileUpload = function(selectEl, fileInputId) {
            const wrapper = document.getElementById('wrapper-' + fileInputId);
            if (selectEl.value === 'ìˆ™ì œ í•¨') {
                wrapper.style.display = 'block';
            } else {
                wrapper.style.display = 'none';
            }
        };

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜
        async function uploadImage(file) {
            if (!storage) { alert("ì´ë¯¸ì§€ ì €ì¥ì†Œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."); return null; }
            const storageRef = storage.ref();
            const fileName = `${new Date().getTime()}_${file.name}`;
            const fileRef = storageRef.child('homework_images/' + fileName);
            
            try {
                const snapshot = await fileRef.put(file);
                return await snapshot.ref.getDownloadURL();
            } catch (e) {
                console.error("Upload failed:", e);
                return null;
            }
        }

        // í¼ ì œì¶œ (ì €ì¥) - ìˆ™ì œ ì œì¶œ ì‹œ ì´ë¯¸ì§€ ì—…ë¡œë“œ í¬í•¨
        async function handleFormSubmit(e) {
            e.preventDefault();
            const formId = e.target.id;
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬ (ìˆ™ì œ í¼ì¸ ê²½ìš°)
            if (formId === 'homeworkForm') {
                const uploadPromises = [];
                const fileInputs = {
                    'file-grammar': 'grammarImage',
                    'file-summary': 'summaryImage',
                    'file-reading': 'readingImage',
                    'file-diary': 'diaryImage'
                };

                showToast('ì €ì¥ ì¤‘... (ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)', 'success');

                for (const [inputId, dataKey] of Object.entries(fileInputs)) {
                    const fileInput = document.getElementById(inputId);
                    if (fileInput && fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        uploadPromises.push(
                            uploadImage(file).then(url => {
                                if (url) data[dataKey] = url; 
                            })
                        );
                    }
                }
                
                if (uploadPromises.length > 0) {
                    await Promise.all(uploadPromises);
                }
            }

            // 2. ì±… ëª©ë¡ ì²˜ë¦¬ (í”Œë˜ë„ˆ í¼ì¸ ê²½ìš°)
            if (formId === 'plannerForm') {
                data.englishBooks = selectedEnglishBooks;
                data.koreanBooks = selectedKoreanBooks;
            }

            // 3. ì„œë²„ ì „ì†¡
            try {
                const res = await fetch('/save-progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                
                if (result.success) {
                    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
                } else {
                    showToast('ì €ì¥ ì‹¤íŒ¨ ğŸ˜¢', 'error');
                }
            } catch (e) { showToast('ì˜¤ë¥˜ ë°œìƒ', 'error'); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) { window.location.href = '/'; return; }
            window.history.replaceState({ view: 'menu' }, '', '');
            loadStudentInfo();
            const today = new Date();
            document.getElementById('currentDate').textContent = `${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ${today.getDate()}ì¼`;
            initializeBookAutocomplete();
            initializeSayuBookAutocomplete();
            goToMenu(false);
            
            document.getElementById('homeworkForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('plannerForm').addEventListener('submit', handleFormSubmit);
        });
        
        async function loadStudentInfo() {
            try {
                const res = await fetch('/api/student-info', { headers: { 'Authorization': `Bearer ${authToken}` } });
                if (res.ok) {
                    const data = await res.json();
                    const name = data.studentName;
                    document.getElementById('studentName').textContent = name;
                    const historyTitle = document.getElementById('historyTitle');
                    if (historyTitle) {
                        const lastChar = name.charCodeAt(name.length - 1);
                        const hasJongseong = (lastChar - 0xAC00) % 28 > 0; 
                        const suffix = hasJongseong ? '(ì´)ì˜' : 'ì˜';
                        historyTitle.textContent = `ğŸ“… ${name}${suffix} ìŠ¤í„°ë”” ë¡œê·¸`;
                    }
                } else {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); window.location.href = '/';
                }
            } catch (e) { console.error(e); }
        }

        function goToMenu(pushHistory = true) {
            document.querySelectorAll('.sub-view').forEach(el => el.classList.remove('active'));
            document.getElementById('menu-view').style.display = 'flex';
            document.getElementById('globalHomeBtn').style.display = 'none'; 
            if (pushHistory) { window.history.pushState({ view: 'menu' }, '', ''); }
        }

        function goToView(viewName) {
            document.getElementById('menu-view').style.display = 'none';
            document.querySelectorAll('.sub-view').forEach(el => el.classList.remove('active'));
            document.getElementById('globalHomeBtn').style.display = 'block'; 
            
            if (viewName === 'homework') {
                document.getElementById('homework-view').classList.add('active');
                loadTodayData('homeworkForm'); 
            } else if (viewName === 'planner') {
                document.getElementById('planner-view').classList.add('active');
                loadTodayData('plannerForm'); 
            } else if (viewName === 'history') {
                document.getElementById('history-view').classList.add('active');
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('historyDateInput').value = today;
                loadHistoryData();
            }
            window.history.pushState({ view: viewName }, '', `#${viewName}`);
        }

        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.view && event.state.view !== 'menu') {
                goToViewHelper(event.state.view);
            } else {
                goToMenuHelper();
            }
        });

        function goToMenuHelper() {
            document.querySelectorAll('.sub-view').forEach(el => el.classList.remove('active'));
            document.getElementById('menu-view').style.display = 'flex';
            document.getElementById('globalHomeBtn').style.display = 'none';
        }

        function goToViewHelper(viewName) {
            document.getElementById('menu-view').style.display = 'none';
            document.querySelectorAll('.sub-view').forEach(el => el.classList.remove('active'));
            document.getElementById('globalHomeBtn').style.display = 'block';
            
            if (viewName === 'homework') {
                document.getElementById('homework-view').classList.add('active');
                loadTodayData('homeworkForm');
            } else if (viewName === 'planner') {
                document.getElementById('planner-view').classList.add('active');
                loadTodayData('plannerForm');
            } else if (viewName === 'history') {
                document.getElementById('history-view').classList.add('active');
            }
        }

        async function loadTodayData(formId) {
            try {
                const res = await fetch('/api/get-today-progress', { headers: { 'Authorization': `Bearer ${authToken}` } });
                const json = await res.json();
                
                if (json.success && json.progress) {
                    const form = document.getElementById(formId);
                    const data = json.progress;

                    Object.keys(data).forEach(key => {
                        const el = form.querySelector(`[name="${key}"]`);
                        if (el) el.value = data[key];
                    });

                    if (formId === 'plannerForm') {
                        if (data.englishBooks) {
                            selectedEnglishBooks = data.englishBooks;
                            renderBookTags('english');
                        }
                        if (data.koreanBooks) {
                            selectedKoreanBooks = data.koreanBooks;
                            renderBookTags('giant');
                        }
                    }
                }
            } catch (e) { console.error('Data load error:', e); }
        }

        async function loadHistoryData() {
            const date = document.getElementById('historyDateInput').value;
            if (!date) return;

            try {
                const res = await fetch(`/api/get-today-progress?date=${date}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const json = await res.json();

                const form = document.getElementById('historyForm');
                form.reset();
                document.getElementById('historyBookList').innerHTML = '';
                document.getElementById('historyTeacherComment').textContent = 'ì½”ë©˜íŠ¸ ì—†ìŒ';

                if (json.success && json.progress) {
                    const data = json.progress;
                    Object.keys(data).forEach(key => {
                        const el = form.querySelector(`[name="${key}"]`);
                        if (el) el.value = data[key];
                    });
                    
                    if (data.englishBooks) {
                        const titles = data.englishBooks.map(b => `<span class="book-tag">${b.title}</span>`).join('');
                        document.getElementById('historyBookList').innerHTML = titles || 'ì—†ìŒ';
                    }
                    
                    if (data['Today\'s Notice!']) { 
                         document.getElementById('historyTeacherComment').textContent = data['Today\'s Notice!'];
                    } else if (data['â¤ Today\'s Notice!']) {
                         document.getElementById('historyTeacherComment').textContent = data['â¤ Today\'s Notice!'];
                    }
                } else {
                     document.getElementById('historyTeacherComment').textContent = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                }

            } catch (e) { console.error(e); }
        }

        function showToast(msg, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = `status-message ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        function logout() {
            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('authToken');
                window.location.href = '/';
            }
        }

        let searchTimeout;
        let currentBooks = [];
        
        function initializeBookAutocomplete() {
            const bookInput = document.getElementById('englishBookTitle');
            if(!bookInput) return;
            
            bookInput.addEventListener('input', function() {
                const query = this.value.trim();
                clearTimeout(searchTimeout);
                if (query.length < 2) { document.getElementById('bookSuggestions').style.display='none'; return; }
                searchTimeout = setTimeout(() => { searchBooks(query, 'english'); }, 500);
            });
        }
        
        function initializeSayuBookAutocomplete() {
             const bookInput = document.getElementById('giantBookTitle');
             if(!bookInput) return;

             bookInput.addEventListener('input', function() {
                const query = this.value.trim();
                clearTimeout(searchTimeout);
                if (query.length < 2) { document.getElementById('sayuBookSuggestions').style.display='none'; return; }
                searchTimeout = setTimeout(() => { searchBooks(query, 'korean'); }, 500);
            });
        }

        async function searchBooks(query, type) {
            const endpoint = type === 'english' ? '/api/search-books' : '/api/search-sayu-books';
            const listId = type === 'english' ? 'bookSuggestions' : 'sayuBookSuggestions';
            
            try {
                const res = await fetch(`${endpoint}?query=${encodeURIComponent(query)}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const books = await res.json();
                const list = document.getElementById(listId);
                
                if (!books.length) {
                    list.innerHTML = '<div class="autocomplete-suggestion">ê²°ê³¼ ì—†ìŒ</div>';
                } else {
                    list.innerHTML = books.map((b, i) => 
                        `<div class="autocomplete-suggestion" onclick="selectBook('${type}', ${i})">
                            ${b.title} <small>${b.author || ''}</small>
                        </div>`
                    ).join('');
                    if(type==='english') window.tempEngBooks = books;
                    else window.tempKorBooks = books;
                }
                list.style.display = 'block';
            } catch (e) { console.error(e); }
        }

        window.selectBook = function(type, index) {
            const book = type === 'english' ? window.tempEngBooks[index] : window.tempKorBooks[index];
            const targetList = type === 'english' ? selectedEnglishBooks : selectedKoreanBooks;
            
            if (!targetList.some(b => b.id === book.id)) {
                targetList.push(book);
                renderBookTags(type);
            }
            
            document.getElementById(type === 'english' ? 'bookSuggestions' : 'sayuBookSuggestions').style.display = 'none';
            document.getElementById(type === 'english' ? 'englishBookTitle' : 'giantBookTitle').value = '';
        };

        function renderBookTags(type) {
            const container = document.getElementById(type === 'english' ? 'englishBookTags' : 'giantBookTags');
            const list = type === 'english' ? selectedEnglishBooks : selectedKoreanBooks;
            
            container.innerHTML = list.map((b, i) => 
                `<div class="book-tag">
                    ${b.title} <span class="remove-btn" onclick="removeBook('${type}', ${i})">Ã—</span>
                </div>`
            ).join('');
        }

        window.removeBook = function(type, index) {
            const list = type === 'english' ? selectedEnglishBooks : selectedKoreanBooks;
            list.splice(index, 1);
            renderBookTags(type);
        };

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.autocomplete-suggestions').forEach(el => el.style.display = 'none');
            }
        });

    </script>
</body>
</html>